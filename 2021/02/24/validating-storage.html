<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Validating storage | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2021/02/24/validating-storage.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Validating storage | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2021/02/24/validating-storage.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2021-02-24T08:02:20Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Validating storage' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="validating-storage-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Validating storage
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>February 24, 2021</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/01/28/database-as-a-queue.html">Database as a Queue</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/02/25/mysql-from-below.html">MySQL from Below</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Where I work, we try to run databases in a memory saturated way. That is, we try to provide so much memory that the working set of the database is memory resident, or in other words, the number of disk reads after an initial warmup is no longer dependent on the database load.</p>
<p><p class="md__image">
  <img src="/uploads/2021/02/workload-intelligence.png" alt=""  />
</p>

</p>
<p><em>Workload Intelligence Analytics showing &ldquo;IOPS over time&rdquo; for a mixed read/write benchmark on Datera iSCSI.</em></p>
<p>We can validate and prove that with automated load testing: For each replication chain we single out a production host, and increase the hosts weight in the load balancer until the system load1 becomes critical. Observing the system behavior in the load test, we see the select rate load go up, but the disk reads stay largely unchanged.</p>
<p>We usually terminate an automated load test when around 3/4 the number of cores in the system are busy, or when the relevant accounts query latency goes out of bounds. We record the system performance at bailout, and with appropriate margins use this as a scale factor for predictive autoscaling.</p>
<p>We have found reactive autoscaling to be unsuitable for databases, but that is another story.</p>
<p>All of this is on completely autoprovisioned baremetal blades. Baremetal provides extremely little jitter in performance: There is no crosstalk from storage that is local, and there is no crosstalk from memory or CPU, because you are fundamentally alone on the box.</p>
<p>In a virtualized environment this changes. You gain the ability to buy and run much fatter machines, and to provide smaller database instances for services, but you need to run with distributed storage and have to live with potential crosstalk from shared infrastructure.</p>
<p>So I am at the moment validating various storage systems for MySQL needs.</p>
<h2 id="workload-characteristics-as-fio-config">
    <a href="#workload-characteristics-as-fio-config">
	Workload characteristics as fio config
    </a>
</h2>
<p>I can classify my database production chains basically by write load: Read load is usually not relevant - it is drowned by local buffer pool, or by the distributed storage systems cache mechanisms.</p>
<p>When it is not, it is what it is, because it is too large for anything.</p>
<p>So my benchmark is the classical MySQL &ldquo;16 KB random write is an excellent predictor for your machineries performance&rdquo; benchmark. I can divide my customers into &ldquo;200 commit/s&rdquo;, &ldquo;2000 commit/s&rdquo; and &ldquo;whatever the machinery can provide&rdquo; classes, and this results in a small <code>fio</code> configuration.</p>
<p>Each section is run individually, sequentially:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">[global]
</span></span></span><span class="line"><span class="cl"><span class="go"> size=800g
</span></span></span><span class="line"><span class="cl"><span class="go"> filename=fio.0
</span></span></span><span class="line"><span class="cl"><span class="go"> directory=/a/fio
</span></span></span><span class="line"><span class="cl"><span class="go"> fadvise_hint=0
</span></span></span><span class="line"><span class="cl"><span class="go"> blocksize=16k
</span></span></span><span class="line"><span class="cl"><span class="go"> direct=1
</span></span></span><span class="line"><span class="cl"><span class="go"> runtime=600
</span></span></span><span class="line"><span class="cl"><span class="go"> ioengine=libaio
</span></span></span><span class="line"><span class="cl"><span class="go"> time_based
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w1q1-200]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=1
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=1
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_iops=200
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_process=poisson
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w1q1-2000]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=1
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=1
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_iops=2000
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_process=poisson
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w1q1-unlimited]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=1
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=1
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w1q2-200]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=1
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=2
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_iops=200
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_process=poisson
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w1q2-2000]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=1
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=2
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_iops=2000
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_process=poisson
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w1q2-unlimited]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=1
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=2
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w8q1-200]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=8
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=1
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_iops=200
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_process=poisson
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w8q1-2000]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=8
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=1
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_iops=2000
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_process=poisson
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w8q1-unlimited]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=8
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=1
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w8q2-200]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=8
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=2
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_iops=200
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_process=poisson
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w8q2-2000]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=8
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=2
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_iops=2000
</span></span></span><span class="line"><span class="cl"><span class="go">  rate_process=poisson
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[w8q2-unlimited]
</span></span></span><span class="line"><span class="cl"><span class="go">  rw=randwrite
</span></span></span><span class="line"><span class="cl"><span class="go">  numjobs=8
</span></span></span><span class="line"><span class="cl"><span class="go">  iodepth=2
</span></span></span></code></pre></div><p>In the <code>[general]</code> section I provide the parameters common to all benchmarks: I mount my storage into <code>/a</code> and create <code>/a/fio</code> as a test directory.</p>
<p>We are using the XFS file system, because we have found the commit performance in <code>ext4</code> to be highly jittery: While the best case commit in <code>ext4</code> is almost twice as good as in <code>XFS</code>, there are inexplicable sync pauses every now and then that lead to three digit ms downspikes in performance, and they ruin the MySQL experience. With XFS we get one single, fixed commit rate with almost no jitter: Stable plannable performance &raquo; good peak performance!</p>
<p>In this example I am running relatively short 600s test runs, which is not suitable for a validation - they need to run an hour or longer, each, because some storage systems show phase changes after long run times. They are suitable for quick testing to zoom in into interesting scenarios, though.</p>
<p>I am working with direct io (<code>direct=1</code>) and the MySQL 16 KB blocksize on an 800 GB test file, using the <code>libaio</code> engine, which mirrors the MySQL use of the system pretty well.</p>
<p>All my test scenarios are using the same schema: <code>randwrite</code> of said 16 KB blocks, in either a single thread or with 8 threads. I am setting a queue depth of 1 or 2, to get worst case and best case performance estimates. For the rated tests, I am setting an <code>rate_iops</code> of 200 or 2000 and observe the latency behavior, and there is always also an unlimited test to establish saturated behavior. Basically, I want to estimate runway length for abuse cases.</p>
<h2 id="collecting-test-data">
    <a href="#collecting-test-data">
	Collecting test data
    </a>
</h2>
<p>I am running all of that with an ugly ad-hoc driver script that runs each test case recording the fio output, the iostat output during the run and running the test under a <code>blktrace -d /dev/$device -D . -a issue -a complete</code>.</p>
<p>The blktrace can later be fed to <a href="https://www.oakgatetech.com/applications/analytics" target="_blank" rel="noopener">Oakgate Workload Intelligence</a>

. This is an analyzer that feeds on blktrace and other input and plots device behavior over time, generates histograms and generally gives insight into storage behavior. The system can also use recorded workloads from real world applications and replay them for synthetic benchmarks to be run on new storage systems.</p>
<p>The ugly little bash driver, which will soon be a proper piece of Python:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#! /bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># drive under test</span>
</span></span><span class="line"><span class="cl"><span class="nv">drive</span><span class="o">=</span>sdb
</span></span><span class="line"><span class="cl"><span class="nv">fio</span><span class="o">=</span><span class="nv">$HOME</span>/fio.cfg
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># yes, ugly</span>
</span></span><span class="line"><span class="cl"><span class="nv">pause</span><span class="o">=</span><span class="m">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">jobs</span><span class="o">=</span><span class="k">$(</span>awk <span class="s1">&#39;/\[/ &amp;&amp; ! /\[global\]/ { print substr($0, 2, length($0)-2); }&#39;</span> <span class="nv">$fio</span> <span class="k">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mkdir <span class="nv">$drive</span>
</span></span><span class="line"><span class="cl">cp fio.cfg doit <span class="nv">$drive</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in <span class="nv">$jobs</span>
</span></span><span class="line"><span class="cl"><span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Running Job </span><span class="nv">$i</span><span class="s2"> </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># make a working dir, and run blktrace and iostat in it</span>
</span></span><span class="line"><span class="cl">    <span class="o">[</span> -d <span class="nv">$drive</span>/<span class="nv">$i</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> rm -rf <span class="nv">$drive</span>/<span class="nv">$i</span>
</span></span><span class="line"><span class="cl">    mkdir <span class="nv">$drive</span>/<span class="nv">$i</span>
</span></span><span class="line"><span class="cl">    <span class="k">until</span> <span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$blktrace_pid</span><span class="s2">&#34;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> sudo <span class="nb">kill</span> -0 <span class="s2">&#34;</span><span class="nv">$blktrace_pid</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$drive</span>/<span class="nv">$i</span><span class="p">;</span> sudo blktrace -w <span class="m">700</span> -d /dev/<span class="nv">$drive</span> -D . -a issue -a <span class="nb">complete</span> <span class="o">)</span> <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">blktrace_pid</span><span class="o">=</span><span class="nv">$!</span>
</span></span><span class="line"><span class="cl">        sleep <span class="nv">$pause</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$drive</span>/<span class="nv">$i</span><span class="p">;</span> iostat -x -k <span class="m">10</span> &gt; iostat.log <span class="o">)</span> <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">iostat_pid</span><span class="o">=</span><span class="nv">$!</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;Blktrace: </span><span class="si">${</span><span class="nv">blktrace_pid</span><span class="si">}</span><span class="s2"> Iostat: </span><span class="si">${</span><span class="nv">iostat_pid</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    sleep <span class="nv">$pause</span>
</span></span><span class="line"><span class="cl">    fio --section<span class="o">=</span><span class="nv">$i</span> <span class="nv">$fio</span> <span class="p">|</span> tee <span class="nv">$drive</span>/<span class="nv">$drive</span>-<span class="nv">$i</span>.run
</span></span><span class="line"><span class="cl">    sleep <span class="nv">$pause</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">kill</span> <span class="si">${</span><span class="nv">iostat_pid</span><span class="si">}</span>
</span></span><span class="line"><span class="cl">    sleep <span class="nv">$pause</span>
</span></span><span class="line"><span class="cl">    pkill iostat
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> sudo <span class="nb">kill</span> -0 <span class="nv">$blktrace_pid</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="nb">echo</span> <span class="s2">&#34;Blktrace </span><span class="nv">$blktrace_pid</span><span class="s2"> still running.&#34;</span>
</span></span><span class="line"><span class="cl">      sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">done</span>
</span></span><span class="line"><span class="cl">    sleep <span class="nv">$pause</span>
</span></span><span class="line"><span class="cl">    <span class="o">(</span> <span class="nb">cd</span> <span class="nv">$drive</span><span class="p">;</span> tar cvzf <span class="nv">$i</span>.tgz <span class="nv">$i</span> <span class="o">)</span>
</span></span><span class="line"><span class="cl">    rm -rf <span class="nv">$drive</span>/<span class="nv">$i</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span></code></pre></div><p>I end up with a directory named after the drive under test, containing the entire description of the test environment, plus subdirectories for each scenario, containing all recorded data. I can tar that up and carry it home for analytics.</p>
<h2 id="example-graphs">
    <a href="#example-graphs">
	Example graphs
    </a>
</h2>
<p>I am mostly interested into the behavior of the system along &ldquo;IOPS over time&rdquo;, &ldquo;Latency over time&rdquo; and &ldquo;Latency histogram&rdquo;.</p>
<p>Looking at the unconstrained, single threaded, queue depth=2 cases I get a relatively representative quick overview over the result:</p>
<p><p class="md__image">
  <img src="/uploads/2021/02/all-results.png" alt=""  />
</p>

</p>
<p><em>Ceph has a commit latency of around 1.1ms, which at a queue depth of 2 results in around 1800 IOPS. Datera has a commit latency of around 0.17ms, which results in around 9000 IOPS, but with nasty downspikes to some 6500ish IOPS.</em></p>
<p>The benchmark is a bit unfair, because we compare an extremely large and extensively optimized Ceph production cluster against a 3-node minimal out-of-the-box Datera. The Datera produces a number of nasty downspikes, which would not happen in a tuned and larger production cluster. It can already be seen that the Datera has an almost, but not quite, 10x advantage in commit latency.</p>
<p>It can also be somewhat seen the Ceph driver can leverage multiple queues (and that is confirmed in other benchmarks): It should produce around 900 IOPS at 1.1ms commit latency, but at a queue depth of 2 it produces 2x that.</p>
<p>iSCSI cannot do that out of the box: We need to install <a href="https://www.kernel.org/doc/html/latest/block/blk-mq.html" target="_blank" rel="noopener">blk-mq</a>

 and see what that does, or use something that does NVME over Fabric over TCP instead. Both these things have multiple queues, and would also be able to take advantage of deeper queues to NVME backends.</p>
<p>More work would have to go into building out the Datera cluster, and configuring it properly to properly show its real strength, but already it wipes the floor with the Ceph with respect to commit latency.</p>
<p>It also shows that the Ceph can carry the &ldquo;200 commit/s&rdquo; workload class without problems. One will have to make compromise with runway length (&ldquo;Time for warning and migration when workload grows&rdquo;) and with replication delay and catchup SLOs - customers will either have to accept more delay and longer catchup times, or accept that the cluster will run in YOLO mode in catchup (<code>innodb_flush_log_at_trx_commit=2</code> until replication has caught up).</p>
<p>There is probably little chance to run the &ldquo;2000 commit/s&rdquo; workload class in a stable way on Ceph, until one can make guarantees about queue depths and parallel writes.</p>
<p>Both systems max out at around 20000 commit/s when run in their respective &ldquo;ideal&rdquo; mode, which happens to be the commit latency to a single flash drive.</p>
<p>Interestingly, <a href="/2019/06/13/adventures-in-storageland.html">NVME does not matter much here</a>

: NVME can offer 40x more IOPS than SATA SSD, but individual commits will still be at about the same speed as with SATA. You need 40x parallel access to eat all the buffet on offer.</p>
<p>To drive Ceph to 20.000 IOPS, you will have to run 16 threads at a queue depth of 2 (or 32 threads at queue depth 1) consistently, feeding all the driver queues in parallel. This is not a kind of workload a transactional system can easily produce.</p>
<p>To drive Datera to 20.000 IOPS, two or three threads running unlimited will suffice. This is still hard on a transactional system, but a doable challenge.</p>
<p>While the recommendation is clear (&ldquo;Use Datera over Ceph for transactional distributed storage&rdquo;), it is interesting to see how Ceph has matured and does no longer completely suck at doing small transactional workloads.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				database
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2021-02-24-validating-storage.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/01/28/database-as-a-queue.html">Database as a Queue</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/02/25/mysql-from-below.html">MySQL from Below</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
