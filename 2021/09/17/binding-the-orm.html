<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Binding the ORM | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2021/09/17/binding-the-orm.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Binding the ORM | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2021/09/17/binding-the-orm.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2021-09-17T14:06:51Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Binding the ORM' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-binding-the-orm-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Binding the ORM
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>September 17, 2021</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/09/15/mysql-tracing-a-single-query-with-performanceschema.html">MySQL: Tracing a single query with PERFORMANCE_SCHEMA</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/09/27/mysql-booking-2010-a-hiring-interview-question.html">MySQL: Our MySQL in 2010, a hiring interview question</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>My task is to collect performance data about a single query, using <code>PERFORMANCE_SCHEMA</code> (P_S for short) in MySQL, to ship it elsewhere for integration with other data.</p>
<p>In a grander scheme of things, I will need to define what performance data from a query I am actually interested in.
I will also need to find a way to attribute the query (as seen on the server) to a point in the codebase of the client, which is not always easy when an ORM or other SQL generator is being used.
And finally I will need to find a way to view the query execution in the context of the client code execution, because the data access is only a part of the system performance.</p>
<p>This is about marking a query so that it can be identified in source and attributed to its origin in the codebase.</p>
<p>In my scenario, I have control over the ORM or DAO.
I can look at the stackframe, identify the caller of the <code>execute</code> function and put filename and line number or other identifying information into the generated query text.
I could also get identifiers (&quot;<a href="https://github.com/opentracing/specification/blob/master/specification.md" target="_blank" rel="noopener">tracing ids</a>

&quot;) from the caller and pass them on, so the query execution can be a child span of the ORM call that made the SQL and ran it.</p>
<p>What will work?</p>
<h1 id="comments-are-stripped-from-p_s">
    <a href="#comments-are-stripped-from-p_s">
	Comments are stripped from P_S
    </a>
</h1>
<p>Let&rsquo;s try comments first.
The <a href="https://dev.mysql.com/doc/refman/8.0/en/comments.html" target="_blank" rel="noopener">manual knows</a>

 three kinds of comments in MySQL:</p>
<ul>
<li><code>/* ... */</code> C-like comments.</li>
<li><code># ...</code> Shell-like comments.</li>
<li><code>-- ...</code> Not quite SQL-like comments.</li>
</ul>
<p>With preserved comments I could put identifying information into the query string, and later extract it from P_S.
I could use this information to attribute the query and link it to its origin in code.</p>
<p>In one connection, I issue</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8025</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="n">msandbox</span><span class="err">}</span><span class="w"> </span><span class="p">(</span><span class="n">kris</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="cm">/* keks */</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="n">m</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">8192</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>The result set is irrelevant, but I put a comment with <code>/* ... */</code> into the query string.</p>
<p>In P_S, I find</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8025</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="n">msandbox</span><span class="err">}</span><span class="w"> </span><span class="p">(</span><span class="n">performance_schema</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">sql_text</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">events_statements_history</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">thread_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">event_id</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">sql_text</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>The comment has been stripped, you can still see the double spaces.</p>
<p>Old-fashioned SQL comments and shell comments seem to die already in the client:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8025</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="n">msandbox</span><span class="err">}</span><span class="w"> </span><span class="p">(</span><span class="n">kris</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="c1">-- keks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">3</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8025</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="n">msandbox</span><span class="err">}</span><span class="w"> </span><span class="p">(</span><span class="n">kris</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="k">cursor</span><span class="w"> </span><span class="n">up</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8025</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="n">msandbox</span><span class="err">}</span><span class="w"> </span><span class="p">(</span><span class="n">kris</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>The same happens with Shell comments: Of course, again, the comment is not in P_S.</p>
<p>It is unclear why comments are stripped, and where.
Maybe it is a vestige from the statement conditioning that was installed as a pre-stage to the late query cache, bless its rotten soul.</p>
<p>There seem to be two mechanisms, one for SQL and Shell comments, and one for C comments:
When looking at the client history, the Shell and SQL  comments are not recalled by the editor, but the C comment is.</p>
<p>This difference in treatment makes some sense, because MySQL uses magic C comments to control statement parsing for compatibility: <code>SELECT /*! 80000 NEW_KEYWORD */</code> is parsed as a <code>SELECT</code> by MySQL before version 8.0.0 and as <code>SELECT NEW_KEYWORD</code> by MySQL 8.0.0 and higher. This allows <code>mysqldump</code> and other programs to emit SQL code that degrades gracefully on older versions of MySQL.</p>
<p>Similar syntax, <code>/*+ ...*/</code> is used to control optimizer hints.</p>
<h1 id="new-query-attributes">
    <a href="#new-query-attributes">
	New: Query attributes
    </a>
</h1>
<p>Query Attributes are a newfangled thing (8.0.23 or newer) that allow a client to annotate a query.
The annotations are preserved in the server and are being made available in some contexts, but they do nothing.</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/query-attributes.html" target="_blank" rel="noopener">The manual</a>

 explains this:</p>
<ul>
<li>Attributes are defined prior to sending a statement.</li>
<li>They exist until the statement ends.</li>
<li>While they exist, they can be accessed on the server side.</li>
</ul>
<p>The examples given are exactly my use-case:
Transporting identifying information from the client into the server, or injecting control information for a plugin from the client into the server in order to affect query processing in the server.</p>
<p>Query Attributes do nothing in the server.
The server does not look at them.</p>
<p>Query Attributes are supported by the C-API client and the MySQL command line client.
Not much support exists elsewhere, yet.</p>
<p>The basic exercise to check functions works:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8025</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="n">msandbox</span><span class="err">}</span><span class="w"> </span><span class="p">(</span><span class="n">mysql</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">INSTALL</span><span class="w"> </span><span class="n">COMPONENT</span><span class="w"> </span><span class="s2">&#34;file://component_query_attributes&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8025</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="n">msandbox</span><span class="err">}</span><span class="w"> </span><span class="p">(</span><span class="n">mysql</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">query_attributes</span><span class="w"> </span><span class="n">n1</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="n">n2</span><span class="w"> </span><span class="n">v3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="w"> </span><span class="p">[</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8025</span><span class="p">]</span><span class="w"> </span><span class="err">{</span><span class="n">msandbox</span><span class="err">}</span><span class="w"> </span><span class="p">(</span><span class="n">mysql</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">mysql_query_attribute_string</span><span class="p">(</span><span class="s1">&#39;n1&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;attr 1&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">mysql_query_attribute_string</span><span class="p">(</span><span class="s1">&#39;n2&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;attr 2&#39;</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">mysql_query_attribute_string</span><span class="p">(</span><span class="s1">&#39;n3&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s1">&#39;attr 3&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------+--------+--------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">attr</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------+--------+--------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">v2</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">v3</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------+--------+--------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>The plugin component is also visible in memory map of <code>mysqld</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@server:~$ grep query_attr /proc/94982/maps
</span></span></span><span class="line"><span class="cl"><span class="go">7f7590f5b000-7f7590f5c000 r--p 00000000 fd:00 221893305                  /home/kris/opt/mysql/8.0.25/lib/plugin/component_query_attributes.so
</span></span></span><span class="line"><span class="cl"><span class="go">7f7590f5c000-7f7590f5d000 r-xp 00001000 fd:00 221893305                  /home/kris/opt/mysql/8.0.25/lib/plugin/component_query_attributes.so
</span></span></span><span class="line"><span class="cl"><span class="go">7f7590f5d000-7f7590f5e000 r--p 00002000 fd:00 221893305                  /home/kris/opt/mysql/8.0.25/lib/plugin/component_query_attributes.so
</span></span></span><span class="line"><span class="cl"><span class="go">7f7590f5e000-7f7590f5f000 r--p 00002000 fd:00 221893305                  /home/kris/opt/mysql/8.0.25/lib/plugin/component_query_attributes.so
</span></span></span><span class="line"><span class="cl"><span class="go">7f7590f5f000-7f7590f60000 rw-p 00003000 fd:00 221893305                  /home/kris/opt/mysql/8.0.25/lib/plugin/component_query_attributes.so
</span></span></span></code></pre></div><h1 id="where-to-go-from-here">
    <a href="#where-to-go-from-here">
	Where to go from here?
    </a>
</h1>
<p>I can generate a query in a client I control, and annotate the query with identifying information.
In my case this information will be</p>
<ul>
<li>A trace flag. If the query is to be traced, the trace flag will be present. The default is: The query will not be traced.</li>
<li>A set of three identifiers (alphanumeric strings: sha256 MACs, UUIDs or strings representing integer numbers). They are a root id, a parent id and a query id. These identifiers allow me to model a span/parent span relationship in a larger tracing context.</li>
</ul>
<p>I need to find a hook in the server for a plugin.
The plugin must run after query execution, but with the execution plan, the query string and the P_S data for the query still present.
I am not yet familiar with this, and need to check the current server about what is on offer.
Maybe the hook that the audit plugin uses can be repurposed.</p>
<p>If the trace flag is set, it will need to access</p>
<ul>
<li>the query attributes</li>
<li>the query plan that ran, if possible (Need to check what <code>EXPLAIN FOR CONNECTION</code> does)</li>
<li>the information about the query execution that can be gathered from P_S data</li>
</ul>
<p>It needs to transform this information into a single serialized form, for example a JSON string, and then exfiltrate this in a way that does not block the server.</p>
<p>The generic way to do this in my environment has in the past been to send a UDP packet to localhost.
UDP to localhost is considered non-lossy, limited to 64K and dropping the data if the listener is not present.
A file write to an append-only file may also write, if there is a rotation/truncation mechanism.</p>
<p>I will then need to take the JSON in my client, transform it some more and send it to a tracing consumer, e.g. Jaeger, Lightstep, or in my case, Honeycomb.</p>
<p>The trace data will there be joined with spans from other components, including spans around the ORM that made the SQL and the code that called into the ORM.
This will allow to view the context of the query without having to grep for it, use modern web tools to analyze query execution in the context that generated it and generally unify SQL debugging with other application debugging.</p>
<p>This makes the need for specialized &ldquo;Database Performance Monitoring&rdquo; (DPM) software go away, at least for individual developers.
A DPM can still be useful for operational tasks, but these are usually served by telegrams MySQL collector, Prometheus and Grafana just fine (and these usually scale better than a DPM).</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2021-09-17-binding-the-orm.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/09/15/mysql-tracing-a-single-query-with-performanceschema.html">MySQL: Tracing a single query with PERFORMANCE_SCHEMA</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/09/27/mysql-booking-2010-a-hiring-interview-question.html">MySQL: Our MySQL in 2010, a hiring interview question</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
