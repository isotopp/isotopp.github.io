<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Page compression revisited | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2021/09/14/mysql-page-compression-revisited.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Page compression revisited | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2021/09/14/mysql-page-compression-revisited.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2021-09-14T16:03:47Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Page compression revisited' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-page-compression-revisited-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Page compression revisited
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>September 14, 2021</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/09/10/create-if-not-exists.html">MySQL: CREATE IF NOT EXISTS TABLE, but CREATE OR REPLACE VIEW</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/09/15/mysql-tracing-a-single-query-with-performanceschema.html">MySQL: Tracing a single query with PERFORMANCE_SCHEMA</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Like I said, I never had much reason to use table compression, and only recently looked into the topic.
MySQL Page Compression looks a lot easier at the database end of things, but relies on hole punching support in the file system.
Let&rsquo;s have a look at what that means.</p>
<h1 id="files-inodes-and-arrays-of-blocks">
    <a href="#files-inodes-and-arrays-of-blocks">
	Files, Inodes and Arrays of Blocks
    </a>
</h1>
<p>The original Unix filesystem saw the disk as a sea of blocks, which were represented in a free map as an array of bits.
Files have numbers, which are an index into an array of so-called inode structures.
Inodes store the files metadata and contain an array of block numbers, which make up the actual file.
The array is folded multiple times, to optimize for the more common case of small files:
The first few block numbers were stored in the inode, followed by a pointer to a block containing file block numbers, then a pointer to a block containing pointers to blocks of file block numbers and so on.</p>
<p><p class="md__image">
  <img src="/uploads/2021/09/filestructure.png" alt=""  />
</p>

</p>
<p><em>The block list inside an array is folded multiple times, to optimize for the more common case of small files.</em></p>
<p>These structures make up the so-called lower filesystem, which deals with organizing blocks into numbered files efficiently.
On top of that resides the upper filesystem, which is concerned with managing names of files, and organizing them into directories.
In our instance the upper filesystem is of no interest, so we are ignoring it completely:
To us files are sequences of blocks, organized in inodes.</p>
<p>While the folded block array of the original file system served us for many decades, more modern file systems try to shrink these block lists by storing extents.
An extent is a pair (start, length) that describes a  contiguous sequence of blocks.
On a mostly empty disk, most files can probably be arranged in such runs of contiguous blocks, so this is a more efficient way to store things.
Also, free lists can in many cases be stored more efficiently as extents.</p>
<p>The XFS filesystem is getting a lot of mileage of such extents, and one major a difference between the Linux ext3 and ext4 is the use of extents instead of block lists and bitmaps in many places.</p>
<h1 id="sparse-files">
    <a href="#sparse-files">
	Sparse Files
    </a>
</h1>
<p>Unix always allowed you to seek past the end of a file and write data.
The following example program creates a file named <code>testfile</code> by opening a new file of length 0, seeking to the position 20 GB and writing an integer at that position.
The resulting file is 20 GB in length, but only occupies a minuscule amount of disk space.
This is called a <em>sparse file</em>, a file with holes in it.</p>
<p>Reading a sparse file, the non-existent blocks are returned as blocks filled with zeroes.
On writing, space is allocated for the previously unallocated blocks in the sparse file, but probably not in sequence.
So on hard disks, a seek occurs that would probably not have occurred, had the file actually been written properly.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">kris</span><span class="err">@</span><span class="nl">server</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">cat</span> <span class="n">sparseme</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/* 20 GB */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define FAR_OUT ((long) 20*1024*1024*1024)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">something</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* trunate to 0, or create, position 0 */</span>
</span></span><span class="line"><span class="cl">        <span class="n">fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;testfile&#34;</span><span class="p">,</span> <span class="s">&#34;w&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Cannot open &#39;testfile&#39;, I die.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* move to far out position */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">FAR_OUT</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* write something */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fwrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">something</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">something</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>When looking at this on the disk we can see that in fact only 4 KB of disk space (one block on a modern disk) has been allocated.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@server:~$ cc -o sparseme sparseme.c
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ ./sparseme
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ ls -lsh testfile
</span></span></span><span class="line"><span class="cl"><span class="go">4.0K -rw-rw-r-- 1 kris kris 21G Sep 14 16:37 testfile
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ xfs_bmap -v testfile
</span></span></span><span class="line"><span class="cl"><span class="go">testfile:
</span></span></span><span class="line"><span class="cl"><span class="go"> EXT: FILE-OFFSET           BLOCK-RANGE          AG AG-OFFSET               TOTAL
</span></span></span><span class="line"><span class="cl"><span class="go">   0: [0..41943039]:        hole                                         41943040
</span></span></span><span class="line"><span class="cl"><span class="go">   1: [41943040..41943047]: 104705904..104705911  3 (10334064..10334071)        8
</span></span></span></code></pre></div><p>We compile the C-program with <code>cc -o sparseme sparseme.c</code>, then run it as <code>./sparseme</code>.
We look at the resulting <code>testfile</code> with <code>ls -lsh testfile</code>. The size of the file is shown as 21G, but the allocation (in the leftmost column, we asked for that with the <code>-s</code> flag) is only 4K.</p>
<p>Using the XFS maintenance program <code>xfs_bmap</code> in verbose mode, we get to see the block map (bmap) of the file, as an extent listing. The program operates with sectors of 512 bytes, the unit that was common for many hard disk before we moved to 4K sectors. We see a large hole from offset 0 to 41943039 (times 512 bytes for sector size, this is 20 GB). Then there are 8 sectors (one 4K disk drive hardware block) mapped to 8 contiguous blocks (actually one hardware block) at 104705904 from the start of the partition.</p>
<p>We can do the same thing using a <code>dd</code> command without writing a C-program:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@server:~$ rm testfile testfile2
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ dd if=/dev/zero of=testfile2 bs=1 count=1 seek=21474836480
</span></span></span><span class="line"><span class="cl"><span class="go">1+0 records in
</span></span></span><span class="line"><span class="cl"><span class="go">1+0 records out
</span></span></span><span class="line"><span class="cl"><span class="go">1 byte copied, 0.000227159 s, 4.4 kB/s
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ ls -lsh testfile2
</span></span></span><span class="line"><span class="cl"><span class="go">4.0K -rw-rw-r-- 1 kris kris 21G Sep 14 16:47 testfile2
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ xfs_bmap -v testfile2
</span></span></span><span class="line"><span class="cl"><span class="go">testfile2:
</span></span></span><span class="line"><span class="cl"><span class="go"> EXT: FILE-OFFSET           BLOCK-RANGE          AG AG-OFFSET               TOTAL
</span></span></span><span class="line"><span class="cl"><span class="go">   0: [0..41943039]:        hole                                         41943040
</span></span></span><span class="line"><span class="cl"><span class="go">   1: [41943040..41943047]: 104705904..104705911  3 (10334064..10334071)        8
</span></span></span></code></pre></div><p>Our <code>of=testfile2</code> generates the outfile, and we write one byte (<code>bs=1</code>) one time (<code>count=1</code>) after seeking to position 20G (<code>seek=...</code>).
Using <code>ls -lsh</code> and the <code>xfs_bmap</code> output, we can confirm that this is indeed a file with a hole.</p>
<p>Sparse files are hard to handle:
When you copy them, the non-existent blocks are read as blocks full of 0-bytes, and written.
The target file will therefore actually allocate all the space the source file only claims to be large.</p>
<p>This is a problem with <code>core</code> files in many Unix system, because they are being dumped as sparse files, mapping the actual process address space to file offsets, and leaving unallocated space in the address space at least in part as holes in the file.
Until you naively copy that file, that is.</p>
<p>The GNU <code>cp</code> program has a <code>--sparse</code> option that tries to handle this, and <code>rsync</code> also has special options that make it sparse file aware.</p>
<h1 id="hole-punching">
    <a href="#hole-punching">
	Hole Punching
    </a>
</h1>
<p>Some filesystems allow you to punch holes into files, using the <a href="https://lwn.net/Articles/415889/" target="_blank" rel="noopener"><code>fallocate(2)</code></a>

 system call.
This system call can be used to assign blocks to a file, making sure it is not a sparse file, without actually having to write all those bytes and a few other things.
Using the filesystem dependent <code>FALLOC_FL_PUNCH_HOLE</code> flag, extents in the file can be marked as &lsquo;unused&rsquo; and be given back to the filesystem.</p>
<p>Let&rsquo;s look what our tables from the <a href="/2021/09/09/mysql-two-kinds-of-compression.html">previous article</a>

 look like on disk, using <code>xfs_bmap</code>.</p>
<p>The uncompressed table looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@server:~/sandboxes/msb_8_0_25/data/kris$ xfs_bmap -v keks.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">keks.ibd:
</span></span></span><span class="line"><span class="cl"><span class="go"> EXT: FILE-OFFSET       BLOCK-RANGE          AG AG-OFFSET             TOTAL
</span></span></span><span class="line"><span class="cl"><span class="go">   0: [0..63]:          104752464..104752527  3 (10380624..10380687)     64
</span></span></span><span class="line"><span class="cl"><span class="go">   1: [64..159]:        104753560..104753655  3 (10381720..10381815)     96
</span></span></span><span class="line"><span class="cl"><span class="go">   2: [160..223]:       104744928..104744991  3 (10373088..10373151)     64
</span></span></span><span class="line"><span class="cl"><span class="go">  ...
</span></span></span><span class="line"><span class="cl"><span class="go">  18: [327680..450559]: 126091200..126214079  4 (262080..384959)     122880
</span></span></span><span class="line"><span class="cl"><span class="go">  19: [450560..516095]: 126404568..126470103  4 (575448..640983)      65536
</span></span></span></code></pre></div><p>We get 20 extents, some of which are smaller than 100 sectors, but some of which are larger than 100k sectors of contiguous space.</p>
<p>Now the page compressed file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@server:~/sandboxes/msb_8_0_25/data/kris$ xfs_bmap -v keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">keks2.ibd:
</span></span></span><span class="line"><span class="cl"><span class="go"> EXT: FILE-OFFSET       BLOCK-RANGE          AG AG-OFFSET            TOTAL
</span></span></span><span class="line"><span class="cl"><span class="go">   0: [0..31]:          104756944..104756975  3 (10385104..10385135)    32
</span></span></span><span class="line"><span class="cl"><span class="go">   1: [32..63]:         104757000..104757031  3 (10385160..10385191)    32
</span></span></span><span class="line"><span class="cl"><span class="go">   2: [64..71]:         104709000..104709007  3 (10337160..10337167)     8
</span></span></span><span class="line"><span class="cl"><span class="go">   3: [72..95]:         hole                                            24
</span></span></span><span class="line"><span class="cl"><span class="go">   4: [96..103]:        104709032..104709039  3 (10337192..10337199)     8
</span></span></span><span class="line"><span class="cl"><span class="go">   5: [104..127]:       hole                                            24
</span></span></span><span class="line"><span class="cl"><span class="go">30886: [494440..494463]: hole                                            24
</span></span></span><span class="line"><span class="cl"><span class="go">30887: [494464..494471]: 127160928..127160935  4 (1331808..1331815)       8
</span></span></span><span class="line"><span class="cl"><span class="go">30888: [494472..494495]: hole                                            24
</span></span></span><span class="line"><span class="cl"><span class="go">30889: [494496..516095]: 127160960..127182559  4 (1331840..1353439)   21600
</span></span></span></code></pre></div><p>We get more than 30k extents here, all of them 8 sectors (4K) of data and 24 sectors (12K) of hole in my very compressible test data.
This is messy.</p>
<p>Trying to delete these things demonstrates the cost of this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@server:~$ cp ~/sandboxes/msb_8_0_25/data/kris/keks.ibd .
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ cp --sparse=always ~/sandboxes/msb_8_0_25/data/kris/keks2.ibd .
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ time rm keks.ibd
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">real    0m0.020s
</span></span></span><span class="line"><span class="cl"><span class="go">user    0m0.000s
</span></span></span><span class="line"><span class="cl"><span class="go">sys     0m0.020s
</span></span></span><span class="line"><span class="cl"><span class="go">kris@server:~$ time rm keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">real    0m0.123s
</span></span></span><span class="line"><span class="cl"><span class="go">user    0m0.000s
</span></span></span><span class="line"><span class="cl"><span class="go">sys     0m0.109s
</span></span></span></code></pre></div><p>With longer files, we get more holes, more overhead and even longer times.</p>
<h1 id="file-size-over-time">
    <a href="#file-size-over-time">
	File Size over Time
    </a>
</h1>
<p>While running <code>insert into keks2 select * from keks</code>, I was monitoring the size of the new table at the file system level.
This looks funny, because we can see the file&rsquo;s allocation growing over time, but there are downward spikes in allocation every few seconds.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@server:~/sandboxes/msb_8_0_25$ while :
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">&gt;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span> ls -lsh data/kris/keks2*
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span> sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="go">197M -rw-r----- 1 kris kris 524M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">200M -rw-r----- 1 kris kris 532M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">203M -rw-r----- 1 kris kris 540M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">205M -rw-r----- 1 kris kris 548M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">208M -rw-r----- 1 kris kris 556M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">212M -rw-r----- 1 kris kris 564M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">207M -rw-r----- 1 kris kris 564M Sep 14 19:09 data/kris/keks2.ibd  &lt;---
</span></span></span><span class="line"><span class="cl"><span class="go">209M -rw-r----- 1 kris kris 572M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">212M -rw-r----- 1 kris kris 580M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">216M -rw-r----- 1 kris kris 588M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">215M -rw-r----- 1 kris kris 588M Sep 14 19:09 data/kris/keks2.ibd  &lt;---
</span></span></span><span class="line"><span class="cl"><span class="go">218M -rw-r----- 1 kris kris 592M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">212M -rw-r----- 1 kris kris 592M Sep 14 19:09 data/kris/keks2.ibd  &lt;---
</span></span></span><span class="line"><span class="cl"><span class="go">219M -rw-r----- 1 kris kris 604M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">223M -rw-r----- 1 kris kris 612M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">226M -rw-r----- 1 kris kris 620M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">225M -rw-r----- 1 kris kris 624M Sep 14 19:09 data/kris/keks2.ibd  &lt;---
</span></span></span><span class="line"><span class="cl"><span class="go">228M -rw-r----- 1 kris kris 632M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">227M -rw-r----- 1 kris kris 636M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">225M -rw-r----- 1 kris kris 640M Sep 14 19:09 data/kris/keks2.ibd  &lt;---
</span></span></span><span class="line"><span class="cl"><span class="go">233M -rw-r----- 1 kris kris 652M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span><span class="line"><span class="cl"><span class="go">232M -rw-r----- 1 kris kris 656M Sep 14 19:09 data/kris/keks2.ibd
</span></span></span></code></pre></div><p>The size of these downward spikes (several megabytes in some instances) is impressive.</p>
<h1 id="implications-for-mysql">
    <a href="#implications-for-mysql">
	Implications for MySQL
    </a>
</h1>
<p>Page Compression was introduced to MySQL in 2015, and Mark Callaghan has been experimenting from early on.
He has a series of blog articles on this:</p>
<ul>
<li><a href="http://smalldatum.blogspot.com/2015/10/wanted-file-system-on-which-innodb.html" target="_blank" rel="noopener">Wanted Wanted: a file system on which InnoDB transparent page compression works</a>

</li>
</ul>
<p>and earlier</p>
<ul>
<li><a href="http://smalldatum.blogspot.com/2015/08/first-day-with-innodb-transparent-page.html" target="_blank" rel="noopener">First day with InnoDB transparent page compression</a>

</li>
<li><a href="http://smalldatum.blogspot.com/2015/09/second-day-with-innodb-transparent-page.html" target="_blank" rel="noopener">Second day with InnoDB transparent page compression</a>

</li>
<li><a href="http://smalldatum.blogspot.com/2015/09/third-day-with-innodb-transparent-page.html" target="_blank" rel="noopener">Third day with InnoDB transparent page compression</a>

</li>
</ul>
<p>and being Mark, he also has a series of bugs open on this.
The links are in the articles.</p>
<p>The &ldquo;Wanted&rdquo; article from the list above contains a number of very recent, very relevant comments by Marko Mäkelä, and a link to <a href="https://lwn.net/Articles/864363" target="_blank" rel="noopener">LWN: Hole-punching races against page-cache filling</a>

, from July 29, 2021.
This bug is still open in all production Linux kernels.</p>
<p>This seems to make using Page Compression a risky and expensive thing. Mark&rsquo;s estimate in private communication was approximately &ldquo;a thing such as RocksDB which never overwrites data has an inherent advantage  over anything that does in-place updates when it comes to compression&rdquo; (my summary of his words), and I think he&rsquo;s correct.</p>
<p>Seems I accidentally did a few things right when I never even tried to use compressed tables in InnoDB.</p>
<h1 id="thanks">
    <a href="#thanks">
	Thanks
    </a>
</h1>
<p>Thanks, Mark, for you very useful and insightful comments, and for nudging me to go deeper on this.
And thanks for necro&rsquo;ing Marks articles with your comments, Marko!</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2021-09-14-mysql-page-compression-revisited.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/09/10/create-if-not-exists.html">MySQL: CREATE IF NOT EXISTS TABLE, but CREATE OR REPLACE VIEW</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/09/15/mysql-tracing-a-single-query-with-performanceschema.html">MySQL: Tracing a single query with PERFORMANCE_SCHEMA</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
