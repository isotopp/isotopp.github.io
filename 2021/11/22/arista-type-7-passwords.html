<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Arista Type 7 Passwords | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2021/11/22/arista-type-7-passwords.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Arista Type 7 Passwords | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2021/11/22/arista-type-7-passwords.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2021-11-21T17:29:00&#43;01:00' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/schloss.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Arista Type 7 Passwords' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/schloss.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="arista-type-7-passwords-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Arista Type 7 Passwords
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>November 22, 2021</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/schloss.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/11/16/a01-2021-broken-access-control.html">A01:2021 - Broken Access Control</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/11/24/mysql-moving-average.html">MySQL: Moving Average</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>A friend of mine wanted to provision BGP passwords for their Arista switch configuration.</p>
<p>So a config stanza such as</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">router bgp 65001
</span></span></span><span class="line"><span class="cl"><span class="go">   router-id 10.1.1.1
</span></span></span><span class="line"><span class="cl"><span class="go">   neighbor mydevices peer-group
</span></span></span><span class="line"><span class="cl"><span class="go">   neighbor mydevices password 7 8kjYaye5DsQh0epELyKNe0oZ3E3zp39X
</span></span></span></code></pre></div><p>requires generation of the Password (actually &ldquo;supersecretpassword&rdquo;) in an encrypted form.</p>
<p>Arista switches can do this using CLI tools, apparently.
They seem to have an onboard Linux, which seems to provide limited tooling, but is good enough to run a 32-bit Python 3.7.
Arista provides modules to help with handling their configuration.
<a href="https://medium.com/@what_if/encrypting-decrypting-arista-bgp-bmp-ospf-passwords-ff2072460942" target="_blank" rel="noopener">Ryan Gelobter</a>


documented these in an article on Medium.</p>
<p>Unfortunately, these modules are not well portable.
They have been implemented in a CPython module for Python 3.7 on i386 (32bit) Linux.
They also have a lot of dependencies to other shared objects that are not easily available except in the switch environment.</p>
<p>So, if you wanted to provision switch configurations,
you would need to run some code on the switch to generate the passwords the way Ryan Gelobter documents,
or do the same in a virtual machine with a virtual switch running in it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">switch1# bash python -c &#39;import DesCrypt;
</span></span></span><span class="line"><span class="cl"><span class="go">print DesCrypt.encrypt(&#34;BMP1_passwd&#34;, &#34;supersecretpassword&#34;)&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">JieKbldfLyl9IzUBJZRvKIcc1w5wWogI
</span></span></span></code></pre></div><p>Looking at the <code>DesCrypt.py</code> is not particularly helpful:
The code in it does little more than</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">_DesCrypt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">encryptedData</span> <span class="o">=</span> <span class="n">_DesCrypt</span><span class="o">.</span><span class="n">cbcEncrypt</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span></code></pre></div><p>and <code>_DesCrypt</code> is actually <code>_Descrypt.cpython-37m-i386-linux-gnu.so</code>.
Well, at least it is only 10 KB in size, so how hard can it be?</p>
<p>Let&rsquo;s have a look:</p>
<h1 id="ghidra">
    <a href="#ghidra">
	Ghidra
    </a>
</h1>
<p>When we drop the module into Ghidra, we get to see a <code>PyInit__DesCrypt(void)</code> symbol.
The code in that function just calls out to <code>PyModuleCreate2(&amp;PyModuleDef, 0x3f5)</code>.</p>
<p>Looking at the <code>PyModuleDef</code> requires <a href="https://docs.python.org/3/c-api/module.html" target="_blank" rel="noopener">the documentation</a>

 to properly understand what is going on.
We identify two functions, <code>cbcEncrypt</code> and <code>cbcDecrypt</code> by their <a href="https://docs.python.org/3/c-api/structures.html#c.PyMethodDef" target="_blank" rel="noopener"><code>PyMethodDef</code></a>

 entries.
Two labels for entry points in a stripped binary identified.</p>
<p><p class="md__image">
  <img src="/uploads/2021/11/arista-pymethoddef.png" alt=""  />
</p>

</p>
<p><em>The Python Method Definition Table for the _DesCrypt Module defines two functions, named <code>cbcEncrypt</code> and <code>cbcDecrypt</code>.</em></p>
<p>Looking at the <code>cbcEncrypt</code> function shows us that it has a dependency on <code>cbc_crypt()</code>,
and that seems to be a function from <code>libc</code>, according to <a href="https://linux.die.net/man/3/cbc_crypt" target="_blank" rel="noopener">the manpage</a>

.
So it is ancient DES, in CBC mode that is being used.
We should be able to do this in pure Python without many additional dependencies then.</p>
<p>Using Ghidra more, we can decode <code>cbcEncrypt()</code> and the <code>getHashedKey()</code> function it calls.</p>
<p><code>getHashedKey</code> generates the key the usual way, by xor-ing the incoming string with itself in an 8 bytes long ring buffer, but the starting value is not all zeroes, but some magic value (<code>238ad5f51ec9a8d5</code>)</p>
<p>Also, <code>cbcEncrypt</code> pads the data to an even 8 byte boundary as required by DES.
How much was padded needs to be embedded in the ciphertext.
There is a selection of standard methods for this, as offered for example by
<a href="https://pycryptodome.readthedocs.io/en/latest/src/util/util.html#Crypto.Util.Padding.pad" target="_blank" rel="noopener">Crypto.Util.Padding.pad()</a>


in pycryptodome (&ldquo;pkcs7&rdquo;, &ldquo;iso7816&rdquo; and &ldquo;x923&rdquo;).</p>
<p><code>cbcEncrypt</code> uses none of these standard methods, and implements its own method:
the padding is encoded in the high nibble of a fixed magic int.</p>
<p>That magic int is always prepended, even if no padding was necessary:
We get <code>?ebb884c</code>, with <code>?</code> indicating the number of padbytes (<code>0</code> to <code>7</code>).</p>
<p><p class="md__image">
  <img src="/uploads/2021/11/arista-gethashedkey.png" alt=""  />
</p>

</p>
<p><em>Ghidra Output of the getHashedKey() function, with a bit of annotation and typing added to get a better view.</em></p>
<p>With this information, we should be able to recreate the function in our own C-code and check if it can recreate the examples Ryan Gelobter provided.</p>
<p>Of course, it does not.</p>
<h1 id="debugging-the-original-code">
    <a href="#debugging-the-original-code">
	Debugging the original code
    </a>
</h1>
<p>We need to debug, and in order to be able to do that we need to be able to load and isolate <code>getHashedKey()</code> first.
The original version, to check what the actual hashed key should look like, and compare the result to our own.</p>
<p>That should be easy:
An example
<a href="/2005/10/08/dynamisch-geladener-code.html">from 2005</a>


(german language article) shows</p>
<ul>
<li>how to turn a function into a <code>libsomething.a</code>,</li>
<li>then into <code>libsomething.so</code>, and</li>
<li>then how to <code>dlopen()</code> and <code>dlsym()</code> that binary to call a single function in it.</li>
</ul>
<p>That final piece of code will serve us well:
We want to load the _DesCrypt module and call <code>getHashedKey()</code> in an isolated context to see what a correct return value looks like.</p>
<h1 id="dependencies">
    <a href="#dependencies">
	Dependencies
    </a>
</h1>
<p>Turns out, loading <code>_DesCrypt...so</code> is not so easy, because of a dependency on <code>libtac.so.0</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ldd _DesCrypt.cpython-37m-i386-linux-gnu.so
</span></span><span class="line"><span class="cl"><span class="go">        linux-gate.so.1 (0xf7f7c000)
</span></span></span><span class="line"><span class="cl"><span class="go">        libtac.so.0 =&gt; not found
</span></span></span><span class="line"><span class="cl"><span class="go">        libpython3.7m.so.1.0 =&gt; not found
</span></span></span><span class="line"><span class="cl"><span class="go">        libstdc++.so.6 =&gt; /lib32/libstdc++.so.6 (0xf7d81000)
</span></span></span><span class="line"><span class="cl"><span class="go">        libm.so.6 =&gt; /lib32/libm.so.6 (0xf7c7d000)
</span></span></span><span class="line"><span class="cl"><span class="go">        libgcc_s.so.1 =&gt; /lib32/libgcc_s.so.1 (0xf7c5e000)
</span></span></span><span class="line"><span class="cl"><span class="go">        libc.so.6 =&gt; /lib32/libc.so.6 (0xf7a73000)
</span></span></span><span class="line"><span class="cl"><span class="go">        /lib/ld-linux.so.2 (0xf7f7e000)```
</span></span></span></code></pre></div><p>So we are missing two libraries:</p>
<ul>
<li><code>libpython3.7m.so.1.0</code> and</li>
<li><code>libtac.so.0</code>.</li>
</ul>
<p>The Python bit is fixed by building a Python-3.7 in 32-bit:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> apt install gcc-multilib
</span></span><span class="line"><span class="cl"><span class="gp">$</span> wget https://www.python.org/ftp/python/3.7.5/Python-3.7.5.tgz
</span></span><span class="line"><span class="cl"><span class="gp">$</span> tar xzf Python-3.7.5.tgz
</span></span><span class="line"><span class="cl"><span class="gp">$</span> <span class="nb">cd</span> Python-3.7.5/
</span></span><span class="line"><span class="cl"><span class="gp">$</span> ./configure --build<span class="o">=</span>i686-pc-linux-gnu <span class="nv">CFLAGS</span><span class="o">=</span>-m32 <span class="nv">CXXFLAGS</span><span class="o">=</span>-m32 <span class="nv">LDFLAGS</span><span class="o">=</span>-m32 --enable-shared
</span></span><span class="line"><span class="cl"><span class="gp">$</span> make -j6
</span></span></code></pre></div><p>A minor roadbump: We need to build for 32-bit, but on a 64-bit machine.
The compile-flag <code>-m32</code> does that, but it will fail due to some missing includes until we install <code>gcc-multilib</code> as shown above.
We can then download the old version of Python, and build it with the required flags for 32-bit support.</p>
<p>The <code>libtac.so.0</code> we could copy off the switch.
If we try, things escalate quickly .
That is, because that <code>.so</code> in turn loads even more libraries, most of which we don&rsquo;t have access to.
And if we had them, they might load even more dependencies.</p>
<p>Looking into Ghidra again, we know that the code we are interested in does not really depend on <code>libtac,so.0</code>.
<code>cbcEncrypt()</code> itself does, but only if something goes wrong and an exception is being raised,
but at this stage of our investigation we only want <code>getHashedKey()</code>.</p>
<p>Following the guide from 16 years ago, we can quickly write some code to <code>dlopen()</code> the library:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span> <span class="kt">func_t</span><span class="p">)(</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;mydevices_passwd&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span>   <span class="n">keylen</span> <span class="o">=</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span>  <span class="n">data</span><span class="p">[</span><span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;supersecretpassword&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="kt">func_t</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">error_msg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">libhandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;main start</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="n">libhandle</span> <span class="o">=</span> <span class="nf">dlopen</span><span class="p">(</span><span class="n">LIBNAME</span><span class="p">,</span> <span class="n">RTLD_LAZY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">libhandle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;dlopen(%s, RTLD_LAZY) failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">LIBNAME</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nf">dlerror</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="c1">// find func
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">error_msg</span> <span class="o">=</span> <span class="nf">dlerror</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="nf">dlsym</span><span class="p">(</span><span class="n">libhandle</span><span class="p">,</span> <span class="s">&#34;_Z12getHashedKeyPKciPc&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">error_msg</span> <span class="o">=</span> <span class="nf">dlerror</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">error_msg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;dlsym(%p, </span><span class="se">\&#34;</span><span class="s">getHashedKey</span><span class="se">\&#34;</span><span class="s"> failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">libhandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">error_msg</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;gethashedKey %p</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="nf">f</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dump</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dump</span><span class="p">(</span><span class="s">&#34;data&#34;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">80</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dlclose</span><span class="p">(</span><span class="n">libhandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="killing-dependencies">
    <a href="#killing-dependencies">
	Killing Dependencies
    </a>
</h1>
<p>That way we can inspect the output of the function (it overwrites the first 8 bytes of <code>data</code>) and get a reference key value to debug against.
Or could, if that would work.
It does not, because the <code>.so</code> we open still has listed <code>libtac.so.0</code> as <code>NEEDED</code> and we need to fix it.</p>
<p>There are many ways to edit ELF binaries, but most are badly maintained.
An easy way is a web service such as <a href="https://elfy.io/" target="_blank" rel="noopener">elfy.io</a>

.
We upload the library, click <code>Load information</code> -&gt; <code>Loader directives</code> and edit the first dependency (<code>libtac.so.0</code>) (offset 0x270) to point to the second dependency (<code>libpython3.7m.so.1.0</code> (offset 0x283) instead.
Downloading the code again, we can rename it to <code>libtest.so</code> and load it with our test program from above, getting a reference key value.
So <code>mydevices_passwd</code> in a non-broken implementation yields the raw key value of <code>4A 0E 5D 1A 70 4F 1F 23</code> for DES.</p>
<p>Having that, debugging can continue.
It turns out: math is hard and Intel is a little-endian architecture:
The seed byte sequence <code>D5 A8 ... 8A 23</code> is of course the long <code>238A…A8D5</code>.
I am definitively not doing these things often enough anymore to not make this kind of mistake.</p>
<h1 id="progress">
    <a href="#progress">
	Progress!
    </a>
</h1>
<p>Having a working <code>getHashedKey()</code> we can now look at <code>cbcEncrypt()</code> and reverse that.</p>
<p><p class="md__image">
  <img src="/uploads/2021/11/arista-cbcencrypt.png" alt=""  />
</p>

</p>
<p><em>The heart of <code>cbcEncrypt()</code> fetches two Python <code>bytearray</code>, <code>key</code> and <code>data</code> and works with them. The <code>key</code> is processed with <code>getHashedKey()</code>, then <code>cbc_crypt()</code> is set up and called. The result returned to Python using <code>Py_BuildValue</code>.</em></p>
<p>The moment we try to build this in C, it proves frustrating again:
<code>cbc_crypt()</code> is no longer part of <code>libc</code>.
It is outdated, legacy, but unfortunately still in use.
Not only by Arista, but also other companies and protocols.
Among them some ancient RPC protocols.
It has been removed from <code>libc</code> and moved to <code>libtirpc3</code>, it seems.
We need to install <code>libtirpc3</code>, <code>libtirpc-dev</code> and <code>libtirpc-common</code> to be able to build code that calls <code>cbc_crypt()</code>.
Even then we seem to be limited to static linking, because for some reason the shared objects do no longer export the symbol.</p>
<p>Some more short short hiccups:</p>
<ul>
<li>The padding value is a nibble, not a byte, and the long it is part of has to be little endian naturally.</li>
<li>The padding needs itself to take the 4 bytes added by the padding itself into account.</li>
</ul>
<p>In the end we get code that reproduces the expected result.</p>
<h1 id="in-python">
    <a href="#in-python">
	In Python
    </a>
</h1>
<p>If, and that is important, <code>des_parity()</code> is being called.
In Python that function is not available, and should not be necessary:
The legacy DES function in Python&rsquo;s module supposedly ignores DES parity bits automatically.</p>
<p>But the Python code produces a different result.
So what goes on here, and how do we get <code>des_parity()</code>?</p>
<p>Turns out, <code>des_parity()</code> is really weird code:
Look at it <a href="https://github.com/alisw/libtirpc/blob/master/src/des_soft.c#L33-L50" target="_blank" rel="noopener">here</a>

.
It is supposed to make the 8 bytes of the DES code uneven parity by manipulating the low-value bits in the key.
But the actual code also effectively masks out the high order bit, so we do not get 56 bit of keyspace, but only 48 bit.
Yay, export crypto?</p>
<p>Anyway, this is the code Arista runs for their key obfuscation, so we need to duplicate it to produce correct data.</p>
<p><a href="https://github.com/isotopp/arista_type_7/blob/main/pypoc.py" target="_blank" rel="noopener">Here</a>

 is a PoC in Python.</p>
<p>With the poc provided, it should be possible to</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">arista_descrypt</span> <span class="kn">import</span> <span class="n">cbc_encrypt</span><span class="p">,</span> <span class="n">cbc_decrypt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">encrypted</span> <span class="o">=</span> <span class="n">cbc_encrypt</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;mydevices_passwd&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;supersecretpassword&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">encrypted</span><span class="p">)</span>
</span></span></code></pre></div><p>and that should be sufficient to build an Ansible module for Arista config provisioning.
The code uses <code>cryptography</code> or <code>pycryptodome</code> automatically, one of the two is installed.
It is not dependent on the legacy <code>cbc_crypt()</code> function that formerly was in <code>libc</code>.</p>
<h1 id="generating-passphrases">
    <a href="#generating-passphrases">
	Generating passphrases
    </a>
</h1>
<p>Encrypting and decrypting BGP passwords requires a passphrase. In EOS,
this passphrase is not static, but depends on the neighbor where the
BGP password is configured.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">router bgp 65001
</span></span></span><span class="line"><span class="cl"><span class="go">   router-id 10.1.1.1
</span></span></span><span class="line"><span class="cl"><span class="go">   neighbor mydevices peer-group
</span></span></span><span class="line"><span class="cl"><span class="go">   neighbor mydevices password 7 8kjYaye5DsQh0epELyKNe0oZ3E3zp39X
</span></span></span></code></pre></div><p>The passphrase is generated by taking the string after <code>neighbor</code> (in this
example <code>mydevices</code>), and appending the string <code>_passwd</code> to it. The string
can be the name of a peer group, an IPv4 address or an IPv6 address, and
has to be used as shown in the device configuration output. This is particularly
important for IPv6 addresses which have multiple forms of representation.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#security" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				security
				</a>
				
				<a href="/tags/#hack" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				hack
				</a>
				
				<a href="/tags/#networking" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				networking
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2021-11-22-arista-type-7-passwords.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/11/16/a01-2021-broken-access-control.html">A01:2021 - Broken Access Control</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/11/24/mysql-moving-average.html">MySQL: Moving Average</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
