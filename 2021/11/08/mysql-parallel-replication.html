<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Parallel Replication | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2021/11/08/mysql-parallel-replication.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Parallel Replication | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2021/11/08/mysql-parallel-replication.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2021-11-08T13:28:27&#43;01:00' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Parallel Replication' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-parallel-replication-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Parallel Replication
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>November 8, 2021</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/11/07/this-blog-is-now-hugo-powered.html">This Blog is now Hugo powered</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/11/08/amd-und-128-cores.html">AMD und 128 cores</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>At work, <a href="/2020/11/27/backups-and-replication.html">replication</a>

 is a central feature in our MySQL Standard Architecture.</p>
<p>But until MySQL 5.6, replication was strictly sequential:
Even if transactions happened in parallel on a primary, they would be downloaded to the replica by the IO_THREAD into the relay log.
From there, a single SQL_THREAD would apply them, one after the other in strict binlog order.
That can lead to Replication Delay.</p>
<p>We had a monitor for that, <a href="/2012/09/28/mysql-replication-load-monitor.html">courtesy of Dennis Kaarsemaker</a>

.
That code looked at the time consumption in the SQL_THREAD, and counted the percentage of idle time over time, visualizing it in Graphite or Grafana.</p>
<p>This was the amount of runway we had.
If the write-load to a specific replication hierarchy threatened to overwhelm a hierarchy, it was a candidate for a schema split.</p>
<h1 id="execution-model">
    <a href="#execution-model">
	Execution Model
    </a>
</h1>
<p>About a decade ago, MySQL as a company started to work on that problem.
The execution part of that is easy, and roughly looks like this:</p>
<p><p class="md__image">
  <img src="/uploads/2021/11/parallel-replication.jpg" alt=""  />
</p>

</p>
<p>As before, the IO_THREAD logs into the primary and downloads the binlog, then saves it to the local disk of the replica.
This is called the relay log.</p>
<p>Unlike before, the single SQL_THREAD is replaced with a coordinator thread which picks up the relay log for consumption.
It then schedules work to a number of worker threads.
These apply the binlog to local tables in parallel.</p>
<p>The complicated part is to find what can be executed in parallel.
This happens in the Primary, which will mark up the binlog for parallel execution on the replicas.</p>
<h1 id="splitting-the-work-by-schema">
    <a href="#splitting-the-work-by-schema">
	Splitting the work by schema
    </a>
</h1>
<p>The low-hanging fruit is splitting work by schema.
We assume there are different schemata <code>a</code>, <code>b</code>, <code>c</code>, <code>d</code> on the Primary, and they are isolated from each other by permissions, in such way that write transactions are guaranteed to modify data only in exactly one schema.</p>
<p>It would allow two different write operations to different schemas on the primary to be applied in parallel, independent worker threads on the replica.</p>
<p>This was <a href="https://dev.mysql.com/doc/refman/8.0/en/replication-options-replica.html#sysvar_replica_parallel_type" target="_blank" rel="noopener"><code>replica-parallel-type=DATABASE</code></a>

, and while it is enormously useful with webhosters, the use-case did not fit our environment.</p>
<p>Newer versions of MySQL got replica-parallel-type=LOGICAL_CLOCK, which can handle parallel execution of compatible statements within a single schema.</p>
<h1 id="splitting-the-work-with-logical_clocks">
    <a href="#splitting-the-work-with-logical_clocks">
	Splitting the work with LOGICAL_CLOCKS
    </a>
</h1>
<p>Originally, MySQL would assign each transaction in the binlog a number, starting with 1 for each binlog, the <code>sequence_number</code>.</p>
<p>All transactions that were executed concurrently obviously were legal to execute in parallel, because they just did on the primary.
MySQL would choose a sequence number from that group and assign it to all of these concurrently executed transactions, the commit group number.</p>
<p>On the replica, transactions with the same commit group number could be executed in parallel, because they did successfully do that on the primary.</p>
<p>While simple and fast, this method has a number of drawbacks:</p>
<ul>
<li>The degree of parallelism is variable, and workload dependent.
On a mostly idle primary, few transactions would be marked up as &ldquo;able to run in parallel&rdquo;, because they would not run in parallel on an idle machine.
While that would not be a disadvantage per se (low load on the primary also means low load on the replicas), it makes it really hard to calculate the runway that you still have on your replication hierarchy.</li>
<li>On an intermediate primary in a multilevel replication hierarchy, the degree of parallelism cannot go up, but can go down when things that happened concurrently in the primary did not in the intermediate.
Execution times and parallelism in the leaf replicas would degrade.</li>
</ul>
<p>Crude hacks were invented to improve the situation with regard to the first problem:
We could artificially delay commit on the primary using a config variable, and hope for other transactions to accumulate in the time window.
From their locking interaction we would see if they were good to be executed in parallel, and hopefully get larger parallel execution batches.</p>
<p>Thus, we would slow down the primary in order to speed up the replicas.</p>
<h1 id="logical-clocks-with-dependency-trees">
    <a href="#logical-clocks-with-dependency-trees">
	Logical Clocks with Dependency Trees
    </a>
</h1>
<p>More modern logical clocks still number transactions in the binlog with a consecutive <code>sequence_number</code> or <code>sn</code>.
They will also assign a second number, the sequence number of an earlier transaction, <code>last_committed</code> or <code>lc</code>,  which is the most recent earlier transaction in this binary log that might be conflicting (at least that is what the server that generated the binary log assumed).</p>
<p>So given a binary log that looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">T1: sn=5 lc=4
</span></span></span><span class="line"><span class="cl"><span class="go">T2: sn=6 lc=5
</span></span></span><span class="line"><span class="cl"><span class="go">T3: sn=7 lc=5
</span></span></span><span class="line"><span class="cl"><span class="go">T4: sn=8 lc=6
</span></span></span><span class="line"><span class="cl"><span class="go">T5: sn=9 lc=4
</span></span></span></code></pre></div><p>we have:</p>
<ul>
<li><code>T2</code> (<code>sn=6</code>) depending on <code>T1</code> (<code>T1</code> has <code>sn=5</code>, and <code>T2</code>&rsquo;s <code>lc</code> is 5),</li>
<li><code>T3</code> also depending on <code>T1</code>,</li>
<li>and <code>T4</code> depending on <code>T2</code>.</li>
<li><code>T6</code> is much later in the log, but is dependent <code>lc=4</code>, just like <code>T1</code>.</li>
</ul>
<p>The scheduler can schedule <code>T1</code>, then must wait for <code>T1</code> to commit.
After that, it schedules <code>T2</code> and <code>T3</code> in parallel, because they do not conflict.
<code>T4</code> must wait for <code>T2</code> to complete before it can run.</p>
<p>The transaction <code>T5</code> can in theory be scheduled in parallel already with <code>T1</code>, but due to a limitation of the scheduler can&rsquo;t: The scheduler does not look ahead - any dependency boundary will act as a block. Thus, <code>T2</code> and <code>T4</code> are barriers that require everything before them to commit before the scheduler can proceed.</p>
<h2 id="splitting-the-work-with-commit_order">
    <a href="#splitting-the-work-with-commit_order">
	Splitting the work with COMMIT_ORDER
    </a>
</h2>
<p>To generate such a dependency tree, for each transaction we look at the end of the transaction, the time interval after the last statement and before the commit.
At this point in time all locks the transaction can have taken actually are taken, and they are being released at the end of the commit.</p>
<p>Two transactions are non-conflicting (can be run in parallel), when their time windows with all locks being taken do actually overlap - if they had overlapping, conflicting locks, that would not be possible.</p>
<p>These transactions are assigned the same <code>lc</code> number.</p>
<p>Again, this is a short time window and the degree of parallelism is suboptimal, but at least it always works.</p>
<h2 id="splitting-the-work-with-writeset">
    <a href="#splitting-the-work-with-writeset">
	Splitting the work with WRITESET
    </a>
</h2>
<p>The introduction of Group Replication required the definition of Write Sets, the sets of primary keys that make up a transaction.
They can also be used to improve parallel replication markup of the binlog:</p>
<blockquote>
<p>&ldquo;Two transactions with non-overlapping primary key sets can be executed in parallel.&rdquo;</p></blockquote>
<p>Wait, what?
That is actually wrong, in more than one way, but it is a useful simplification for many cases.</p>
<p>Two transactions are actually capable of running in parallel if their <strong>lock sets</strong> are compatible and non-overlapping.</p>
<p>In a transaction, each primary key of any row that we write to gets an X-lock, and thus these two things (primary key set and lock set) are almost, but not quite the same.</p>
<p>When are they not the same?</p>
<ol>
<li>We may theoretically have tables without a primary key.
That&rsquo;s bad, and basically while we can lock rows, we can still have two identical rows, one locked and not.
We cannot handle WRITESET things for tables without primary keys (but any sensible DBA will require your tables to always have a primary key defined anyway, so that should never be an issue).</li>
<li>We may have tables with foreign key constraints, and the foreign key constraints may generate S-locks on REFERENCED rows.
These locks in other tables may prevent other writes from proceeding.
We cannot handle WRITESET things in the presence of foreign key constraint definitions.</li>
</ol>
<p>So:</p>
<ul>
<li>with Write Sets, we can create maximally parallel dependency trees for a large number of cases, and</li>
<li>with COMMIT_ORDER, we have a fallback plan when we can&rsquo;t.</li>
</ul>
<h1 id="how-parallel-is-our-workload">
    <a href="#how-parallel-is-our-workload">
	How parallel is our workload?
    </a>
</h1>
<p>Let&rsquo;s write a bit of code to find that out.
You can follow along <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-binlog-parallel/mysql-binlog-parallel.py" target="_blank" rel="noopener">here</a>

.</p>
<p>Using the <code>mysqlbinlog</code> program, we can read a MySQL binlog and extract the <code>lc</code>/<code>sn</code> pairs.
The following <code>mysqlbinlog | grep</code> will produce lines that look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> mysqlbinlog -vvv binlog.654321 <span class="p">|</span> grep <span class="s2">&#34;last_committed=&#34;</span> <span class="p">|</span> head -3
</span></span><span class="line"><span class="cl"><span class="go"> 
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span><span class="m">211102</span>  8:44:24 server id <span class="m">210015197</span>  end_log_pos <span class="m">475</span> CRC32 0x61436ace 	
</span></span><span class="line"><span class="cl"><span class="go">    GTID	last_committed=0	sequence_number=1	rbr_only=yes
</span></span></span><span class="line"><span class="cl"><span class="go"> 	original_committed_timestamp=1635839064507445
</span></span></span><span class="line"><span class="cl"><span class="go"> 	immediate_commit_timestamp=1635839064507445	transaction_length=501
</span></span></span><span class="line"><span class="cl"><span class="go"> 
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span><span class="m">211102</span>  8:44:24 server id <span class="m">210015197</span>  end_log_pos <span class="m">976</span> CRC32 0xb28c4330 	
</span></span><span class="line"><span class="cl"><span class="go">    GTID	last_committed=1	sequence_number=2	rbr_only=yes
</span></span></span><span class="line"><span class="cl"><span class="go">    original_committed_timestamp=1635839064507452	
</span></span></span><span class="line"><span class="cl"><span class="go">    immediate_commit_timestamp=1635839064507452	transaction_length=501
</span></span></span><span class="line"><span class="cl"><span class="go"> 
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span><span class="m">211102</span>  8:44:24 server id <span class="m">210015197</span>  end_log_pos <span class="m">1477</span> CRC32 0xca77099e
</span></span><span class="line"><span class="cl"><span class="go">    GTID	last_committed=2	sequence_number=3	rbr_only=yes
</span></span></span><span class="line"><span class="cl"><span class="go">    original_committed_timestamp=1635839064507455
</span></span></span><span class="line"><span class="cl"><span class="go">    immediate_commit_timestamp=1635839064507455	transaction_length=505
</span></span></span></code></pre></div><p>Our code will need to grab the <code>lc</code>/<code>sn</code> pairs and store them into value objects of the Transaction type we create.
We then add the transactions to the commit scheduler:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">while</span> <span class="n">line</span> <span class="o">:=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">lc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">sn</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">(</span><span class="n">lc</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sched</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span></span></code></pre></div><p>Adding a transaction with <code>sched.add(t)</code> checks if the transaction is blocked by a still open conflicting transaction.
If that is the case, it first forces the open transactions to be committed, before it adds the new transaction to the (now empty) list of open transactions.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">wait_for</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">lc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">wait_for</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">blocker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="n">lc</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">t</span><span class="si">=}</span><span class="s2"> is blocked by </span><span class="si">{</span><span class="n">blocker</span><span class="si">=}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;adding </span><span class="si">{</span><span class="n">t</span><span class="si">=}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">sn</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
</span></span></code></pre></div><p>&ldquo;Committing&rdquo; is simple: We just clear the list.
Before we do that, we collect a number of statistics.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">sum</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">hist</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">debug</span> <span class="ow">or</span> <span class="n">incremental</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Commit: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sum</span><span class="si">=}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">=}</span><span class="s2"> Avg=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">avg</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="bp">self</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</span></span></code></pre></div><p>Doing that, each time there is a conflict we collect the length of the list of parallel transactions, for a global average and also in a histogram.
If incremental is on, we emit a running update with the current degree of parallelism.</p>
<h2 id="actual-data">
    <a href="#actual-data">
	Actual data
    </a>
</h2>
<p>We have some very low traffic hierarchies such as data archives, that have an extremely low degree of parallelism - mostly because they are idle most of the time.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> mysqlbinlog -vvv binlog.000058 <span class="p">|</span> grep <span class="s2">&#34;last_committed=&#34;</span> <span class="p">|</span> ./binlog.py
</span></span><span class="line"><span class="cl"><span class="go">1: 631546
</span></span></span><span class="line"><span class="cl"><span class="go">2: 481
</span></span></span><span class="line"><span class="cl"><span class="go">3: 552
</span></span></span><span class="line"><span class="cl"><span class="go">4: 300
</span></span></span><span class="line"><span class="cl"><span class="go">5: 222
</span></span></span><span class="line"><span class="cl"><span class="go">6: 423
</span></span></span><span class="line"><span class="cl"><span class="go">7: 381
</span></span></span><span class="line"><span class="cl"><span class="go">8: 184
</span></span></span><span class="line"><span class="cl"><span class="go">9: 31
</span></span></span><span class="line"><span class="cl"><span class="go">10: 13
</span></span></span><span class="line"><span class="cl"><span class="go">11: 18
</span></span></span><span class="line"><span class="cl"><span class="go">12: 9
</span></span></span><span class="line"><span class="cl"><span class="go">13: 4
</span></span></span><span class="line"><span class="cl"><span class="go">14: 1
</span></span></span><span class="line"><span class="cl"><span class="go">15: 3
</span></span></span><span class="line"><span class="cl"><span class="go">16: 3
</span></span></span><span class="line"><span class="cl"><span class="go">Avg = 1.0155383957954558
</span></span></span><span class="line"><span class="cl"><span class="go">Max = 16
</span></span></span></code></pre></div><p>The output is a histogram, so for this binlog, we had 3 instances where the open queue was 16 deep, and so on.
On the average, degree of parallelism was 1.02, and the maximum was 16.</p>
<p>Others, showing a more normal workload, look a bit better:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> mysqlbinlog -vvv binlog.000165 <span class="p">|</span> grep <span class="s2">&#34;last_committed=&#34;</span> <span class="p">|</span> ./binlog.py
</span></span><span class="line"><span class="cl"><span class="go">1: 78255
</span></span></span><span class="line"><span class="cl"><span class="go">2: 69955
</span></span></span><span class="line"><span class="cl"><span class="go">3: 46694
</span></span></span><span class="line"><span class="cl"><span class="go">4: 30747
</span></span></span><span class="line"><span class="cl"><span class="go">5: 21162
</span></span></span><span class="line"><span class="cl"><span class="go">6: 15942
</span></span></span><span class="line"><span class="cl"><span class="go">7: 12431
</span></span></span><span class="line"><span class="cl"><span class="go">8: 9465
</span></span></span><span class="line"><span class="cl"><span class="go">9: 7580
</span></span></span><span class="line"><span class="cl"><span class="go">10: 6059
</span></span></span><span class="line"><span class="cl"><span class="go">11: 4984
</span></span></span><span class="line"><span class="cl"><span class="go">12: 4155
</span></span></span><span class="line"><span class="cl"><span class="go">13: 3583
</span></span></span><span class="line"><span class="cl"><span class="go">14: 3018
</span></span></span><span class="line"><span class="cl"><span class="go">15: 2565
</span></span></span><span class="line"><span class="cl"><span class="go">16: 2218
</span></span></span><span class="line"><span class="cl"><span class="go">17: 1960
</span></span></span><span class="line"><span class="cl"><span class="go">18: 1635
</span></span></span><span class="line"><span class="cl"><span class="go">19: 1406
</span></span></span><span class="line"><span class="cl"><span class="go">20: 1196
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">62: 1
</span></span></span><span class="line"><span class="cl"><span class="go">Avg = 4.569389646418146
</span></span></span><span class="line"><span class="cl"><span class="go">Max = 62
</span></span></span></code></pre></div><p>Here we end up with an average degree of parallelism of 4.6, and a maximum of 62.</p>
<p>For an internal control plane state storage, we get ~2.</p>
<p>And for our legacy central database, we get a whopping 18.
That makes a lot of sense if you think about it - this is a shared database with a number of independent sets of tables that will never block each other.
That&rsquo;s why we are able to split it into individual smaller databases in the first place, which is what currently happens.</p>
<h1 id="tldr">
    <a href="#tldr">
	TL;DR
    </a>
</h1>
<p>MySQL has made great progress in being able to run parallel replication, and the work on Write Sets for Group Replication has helped tremendously with that.</p>
<p>Still, the degree of exploitable parallelism is workload dependent and varies a lot (20x!), depending on replication chain and also, unfortunately, time of day and month.</p>
<p>There are legit use-cases that have very extremely low degrees of exploitable parallelism, and any SLO on replication performance always must be made with the assumption of a &ldquo;degree of parallelism=1&rdquo;.</p>
<p>If, and how much parallelism there is, is entirely dependent on the database owner and the workload they have.
It cannot be controlled by the database operators.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#replication" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				replication
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2021-11-08-mysql-parallel-replication.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/11/07/this-blog-is-now-hugo-powered.html">This Blog is now Hugo powered</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/11/08/amd-und-128-cores.html">AMD und 128 cores</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
