<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Python and WHERE &hellip; IN () | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2021/10/28/python-where-in.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Python and WHERE &hellip; IN () | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2021/10/28/python-where-in.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2021-10-28T14:06:51Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Python and WHERE ... IN ()' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-python-and-where-...-in-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Python and WHERE &hellip; IN ()
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>October 28, 2021</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/10/27/metaverse-en.html">Metaverse (en)</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/10/29/relational-algebra.html">Relational, and an Algebra</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<blockquote>
<p>As a developer using Python, I want to be able to hand
a <code>list</code> to an SQL statement with a
<code>WHERE id IN (…)</code> clause, and it should do the right thing.</p></blockquote>
<p>Well, that is not how it started, because it was asked on the  internal no-work-channel, so it kind of escalated more.</p>
<h1 id="a-question">
    <a href="#a-question">
	A question
    </a>
</h1>
<p>The original question was:</p>
<blockquote>
<p>Dev&gt; Why is it 2021, and SQL prepared statements still can&rsquo;t deal with IN?  Or have I missed some exciting development?</p></blockquote>
<p>After a quick detour through Java (which we won&rsquo;t discuss any further in this article), we established that this was a Python problem in this particular instance.
And we touched on several other interesting things on our way.</p>
<p>But first, the solution:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#! /usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">click</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">MySQLdb</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">MySQLdb.cursors</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DebugCursor</span><span class="p">(</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Debug: </span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span><span class="o">=</span><span class="s2">&#34;kris&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">passwd</span><span class="o">=</span><span class="s2">&#34;secret&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="o">=</span><span class="s2">&#34;kris&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursorclass</span><span class="o">=</span><span class="n">DebugCursor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@click.group</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&#34;Making WHERE IN great again.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sql</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@sql.command</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">make_table</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">sql1</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;drop table if exists insert_test&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sql2</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;create table insert_test ( id serial, d varchar(200) )&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sql3</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;insert into insert_test values ( NULL, </span><span class="si">%(value)s</span><span class="s2"> )&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;eins&#39;</span><span class="p">,</span> <span class="s1">&#39;zwei&#39;</span><span class="p">,</span> <span class="s1">&#39;drei&#39;</span><span class="p">,</span> <span class="s1">&#39;zw&#34;ei&#39;</span><span class="p">,</span> <span class="s1">&#39;dr\ei&#39;</span> <span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql3</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;value&#34;</span><span class="p">:</span> <span class="n">i</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@sql.command</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">query</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">ary</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;eins&#39;</span><span class="p">,</span> <span class="s1">&#39;zwei&#39;</span><span class="p">,</span> <span class="s1">&#39;drei&#39;</span><span class="p">,</span> <span class="s1">&#39;zw&#34;ei&#39;</span><span class="p">,</span> <span class="s1">&#39;dr\ei&#39;</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">ary</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&#34;select d from insert_test where d in </span><span class="si">%(ary)s</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;ary&#34;</span><span class="p">:</span> <span class="n">ary</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="n">res</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sql</span><span class="p">()</span>
</span></span></code></pre></div><p>In case you didn&rsquo;t spot it: you can safely generate the <code>WHERE d IN …</code> clause by supplying a string placeholder and then handing it a <code>list</code>.
Do not provide parens, the list will bring its own: It is <code>select d from t where id in %s</code> and <em>not</em> <code>select d from t where id in ( %s )</code>.</p>
<h1 id="why-is-that-safe">
    <a href="#why-is-that-safe">
	Why is that safe?
    </a>
</h1>
<p>We are calling <code>cursor.execute(sql, args)</code> to run the SQL.
<code>cursor</code> is from <code>MySQLdb</code>, which is the package <code>mysqlclient</code>, obviously.</p>
<h2 id="wait-what">
    <a href="#wait-what">
	Wait, what?
    </a>
</h2>
<p>In Python 2, there was a MySQL database class called <code>MySQLdb</code> in the package <code>MySQLdb</code>, which was not Python 3 compatible, and the maintainer vanished.
Also, Python 3 wanted to do away with upper case letters in package names, anyway.</p>
<p>So somebody took over the package, renamed it <code>mysqlclient</code> and made it Python 3 compatible, and kept the old class names in order to, uncharacteristically for Python, not break compatibility.
Hence, you install the dependency <code>mysqlclient</code> to get the <code>MySQLdb</code> class.</p>
<p>Remember this the next time a Python person makes fun of your PHP needles and haystacks, or your Perl anything.</p>
<h2 id="anyway">
    <a href="#anyway">
	Anyway…
    </a>
</h2>
<p>In any case, the cursors are in <code>cursors.py</code>, hopefully somewhere in your venv.
And <a href="https://github.com/PyMySQL/mysqlclient/blob/143129be8f57d3a0667f01c989b9776bd80c28d3/MySQLdb/cursors.py#L171-L207" target="_blank" rel="noopener"><code>cursor.execute()</code></a>

 looks something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="mi">171</span>     <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="mi">190</span>         <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">191</span>             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="mi">192</span>                 <span class="n">nargs</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="mi">193</span>                 <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl"><span class="mi">194</span>                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl"><span class="mi">195</span>                         <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">196</span>                     <span class="n">nargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">literal</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">197</span>                 <span class="n">args</span> <span class="o">=</span> <span class="n">nargs</span>
</span></span><span class="line"><span class="cl"><span class="mi">198</span>             <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">199</span>                 <span class="n">args</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">literal</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="mi">200</span>             <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">201</span>                 <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">%</span> <span class="n">args</span>
</span></span><span class="line"><span class="cl"><span class="mi">202</span>             <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="mi">203</span>                 <span class="k">raise</span> <span class="n">ProgrammingError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="mi">204</span>
</span></span><span class="line"><span class="cl"><span class="mi">205</span>         <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="mi">206</span>         <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">207</span>         <span class="k">return</span> <span class="n">res</span>
</span></span></code></pre></div><p>So in line 201, the replacement is a simple old style Python string formatting, <code>query % args</code>.
This is then handed to <code>self._query()</code> in line 206.</p>
<p>Before that, in 190ff, the args are massaged.</p>
<p>If <code>args</code> is not a <code>dict</code>, we <code>map(db.literal, args)</code>, which happens to be defined in
<a href="https://github.com/PyMySQL/mysqlclient/blob/5c04abf87d32a3254dd481c03740a8c56520bc3a/MySQLdb/connections.py#L266-L287" target="_blank" rel="noopener"><code>connections.py:266</code></a>

.
The function escapes the arg using the proper encoding required.
It ends up using
<a href="https://github.com/PyMySQL/mysqlclient/blob/204fb123683454cdb670e0065f09e50d425b94c8/MySQLdb/_mysql.c#L964-L1011" target="_blank" rel="noopener"><code>string_literal()</code></a>

,
which is defined in <code>_mysql</code>, a C-language wrapper that links against <code>libmysqlclient.so</code>, the C language client protocol library.
And that in turn ends up being a call to
<a href="https://github.com/PyMySQL/mysqlclient/blob/204fb123683454cdb670e0065f09e50d425b94c8/MySQLdb/_mysql.c#L1000" target="_blank" rel="noopener"><code>mysql_real_escape_string_quote()</code></a>

,
which is the appropriate function for this.</p>
<p>For <code>dicts</code>, similarly, the items are being enumerated and then <code>db.literal()</code> is applied.</p>
<p>So this is proven to work, and it uses the recommended escape function on parameters for MySQL.</p>
<h1 id="debugging">
    <a href="#debugging">
	Debugging
    </a>
</h1>
<p>We do hand the query off to
<a href="https://github.com/PyMySQL/mysqlclient/blob/143129be8f57d3a0667f01c989b9776bd80c28d3/MySQLdb/cursors.py#L316-L323" target="_blank" rel="noopener"><code>self._query()</code></a>


in the end. And that does the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_db</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_do_get_result</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_post_get_result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">_executed</span> <span class="o">=</span> <span class="n">q</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rowcount</span>
</span></span></code></pre></div><p>That it, it fetches the existing database connection db, sends off the query and fetches and processes the result (so that you can call <code>cursor.fetchall()</code> or similar on it).
It also remembers the query string in <code>cursor._executed</code>, but only after the query ran without error.
And finally, it returns the rowcount.</p>
<p>We could debug by printing <code>cursor._executed</code>, but only if we don&rsquo;t need to debug and the query actually ran.
That is, because the assignment happens only after the <code>db.query()</code>, which in turn will throw an exception if there is a problem with our SQL.</p>
<p>So in order to actually debug, we need to do better:
We can specify a <code>cursorclass=</code> anyway, as a connection parameter.</p>
<p>We make our own cursorclass, <code>DebugCursor</code>, which we let inherit from our cursor class of choice.
I happen to be partial to <code>DictCursor</code>, so I inherit from that.</p>
<p>In my <code>DebugCursor</code>, I simply override <code>_query()</code>, log the query string and hand off things otherwise unchanged to the superclass.
Because I do that before everything else, I get my log sent before stuff catches fire and my code burns to the ground.</p>
<p>That way I get to see the replaced SQL before it runs, even it if is gibberish.
So I can actually see that</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&#34;select d from insert_test where d in ( </span><span class="si">%(ary)s</span><span class="s2"> )&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">{</span><span class="s2">&#34;ary&#34;</span><span class="p">:</span> <span class="n">ary</span><span class="p">})</span>
</span></span></code></pre></div><p>in which I supply my own parens, turns into</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> python3 prep.py query
</span></span><span class="line"><span class="cl"><span class="go">[&#39;eins&#39;, &#39;zwei&#39;, &#39;drei&#39;, &#39;zw&#34;ei&#39;, &#39;dr\\ei&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">Debug: b&#39;select d from insert_test where d in ( (\&#39;eins\&#39;,\&#39;zwei\&#39;,\&#39;drei\&#39;,\&#39;zw\\&#34;ei\&#39;,\&#39;dr\\\\ei\&#39;) )&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">Traceback (most recent call last):
</span></span></span><span class="line"><span class="cl"><span class="go">  File &#34;prep.py&#34;, line 54, in &lt;module&gt;
</span></span></span></code></pre></div><p>while without those extra parens I get</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> python3 prep.py query
</span></span><span class="line"><span class="cl"><span class="go">[&#39;eins&#39;, &#39;zwei&#39;, &#39;drei&#39;, &#39;zw&#34;ei&#39;, &#39;dr\\ei&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">Debug: b&#39;select d from insert_test where d in (\&#39;eins\&#39;,\&#39;zwei\&#39;,\&#39;drei\&#39;,\&#39;zw\\&#34;ei\&#39;,\&#39;dr\\\\ei\&#39;)&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">{&#39;d&#39;: &#39;eins&#39;}
</span></span></span><span class="line"><span class="cl"><span class="go">{&#39;d&#39;: &#39;zwei&#39;}
</span></span></span><span class="line"><span class="cl"><span class="go">{&#39;d&#39;: &#39;drei&#39;}
</span></span></span><span class="line"><span class="cl"><span class="go">{&#39;d&#39;: &#39;zw&#34;ei&#39;}
</span></span></span><span class="line"><span class="cl"><span class="go">{&#39;d&#39;: &#39;dr\\ei&#39;}
</span></span></span></code></pre></div><p>and so I get to actually see that all is fine and well, and properly escaped.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2021-10-28-python-where-in.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/10/27/metaverse-en.html">Metaverse (en)</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/10/29/relational-algebra.html">Relational, and an Algebra</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
