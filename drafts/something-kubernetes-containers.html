<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Die wunderbare Welt von Isotopp - Someting Kubernetes Containers</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="site.webmanifest">
<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">





    



<link rel="stylesheet" href="/style.min.e525cc19e18f2cbf426091105e559b85dfd95ed4f6e083666ffc41242d16af82.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
  <div class="container-fluid">

    <a class="navbar-brand justify-content-center" href="" rel="home" title=".Site.Title">
      <img height='48' width='48' src='/assets/img/kris.jpg' class='p-0 me-3 d-block d-lg-inline'>
      <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
    </a>

    <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">

      

      
        <li class="nav-item ">
                        <a class="nav-link" href="/about/">
          
          <span>About</span>
          <span class="visually-hidden">(Current)</span>
            </a>
            
        <li class="nav-item ">
                        <a class="nav-link" href="/contribute/">
          
          <span>Contribute</span>
          <span class="visually-hidden">(Current)</span>
            </a>
            
        <li class="nav-item ">
                        <a class="nav-link" href="/search/">
          <svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg>
          <span></span>
          <span class="visually-hidden">(Current)</span>
            </a>
            
        <li class="nav-item ">
                        <a class="nav-link" href="/tags/">
          <svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg>
          <span></span>
          <span class="visually-hidden">(Current)</span>
            </a>
            
        </li>
      </ul>
        
    </div>

  </div>
</nav>


        <main role="main" class="container-fluid p-0">

            


<div class="page">
  <article class="someting-kubernetes-containers-page">
    <div class='row justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            Someting Kubernetes Containers
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
              <img src='/assets/img/kris.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
              <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
              </a>
            

            
              <span class='d-none d-lg-inline'>-</span> 
              <div class='d-block d-lg-inline'>June 3, 2017</div>
            

          </div>
        </div>
        <img src='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg'>
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p>002
Title was not set when I applied for the talk, something about continers
Now Containers at Booking
Not there yet, it is a thing we are still working on</p>
<p>003
What we do, selling rooms, getting commission from the Hotel
A very simple thing, it seems, but very different depending on where in the world you are
Very hard to explain what a hotel offers, lots of reviews and images
When we fail, somebody is sleeping under a bridge
That is why we need to be boring.</p>
<p>006
Where we are:
Automated Bare Metal
Colocation Customer, multiple rooms in muiltiple data centers
We have a set of Python Django Apps, written in House, that automatically provision stuff.
ServerDB manages hardware, from managing procurement and vendor data ingest, to burnin, bios updates, inventorization of the HW, provisioning the hardware
As a developer you ask ServerDB for servers in a location of a given type,
ServerDB will flash these things up to spec, provision that for you, partition table and base OS, tell puppet what to do
Puppet will install packages, hand over to class specific tooling
Database tooling will create servers with appropriate tooling,
200 databases with nobody touching any piece of hardware, fully inserted into replication chains</p>
<p>Disadvantages:
slow, because HW provisioning is always slow
Hardware is often too large or too small for the task, the hardware we use is at the low end of the available spec</p>
<p>009
Current hardware is very powerful,
one chassis = 10 U, around 1000 cores, 3 TB of memory, 320 GBit/s network, can consume up to 6400W.
Racks cannot realistically hold 4 of these things</p>
<p>010
We need to handle more developers,
we need to be able to handle more databases with fewer people
we need to decouple provisioning of HW from consumption (independent of workload)
I need machine readable service descriptions (who talks to what)</p>
<p>011
The software currently is a monolith and needs to be split from being a 6GB process into something smaller.
The software is written in perl and is pretty okay, but the deployment model is outdated.
We roll out between 10-14 times a day.</p>
<p>012
What so we want to do?
Change the entire stack:
DC &amp; HW level, looking for better DC space, containers to slice and dice the HW, work towards microservices, work to a different business model as well.</p>
<p>Containers are useful, because they spawn faster than HW is being provisioned
And we can buy hardware in any shape, and then slice and dice it into consumption sizes.</p>
<p>013
What are containers?
fork + fairy dust + exec
Namespaces, CGroups,</p>
<p>014
Docker standalone is not useful for production, it is dev centric
From a dev PoV very useful, layering, instant availabilty,
fold production into a single host,
K8s is useful because it throws away most of Docker and does proper production things.
A single dockerhost can take you very far (20C, 512GB memory, disks) can hold a lot of development
Not for production, SPOF, does not scale, but for devs very useful</p>
<p>015
For production, it is very useful to have images.
Keeps the base host clean, put application there without much hassle,
also makes app removeable (instant application, as CPU and memory)</p>
<p>016
CI/CD are necessary
you need to understand what is in an image,
you can only know that if you build these tjings and cache things locally
reproducible builds.</p>
<p>018
We came from a hackathon project, Mesos and Docker.</p>
<p>019
suddenly running stuff
(list)</p>
<p>internal facing only</p>
<p>020
Modular, but parts fall off under load
Typical for all Apache (Hadoop, Mesos/Marathon)
This is not stuff that should happen in production
Also, lots of things missing that need to be there in production:
isolation of tenants, no discovery, no deployment ruyles, no auto-scaling, no one-time batch runs, no rbac.</p>
<p>021
When lookign around we found K8s,
has all the stuff we needed.</p>
<p>Environment very cooperative and receptive to suggestions</p>
<p>022
This is what you get:
&ldquo;I want to run something&rdquo;, and it runs somewhere in the cluster where there is space.
Clean machines after workload is gone.
Like init, but for a set of machines.</p>
<p>023
The Pod, split a container into units that make more sense.
Pod = resource barriers (like VM, but is not a VM)
images, multiple, allow for sidecars
sidecars can manipulate and debug payloads in their pod
pods are very cheap, just namespaces and limits, take up almost no resources themselves</p>
<p>024
Don&rsquo;t say container
container = the pod, the image, the init-container, the sidecar?
use specific words</p>
<p>025
Iteration 1:
inital deployment to test things out
8 bladecenters = 128 blades, 2x 10 Gbit per Blade
&ldquo;Not really a cloud, it&rsquo;s more like ground fog&rdquo; when you have only one blade center per rack</p>
<p>Iteration 2:
128 discretes, 8 racks, 1x 25 Gbit/s per machine, with option to double, lots of storage and play with distributed storage</p>
<p>026
The million core computer
20.000 machines at 50 cores for a million core computer, too large, needs to be split for many reasons</p>
<p>image based
unified hardware
location indepence = any core to any disk in aby box
strong networking</p>
<p>027
List of problems that need solving
ours vs. openshift
openshift has solved many of the base problems</p>
<p>029
L3, Leaf-and-spine, can be oversubscription free up to 1.6 TBit/s at the ToR, but we have no need atm
we have a lot of east-west-traffic, that is unlike before</p>
<p>030
Out network looks like this, PROD 15
containers has 100 Gbit, but same topology
No special K8s network, just better cables, more switches</p>
<p>031
Juniper, Midokura, we found that SDN &ldquo;is too good&rdquo; for our needs,
not using a SDN, having Midokura on the backburner,</p>
<p>032
Openstack like SDN gives you a lot of flexibility
can build an arbitrary virtual network,
SDN will build and simulate that
We do not want to give Devs this power,
we do not want devs to build arbitrary networks.
We want something standardized.</p>
<p>033
Shared infra on a physical node (centralized logging)
We do not do this right now, instead sidecars
Logging, Monitoring use cases
We are not a hoster, so sharing things can be done and is fine</p>
<p>034
IP addresses and host names no longer mean a thing
everything is dynamic
how do you find things?</p>
<p>035
service load balancer
instances register in the etcd, I am operational (readyness), announce endpoint
life check, renew subscription</p>
<p>036
services expose load balancer pools
Lookup not done for every request, only on pod creation/destruction</p>
<p>037
in reality a bunch of iptables rules
really many iptables rules
40-50k
select random instance to handle request on DNAT</p>
<p>038
K8s does not migrate instances
destroy/create == rescheduling
number of instances is variable, single things should not exist</p>
<p>040
storage is complicated
state is complicated
manually created PVs,
first match,
manual pool,
overprovision</p>
<p>041
PVC, dynamically provisioned, matches PV to PVC and provides
banana with 10 GB
many storages do not like volumes created/deleted at a fast pace
or reclaim if exists
cleanup?</p>
<p>042, 043
mount to host, bind mount into container
on reschedule mount follows you around</p>
<p>044
iSCSI has limits (64 hosts with Trident)
using wrong API
is being fixed
iscsi latencies are a thing that is important</p>
<p>046
things with names
are pets not cattle
pet sets -&gt; stateful sets
uniqueness guaranteed
ordered teardown, startup
identity (also identity tied to volume)
examples zookeeper, mysql, elasticsearch, others
we have mysql running</p>
<p>049
Network side of things:
ip per pod
100 hosts, how many ip per host, how many per cluster
100 node cluster -&gt; eat a /16
we need ipv6 in cluster, but k8s is not doing this</p>
<p>050
Ingress Routers exist on Gateway node,
can act as chokepoints when there is a lot of traffic from certain nodes,</p>
<p>051
Put legacy databases inside the cluster
using in our case ovs-switchd,
&ldquo;take physical database and lift it into the virtual&rdquo;
have a node in the cluster that is not a cluster node.
So node needs to be trusted.
Also a problem in proper SDN</p>
<p>052
exist IP is random, and does not identify a service
ip based security no longer works.
traditional firewall is useles, whitelist entire cluster
red = allowed, green, yellow, blue = random other things</p>
<p>053
in our current model, fw rules autogenerated from serverdb data
firewall rule autogenerated is useless</p>
<p>054
TLS all the things, use client certs
handle auth transparently, trireme
JWT in TCP 3-way handshake
still needs to be tested
scary idea</p>
<p>056
how large can a cluster be?
can run on a laptop, or 1 or 3 prod boxes
low hundreds of cluster nodes
large clusters not good
want multiple clusters, for resiliency</p>
<p>057
federation if you have multiple clusters
very experimental k8s feature
research topic, no idea if that works
if it works, it will be very useful</p>
<p>059
We like baremetal, we control the crosstalk between apps
freely define instance sizes
talk to cloud provider about 1 mio cores, how long would it take to spin this up?
they do not have the capacity ready in idle, can take a while to get capacity
at enterprise level the cloud is not elastic, preallocation is necessary
data centers are not things that have high margins or low latency
4MW = 20.000 machines -&gt; somebody needs to run excavators
long term contracts are par for the course
so it is mostly a capex to opex shift</p>
<p>060
why on bare metal
vms are not helping with any problem we have
vm management systems do not look reliable</p>
<p>061
What about the Monolith?
That&rsquo;s another problem, it&rsquo;s a problem being worked on.</p>

      </div>
    </div>

    <div class='row justify-content-center mb-3'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=%2fdrafts%2fsomething-kubernetes-containers.html' target='_blank'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=%2fdrafts%2fsomething-kubernetes-containers.html&text=Someting%20Kubernetes%20Containers%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20%2fdrafts%2fsomething-kubernetes-containers.html' target='_blank'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top'>
      <div class='col-lg-4 text-center text-lg-start'>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
         
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="/drafts/elektronischer-personalausweis-f-r-das-internet.html">Elektronischer Personalausweis für das Internet</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/index.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="/js/bootstrap.js"></script>




<script src="/js/lunr.js"></script>





<script src="/js/app.js"></script>


    </body>
</html>
