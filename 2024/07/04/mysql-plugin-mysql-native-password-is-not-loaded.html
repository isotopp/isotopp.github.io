<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Plugin &lsquo;mysql_native_password&rsquo; is not loaded | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2024/07/04/mysql-plugin-mysql-native-password-is-not-loaded.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Plugin &lsquo;mysql_native_password&rsquo; is not loaded | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='A user lost login to their database instance, which has been accidentally upgraded to 9.0. They had mysql_native_password active on the root account, which has been deprecated since 8.0 and has been removed in 9.0. Due to the upgrade they have lost access to their database. Here is how to recover this.' />
<meta property="og:description" content='A user lost login to their database instance, which has been accidentally upgraded to 9.0. They had mysql_native_password active on the root account, which has been deprecated since 8.0 and has been removed in 9.0. Due to the upgrade they have lost access to their database. Here is how to recover this.' />
<meta property="og:url" content="https://blog.koehntopp.info/2024/07/04/mysql-plugin-mysql-native-password-is-not-loaded.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2024-07-04T05:06:07Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Plugin &#39;mysql_native_password&#39; is not loaded' />
<meta property="twitter:description" content='A user lost login to their database instance, which has been accidentally upgraded to 9.0. They had mysql_native_password active on the root account, which has been deprecated since 8.0 and has been removed in 9.0. Due to the upgrade they have lost access to their database. Here is how to recover this.' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-plugin-mysql_native_password-is-not-loaded-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Plugin &lsquo;mysql_native_password&rsquo; is not loaded
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>July 4, 2024</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2024/07/01/practice.html">Practice</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2024/07/12/sonos-s2-analysis.html">Sonos S2 Analysis</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
				<header class="toc bg-light">
					<nav id="TableOfContents">
  <ul>
    <li><a href="#creating-a-test-setup">Creating a test setup</a></li>
    <li><a href="#recreating-the-original-setup-using-mysql-57">Recreating the original setup using MySQL 5.7</a></li>
    <li><a href="#upgrade-to-80">Upgrade to 8.0</a></li>
    <li><a href="#upgrading-to-84-and-breaking-the-installation">Upgrading to 8.4 and breaking the installation</a></li>
    <li><a href="#recovering-the-server">Recovering the server</a></li>
    <li><a href="#upgrading-the-existing-accounts-and-making-a-new-one">Upgrading the existing accounts and making a new one</a></li>
    <li><a href="#validation">Validation</a></li>
    <li><a href="#cleanup">Cleanup</a></li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
				</header>
				
			</div>
			<div class='col-lg-8'>
				<p>In <code>libera:#mysql</code> a user has been running MySQL in a docker container with <code>mysql:latest</code>.
This container got automatically upgraded to MySQL 9.0.0, an innovation release.</p>
<p>Part of the 9.0 release is the removal of the <code>mysql_native_password</code> plugin, which has been deprecated since 8.0.
The user now can no longer login to their database.
They have no backup and no replica.</p>
<p>We recreate the problem from scratch, using docker, and then recover the instance.</p>
<h1 id="creating-a-test-setup">
    <a href="#creating-a-test-setup">
	Creating a test setup
    </a>
</h1>
<p>On my system, I am using LVM2, and I am routinely using the XFS file system.
I am creating a 10 GB sized test filesystem, which I mount to <code>/a</code>.
In that, we create a <code>mysql</code> and a <code>conf</code> directory.</p>
<p>The official <code>mysql</code> image is running as UID 999, and that is visible outside the container.
There are ways around that, but for a short test we do not care.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# lvcreate -n mysqltest -L 10G data
</span></span></span><span class="line"><span class="cl"><span class="go">  Logical volume &#34;mysqltest&#34; created.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">root@server:~# mkfs -t xfs -f /dev/data/mysqltest
</span></span></span><span class="line"><span class="cl"><span class="go">meta-data=/dev/data/mysqltest    isize=512    agcount=4, agsize=655360 blks
</span></span></span><span class="line"><span class="cl"><span class="go">         =                       sectsz=512   attr=2, projid32bit=1
</span></span></span><span class="line"><span class="cl"><span class="go">         =                       crc=1        finobt=1, sparse=1, rmapbt=1
</span></span></span><span class="line"><span class="cl"><span class="go">         =                       reflink=1    bigtime=1 inobtcount=1 nrext64=0
</span></span></span><span class="line"><span class="cl"><span class="go">data     =                       bsize=4096   blocks=2621440, imaxpct=25
</span></span></span><span class="line"><span class="cl"><span class="go">         =                       sunit=0      swidth=0 blks
</span></span></span><span class="line"><span class="cl"><span class="go">naming   =version 2              bsize=4096   ascii-ci=0, ftype=1
</span></span></span><span class="line"><span class="cl"><span class="go">log      =internal log           bsize=4096   blocks=16384, version=2
</span></span></span><span class="line"><span class="cl"><span class="go">         =                       sectsz=512   sunit=0 blks, lazy-count=1
</span></span></span><span class="line"><span class="cl"><span class="go">realtime =none                   extsz=4096   blocks=0, rtextents=0
</span></span></span><span class="line"><span class="cl"><span class="go">Discarding blocks...Done.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">root@server:~# mount /dev/data/mysqltest /a
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">root@server:~# mkdir /a/{mysql,conf}
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">root@server:~# chown 999:999 /a/{mysql,conf}
</span></span></span></code></pre></div><h1 id="recreating-the-original-setup-using-mysql-57">
    <a href="#recreating-the-original-setup-using-mysql-57">
	Recreating the original setup using MySQL 5.7
    </a>
</h1>
<p>As <code>mysql_native_password</code> has been deprecated since 8.0,
we need to install a 5.7 image to reproduce the problem.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker pull mysql:5.7
</span></span></span><span class="line"><span class="cl"><span class="go">5.7: Pulling from library/mysql
</span></span></span><span class="line"><span class="cl"><span class="go">Digest: sha256:4bc6bc963e6d8443453676cae56536f4b8156d78bae03c0145cbe47c2aad73bb
</span></span></span><span class="line"><span class="cl"><span class="go">Status: Image is up to date for mysql:5.7
</span></span></span><span class="line"><span class="cl"><span class="go">docker.io/library/mysql:5.7
</span></span></span></code></pre></div><p>We run this image with datadir in <code>/a/mysql</code>, and we want a root password <code>cookie</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker run -v/a/mysql:/var/lib/mysql --name mysqltest -e MYSQL_ROOT_PASSWORD=cookie --rm -d mysql:5.7
</span></span></span><span class="line"><span class="cl"><span class="go">d16ab1076a328d91562970ed2870a273a2cdffd0eace263002c72fd360a7b4a4
</span></span></span></code></pre></div><p>We verify that the plugin used is indeed the to-be-deprecated <code>mysql_native_password</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker exec -ti mysqltest bash
</span></span></span><span class="line"><span class="cl"><span class="go">bash-4.2# mysql -u root -pcookie mysql
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">Server version: 5.7.44 MySQL Community Server (GPL)
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; select user, host, plugin from mysql.user;
</span></span></span><span class="line"><span class="cl"><span class="go">+---------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| user          | host      | plugin                |
</span></span></span><span class="line"><span class="cl"><span class="go">+---------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| root          | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.session | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.sys     | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| root          | %         | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">+---------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">4 rows in set (0.00 sec)
</span></span></span><span class="line"><span class="cl"><span class="go">mysql&gt; ^DBye
</span></span></span><span class="line"><span class="cl"><span class="go">bash-4.2# kill 1
</span></span></span><span class="line"><span class="cl"><span class="go">bash-4.2# root@server:~#
</span></span></span></code></pre></div><p>We have two <code>root</code> users, one <code>root@localhost</code>, the other <code>root@%</code>.
All four users are on <code>mysql_native_password</code>.</p>
<h1 id="upgrade-to-80">
    <a href="#upgrade-to-80">
	Upgrade to 8.0
    </a>
</h1>
<p>Since we did <code>docker run ... -n mysqltest --rm</code>, the container was destroyed when it ended.
We ended it with <code>kill 1</code>, killing the init process inside the container.
This shuts down the database cleanly and drops us back to the host.</p>
<p>We pull 8.0 and run it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker pull mysql:8.0
</span></span></span><span class="line"><span class="cl"><span class="go">8.0: Pulling from library/mysql
</span></span></span><span class="line"><span class="cl"><span class="go">Digest: sha256:134e2d1c7c517d05e5328a77aa5a165a314dc4c4116503e7e089494f4e398ab1
</span></span></span><span class="line"><span class="cl"><span class="go">Status: Image is up to date for mysql:8.0
</span></span></span><span class="line"><span class="cl"><span class="go">docker.io/library/mysql:8.0
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">root@server:~# docker run -v/a/mysql:/var/lib/mysql --name mysqltest -e MYSQL_ROOT_PASSWORD=cookie --rm -d mysql:8.0
</span></span></span><span class="line"><span class="cl"><span class="go">10379b753d6a997b2f27b5d419ed84c083131d7ec95d3e3aa278ab858c77aa53
</span></span></span></code></pre></div><p>This has upgraded datadir, <code>/a/mysql</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker logs mysqltest
</span></span></span><span class="line"><span class="cl"><span class="go">0 [System] [MY-010116] [Server] /usr/sbin/mysqld (mysqld 8.0.38) starting as process 1
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">5 [System] [MY-013381] [Server] Server upgrade from &#39;50700&#39; to &#39;80038&#39; started.
</span></span></span><span class="line"><span class="cl"><span class="go">5 [System] [MY-013381] [Server] Server upgrade from &#39;50700&#39; to &#39;80038&#39; completed.
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><p>We can still access the server.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker exec -ti mysqltest bash
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# mysql -u root -pcookie mysql
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">Server version: 8.0.38 MySQL Community Server - GPL
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">mysql&gt; select user, host, plugin from mysql.user;
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| user             | host      | plugin                |
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| root             | %         | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.infoschema | localhost | caching_sha2_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.session    | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.sys        | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| root             | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">5 rows in set (0.00 sec)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; ^DBye
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# kill 1
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# root@server:~#
</span></span></span></code></pre></div><p>An additional account, <code>mysql.infoschema</code>, as been created.
This account already uses <code>caching_sha2_password</code>.</p>
<p>It is at this point where an upgrade to <code>caching_sha2_password</code> for all accounts should have happened.</p>
<h1 id="upgrading-to-84-and-breaking-the-installation">
    <a href="#upgrading-to-84-and-breaking-the-installation">
	Upgrading to 8.4 and breaking the installation
    </a>
</h1>
<p>We pull 8.4 and run it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker pull mysql:8.4
</span></span></span><span class="line"><span class="cl"><span class="go">8.4: Pulling from library/mysql
</span></span></span><span class="line"><span class="cl"><span class="go">Digest: sha256:d26a69e1ef146c77ecfddf3128134e3a0f4c6123133725835818107037649827
</span></span></span><span class="line"><span class="cl"><span class="go">Status: Image is up to date for mysql:8.4
</span></span></span><span class="line"><span class="cl"><span class="go">docker.io/library/mysql:8.4
</span></span></span><span class="line"><span class="cl"><span class="go">root@server:~# docker run -v/a/mysql:/var/lib/mysql --name mysqltest -e MYSQL_ROOT_PASSWORD=cookie --rm -d mysql:8.4
</span></span></span><span class="line"><span class="cl"><span class="go">698e26254761711ee7bfff158adff9b6272bba1ce6171d68a18aab8367a8373f
</span></span></span></code></pre></div><p>Checking the log, we see the upgrade to 8.4 happening successfully.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker logs mysqltest
</span></span></span><span class="line"><span class="cl"><span class="go">1 [Note] [Entrypoint]: Entrypoint script for MySQL Server 8.4.1-1.el9 started.
</span></span></span><span class="line"><span class="cl"><span class="go">1 [System] [MY-011090] [Server] Data dictionary upgrading from version &#39;80023&#39; to &#39;80300&#39;.
</span></span></span><span class="line"><span class="cl"><span class="go">1 [System] [MY-013413] [Server] Data dictionary upgrade from version &#39;80023&#39; to &#39;80300&#39; completed.
</span></span></span><span class="line"><span class="cl"><span class="go">4 [System] [MY-013381] [Server] Server upgrade from &#39;80038&#39; to &#39;80401&#39; started.
</span></span></span><span class="line"><span class="cl"><span class="go">4 [System] [MY-013381] [Server] Server upgrade from &#39;80038&#39; to &#39;80401&#39; completed.
</span></span></span></code></pre></div><p>Trying to login new already fails:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">bash-5.1# mysql -u root -pcookie
</span></span></span><span class="line"><span class="cl"><span class="go">mysql: [Warning] Using a password on the command line interface can be insecure.
</span></span></span><span class="line"><span class="cl"><span class="go">ERROR 1524 (HY000): Plugin &#39;mysql_native_password&#39; is not loaded
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1#
</span></span></span></code></pre></div><h1 id="recovering-the-server">
    <a href="#recovering-the-server">
	Recovering the server
    </a>
</h1>
<p>We copy <code>/etc/my.cnf</code> to datadir, and modify it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">bash-5.1# cp /etc/my.cnf /var/lib/mysql/my.cnf
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# kill 1
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# root@server:~# tail -3 /a/mysql/my.cnf
</span></span></span><span class="line"><span class="cl"><span class="go">socket=/var/run/mysqld/mysqld.sock
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">!includedir /etc/mysql/conf.d/
</span></span></span></code></pre></div><p>We modify the <code>my.cnf</code> file as follows:</p>
<ul>
<li><code>mv</code> it to <code>/a/conf/my.cnf</code>.</li>
<li>remove the <code>!includedir</code> section.</li>
<li>put a <code>skip_grant_tables</code> into the <code>[mysqld]</code> section.</li>
</ul>
<p><p class="md__image">
  <img src="/uploads/2024/07/recover-root-01.png" alt=""  />
</p>

</p>
<p><em>Putting <code>skip_grant_tables</code> into the <code>[mysqld]</code> section of the <code>my.cnf</code>.</em></p>
<p>This is the procedure documented in
<a href="https://dev.mysql.com/doc/refman/8.4/en/resetting-permissions.html" target="_blank" rel="noopener">the manual</a>

,
<strong>B.3.3.2 How to Reset the Root Password</strong>, last subsection.
We use this approach because it works fine interactively,
and we can debug things as we go along.</p>
<p>We proceed to run the server with our modified <code>my.cnf</code> mapped into the image as a volume.
This will be layered over the existing <code>/etc/my.cnf</code> inside the image.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker run -v/a/conf/my.cnf:/etc/my.cnf  -v/a/mysql:/var/lib/mysql --name mysqltest -e MYSQL_ROOT_PASSWORD=cookie --rm -d mysql:8.4
</span></span></span><span class="line"><span class="cl"><span class="go">6a5bb298fcdd7eb670b8d1403ab285a4492ad012ee659c1157579a37d127b739
</span></span></span><span class="line"><span class="cl"><span class="go">root@server:~# docker exec -ti mysqltest bash
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# grep skip /etc/my.cnf
</span></span></span><span class="line"><span class="cl"><span class="go">skip-name-resolve
</span></span></span><span class="line"><span class="cl"><span class="go">skip_grant_tables
</span></span></span></code></pre></div><p>We can now get into the server without any password at all.
We check the accounts present and their plugins.</p>
<p>After running <code>FLUSH PRIVILEGES;</code> the server is initialized enough
to allow us to run <code>GRANT</code> or <code>ALTER USER</code> statements.</p>
<p>We then start to fix accounts.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">bash-5.1# mysql
</span></span></span><span class="line"><span class="cl"><span class="go">Welcome to the MySQL monitor.  Commands end with ; or \g.
</span></span></span><span class="line"><span class="cl"><span class="go">Your MySQL connection id is 7
</span></span></span><span class="line"><span class="cl"><span class="go">Server version: 8.4.1 MySQL Community Server - GPL
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">mysql&gt; select user, host, plugin from mysql.user;
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| user             | host      | plugin                |
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| root             | %         | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.infoschema | localhost | caching_sha2_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.session    | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.sys        | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| root             | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">5 rows in set (0.00 sec)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; flush privileges;
</span></span></span><span class="line"><span class="cl"><span class="go">Query OK, 0 rows affected (0.02 sec)
</span></span></span></code></pre></div><p>We need to fix <code>root@localhost</code>, <code>root@%</code>
and for good measure also want to create another root account named <code>newroot@localhost</code>,
just to show how that can be done.</p>
<h1 id="upgrading-the-existing-accounts-and-making-a-new-one">
    <a href="#upgrading-the-existing-accounts-and-making-a-new-one">
	Upgrading the existing accounts and making a new one
    </a>
</h1>
<p>Using the
<a href="https://dev.mysql.com/doc/refman/8.4/en/alter-user.html" target="_blank" rel="noopener">ALTER USER</a>


statement, we can modify existing accounts:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mysql&gt; alter user &#34;root&#34;@&#34;localhost&#34; identified with &#34;caching_sha2_password&#34; by &#34;cookie&#34;;
</span></span></span><span class="line"><span class="cl"><span class="go">Query OK, 0 rows affected (0.01 sec)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; select user, host, plugin from mysql.user;
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| user             | host      | plugin                |
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| root             | %         | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.infoschema | localhost | caching_sha2_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.session    | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.sys        | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| root             | localhost | caching_sha2_password |
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">5 rows in set (0.01 sec)
</span></span></span></code></pre></div><p>Note how in the fifth row it now says &ldquo;caching_sha2_password&rdquo;.
We apply the same change to <code>root@%</code>:</p>
<p>Finally, we create a new user &ldquo;newroot@localhost&rdquo;, and make it another root user.
We check the <code>mysql.user</code> table to verify.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mysql&gt; alter user &#34;root&#34;@&#34;%&#34; identified with &#34;caching_sha2_password&#34; by &#34;cookie&#34;;
</span></span></span><span class="line"><span class="cl"><span class="go">Query OK, 0 rows affected (0.02 sec)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; create user &#34;newroot&#34;@&#34;localhost&#34; identified with &#34;caching_sha2_password&#34; by &#34;cookie&#34;;
</span></span></span><span class="line"><span class="cl"><span class="go">Query OK, 0 rows affected (0.03 sec)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; grant all on *.* to &#34;newroot&#34;@&#34;localhost&#34; with grant option;
</span></span></span><span class="line"><span class="cl"><span class="go">Query OK, 0 rows affected, 1 warning (0.01 sec)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; select user, host, plugin from mysql.user;
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| user             | host      | plugin                |
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| root             | %         | caching_sha2_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.infoschema | localhost | caching_sha2_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.session    | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| mysql.sys        | localhost | mysql_native_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| newroot          | localhost | caching_sha2_password |
</span></span></span><span class="line"><span class="cl"><span class="go">| root             | localhost | caching_sha2_password |
</span></span></span><span class="line"><span class="cl"><span class="go">+------------------+-----------+-----------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">6 rows in set (0.00 sec)
</span></span></span></code></pre></div><p>Some things to note:</p>
<ul>
<li>We did have to quote <code>&quot;root&quot;@&quot;%&quot;</code>, because it contained special characters.
We got away with not quoting <code>root@localhost</code>.</li>
<li>We did have to quote <code>&quot;root&quot;</code> and <code>&quot;%&quot;</code> separately.
The <code>@</code> is unquoted, it is a keyword, just as <code>ALTER</code>.</li>
<li>We create a new user <code>newroot@localhost</code>.
We then grant it the same privileges as <code>root</code>.
We include <code>WITH GRANT OPTION</code>, so that <code>newroot</code> can pass these privileges on to other users.</li>
</ul>
<p>This is now complete.
We can kill the server, and restart it with the original config by just leaving our overlay <code>my.cnf</code> off.</p>
<h1 id="validation">
    <a href="#validation">
	Validation
    </a>
</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mysql&gt; ^DBye
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# kill 1
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# root@server:~#
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">root@server:~# docker run -v/a/mysql:/var/lib/mysql --name mysqltest -e MYSQL_ROOT_PASSWORD=cookie --rm -p 3307:3306 -d mysql:8.4
</span></span></span><span class="line"><span class="cl"><span class="go">f4c58332e5875bbb5e3040ac084b7da5dedbaf58ca8a3f3e3674e24aa2067194
</span></span></span><span class="line"><span class="cl"><span class="go">root@server:~# docker exec -ti mysqltest bash
</span></span></span><span class="line"><span class="cl"><span class="go">bash-5.1# mysql -u root -pcookie mysql
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">Server version: 8.4.1 MySQL Community Server - GPL
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; select current_user();
</span></span></span><span class="line"><span class="cl"><span class="go">+----------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| current_user() |
</span></span></span><span class="line"><span class="cl"><span class="go">+----------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| root@localhost |
</span></span></span><span class="line"><span class="cl"><span class="go">+----------------+
</span></span></span><span class="line"><span class="cl"><span class="go">1 row in set (0.00 sec)
</span></span></span></code></pre></div><p>Note that we did start the server with <code>-p 3307:3306</code>,
making the containers mysql at <code>3306</code> available on the host as port <code>3307</code>.</p>
<p>That means we can also try to use it from the host, using <code>root@%</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# mysql -h 127.0.0.1 --port 3307 -u root -pcookie mysql
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">Server version: 8.4.1 MySQL Community Server - GPL
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">root@172.17.0.1 [mysql]&gt; select current_user();
</span></span></span><span class="line"><span class="cl"><span class="go">+----------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| current_user() |
</span></span></span><span class="line"><span class="cl"><span class="go">+----------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| root@%         |
</span></span></span><span class="line"><span class="cl"><span class="go">+----------------+
</span></span></span><span class="line"><span class="cl"><span class="go">1 row in set (0.00 sec)
</span></span></span></code></pre></div><h1 id="cleanup">
    <a href="#cleanup">
	Cleanup
    </a>
</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker kill mysqltest
</span></span></span><span class="line"><span class="cl"><span class="go">Error response from daemon: Cannot kill container: mysqltest: container 42434a73138a PID 1403647 is zombie and can not be killed. Use the --init option when creating containers to run an init inside the container that forwards signals and reaps processes
</span></span></span><span class="line"><span class="cl"><span class="go">root@server:~# docker rm mysqltest
</span></span></span><span class="line"><span class="cl"><span class="go">Error response from daemon: No such container: mysqltest
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">root@server:~# umount /a
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">root@server:~# lvremove /dev/data/mysqltest
</span></span></span><span class="line"><span class="cl"><span class="go">Do you really want to remove and DISCARD active logical volume data/mysqltest? [y/n]: y
</span></span></span><span class="line"><span class="cl"><span class="go">  Logical volume &#34;mysqltest&#34; successfully removed.
</span></span></span></code></pre></div><p>To clean up, we kill the container <code>mysqltest</code>, and make sure it is removed.
We then unmount the test filesystem, and destroy the volume to regain out 10 GB of disk space.</p>
<p>We could then proceed to <code>docker images -a | grep mysql</code>, and then <code>docker rmi ...</code> the <code>mysql</code> images,
if we cared.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@server:~# docker images -a | grep mysql
</span></span></span><span class="line"><span class="cl"><span class="go">mysql                                               8.4             736ced9665e8   2 days ago      583MB
</span></span></span><span class="line"><span class="cl"><span class="go">mysql                                               8.0             0b60ddd8609d   2 days ago      572MB
</span></span></span><span class="line"><span class="cl"><span class="go">mysql                                               5.7             5107333e08a8   6 months ago    501MB
</span></span></span></code></pre></div><p>To gain back these 1.5 GB, <code>docker rmi mysql:{5.7,8.0,8.4}</code>.
Unlike <code>docker pull</code>, which accepts only a single image tag, <code>docker rmi</code> accepts a list of image tags.
That means we do not have to wrap the bash brace expansion <code>{}</code> into a bash <code>for; do done</code> loop.</p>
<h1 id="summary">
    <a href="#summary">
	Summary
    </a>
</h1>
<p>We created a MySQL 5.7 in docker, and ran it with a persistent external volume.
We performed a series of upgrades to 8.0 and 8.4,
until we ran into a situation where the <code>mysql_native_password</code> authentication method no longer was recognized.</p>
<p>We then crafted a recovery <code>my.cnf</code> file with a <code>skip_grant_tables</code> config, mapped that into the container, and performed a recovery.</p>
<p>We have demonstrated the <code>ALTER USER</code> statements to upgrade the authentication method to <code>caching_sha2_password</code>.
We have also demonstrated how to create more users with a complete set of privileges.</p>
<p>We have demonstrated that the container is now reachable as root,
from inside the container and with an exported port from the outside.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				database
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2024-07-04-mysql-plugin-mysql-native-password-is-not-loaded.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2024/07/01/practice.html">Practice</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2024/07/12/sonos-s2-analysis.html">Sonos S2 Analysis</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
