<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Deploying websites - an escalation | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2024/01/09/deploying-websites.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Deploying websites - an escalation | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2024/01/09/deploying-websites.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2024-01-09T05:06:07Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Deploying websites - an escalation' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="deploying-websites-an-escalation-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Deploying websites - an escalation
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>January 9, 2024</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/12/30/restic.html">Restic</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2024/01/16/jusprog-ist-nur-der-anfang.html">JusProg ist nur der Anfang</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
				<header class="toc bg-light">
					<nav id="TableOfContents">
  <ul>
    <li><a href="#a-simple-problem-easily-solved-by-ansible">A simple problem, easily solved by Ansible.</a></li>
    <li><a href="#this-actually-needs-a-shell-script">This actually needs a shell script</a></li>
    <li><a href="#enter-deploy-a-python-cli-application">Enter <code>deploy</code>, a Python CLI application</a></li>
    <li><a href="#it-is-still-ugly">It is still ugly</a></li>
  </ul>
</nav>
				</header>
				
			</div>
			<div class='col-lg-8'>
				<p>We are still playing minecraft.
This time it is a highly modded Fabric server, which requires more memory than the old box had.
The new box has 12 cores, 128 GB of memory, and two nice SSD.
It is pretty nifty.</p>
<h1 id="a-simple-problem-easily-solved-by-ansible">
    <a href="#a-simple-problem-easily-solved-by-ansible">
	A simple problem, easily solved by Ansible.
    </a>
</h1>
<p>The machine also needs some kind of webserver to run websites.
An easy problem to solve, naturally.</p>
<p>A bit of Ansible, deploy a few config files into the system and be done with it.</p>
<p>Only, these are different types of websites, and over time additional sites are being added.
When a new website is being added, we need to collect all website names
and generate an
<a href="https://httpd.apache.org/docs/2.4/mod/mod_md.html#mdomain" target="_blank" rel="noopener"><code>MDomain</code></a>


statement in the config for Apache&rsquo;s
<a href="https://httpd.apache.org/docs/2.4/mod/mod_md.html" target="_blank" rel="noopener"><code>mod_md</code></a>

.
This module will then automatically request the necessary certificates for the webserver&rsquo;s TLS.</p>
<p>Collecting all domain names from the configuration files can be done in Ansible, but it kind of hurts.
Ansible works best when you run it to deploy a few templated config files, and then have services doing the actual work.</p>
<p>It is also more complicated than this, because we have different types of websites.
Initially we had only</p>
<ul>
<li><code>static sites</code> (<code>https://example.com</code>)</li>
<li>We also needed <code>redirect_sites</code> (<code>https://www.example.com</code> -&gt; <code>https://example.com</code>)</li>
<li>We also needed reverse proxies for applications (<code>https://grafana.example.com</code> -&gt; <code>https://localhost:3000</code>)</li>
<li>We also need a Discord bot.</li>
<li>Then we also needed the <code>wsgi_site</code> deployed.</li>
</ul>
<p>But a <code>wsgi_site</code> needs to be redeployed when the code has changed on GitHub.
Also, initial deployment of a <code>wsgi_site</code> needs to create a user,
and initial checkout of the code into the users home,
and installation of the requirements.</p>
<p>After a code update, the server needs to be restarted.</p>
<h1 id="this-actually-needs-a-shell-script">
    <a href="#this-actually-needs-a-shell-script">
	This actually needs a shell script
    </a>
</h1>
<p>Okay, let&rsquo;s not do this in Ansible.
Let&rsquo;s write a simple and easy shell script for this.</p>
<p>That kind of worked, initially, but quickly fell apart when the number of variants grew,
also error checking became complicated.</p>
<p>Ultimately, it broke when we needed to collect and store per-site config parameters as a JSON, and act on it.
The moment you write shell functions with parameters, traps and other bells and whistles,
it is time to cut your losses and start over differently.
In this case, in Python.</p>
<h1 id="enter-deploy-a-python-cli-application">
    <a href="#enter-deploy-a-python-cli-application">
	Enter <code>deploy</code>, a Python CLI application
    </a>
</h1>
<p>In the current intermediate stage, this is a Python script of 32 KB and around 1000 lines.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@bigbox ~<span class="o">]</span><span class="c1"># wc -l Source/deploy/deploy </span>
</span></span><span class="line"><span class="cl"><span class="m">951</span> Source/deploy/deploy
</span></span></code></pre></div><p>and</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@bigbox ~<span class="o">]</span><span class="c1">#  ls -l Source/deploy/deploy</span>
</span></span><span class="line"><span class="cl">-rwxr-xr-x. <span class="m">1</span> root root <span class="m">31428</span> Jan  <span class="m">8</span> 18:42 Source/deploy/deploy
</span></span></code></pre></div><p>It understands the five types of server outlined above, and can handle a number of different operations for them.</p>
<ul>
<li><code>create</code> makes a new server-config.</li>
<li><code>delete</code> throws it away.</li>
</ul>
<p>We store them in a central directory, <code>/etc/projects</code>, as JSON files.
For each site type, we accept a number of parameters:</p>
<ul>
<li><code>--type</code>, the five types above.</li>
<li><code>--username</code>, a Unix User we create for the site.</li>
<li><code>--github</code> The source code repository URL.</li>
<li><code>--hostname</code> If necessary, this is inferred from the username and the default domain.</li>
<li><code>--projectdir</code> Only necessary for anomalously structured Python code.</li>
<li><code>--to_host</code> Only for redirects.</li>
<li><code>--port</code> Only for proxies.</li>
</ul>
<p>We now can do</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># deploy show projects</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">- grafana
</span></span><span class="line"><span class="cl">- learn
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># deploy show grafana</span>
</span></span><span class="line"><span class="cl">*** PROJECT /etc/projects/grafana
</span></span><span class="line"><span class="cl">- github    : None
</span></span><span class="line"><span class="cl">- hostname  : grafana.example.com
</span></span><span class="line"><span class="cl">- port      : <span class="m">3000</span>
</span></span><span class="line"><span class="cl">- project   : grafana
</span></span><span class="line"><span class="cl">- <span class="nb">type</span>      : proxy
</span></span></code></pre></div><p>The <code>deploy create --type proxy --hostname grafana.example.com --port 3000</code> has created an apache configuration,
built the TLS configuration and restarted the <code>httpd.service</code> to update things.</p>
<p>We can also do more complicated things:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># deploy create --type wsgi_site --user learn --github ... learn</span>
</span></span><span class="line"><span class="cl">... creates /etc/project/learn
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># deploy show learn</span>
</span></span><span class="line"><span class="cl">*** PROJECT /etc/projects/learn
</span></span><span class="line"><span class="cl">- github    : git@github.com:.../learn.git
</span></span><span class="line"><span class="cl">- home      : /home/learn
</span></span><span class="line"><span class="cl">- hostname  : learn.example.com
</span></span><span class="line"><span class="cl">- project   : learn
</span></span><span class="line"><span class="cl">- projectdir: learn
</span></span><span class="line"><span class="cl">- pubkey    : ssh-rsa AAAAB3...cfudtTQ<span class="o">==</span> root@bigbox
</span></span><span class="line"><span class="cl">- <span class="nb">type</span>      : wsgi_site
</span></span><span class="line"><span class="cl">- username  : learn
</span></span></code></pre></div><p>This will create a Linux user, set up a checkout of the GitHub, install requirements, set up a WSGI Apache configuration,
configure TLS, and restart the server as needed.</p>
<p>We can now <code>deploy update learn</code> or <code>deploy restart learn</code> to check out a new version and restart the server,
and we can also <code>deploy logs learn</code> to tail the server logs for this site.</p>
<h1 id="it-is-still-ugly">
    <a href="#it-is-still-ugly">
	It is still ugly
    </a>
</h1>
<p>Because this started out as a shell script, it still is ugly.
There are multiple levels of giant case-branches in this.
To become a proper solution, it needs a cleaner structure, in a more object-oriented fashion.</p>
<p>But already it works better than the shell script it initially was,
has better error handling and can handle borderline cases more safely.</p>
<p><a href="https://github.com/isotopp/deploy" target="_blank" rel="noopener">Github</a>

.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#linux" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				linux
				</a>
				
				<a href="/tags/#devops" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				devops
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2024-01-09-deploying-websites.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/12/30/restic.html">Restic</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2024/01/16/jusprog-ist-nur-der-anfang.html">JusProg ist nur der Anfang</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
