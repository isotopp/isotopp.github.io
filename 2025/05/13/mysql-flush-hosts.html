<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: FLUSH HOSTS | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2025/05/13/mysql-flush-hosts.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.147.9">
<meta property="og:title" content='MySQL: FLUSH HOSTS | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2025/05/13/mysql-flush-hosts.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2025-05-13T05:06:07Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: FLUSH HOSTS' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.c8765aadab442b801a90f4dd31571e4fb141c60e6f986484fc8faf9b68e4116b.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-flush-hosts-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: FLUSH HOSTS
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>May 13, 2025</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2025/04/06/thermometer.html">Thermometer</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2025/06/04/recommended.html">Recommended</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
				<header class="toc bg-light">
					<nav id="TableOfContents">
  <ul>
    <li><a href="#max_connect_errors"><code>max_connect_errors</code></a></li>
    <li><a href="#unblocking">Unblocking</a></li>
    <li><a href="#the-host-cache-is-not-a-cache">The Host Cache is not a cache</a></li>
    <li><a href="#what-happens-on-connection">What Happens on Connection</a></li>
    <li><a href="#recommendations-for-proxy-and-k8s-users">Recommendations for Proxy and K8s users</a></li>
  </ul>
</nav>
				</header>
				
			</div>
			<div class='col-lg-8'>
				<p>Sometimes, MySQL throws an error like this:</p>
<blockquote>
<p>Host &lsquo;&hellip;&rsquo; is blocked because of many connection errors</p>
<p>Unblock with &lsquo;mysqladmin flush-hosts&rsquo;</p></blockquote>
<p>This typically means that MySQL has blocked a host after too many connection errors. The usual fix is to run:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mysqladmin flush-hosts
</span></span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">FLUSH</span><span class="w"> </span><span class="n">HOSTS</span><span class="p">;</span><span class="w"> </span><span class="cm">/* deprecated since 8.0.23; invalid in 8.4 */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">host_cache</span><span class="p">;</span><span class="w"> </span><span class="cm">/* recommended since 5.6.5 */</span><span class="w">
</span></span></span></code></pre></div><p>A host is blocked, because of many connection errors, specifically more connection errors than <code>max_connect_errors</code>.</p>
<p>So</p>
<ul>
<li>what counts as a connection error?</li>
<li>what is counted per what?</li>
<li>and how is the error count cleared?</li>
</ul>
<h1 id="max_connect_errors">
    <a href="#max_connect_errors">
	<code>max_connect_errors</code>
    </a>
</h1>
<p>There is a configuration variable, <code>max_connect_errors</code>.
It is documented here:
<a href="https://dev.mysql.com/doc/refman/8.4/en/server-system-variables.html#sysvar_max_connect_errors" target="_blank" rel="noopener">MySQL 8.4: <code>max_connect_errors</code></a>

.</p>
<p>The variable is a 64 bit integer, so it can be set to very large values.
It can be configured via command-line or config file (using dashes instead of underscores), or dynamically at runtime:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="kt">SET</span><span class="w"> </span><span class="n">GLOBAL</span><span class="w"> </span><span class="n">max_connect_errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18446744073709551614</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>Check it with</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">@@</span><span class="n">global</span><span class="p">.</span><span class="n">max_connect_errors</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>By default, it’s set to 100.</p>
<p>According to MySQL’s documentation,
a host is blocked after more than <code>max_connect_errors</code> connection attempts from that host fail without a successful connection in between.</p>
<p>This means:</p>
<ul>
<li>The error count is tracked per host.</li>
<li>A successful connection resets the counter, but only if it happens before the threshold is exceeded.</li>
<li>Once blocked, a host remains blocked indefinitely unless the cache is cleared.</li>
</ul>
<h1 id="unblocking">
    <a href="#unblocking">
	Unblocking
    </a>
</h1>
<p>MySQL tracks blocked hosts using a structure called the host cache.</p>
<p>Before MySQL 5.6.5, there was no way to inspect the host cache.
You could run <code>FLUSH HOSTS</code> to reset it, but you couldn’t see which hosts were blocked or how many errors they had.</p>
<p>That was lamented by many people, among them yours truly <a href="https://bugs.mysql.com/bug.php?id=24906" target="_blank" rel="noopener">in 2006</a>

.
And Daniel van Eeden <a href="https://bugs.mysql.com/bug.php?id=59404" target="_blank" rel="noopener">in 2011</a>

, on behalf of Booking.com.
That was converted into <a href="https://dev.mysql.com/worklog/task/?id=5259" target="_blank" rel="noopener">ML#5259</a>

,
the implementation of <code>PERFORMANCE_SCHEMA.HOST_CACHE</code>.
It was implemented by Marc Alff starting in 7e3ba778349e8e2bd01b60d6b22f44f7f098d731 in 2-Aug 2011
(released in 5.6.5, after 29-Mar-2012).</p>
<p>Since then, you can query host cache details directly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">host_cache</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>You can also reset it with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">TRUNCATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">host_cache</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>This works exactly like <code>FLUSH HOSTS</code>, but uses different permissions:</p>
<ul>
<li><code>FLUSH HOSTS</code> requires the <code>RELOAD</code> privilege.</li>
<li><code>TRUNCATE TABLE performance_schema.host_cache</code> requires <code>DROP</code> privilege on that table.</li>
</ul>
<p><strong>Note:</strong> <code>FLUSH HOSTS</code> has been <strong>deprecated as of MySQL 8.0.23 and is removed in MySQL 8.4.</strong></p>
<p>There is no way to unblock just one host—only clearing the entire host cache resets the counters and unblocks all hosts.</p>
<p><strong>Note:</strong> Changing the host cache size using the <code>host_cache_size</code> global dynamic variable also flushes the host cache.
This requires the <code>SYSTEM_VARIABLES_ADMIN</code> privilege (formerly <code>SUPER</code>).</p>
<h1 id="the-host-cache-is-not-a-cache">
    <a href="#the-host-cache-is-not-a-cache">
	The Host Cache is not a cache
    </a>
</h1>
<p>Despite its name, the host cache does more than traditional caching.</p>
<p>A cache is a data structure that stores unchanging data locally, because retrieving the data again would be expensive.
A cache can be expired or fully deleted at any time without losing information,
because the original information can be (at cost) retrieved again.</p>
<p>But MySQL’s host cache stores stateful data—specifically, security-related error counters.
Deleting a host cache entry removes:</p>
<ul>
<li>the ip-to-hostname mapping (which can be rebuilt)</li>
<li>the host&rsquo;s connection error history (which can&rsquo;t)</li>
</ul>
<p>This means that resetting the host cache has security implications.
That is increasingly unimportant in modern environments
such as K8s clusters or virtualized environments with a control plane and a service mesh.
In other, more traditional environments it might not be.</p>
<h1 id="what-happens-on-connection">
    <a href="#what-happens-on-connection">
	What Happens on Connection
    </a>
</h1>
<p>When a client connects, MySQL runs <code>sql_connect.cc:check_connection()</code>, which checks the client’s IP address.</p>
<p>If <code>name-resolve</code> is enabled, which it is unless you run with <code>skip-name-resolve</code>,
MySQL attempts a reverse DNS lookup via <code>hostname_cache.cc:ip_to_hostname()</code>:</p>
<ul>
<li>If the IP is already in the host cache and marked valid, DNS lookup is skipped.</li>
<li>Otherwise, MySQL tries to resolve the IP to a hostname (PTR record),
then resolve the hostname back to an IP (A record).
This is known as Forward Confirmed Reverse DNS (FCR).</li>
<li>Only hostnames that pass both lookups are marked as &ldquo;validated&rdquo;.</li>
</ul>
<p>The host cache keeps track of connection errors in <code>ip_to_hostname()</code>
and will block the host if it exceeds the threshold set in <code>max_connect_errors</code>.</p>
<p>The function also uses the host cache itself, and will avoid DNS resolution if there is an entry that matches this IP.
It maintains error counts and will perform host blocking, if the error count exceeds <code>max_connect_errors</code>.</p>
<p>The cache uses LRU (Least Recently Used) eviction policy.
If more IPs try to connect than the cache can hold, old entries are removed—including their error counters.
This means that blocked hosts can become unblocked over time if they’re evicted.</p>
<p>Modern MySQL defaults host_cache_size to <code>-1</code>, which means it auto-sizes between 128 and 2000 based on <code>max_connections</code>.
In older versions the size was fixed.</p>
<p>None of the above will happen if the server is running with <code>skip-name-resolve</code>.</p>
<p>Specifically, the code in <code>sql_connect.cc:check_connection()</code> will, among other things, not even call <code>ip_to_hostname()</code>,
thus there will be no usage of the host cache, as no DNS resolution happens.
There will also be no blocking of hosts due to connection errors.</p>
<h1 id="recommendations-for-proxy-and-k8s-users">
    <a href="#recommendations-for-proxy-and-k8s-users">
	Recommendations for Proxy and K8s users
    </a>
</h1>
<p><strong>TIP:</strong> Run <code>SHOW PROCESSLIST</code> multiple times, and check the visible connections.
If they are all always the same host, this recommendation applies to you.</p>
<p>You may be running MySQL in Kubernetes with a service mesh,
or you may be running MySQL with MySQL Router or MySQL Proxy.
In that case, all connections the server sees will originate from a single IP.</p>
<p>That means any error by any client will be attributed to the only IP the server sees.
Any single client running with a wrong password will block the only IP your system sees with failed login attempts.
It will lock out all users for all applications with no timeout.</p>
<blockquote>
<p>If the origin IP is <code>127.0.0.1</code> or <code>[::1]</code>, no entry in the host cache will be made,
as these addresses are specifically checked for, and are exempt.<br>
<strong>You do not need to act.</strong></p></blockquote>
<p>If that IP number is fixed, but not one of these two special local addresses,
you <strong>SHOULD</strong> turn off <code>name-resolve</code> by running with <code>skip-name-resolve</code>.</p>
<ul>
<li>This will disable the DNS resolution.</li>
<li>You now need to write access control entries with IP numbers
(<code>GRANT ... TO user@32.16.8.4 ...</code>),
because names will no longer be resolved.</li>
<li>Your server will no longer make DNS queries.</li>
<li>No host blocking on IP will occur.
You will be protected from clients hammering the server with a wrong password.</li>
<li>You are not losing anything security-wise, as the server has no useful IP information anyway.
Security must be handled by the service mesh.</li>
</ul>
<p>You <strong>COULD</strong> also set the <code>host-cache-size=0</code> for the same effect, but that will still generate DNS queries,
and a lot of them (two, PTR and A, per connection attempt).
They will always be for that single IP, so they are easily cacheable in external caches.</p>
<p>You <strong>SHOULD</strong> set <code>max_connect_errors</code> to a large value (<code>2^64-1</code>) to prevent the host cache from locking out any host.
This has no additional benefits over running with <code>skip-name-resolve</code>: There will be only one host cache entry,
and there will be no per-host error counters, as all connections are seemingly coming from a single host.</p>
<p>All these measures are compatible, and you can deploy all three of them.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				database
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2025-05-13-mysql-flush-hosts.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2025/04/06/thermometer.html">Thermometer</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2025/06/04/recommended.html">Recommended</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
