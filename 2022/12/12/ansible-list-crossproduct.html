<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Ansible: List Cross-Join | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2022/12/12/ansible-list-crossproduct.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Ansible: List Cross-Join | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2022/12/12/ansible-list-crossproduct.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2022-12-12T21:22:23Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Ansible: List Cross-Join' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="ansible-list-cross-join-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Ansible: List Cross-Join
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>December 12, 2022</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/12/11/chatgpt-and-limits.html">ChatGPT and Limits</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/12/22/tying-the-bi-pipeline-together.html">Tying the BI pipeline together</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>A friend asked in Discord:</p>
<blockquote>
<p>I need a pointer to a solution in Jinja.</p>
<p>Given two lists, <code>x: [a,b,c]</code> and <code>y: [d,e,f]</code>, I need the cross-join <code>[&quot;a.d&quot;,&quot;a.e&quot;,&quot;a.f&quot;,&quot;b.d&quot;,…,&quot;c.e&quot;,&quot;c.f&quot;]</code>.
I know how to cross-join, but that then is a list of lists, and I want join the inner lists.</p></blockquote>
<p>After some experimentation the result was a set of nasty templating loops.
There has to be a better way.</p>
<p>There are two:</p>
<h1 id="ansible-custom-filters-in-python">
    <a href="#ansible-custom-filters-in-python">
	Ansible Custom Filters in Python
    </a>
</h1>
<h2 id="playbook">
    <a href="#playbook">
	Playbook
    </a>
</h2>
<p>We want a custom filter <code>cross</code>, which produces the desired result.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># $ cat testing/myfilter.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Keks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">x</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;b&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;c&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">y</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;d&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;e&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;f&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Keks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ x| cross(y) }}&#34;</span><span class="w">
</span></span></span></code></pre></div><h2 id="desired-output">
    <a href="#desired-output">
	Desired Output
    </a>
</h2>
<p>The playbook shall produce this output</p>
<pre tabindex="0"><code>PLAY [Keks] ********************************************************************

TASK [Keks] ********************************************************************
ok: [localhost] =&gt; {
    &#34;msg&#34;: [
        &#34;a.d&#34;,
        &#34;a.e&#34;,
        &#34;a.f&#34;,
        &#34;b.d&#34;,
        &#34;b.e&#34;,
        &#34;b.f&#34;,
        &#34;c.d&#34;,
        &#34;c.e&#34;,
        &#34;c.f&#34;
    ]
}

PLAY RECAP *********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
</code></pre><h2 id="creating-a-custom-filter">
    <a href="#creating-a-custom-filter">
	Creating a custom filter
    </a>
</h2>
<p>For that, we need a directory <code>filter_plugins</code> next to the playbook (or in the role directory next to the <code>tasks</code> directory).
Inside that directory, we place a Python file <code>cross.py</code>, which will contain our custom filter code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ tree testing/
</span></span><span class="line"><span class="cl">testing/
</span></span><span class="line"><span class="cl">├── filter_plugins
</span></span><span class="line"><span class="cl">│   └── cross.py
</span></span><span class="line"><span class="cl">└── myfilter.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> directory, <span class="m">2</span> files
</span></span></code></pre></div><p>The file <code>cross.py</code> looks like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="hl"><span class="lnt"> 8
</span></span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="hl"><span class="lnt">11
</span></span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="hl"><span class="lnt">21
</span></span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#! /usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FilterModule</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">                <span class="s1">&#39;cross&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">    <span class="k">def</span> <span class="nf">cross</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sepchar</span><span class="o">=</span><span class="s2">&#34;.&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;parameter1 is not an Iterable&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&#34;parameter2 is not an Iterable&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sepchar</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;parameter3  is not a string&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">        <span class="n">z</span> <span class="o">=</span> <span class="p">[</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">i</span><span class="si">}{</span><span class="n">sepchar</span><span class="si">}{</span><span class="n">j</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">y</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">z</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This defines a class <code>FilterModule</code> with a method <code>filters()</code>.
The names are prescribed, and cannot be changed.</p>
<p>In the <code>filters()</code> method we are to return a dictionary with pairs of Jinja2 templating filter name (we want <code>cross</code>) and matching Python function or method reference (that is, the name a callable without parameter parentheses attached).
In our example, we map the Jinja2 filter <code>cross</code> to the method <code>self.cross()</code> in our Python class (Line 8).</p>
<p>The actual <code>cross()</code> method is in Line 11. It takes 2 mandatory parameters, <code>x</code> and <code>y</code> and an optional parameter <code>sepchar</code>.
The first two parameters <code>x</code> and <code>y</code> are supposed to be Lists or other Iterables that are to be cross-joined.
We expressly prohibit strings, because they are iterable by character, but that is likely not what we want.</p>
<p>The third parameter <code>sepchar</code> is the separator character we are putting between these joined pairs.
It defaults to <code>.</code> (dot) and can be left out.</p>
<p>The actual work is done in Line 21 after the error checks.
We produce a list, which we return.</p>
<p>We can test with</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ansible-playbook testing/myfilter.yml
</span></span></code></pre></div><p>which indeed produces the desired output.</p>
<h1 id="ansible-solution-with-native-filters">
    <a href="#ansible-solution-with-native-filters">
	Ansible solution with native filters
    </a>
</h1>
<p>My friend had objections to shipping custom filters with a role.
So here is a solution that uses no loops and only native filters.</p>
<p>We can use the Jinja2 default filter <code>product</code> to create a cross product:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl">- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Keks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">gather_facts</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">vars</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">x</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;a&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;b&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;c&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">y</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&#34;d&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;e&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;f&#34;</span><span class="w"> </span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">keks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">set_fact</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">z</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ x|product(y) }}&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">Keks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">debug</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{ z }}&#34;</span><span class="w">
</span></span></span></code></pre></div><p>But this produces the list of lists mentioned in the beginning.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">PLAY [Keks] ********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">TASK [keks] ********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="go">ok: [localhost]
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">TASK [Keks] ********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="go">ok: [localhost] =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="go">    &#34;msg&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="go">        [
</span></span></span><span class="line"><span class="cl"><span class="go">            &#34;a&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">            &#34;d&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">        ],
</span></span></span><span class="line"><span class="cl"><span class="go">        [
</span></span></span><span class="line"><span class="cl"><span class="go">            &#34;a&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">            &#34;e&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">        ],
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><p>We can use <code>z: &quot;{{ x|product(y)|map('join') }}&quot;</code> to produce the pairs we want:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">TASK [Keks] ********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="go">ok: [localhost] =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="go">    &#34;msg&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;ad&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;ae&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;af&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;bd&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;be&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;bf&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;cd&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;ce&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;cf&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">    ]
</span></span></span><span class="line"><span class="cl"><span class="go">}
</span></span></span></code></pre></div><p>But we need to pass a parameter to <code>join()</code>, because we want a <code>.</code> separator character.
This is done by adding this parameter after the function to be mapped.
So we need <code>z: &quot;{{ x|product(y)|map('join','.') }}&quot;</code> for our solution.</p>
<p>The run results in</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">TASK [Keks] ********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="go">ok: [localhost] =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="go">    &#34;msg&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;a.d&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;a.e&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;a.f&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;b.d&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;b.e&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;b.f&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;c.d&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;c.e&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;c.f&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">    ]
</span></span></span><span class="line"><span class="cl"><span class="go">}
</span></span></span></code></pre></div><p>which is what we wanted.</p>
<h1 id="the-actual-problem">
    <a href="#the-actual-problem">
	The actual problem
    </a>
</h1>
<p>The actual problem looks like this, but in a single line:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">{%- for host in hosts -%}
</span></span></span><span class="line"><span class="cl"><span class="go">  {%- for domain in domains -%}
</span></span></span><span class="line"><span class="cl"><span class="go">    {{proto}}://{{ host }}.{{ domain }}:{{port}}{{ &#34;, &#34; if not loop.last }}
</span></span></span><span class="line"><span class="cl"><span class="go">  {%- endfor -%}
</span></span></span><span class="line"><span class="cl"><span class="go">  {{ &#34;, &#34; if not loop.last }}
</span></span></span><span class="line"><span class="cl"><span class="go">{%- endfor -%} 
</span></span></span></code></pre></div><p>The replacement with native functions looks like this, again in a single line:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">{{ [proto] | 
</span></span></span><span class="line"><span class="cl"><span class="go">    product(hosts |
</span></span></span><span class="line"><span class="cl"><span class="go">        product(domains) |
</span></span></span><span class="line"><span class="cl"><span class="go">        map(&#39;join&#39;,&#39;.&#39;)
</span></span></span><span class="line"><span class="cl"><span class="go">    ) | map(&#39;join&#39;,&#39;://&#39;) |
</span></span></span><span class="line"><span class="cl"><span class="go">    product([port])|
</span></span></span><span class="line"><span class="cl"><span class="go">   map(&#39;join&#39;,&#39;:&#39;)|
</span></span></span><span class="line"><span class="cl"><span class="go">   join(&#34;, &#34;) 
</span></span></span><span class="line"><span class="cl"><span class="go">}}
</span></span></span></code></pre></div><p>Using <code>cross()</code> it is a lot less ugly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">proto | cross(hosts,&#39;://&#39;) | cross(domains) | cross(port,&#39;:&#39;)
</span></span></span></code></pre></div><p>If <code>proto</code> or <code>port</code> are scalar, write them as <code>[proto]</code> and <code>[port]</code> to keep the syntax.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">- name: Keks
</span></span></span><span class="line"><span class="cl"><span class="go">  hosts: localhost
</span></span></span><span class="line"><span class="cl"><span class="go">  gather_facts: false
</span></span></span><span class="line"><span class="cl"><span class="go">  vars:
</span></span></span><span class="line"><span class="cl"><span class="go">    hosts: [ &#34;hosta&#34;, &#34;hostb&#34;, &#34;hostc&#34; ]
</span></span></span><span class="line"><span class="cl"><span class="go">    domains: [ &#34;domaina.net&#34;, &#34;domainb.com&#34;, &#34;domainc.org&#34; ]
</span></span></span><span class="line"><span class="cl"><span class="go">    proto: &#34;https&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">    port: &#34;8443&#34;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">  tasks:
</span></span></span><span class="line"><span class="cl"><span class="go">    - name: Keks
</span></span></span><span class="line"><span class="cl"><span class="go">      debug:
</span></span></span><span class="line"><span class="cl"><span class="go">        msg: &#34;{{ [proto]|cross(hosts,&#39;://&#39;)|cross(domains)|cross([port],&#39;:&#39;) }}&#34;
</span></span></span></code></pre></div><p>yields</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">TASK [Keks] ********************************************************************
</span></span></span><span class="line"><span class="cl"><span class="go">ok: [localhost] =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="go">    &#34;msg&#34;: [
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hosta.domaina.net:8443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hosta.domainb.com:8443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hosta.domainc.org:8443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hostb.domaina.net:8443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hostb.domainb.com:8443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hostb.domainc.org:8443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hostc.domaina.net:8443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hostc.domainb.com:8443&#34;,
</span></span></span><span class="line"><span class="cl"><span class="go">        &#34;https://hostc.domainc.org:8443&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">    ]
</span></span></span><span class="line"><span class="cl"><span class="go">}
</span></span></span></code></pre></div><h1 id="summary">
    <a href="#summary">
	Summary
    </a>
</h1>
<p>With a short, concise and type-safe Python function that can be shipped as part of the role, we solved the original problem.
We can produce the solution in a single, rather readable line instead of deeply nesting function calls, or worse,
a bunch of templating loops.</p>
<p>Debugging and testing of the Python function can be done with the full power of our Python tooling,
instead of messing with an un-debuggable and untestable DSL.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#devops" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				devops
				</a>
				
				<a href="/tags/#python" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				python
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2022-12-12-ansible-list-crossproduct.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/12/11/chatgpt-and-limits.html">ChatGPT and Limits</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/12/22/tying-the-bi-pipeline-together.html">Tying the BI pipeline together</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
