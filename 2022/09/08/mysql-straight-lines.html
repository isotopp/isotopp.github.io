<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Straight lines | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2022/09/08/mysql-straight-lines.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Straight lines | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2022/09/08/mysql-straight-lines.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2022-09-08T12:13:00Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Straight lines' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-straight-lines-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Straight lines
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>September 8, 2022</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/09/02/mysql-yolo-mode.html">MySQL: YOLO mode</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/09/14/artifactory-conclusion.html">MySQL: Artifactory Conclusion</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>A database is showing replication delay, and so are all the other instances of the same replication hierarchy, all of which reside in Openstack.</p>
<p><p class="md__image">
  <img src="/uploads/2022/09/straight-01.png" alt=""  />
</p>

</p>
<p><em>Shortly before 21:30 the database begins to lag, until around 23:45, when it starts to catch up, slowly. After 00:30, we gain delay again, plateau and then around 01:45, we catch up.</em></p>
<p>The database is moving deep into replication delay sometimes.
It does not do that on bare metal.</p>
<h1 id="ground-truth">
    <a href="#ground-truth">
	Ground Truth
    </a>
</h1>
<p>The VM is a nice hardware blade simulation, 16C/32T, 128 GB of memory.</p>
<p>The data is on persistent volume backed by Ceph.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> df -Th /mysql/&lt;hierarchyname&gt;/
</span></span><span class="line"><span class="cl"><span class="go">Filesystem                Type  Size  Used Avail Use% Mounted on
</span></span></span><span class="line"><span class="cl"><span class="go">/dev/mapper/vg00-mysqlVol xfs   1.8T  1.1T  766G  58% /mysql/&lt;hierarchyname&gt;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> vgs
</span></span><span class="line"><span class="cl"><span class="go">  VG    #PV #LV #SN Attr   VSize VFree
</span></span></span><span class="line"><span class="cl"><span class="go">  sysvm   1   8   0 wz--n- 1.75t 121.27g
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> du -sh /mysql/&lt;hierarchyname&gt;/*
</span></span><span class="line"><span class="cl"><span class="go">0       /mysql/&lt;hierarchyname&gt;/coredumps
</span></span></span><span class="line"><span class="cl"><span class="go">1017G   /mysql/&lt;hierarchyname&gt;/data
</span></span></span><span class="line"><span class="cl"><span class="go">24G     /mysql/&lt;hierarchyname&gt;/log
</span></span></span><span class="line"><span class="cl"><span class="go">0       /mysql/&lt;hierarchyname&gt;/tmp
</span></span></span></code></pre></div><p>This database does not fit into the buffer pools:
The working set is too large.
We see read traffic in a warmed up database, at a rate of several dozen MB/s.</p>
<p>Checking in on <code>information_schema.tables</code>, the two largest tables of this database are around 200 GB in size, each.
They seem to be accessed in full, there is little or no exploitable locality of reference.
So in order to quench these reads, we would need to supply three times the memory, 384 GB.
Since we can&rsquo;t, we need to handle the I/O instead.</p>
<p>Let&rsquo;s have a look at the I/O:
When you run iostat, use <code>iostat -x -k 10</code>, and discard the first output.
It contains the data collected since system boot, a very large average interval.
We want a clean 10s sample instead.</p>
<p>The paste:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">Device            r/s     w/s     rMB/s     wMB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util
</span></span></span><span class="line"><span class="cl"><span class="go">sdc           4302.00  348.00     67.22      1.22     0.00     0.00   0.00   0.00    1.24    1.91   6.00    16.00     3.58   0.21  99.70
</span></span></span><span class="line"><span class="cl"><span class="go">sdb              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00
</span></span></span><span class="line"><span class="cl"><span class="go">sda              0.00    4.00      0.00      0.02     0.00     0.00   0.00   0.00    0.00    2.50   0.01     0.00     4.00   2.75   1.10
</span></span></span><span class="line"><span class="cl"><span class="go">loop0            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00
</span></span></span><span class="line"><span class="cl"><span class="go">dm-0          4304.00  347.00     67.25      1.21     0.00     0.00   0.00   0.00    1.24    1.93   6.02    16.00     3.58   0.21  99.70
</span></span></span></code></pre></div><p>We see the busy drive being sdc, the persistent volume.
We see increased service times (<code>r_await</code>, unit ms), and queues (<code>aqu-sz</code>, unit is &ldquo;average number of requests in  queue, during the observation interval&rdquo;, which is 10s).</p>
<p>We also see around 4300 read requests/s and 67 MB/s read traffic.</p>
<h1 id="i-know-that-smell">
    <a href="#i-know-that-smell">
	I know that smell
    </a>
</h1>
<p>Some previous experience in other projects suggests that a crucial piece of information may be missing.
This replication chain is no longer on bare metal, but is running on Openstack.
All traffic to disk in Openstack is quota-ed.</p>
<p>Any I/O problem on Openstack is undebuggable, unless you know the Quota affecting you.
Indeed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> openstack volume qos show &lt;uuid&gt;
</span></span><span class="line"><span class="cl"><span class="go">+--------------+----------------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| Field        | Value                                              |
</span></span></span><span class="line"><span class="cl"><span class="go">+--------------+----------------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="go">| associations | standard-iops                                      |
</span></span></span><span class="line"><span class="cl"><span class="go">| consumer     | front-end                                          |
</span></span></span><span class="line"><span class="cl"><span class="go">| id           | &lt;uuid&gt;                                             |
</span></span></span><span class="line"><span class="cl"><span class="go">| name         | 200MB/s-3000iops                                   |
</span></span></span><span class="line"><span class="cl"><span class="go">| properties   | total_bytes_sec=&#39;209715200&#39;, total_iops_sec=&#39;3000&#39; |
</span></span></span><span class="line"><span class="cl"><span class="go">+--------------+----------------------------------------------------+
</span></span></span></code></pre></div><p>We have an allowance for a maximum of 200 MB/s and a maximum of 3000 IOPS.
Measured in the system we see an ok bandwidth of 67 MB/s, but the IOPS hit the roof.</p>
<p>When we zoom in on a phase of replication delay in the Single Instance Info Panel of our grafana, we get to the bottom of that straight away.</p>
<p>Replication delay interval:</p>
<p><p class="md__image">
  <img src="/uploads/2022/09/straight-01.png" alt=""  />
</p>

</p>
<p>At the same time:</p>
<p><p class="md__image">
  <img src="/uploads/2022/09/straight-02.png" alt=""  />
</p>

</p>
<p>When we have replication delay, we see a straight line in the sum of dm-reads for 70-ish MB/s.
This is well below quota.</p>
<p>Looking at the IOPS:</p>
<p><p class="md__image">
  <img src="/uploads/2022/09/straight-03.png" alt=""  />
</p>

</p>
<p>This is the sum of all dm-Reads, and we only are interested in the reads for our device.
But we do see a straight line, and that suggests some kind of limit or resource exhaustion.
Also, the line is at around 4000 read/s versus a Quota of 3000 IOPS.
Together that suggest we run into resource depletion in the IOPS dept here.</p>
<p>Is that bad?</p>
<p><p class="md__image">
  <img src="/uploads/2022/09/straight-04.png" alt=""  />
</p>

</p>
<p>The observed statement latency for the production user goes up from a minimum 348 ms to a max of 37100 ms (37.1s).
That is approximately 100x worse than normal.</p>
<p>The observed statement latency is also jumping rapidly up and down.
System performance is not only bad, but also wildly unpredictable, with high frequency swings across a wide corridor.</p>
<p>This is often indicative of a token bucket quota mechanism getting into resonance with the evaluation cycle of the token bucket itself:</p>
<p>Load is running away and then then Quota eval check cycle comes and bites down hard on the system over quota, essentially halting it.
The system stops, because a database without I/O is doing nothing.
It then accumulates new performance tokens in the token bucket, and in the next cycle executes, immediately draining the token pool and running over Quota.
Then the cycle repeats.</p>
<p>Maybe it is less noisy if the quota is applied with <code>consumer=backend</code>.</p>
<p>All expectations the user may have on performance are broken and the system may as well be offline.
Also, the variance in performance may create input signal spikes on dependent systems, affecting their performance if there is resonance.</p>
<p>Without being aware of Quota limits and checking for them this is nearly undebuggable, and sometimes you may be looking at secondary effects downstream of the affected system.
With proper metrics and knowledge of the Quota it is plain obvious.</p>
<h1 id="be-wary-of-straight-lines-in-performance-graphs">
    <a href="#be-wary-of-straight-lines-in-performance-graphs">
	Be wary of straight lines in performance graphs
    </a>
</h1>
<blockquote>
<p>Load is spiky, straight lines do not exist</p>
<p>This is a general truth for our systems:
In general our load is spiky.
It has peaks and valleys, and there are no plateaus or straight lines (outside of Kafka and other Queues and the systems fed by them).</p>
<p>That is, if you see a straight line, I see a resource being exhausted and limiting system performance.</p></blockquote>
<p>In this case, the exhausted resource is IOPS quota.</p>
<p>In other cases in the past, a straight line in dirty buffer pool pages graph was signaling exhaustion of the redo log space, or similar performance choke points.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2022-09-08-mysql-straight-lines.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/09/02/mysql-yolo-mode.html">MySQL: YOLO mode</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/09/14/artifactory-conclusion.html">MySQL: Artifactory Conclusion</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
