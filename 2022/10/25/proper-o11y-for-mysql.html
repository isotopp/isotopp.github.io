<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Proper O11y for MySQL | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2022/10/25/proper-o11y-for-mysql.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Proper O11y for MySQL | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2022/10/25/proper-o11y-for-mysql.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2022-10-18T06:07:08Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Proper O11y for MySQL' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="proper-o11y-for-mysql-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Proper O11y for MySQL
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>October 25, 2022</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/10/18/software-supply-chain-issues.html">Software Supply Chain Issues</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/11/07/bandwidth-iops-and-latency.html">Bandwidth, IOPS and Latency</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Three years ago, I learned that due to SREcon, Charity Majors was in Amsterdam.
I set up a meeting between Benjamin Tyler, Yves Orton and a few more colleagues of mine, and her.
That is, because apparently in a case of co-evolution, our company internal &ldquo;Events&rdquo; system and Honeycombs observability tooling, modelled after experiencing Fabooks &ldquo;Scuba&rdquo; seemed to be doing a lot of the same things.</p>
<p>These days, we are using Honeycomb a lot to record events, and debug code running in distributed systems.
But one type of system does not fit into this very well:
Databases of all kinds.
And I don&rsquo;t understand why, because it would be perfect.</p>
<p>About one year ago, I wrote an article about &ldquo;<a href="/2021/09/15/mysql-tracing-a-single-query-with-performanceschema.html">Tracing a single query with PERFORMANCE_SCHEMA</a>

&rdquo;.
Why would I want to trace a single query like that?</p>
<p>I want to get data about query execution out of MySQL, at scale, and push this into Honeycomb.</p>
<h1 id="honeycomb-spans-traces-and-tags">
    <a href="#honeycomb-spans-traces-and-tags">
	Honeycomb, Spans, Traces and Tags
    </a>
</h1>
<p>Honeycomb is a tool that ingests &ldquo;Spans&rdquo;, time intervals, that can be annotated with arbitrary key-value pairs.
Spans do not only have a start and stop time, but also maintain relationships between Callers and Callees as a Tree Structure.
A root Span and its children form an execution trace (&ldquo;a trace&rdquo;) of a single call or entity of work in a distributed system.</p>
<p>A lot of Honeycomb assumes that the values are numbers, but it doesn&rsquo;t have to stop here (and other tooling can read Spans and work with non-numeric data, too).</p>
<p>Spans nest, and you could look at the execution of your program as an arrow of time on which the spans are arranged.</p>
<p><p class="md__image">
  <img src="/uploads/2022/10/proper-o11y-01.png" alt=""  />
</p>

</p>
<p><em>A root span at the application level is started in <code>buildAvailabilityQuery()</code>. This called into <code>sqlORM()</code>, which in turn called <code>runSQL()</code> several times. All this is recorded from the application and the application code. We&rsquo;d want to see MySQL execution data in there, as subspans of <code>runSQL()</code>.</em></p>
<p>For each span then any number of KV-pairs are recorded, so you could record call parameters, results, or intermediate state.</p>
<p>Honeycomb allows you to aggregate such data on the fly, in almost real time, so you can ask &ldquo;how many SQL queries is each action running, as a histo&rdquo;.</p>
<p>You could also ask &ldquo;What is the aggregated SQL time of each action&rdquo;, over time. You&rsquo;d see that at a certain point in time this time changed in the P95 and above.
With their &ldquo;Bubble up&rdquo; functionality you&rsquo;d mark the time interval and the aggregate interval (&quot;&gt; 1.5ms execution time&quot;).
Honeycomb would take the marked set vs. the base set (before, and faster), and highlight you all KV pairs that are different.</p>
<p>You might see that all slow samples have a specific commit tag associated with them, or you might see that all slow samples have a specific host machine tag or AZ tag associated with them.</p>
<p>Without prior knowledge you&rsquo;d see what the root cause for the slowness is.</p>
<h1 id="application-level-instrumentation">
    <a href="#application-level-instrumentation">
	Application level instrumentation
    </a>
</h1>
<p>Database instrumentation right now does not provide good data that can go into systems such as Honeycomb.</p>
<p>With application code, this is all easy.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">beeline</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@beeline.traced</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;external_api_request&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">external_api_request</span><span class="p">(</span><span class="n">request_params</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># adding fields here will add it to the active span wrapping</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># this function</span>
</span></span><span class="line"><span class="cl">    <span class="n">beeline</span><span class="o">.</span><span class="n">add_context_field</span><span class="p">(</span><span class="s2">&#34;response_time&#34;</span><span class="p">,</span> <span class="n">response_time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@beeline.traced</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">  <span class="n">beeline</span><span class="o">.</span><span class="n">add_context</span><span class="p">({</span><span class="s2">&#34;request_params&#34;</span><span class="p">:</span> <span class="n">request_params</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># calling this function will create a new span, under the &#34;main&#34; span</span>
</span></span><span class="line"><span class="cl">  <span class="n">result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="n">external_api_request</span><span class="p">(</span><span class="n">request_params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># add more context once we have results</span>
</span></span><span class="line"><span class="cl">  <span class="n">beeline</span><span class="o">.</span><span class="n">add_context</span><span class="p">({</span><span class="s2">&#34;result_count&#34;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="s2">&#34;error&#34;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># This will create a span - or if no trace is in progress, will also</span>
</span></span><span class="line"><span class="cl"><span class="c1"># start a trace</span>
</span></span><span class="line"><span class="cl"><span class="n">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Do not forget to close the beeline to ensure all spans get sent</span>
</span></span><span class="line"><span class="cl"><span class="c1"># before the application ends!</span>
</span></span><span class="line"><span class="cl"><span class="n">beeline</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></div><p><em>Example from the <a href="https://docs.honeycomb.io/getting-data-in/beeline/python/#using-a-decorator" target="_blank" rel="noopener">Honeycomb Documentation</a>

, showing how to instrument Python code.</em></p>
<p>Even if you know nothing about Python or Honeycomb, you can understand this.</p>
<p>The <code>@beeline.traced()</code> decorator wraps the function after it into the tracing harness, creating a span and maintaining the caller/callee relationships.
The <code>beeline.add_context()</code> calls add KV-pairs to the tracing span.</p>
<h1 id="what-database-integration-can-look-like">
    <a href="#what-database-integration-can-look-like">
	What database integration can look like
    </a>
</h1>
<p><p class="md__image">
  <img src="/uploads/2022/10/proper-o11y-02.png" alt=""  />
</p>

</p>
<p><em>What we want from a Query: The SQL_TEXT, and the Query Plan that actually ran for that Query. We would also want a list of Page#&rsquo;s requested and Page#&rsquo;s read from disk. Optionally, we would want subspans for each lock and wait, with annotations.</em></p>
<p>Why?</p>
<p>We get a Span for each SQL statement, maintaining the Caller/Callee Relationship with the code that sent us the query.
Thus, we see the SQL exectution in the context of the ORM that generated the SQL, in the context of the Application Code that called into the ORM.</p>
<p>Even ungreppable, generated SQL becomes attributable to the location in the source it is coming from.
We get to see the ORM&rsquo;s work in the context of the application that used it and the SQL it generated. With timings.
Attribution was previously hard to do, but this way it is trivial, because the call tree relationship is explicitly maintained.</p>
<p>We also get to see if somebody is running &ldquo;SELECT in a loop&rdquo; instead of using a JOIN (&ldquo;machine gunning pattern&rdquo;).
Machine gunning was previously very hard to even detect, and even harder to attribute. Now it is trivial.</p>
<p>We get to see the Query plan that ran, in the context of the application code (two spans up) that asked for data, with timings.
We get to attribute SQL runtime, and result processing time in the application, easily, because we get to see if the database SQL runtime span fills all of the SQL query processing span, or if there is additional time that is only visible in the application. This could only be result processing that was not marked up properly.</p>
<p>We get to see pages requested from disk (before hitting the cache) and actual IO generated (cache misses) for each query.
That allows us to see queries that have a good plan, but are slow, and understand why this is.
With optional locking and wait information, we&rsquo;d see more of that, for cases where this is not caused by IO but contention.</p>
<p>And, as a side benefit, a page# stream before and after the cache also allows us to determine the working set size of the database (for one query, for a subset of queries or for all queries), and to calculate ideal cache and instance sizes.
This makes instance type selection a guided, non-empirical process, but that is another article.</p>
<h1 id="conclusion">
    <a href="#conclusion">
	Conclusion
    </a>
</h1>
<p>None of that exists, but I don&rsquo;t know why.
Database tracing is completely ignoring modern observability integration, and things such as PMM or VividCortex are distinct from Honeycomb like systems.
Attribution of SQL (when generated) is a <em>mess</em>.</p>
<p>Information about the plan of queries that ran is not retained well in MySQL.
IO traces around the buffer pool are not even instrumented. They can be done. I routinely do them on production systems <a href="/2022/09/27/mysql-local-and-distributed-storage.html">at the file system level with blktrace</a>

.</p>
<p>And exfil of that data through <code>P_S</code> is just painful.
One would want an in-server ring buffer and a Pusher thread that sends this data in a non-blocking way (using localhost UDP?) to a listener, that transforms this into whatever O11y system you&rsquo;d be using.</p>
<p>So here I am, with my limited C++, and a 100 GB build partition, trying to build a P_S table that is mostly a stream of BLOBs, into which I try to collect the data I need in a non-crashing way.
Once I have that, I can try to build a Pusher that takes data from that pool, trying to ship that to my coprocess, which then takes this and transforms it into whatever Honeycomb wants, injecting Spans into their system.</p>
<p>Then I will finally be able to debug SQL properly, and in a single place with the code that made that SQL in the first place.</p>
<h1 id="other-systems">
    <a href="#other-systems">
	Other Systems
    </a>
</h1>
<p>My colleague Willian Stewart pointed me at Vitess, which <a href="https://vitess.io/docs/16.0/user-guides/configuration-advanced/tracing/#instrumenting-queries" target="_blank" rel="noopener">already does that for the &ldquo;above MySQL&rdquo;</a>

 part of Vitess:</p>
<p><p class="md__image">
  <img src="/uploads/2022/10/proper-o11y-03.png" alt=""  />
</p>

</p>
<p><em>The call tree of a Query to Vitess as it is being handled inside of Vitess, as seen by Jaeger.</em></p>
<p>Vitess requires you to generate a piece of JSON that contains the necessary IDs to build a call tree:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span><span class="nt">&#34;uber-trace-id&#34;</span><span class="p">:</span><span class="s2">&#34;{trace-id}:{span-id}:{parent-span-id}:{flags}&#34;</span><span class="p">}</span>
</span></span></code></pre></div><p>All items of a single trace have the same <code>trace-id</code>.
Each span has their own <code>span-id</code> and also states what the <code>parent-span-id</code> is.
Additional <code>flags</code> control the annotations generated (&ldquo;what gets traced&rdquo;).</p>
<p>To protect the data against accidental interpretation and munging, Vitess wants you to base64 encode the thing and then put it into a <code>/*VT_SPAN_CONTEXT=...*/</code> pseudo-comment as part of the query to be traced.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
				<a href="/tags/#debug" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				debug
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2022-10-25-proper-o11y-for-mysql.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/10/18/software-supply-chain-issues.html">Software Supply Chain Issues</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/11/07/bandwidth-iops-and-latency.html">Bandwidth, IOPS and Latency</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
