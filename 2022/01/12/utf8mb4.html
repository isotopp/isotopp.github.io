<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>UTF8MB4</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">
<link rel="canonical" href="https://blog.koehntopp.info">


<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">




<meta name="generator" content="Hugo 0.92.0" />
<meta property="og:title" content='UTF8MB4' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />


<meta property="og:locale" content="en_US" />


<meta name="description" content='' />
<meta property="og:description" content='' />

<link rel="canonical" href="https://blog.koehntopp.info" />
<meta property="og:url" content="https://blog.koehntopp.info" />


<meta property="og:type" content="article" />
<meta name="article:published_time" content='2022-01-10T16:28:00&#43;01:00' />



<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content='@isotopp' />
<meta name="twitter:creator" content='@isotopp' />
<meta property="twitter:title" content='UTF8MB4' />
<meta property="twitter:description" content='' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />

<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","description":null,"headline":"UTF8MB4","image":"/assets/img/background/mysql.jpg","name":"Die wunderbare Welt von Isotopp","url":"https://blog.koehntopp.info"}
</script>

    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.34cf67ab5155251adc1c5fa5c2f37d5a4f8f029f51399eb2556031d6ac918d49.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            




<div class="page">
  <article class="utf8mb4-page">
    <div class='row  justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            UTF8MB4
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
            <img alt='isotopp image' src='/assets/img/isotopp.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
            <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
            </a>

            
              <span class='d-none d-lg-inline'>-</span>
              <div class='d-block d-lg-inline'>January 12, 2022</div>
            

          </div>
        </div>
        
          <img alt='a featured image' src="/assets/img/background/mysql.jpg">
        
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p>On Twitter, Jan Wildeboer <a href="https://twitter.com/jwildeboer/status/1481308177727729668" target="_blank" rel="noopener">linked</a>

 an <a href="https://adamhooper.medium.com/in-mysql-never-use-utf8-use-utf8mb4-11761243e434" target="_blank" rel="noopener">article by Adam Hooper</a>

 on MySQL and the weird <code>utf8mb4</code> character set.</p>
<p>The recommendation is correct:
In MySQL, use <code>utf8mb4</code> when you mean to work with <code>utf8</code> in your programming language.
The background and reasoning why this is is wrong and way more complicated.</p>
<p>So let&rsquo;s walk through this:</p>
<h2 id="mysql-utf8-means-unicode-10-bmp">
    <a href="#mysql-utf8-means-unicode-10-bmp">
	MySQL <code>utf8</code> means Unicode 1.0 BMP
    </a>
</h2>
<p>UTF8 in MySQL encodes the <a href="https://en.wikipedia.org/wiki/Plane_%28Unicode%29#Basic_Multilingual_Plane" target="_blank" rel="noopener">Unicode BMP</a>

.
The Unicode Basic Multilingual Plane, or BMP, is the original 65536 character plane of Unicode 1.0.
It was thought to be enough for all scripts in the world.
It wasn&rsquo;t.
Unicode was extended, as early as with the 2.0 release, to have more characters than that, in more code planes.
There can now be up to 17 Unicode planes.</p>
<p>There are various ways to encode codepoints of Unicode.</p>
<p>Some of them are fixed with.
For example, Windows uses internally a 16 bit character encoding, also from the time when people thought that Unicode 1.0 would solve the worlds writing problems.
This is not only limited, but also wasteful:
When writing western text, every other byte in Windows Unicode text is a null byte.</p>
<p>In Unix, specifically originally in Plan 9 from AT&amp;T, a variable length encoding for Unicode was developed.
Basically, the number of consecutive high bits of the first byte determines how long the byte sequence is.</p>
<ul>
<li>So a thing starting with <code>0x8?</code> denotes a single character sequence,</li>
<li>a thing starting with <code>0xc?</code> identifies a two character sequence and</li>
<li>a <code>0xe?</code> a three byte sequence.</li>
<li>Four byte codepoints start with <code>0xf?</code></li>
</ul>
<p>MySQL also is from the time when people still believed in 65536 glyphs, and offers a number of encodings.
You can list the interesting ones with <code>SHOW CHARSET WHERE MAXLEN &gt; 1</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">charset</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">maxlen</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">---------+---------------------------------+---------------------+--------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">Charset</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Description</span><span class="w">                     </span><span class="o">|</span><span class="w"> </span><span class="k">Default</span><span class="w"> </span><span class="k">collation</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Maxlen</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">---------+---------------------------------+---------------------+--------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">big5</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Big5</span><span class="w"> </span><span class="n">Traditional</span><span class="w"> </span><span class="n">Chinese</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">big5_chinese_ci</span><span class="w">     </span><span class="o">|</span><span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">cp932</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">SJIS</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="n">Japanese</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">cp932_japanese_ci</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">eucjpms</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UJIS</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="n">Japanese</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">eucjpms_japanese_ci</span><span class="w"> </span><span class="o">|</span><span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">euckr</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">EUC</span><span class="o">-</span><span class="n">KR</span><span class="w"> </span><span class="n">Korean</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">euckr_korean_ci</span><span class="w">     </span><span class="o">|</span><span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">gb18030</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">China</span><span class="w"> </span><span class="k">National</span><span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="n">GB18030</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">gb18030_chinese_ci</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">gb2312</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">GB2312</span><span class="w"> </span><span class="n">Simplified</span><span class="w"> </span><span class="n">Chinese</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">gb2312_chinese_ci</span><span class="w">   </span><span class="o">|</span><span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">gbk</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">GBK</span><span class="w"> </span><span class="n">Simplified</span><span class="w"> </span><span class="n">Chinese</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">gbk_chinese_ci</span><span class="w">      </span><span class="o">|</span><span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">sjis</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">Shift</span><span class="o">-</span><span class="n">JIS</span><span class="w"> </span><span class="n">Japanese</span><span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="n">sjis_japanese_ci</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">ucs2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">UCS</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="n">Unicode</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">ucs2_general_ci</span><span class="w">     </span><span class="o">|</span><span class="w">      </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">ujis</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">EUC</span><span class="o">-</span><span class="n">JP</span><span class="w"> </span><span class="n">Japanese</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="n">ujis_japanese_ci</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">utf16</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">UTF</span><span class="o">-</span><span class="mi">16</span><span class="w"> </span><span class="n">Unicode</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="n">utf16_general_ci</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">utf16le</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UTF</span><span class="o">-</span><span class="mi">16</span><span class="n">LE</span><span class="w"> </span><span class="n">Unicode</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="n">utf16le_general_ci</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">utf32</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">UTF</span><span class="o">-</span><span class="mi">32</span><span class="w"> </span><span class="n">Unicode</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="n">utf32_general_ci</span><span class="w">    </span><span class="o">|</span><span class="w">      </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">utf8</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"> </span><span class="n">Unicode</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">utf8_general_ci</span><span class="w">     </span><span class="o">|</span><span class="w">      </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">utf8mb4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"> </span><span class="n">Unicode</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="n">utf8mb4_0900_ai_ci</span><span class="w">  </span><span class="o">|</span><span class="w">      </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">---------+---------------------------------+---------------------+--------+
</span><span class="c1"></span><span class="mi">15</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></div><p>Specifically, there are the <code>utf16</code>, <code>utf16le</code> and <code>utf32</code> encodings.
And we can check what they do. In my terminal, which incidentally uses <code>utf8</code> to talk to the database, I can  <code>select hex(&quot;ö&quot;) as ch</code> to check the representation of an o-Umlaut as bytes.</p>
<p>I can also <code>select hex(convert(&quot;ö&quot; using &lt;somecharset&gt;))) as ch</code> to check what these bytes would be in other encodings.</p>
<p>Let&rsquo;s do that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">hex</span><span class="p">(</span><span class="s2">&#34;ö&#34;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">ch</span><span class="w">   </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">C3B6</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">hex</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="s2">&#34;ö&#34;</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">latin1</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">ch</span><span class="w">   </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">F6</span><span class="w">   </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">hex</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="s2">&#34;ö&#34;</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">utf16</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">ch</span><span class="w">   </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">00</span><span class="n">F6</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">hex</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="s2">&#34;ö&#34;</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">utf16le</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">ch</span><span class="w">   </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">F600</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">hex</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="s2">&#34;ö&#34;</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="n">utf32</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">ch</span><span class="w">       </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">000000</span><span class="n">F6</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----------+
</span><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></div><p>So we learn:</p>
<ul>
<li>The <code>UTF8</code> o-Umlaut is <code>0xc3b6</code>.</li>
<li>In the fixed 8-bit charset <code>latin1</code> that becomes <code>0xf6</code>.</li>
<li>In <code>UTF16</code>, a superset of that, it becomes <code>0x00f6</code>.</li>
<li>Unsurprisingly, in <code>UTF16LE</code> that is now the same, backwards, <code>0xf600</code>.</li>
<li>And in the staggering wasteful <code>UTF32</code> we actually get three null bytes per glyph when storing western script, <code>0x000000f6</code>.</li>
</ul>
<p>In fact, to encode all possible 17 unicode planes we require only 21 bits, so <code>UTF32</code> is hopelessly wasteful even for non-western scripts.
That is at least one null byte for each glyph in any script.</p>
<h2 id="later-unicode-revisions-add-more-planes">
    <a href="#later-unicode-revisions-add-more-planes">
	Later Unicode revisions add more planes
    </a>
</h2>
<p>But: The singular Basic Multilingual Plane was not enough for all of earths scripts, so it needed to be extended.
So we get characters that no longer fit a Windows <code>wchar</code>, and also not the 3-byte <code>utf8</code> encoding.</p>
<p>MySQL extends the character representation to 4 bytes, which covers all possible 17 Unicode planes, and names that character set <code>utf8mb4</code>.
Case closed.</p>
<p>When working with modern Unicode in MySQL, always define the character set as <code>utf8mb4</code>.
It is that simple.</p>
<h2 id="but-why-is-the-4-byte-utf8-named-differently">
    <a href="#but-why-is-the-4-byte-utf8-named-differently">
	But why is the 4-byte <code>utf8</code> named differently?
    </a>
</h2>
<p>So why did MySQL name the 4-byte <code>utf8</code> weirdly <code>utf8mb4</code> and did not update the definition of <code>utf8</code> to 4 bytes?</p>
<p>That is, because in databases you cannot ever change the definition of a character set or character set sort order (&ldquo;collation&rdquo;) without great pains.
You can easily add more, but you can never change what you have delivered to customers, ever.</p>
<h3 id="indexes-physically-materialize-columns-in-sort-order-for-fast-lookups">
    <a href="#indexes-physically-materialize-columns-in-sort-order-for-fast-lookups">
	Indexes physically materialize columns in sort order for fast lookups
    </a>
</h3>
<p>So, databases have this thing called indexes.
Suppose you have a table with a character column (a column of any datatype that has a charset and a collation), it may be a <code>char</code>, <code>varchar</code> or any of the four <code>text</code> types.
And you define an index on it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">kris</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="nb">serial</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span><span class="w"> </span><span class="k">index</span><span class="p">(</span><span class="k">c</span><span class="p">),</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="nb">integer</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">28</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">kris</span><span class="err">\</span><span class="k">G</span><span class="w">
</span><span class="w">       </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="n">kris</span><span class="w">
</span><span class="w">       </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="n">kris</span><span class="w">
</span><span class="w"></span><span class="k">Create</span><span class="w"> </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">kris</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="n">unsigned</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="o">`</span><span class="n">d</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span><span class="w">  </span><span class="k">UNIQUE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="k">c</span><span class="o">`</span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="w"> </span><span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_0900_ai_ci</span><span class="w">
</span><span class="w"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span><span class="w">
</span></code></pre></div><p>What happens here?
We store rows in the table <code>kris</code> by inserting data.
The database assigns a primary key <code>id</code>, and stores the tuple <code>(id, c, d)</code> in the table.
It also needs to maintain the index on <code>c</code>, so it will take the <code>c</code>-value of each row and store it in the index <strong>in sorted order</strong> with a pointer to the full row.</p>
<p>In InnoDB, the row pointer used by secondary indexes is actually the primary, <code>id</code>, so we do get the index <code>c</code> as tuples of <code>(c, id)</code>.
That means each secondary has the primary key as a tail, so the primary key better be short.
In our case, it is a <code>BIGINT</code>, so 8 bytes are added as a row pointer to the index, for each row.</p>
<p>Notice the fat <strong>in sorted order</strong>?</p>
<p>The index <code>c</code> is sorted, in the order defined by the collation for the character set.
That is going to be critically important.
So let&rsquo;s have a look at character ordering.</p>
<h3 id="collations-are-comparison-rules-for-characters">
    <a href="#collations-are-comparison-rules-for-characters">
	Collations are comparison rules for characters
    </a>
</h3>
<p>Our collation is given as <code>utf8mb4_0900_ai_ci</code>, and that are the Unicode Collation Algorithm (UCA) 9.0 sorting rules for 4-byte UTF8, with accent insensitivity (<code>ai</code>)<code>and case insensitivity (</code>ci`).</p>
<p>We need to learn even more:</p>
<ul>
<li>Collations are rules for handling comparisons between glyphs in a specific encoding.
There are encodings for <code>latin1</code>, other ones specific to <code>utf8</code> and again different ones for <code>utf8mb4</code>.</li>
<li>Collations define <em>sort orders</em> and <em>equality rules</em>.
<code>ci</code> means the <em>sort order</em> is case insensitive, so &ldquo;Köhntopp&rdquo;, &ldquo;KÖHNTOPP&rdquo; and &ldquo;köhntopp&rdquo; sort the same. With <code>cs</code> they would not.
<code>ai</code> means accent insentitive, so <code>WHERE c = &quot;Kohntopp&quot;</code> matches &ldquo;Köhntopp&rdquo;. With <code>as</code> it would not.</li>
</ul>
<p>We can show the collations for a given character set.
There are over 250 of them, and 75 alone for <code>utf8mb4</code>.
Let&rsquo;s check just the <code>utf8mb4%_ai_ci</code> ones.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">collation</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">collation</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s2">&#34;utf8mb4%_ai_ci&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----------------------------+---------+-----+---------+----------+---------+---------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">Collation</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="n">Charset</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Id</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">Default</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Compiled</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Sortlen</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Pad_attribute</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----------------------------+---------+-----+---------+----------+---------+---------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">utf8mb4_0900_ai_ci</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">utf8mb4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Yes</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">Yes</span><span class="w">      </span><span class="o">|</span><span class="w">       </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="k">PAD</span><span class="w">        </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">utf8mb4_cs_0900_ai_ci</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">utf8mb4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">266</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Yes</span><span class="w">      </span><span class="o">|</span><span class="w">       </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="k">PAD</span><span class="w">        </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="p">...</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">utf8mb4_vi_0900_ai_ci</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">utf8mb4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">277</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">Yes</span><span class="w">      </span><span class="o">|</span><span class="w">       </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NO</span><span class="w"> </span><span class="k">PAD</span><span class="w">        </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">----------------------------+---------+-----+---------+----------+---------+---------------+
</span><span class="c1"></span><span class="mi">22</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></div><p>So many nation specific sort orders.
And if you define an index on a character column, it has a collation attached and the data will be physically sorted in that nations sort order.</p>
<p>These things are in fact even versioned:
If there is an UCA 9.0, are there other, earlier ones?
Sure enough:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">information_schema</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">collations</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">collation_name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s2">&#34;%general_mysql%&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------------------+--------------------+-----+------------+-------------+---------+---------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">COLLATION_NAME</span><span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="k">CHARACTER_SET_NAME</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ID</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">IS_DEFAULT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">IS_COMPILED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SORTLEN</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PAD_ATTRIBUTE</span><span class="w"> </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------------------+--------------------+-----+------------+-------------+---------+---------------+
</span><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">ucs2_general_mysql500_ci</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ucs2</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="mi">159</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Yes</span><span class="w">         </span><span class="o">|</span><span class="w">       </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">PAD</span><span class="w"> </span><span class="k">SPACE</span><span class="w">     </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">utf8_general_mysql500_ci</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">utf8</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="mi">223</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">Yes</span><span class="w">         </span><span class="o">|</span><span class="w">       </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">PAD</span><span class="w"> </span><span class="k">SPACE</span><span class="w">     </span><span class="o">|</span><span class="w">
</span><span class="w"></span><span class="o">+</span><span class="c1">--------------------------+--------------------+-----+------------+-------------+---------+---------------+
</span><span class="c1"></span><span class="mi">2</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></code></pre></div><p>The fine manual notes, at the bottom of <a href="https://dev.mysql.com/doc/refman/8.0/en/charset-unicode-sets.html#charset-unicode-sets-uca" target="_blank" rel="noopener">Unicode Character Sets</a>

:</p>
<blockquote>
<h4 id="miscellaneous-information">
    <a href="#miscellaneous-information">
	Miscellaneous Information
    </a>
</h4>
<p>The xxx_general_mysql500_ci collations preserve the pre-5.1.24 ordering of the original xxx_general_ci collations and permit upgrades for tables created before MySQL 5.1.24 (Bug #27877).</p>
</blockquote>
<p>MySQL 5.1.24 was released on 2008-04-08, 14 years ago.
We have <em>buggy</em> sort orders used back then maintained in current MySQL for the sake of upgradability.</p>
<h3 id="tldr-so-far">
    <a href="#tldr-so-far">
	TL;DR, so far
    </a>
</h3>
<ul>
<li>Databases use indexes to access data quickly.</li>
<li>Indexes physically materialize a column (and row pointers) in sort order.</li>
<li>Sort order for character sets character set dependent, and national language dependent.</li>
<li>Sort order also got major upgrades during the evolution of Unicode: Not only did we move from &ldquo;only BMP&rdquo; to 17 planes, we also went through at least 9 revisions of the Unicode Collation Algorithm.</li>
</ul>
<p>So:</p>
<ul>
<li>If you change the collation (the sort order) of an index, the index needs to be rebuilt.</li>
<li>Sort orders are a property of character sets.</li>
<li>UTF8 sorted according to UCA 4.x and UCA 5.0, UTF8MB4 sorts according to UCA 9.0. Specifically, the concept of segregating sort order comparison from equality comparison, and introducing accent insensitivity is new in UCA 9.0 and not present in previous UCA versions.</li>
</ul>
<p>That means, while <code>utf8</code> is a strict subset of <code>utf8mb4</code> in terms of character repertoire and encoding (modulo bug fixes), it sorts differently.
An <code>ALTER TABLE kris MODIFY COLUMN c varchar(20) charset utf8</code> in our example table implies a drop on the index <code>c</code>, and it&rsquo;s recreation with a different sort order, from scratch.
Not fast on a large table.</p>
<h2 id="so-what-would-happen-if-utf8-suddently-meant-utf8mb4">
    <a href="#so-what-would-happen-if-utf8-suddently-meant-utf8mb4">
	So what would happen if <code>utf8</code> suddently meant <code>utf8mb4</code>?
    </a>
</h2>
<p>Let&rsquo;s imagine a MySQL 9.0 comes out, and in that release <code>utf8</code> suddenly means <code>utf8mb4</code>.
If you greenfield a new installation, no problem.</p>
<p>If you apply the update to an existing installation, all your character columns that are part of an index need to be checked, and if required, rebuilt.
At the time when you apply the database update.
Which can take a very long time, during which the database is not available.
That can be quite inconvenient.</p>
<h2 id="what-happens-instead-if-we-dont-do-that">
    <a href="#what-happens-instead-if-we-dont-do-that">
	What happens instead if we don&rsquo;t do that?
    </a>
</h2>
<p>In that case, <code>utf8</code> means <code>utf8</code>, nothing changes, and <code>utf8mb4</code> is added and not used at all.
Unless you do.</p>
<p>So you could create new columns using the new character set and collations, even in existing tables.
That is possible, because unlike in the other database, in MySQL a charset and collation is a column attribute.
Tables, databases and servers just provide defaults that are inherited at the time of subordinate object creation.</p>
<p>So if you wanted to upgrade your database, you&rsquo;d install a new version.
Then you would check all columns and note which one need changing.
And then you would change them, table by table, at your own leisure.
Possibly using tooling such as Percona Online Table Change (&ldquo;OSC&rdquo;), making the change in the background without service interruption.</p>
<p>That is what MySQL does.
It never changes collations any more (it did, in the dark, evil past, creating a lot of suffering).
It is not even correcting bugs in existing collations any more (except by creating newly renamed collations).
Instead you run your collation migrations as it fits into your operational schedule.</p>
<p>For Unicode that means, 4-byte Unicode is <code>utf8mb4</code> in MySQL, because the name <code>utf8</code> was already taken by a previous version of the Unicode character set.</p>
<h2 id="not-using-libc">
    <a href="#not-using-libc">
	Not using libc.
    </a>
</h2>
<p>MySQL does not use <code>libc</code> and the character set comparison functions in there for itself.
Instead it brings its own collations.</p>
<p>That is also an important lesson.
It means that, unlike the other database, MySQL does not break when you upgrade the operating system <code>libc</code> on your machine.
If MySQL used <code>libc</code> fort sorting and comparing, the database could break without any changes to the database whatsoever - an innocent security update to the operation systems <code>libc</code> that for some reason also touched <code>libc</code> sorting and comparison would break all character indexes in your database.</p>
<p>MySQL does not do that.
It lets you migrate these things in a way that is operationally convenient.</p>
<p>It also means that MySQL versions sort the same between Linux, FreeBSD, Solaris and even Windows.
Just like the on disk format is compatible across all platforms, so is character handling and time zone handling.
MySQL is MySQL on any platform, and copying files and replication always work across these boundaries.</p>
<h2 id="dude-thats-complicated">
    <a href="#dude-thats-complicated">
	Dude, that&rsquo;s complicated
    </a>
</h2>
<p>Yes.
Databases are weird, complicated and large.</p>
<p>That is because they keep the state for your program, so that your program can be stateless and easy to manage.
Guess where all that complexity and technical debt management went?</p>
<p>Where I work there is a replication hierarchy where the database instances are 120 TB in size, with the largest table being 35 TB in size.
Cloning a new instance at 400 MB/s takes around a week, plus replication catchup, so you wait around two weeks for a new instance, if nothing goes wrong.</p>
<p>Moving this to <code>utf8mb4</code> is a 6 month project, at least, and most of it is waiting.</p>
<p>This database was created around 16 years ago.
It has an unbroken chain of state changes (&ldquo;inserts, updates and deletes&rdquo;) from back then to the present.</p>
<p>It was born as MySQL 4.x, at some point became a MariaDB and is now an Oracle MySQL 5.7.
None of the code that was running when it was created still exists.
But the bugs and faulty updates that code did, back then, still exist somewhere in the data, unless they have been found and corrected.</p>
<p>Persistence systems - databases and their NoSQL brethren that actually manage to write data to disk properly - are stateful systems.
The data they store usually outlives the code that created the records.
Changes to this data are forever.
Mistakes in handling the data or the updates are forever, too.</p>
<p>DBA are a very special folk.
They are very paranoid.
They have tested restores of their backups, and their backups have backups.
That is, because if they make a mistake and data is gone, it is gone forever, and no rollout to fix things is possible.</p>
<h2 id="sorting-stuff">
    <a href="#sorting-stuff">
	Sorting stuff
    </a>
</h2>
<p>Not only can databases, tables and individual indexes be very large, they also need to be kept sorted, and sometimes data needs to be re-sorted.
Databases ususally have a large number of strategies for that.</p>
<p>Small things are sorted in memory.
That is, the database creates the full rows of the result table in memory, using all columns.
It then sorts these rows in memory by shuffling around the full rows.
That uses up a lot of memory bandwidth, because we copy around full rows, which can be large.</p>
<p>Sometimes we do not want to move around full rows.
So we only sort the columns specified in the <code>ORDER BY CLAUSE</code>, which is a tiny subset of the full columns set of each row of the result table, and attach a row pointer to each of these sort rows.</p>
<p>In the end we have a tiny in-memory table in sort order, which only holds columns from the <code>ORDER BY</code>, and each row in there points to the unsorted full rows somewhere else - in memory or on disk.
We then output the full rows in sort order, but that means we generate a lot of seeks - possibly on disk.
That is, because the full rows have not been sorted, so the row pointers from the sorted data to the full rows are a mess.</p>
<p>Sometimes we have very many rows.
So we do as before, but for a subset of all rows - as many as fit into our sort buffer.
When the sort buffer is full, we write it out to disk.
Then we continue with the next batch.
Across all partial results we perform a merge sort.</p>
<p>If the things sorted were full rows, we can emit full result rows rather quickly.
If the things sorted were only <code>ORDER BY</code> columns or other partial result set rows with row pointers attached, we may have to perform one or multiple seeks in order to get the missing columns from all tables involved.</p>
<p>The optimizer has to decide which strategy to use here, based on estimates of the row width, size of the result set (which has not yet been produced, so it&rsquo;s a guess) and the available amount of resources.</p>
<h3 id="and-then-implementation-issues">
    <a href="#and-then-implementation-issues">
	And then, implementation issues
    </a>
</h3>
<p>Older versions of MySQL have different storage engines: <code>MYISAM</code>, <code>INNODB</code>, <code>MEMORY</code> and others.
Modern MySQL has only <code>INNODB</code>, but for temporary tables has a few tricks ready to make things faster (for example, temporary tables can be recreated and do not need to be crash safe, so no redo and undo logging is required).</p>
<p>Other storage engines than <code>INNODB</code> had restrictions.</p>
<p>For example, <code>MEMORY</code> tables could not have variable length columns, there was no <code>VARCHAR</code>, only <code>CHAR</code>.
So when sorting with temporary tables in memory, MySQL created these tables as <code>MEMORY</code> tables, promoting every <code>varchar(255)</code> to <code>CHAR(255)</code>, and so a row with a varchar value of <code>hello</code> suddenly used 255 bytes instead of 6 bytes to represent the string <code>hello</code> (plus a lot of padding).</p>
<p>Of course, with <code>utf8</code>, a <code>varchar(255) charset utf8</code> is promoted to a <code>char(255) charset utf8</code>, which instead allocates 765 bytes of memory, out of which the first five bytes contain the string <code>hello</code>, and the rest is wasteful padding.</p>
<p><code>MEMORY</code> tables had a configurable size limit, and if your table exceeded that (which happened rather quickly, given the above restrictions), it was converted to an on-disk temporary table in <code>MYISAM</code> format.
That, of course had <code>varchar(255) charset utf8</code> as a native type and your <code>hello</code> would again shrink to six bytes.
Looking at the on disk temporary file, which was rather small, you might wander what caused the spill.</p>
<p>MySQL 8 introduces unlogged <code>INNODB</code> temporary tables (and a failed experiment involving mmap that you may want to disable).
So this problem is gone, once and for all: <code>varchar</code> is <code>varchar</code> at all times, and representing Unicode variants in temporary tables is no longer a problem.</p>
<p>In MySQL 8.</p>
<p>This is in fact one of the major reasons to graduate from 5.7 for many people.</p>
<h3 id="sorting-tldr-and-unicode">
    <a href="#sorting-tldr-and-unicode">
	Sorting TLDR and Unicode
    </a>
</h3>
<p>Sorting Unicode columns was expensive in versions of MySQL before MySQL 8.
That is because the memory engine used did not understand variable length data types at all.
That led to all kinds of recommendations restricting the use of Unicode columns:
Don&rsquo;t use them, if you do not need them.
Keep them short.
Exclude BLOB and TEXT columns from sorting.
And so on.</p>
<p>MySQL 8 fixes all that.
Use Unicode columns as you see fit.
They work well, and as expected.
BLOB and TEXT are no longer a problem with sorting (well, they are, but for other reasons, but they do not longer trigger an immediate spill, no matter how tiny they are).</p>
<h2 id="tldr">
    <a href="#tldr">
	TLDR
    </a>
</h2>
<p>We learned:</p>
<ul>
<li>Your programming languages <code>utf8</code> is called <code>utf8mb4</code> in MySQL.</li>
<li><code>utf8</code> and <code>utf8mb4</code> sort differently due to changes in the Unicode Collation Algorithm (UCA).</li>
<li>Indexes are physically materialized sort orders of column sets. They can become pretty large.</li>
<li>MySQL never changes sort orders of character sets (collations), even if they are buggy. Instead a new collation with a new name is created.</li>
<li>That is, because changing a sort order may require dropping and recreating an index, which is expensive if the index is large.</li>
<li>Sorting things can be done in many different ways, depending on data set size, column size and other considerations.</li>
<li>Implementation details can make sorting even more complicated.</li>
<li>MySQL 8 is a worthwhile upgrade.</li>
<li>Databases manage state so you don&rsquo;t have to. If you think databases are complicated, consider what you would have to do if the database and your DBA would not be there for you.</li>
</ul>

      </div>
    </div>

    
    
    <div class='row justify-content-center mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2022%2f01%2f12%2futf8mb4.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.koehntopp.info%2f2022%2f01%2f12%2futf8mb4.html&text=UTF8MB4%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20https%3a%2f%2fblog.koehntopp.info%2f2022%2f01%2f12%2futf8mb4.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
        <a href='http://www.reddit.com/submit?url=https%3a%2f%2fblog.koehntopp.info%2f2022%2f01%2f12%2futf8mb4.html&title=UTF8MB4' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>
        <a href='mailto:?subject=UTF8MB4&body=https%3a%2f%2fblog.koehntopp.info%2f2022%2f01%2f12%2futf8mb4.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope-fill'/></svg>
        </a>
      </div>
    </div>

    
    
    <div class='row justify-content-center py-3 mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
        
          <a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            lang_en
          </a>
        
          <a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            mysql
          </a>
        
          <a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            mysqldev
          </a>
        
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top mx-0'>
      <div class='col-lg-4 text-center text-lg-start'>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2022/01/10/never-check-for-an-error-condition.html">Never check for an error condition you don&#39;t know how to handle</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
