<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Rolling back MySQL versions | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">
<link rel="canonical" href="https://blog.koehntopp.info">


<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">




<meta name="generator" content="Hugo 0.100.1" />
<meta property="og:title" content='Rolling back MySQL versions' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />


<meta property="og:locale" content="en_US" />


<meta name="description" content='' />
<meta property="og:description" content='' />

<link rel="canonical" href="https://blog.koehntopp.info" />
<meta property="og:url" content="https://blog.koehntopp.info" />


<meta property="og:type" content="article" />
<meta name="article:published_time" content='0001-01-01T00:00:00Z' />



<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content='@isotopp' />
<meta name="twitter:creator" content='@isotopp' />
<meta property="twitter:title" content='Rolling back MySQL versions' />
<meta property="twitter:description" content='' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />

<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","description":null,"headline":"Rolling back MySQL versions","image":"/assets/img/background/mysql.jpg","name":"Die wunderbare Welt von Isotopp","url":"https://blog.koehntopp.info"}
</script>

    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.86f04b5a1d6147160ec8236adc1a4f12f5bfbf89594c2979ffc4b09a85fe1b31.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            




<div class="page">
  <article class="rolling-back-mysql-versions-page">
    <div class='row  justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            Rolling back MySQL versions
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
            <img alt='isotopp image' src='/assets/img/isotopp.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
            <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
            </a>

            
              <span class='d-none d-lg-inline'>-</span>
              <div class='d-block d-lg-inline'>June 3, 2022</div>
            

          </div>
        </div>
        
          <img alt='a featured image' src="/assets/img/background/mysql.jpg">
        
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p>Where I work, we <a href="https://blog.koehntopp.info/2021/03/24/a-lot-of-mysql.html">manage databases in an automated way</a>

.
Not as automated as I wish it to be, but largely without touching boxes.</p>
<p>We have been doing so for a long time.</p>
<p>Over ten years ago, I set the team the challenge &ldquo;be on an arbitrary version of MySQL within 20 workdays (one calendar month), no matter how many servers we have&rdquo;.
We are there now, in a way: we are on a 30-day refresh cycle for our bare metal cloud, and we match that cycle for our virtualized fleet.
It was a long road.</p>
<h1 id="the-51-to-55-disaster">
    <a href="#the-51-to-55-disaster">
	The 5.1 to 5.5 disaster
    </a>
</h1>
<p>The worst place we have been in the past was our transition from MySQL 5.1 to 5.5.</p>
<p>Along the way we picked up a mutant Non-GA version of 5.1 for reasons that seemed valid at that time.
But unfortunately, this version changed the on-disk format to fix a thing.
That meant we had no binary &ldquo;on-disk&rdquo;, &ldquo;in-place&rdquo; upgrade path for us, for any system that was on this particular strain of 5.1.</p>
<h2 id="in-place-upgrades-are-fast">
    <a href="#in-place-upgrades-are-fast">
	In-place upgrades are fast
    </a>
</h2>
<p>Normally, upgrading MySQL is easy:
You stop the server, push the new RPM, run <code>mysql_upgrade</code> (now integrated and automatic), and the on-disk format is adjusted.
Then the server comes up again.
Takes a minute or two, plus time to reheat the caches.</p>
<p>Also, downgrading MySQL is often easy and, important!, possible:
<strong>In the past the on-disk format only changed between major versions.</strong></p>
<p>In our case, none of these options were open to us:
A binary transition between our mutant non-GA 5.1 and 5.5 was impossible.
We had to dump and reload all the data.</p>
<p>Back then we already had a three-digit number of MySQL replication hierarchies, and even back then a replication hierarchy typically had a disk footprint of 1-2 TB (ie 2-4h at 200 MB/s).</p>
<p>So we would dump the 5.1 database, reload it into a 5.5 instance, recreating all the indexes (which makes it slow), then attach it in replication and wait for it to catch up.</p>
<p><p class="md__image">
  <img src="/uploads/2022/06/mysql-upgrade.png" alt=""  />
</p>

</p>
<p><em>Converting from 5.1 to 5.5 without interruption, by rebuilding the replication tree under a new intermediate, then beheading the chain. Reimporting a dump into a 5.5 instance is the slowest step, recloning was a nuisance back then &ndash; it is automated these days.</em></p>
<p>We would then make more replicas under the 5.5 which acts as an intermediate primary, and remove 5.1 replicas to match.
In the end we would move writes down from the 5.1 primary to the 5.5 intermediate primary, behead the tree and be done.
That takes around a week per hierarchy, and was not properly automated back then. In fact, the entire experience is part of why we have so much automation.</p>
<p>It meant that the transition from 5.1 to 5.5 took us almost two years.</p>
<h2 id="why-the-mutant">
    <a href="#why-the-mutant">
	Why the mutant?
    </a>
</h2>
<p>We had the 5.1 mutant because of a bug fix that we thought we needed, which led to a change in on-disk format.
We completely underestimated the impact of a breaking change in on-disk format on our operations, and the amount of toil coming from this.</p>
<p>And we paid dearly for us.</p>
<h1 id="mysql-8-and-todays-situation">
    <a href="#mysql-8-and-todays-situation">
	MySQL 8 and today&rsquo;s situation
    </a>
</h1>
<p>These days, phase 2 of that conversion would be completely automated:
If we have a working binary datadir, we can reclone it at scale, limited by the media speed or the cluster quota.
Still, we need an up-to-date binary datadir to be able to do that.</p>
<p>These days, MySQL 8 broke with the promise of &ldquo;no new features, no new disk formats with a single major version&rdquo;.
The former is okay, and in fact, welcome.
It has had some impact on stability, but in general the development process of MySQL and the refactoring of its internals have become good enough to offset that, mostly.
So, yes, we are okay with the new MySQL 8 development model, and we are in fact making use of new features.</p>
<p>The latter is catastrophic, because it leads to either incomplete upgrades for us, or leads us back into a dump-and-reload hell.</p>
<p>Let me explain:</p>
<ul>
<li>In order to roll back, we do need a current binary datadir that is compatible with the version we want to roll back to.</li>
<li>Replication has an order, a replica must be newer or equal in version to its source.
Otherwise, it risks that things coming down the replication stream are too new, and cannot be recognized.</li>
<li>So in order to have a valid binary datadir <em>and</em> have a valid replication hierarchy, we cannot behead a primary until we trust that we never want to roll back.</li>
</ul>
<p>Or, we do behead the chain and promote one of the new version intermediates to writeable true primary.
In which case we lose rollback capability, and are back to dump and reload.</p>
<p>Only we now have more chains, and some databases are truly too large to ever dump and reload.
I mean, we had a 120 TB MariaDB instance that was converted to Oracle MySQL 5.7 by dump and reload, and that took a machine with AMD EPYC CPU, 1 TB of RAM and multiple months to complete.
The conversion saga was painful enough to warrant a <a href="https://twitter.com/_digitalknight/status/1526671502116114435" target="_blank" rel="noopener">Percona Live talk</a>

 about the entire thing by Simon Mudd and Pep Pla.</p>
<h1 id="sometimes-changes-fail">
    <a href="#sometimes-changes-fail">
	Sometimes changes fail
    </a>
</h1>
<p>MySQL 8 gives us a lot of new features, <a href="https://www.percona.com/blog/quick-peek-at-mysql-8-0-29/" target="_blank" rel="noopener">here are some highlights</a>

.
They are very welcome, but… untested.</p>
<p>They come with breaking changes, <a href="https://www.percona.com/blog/mysql-8-0-29-and-percona-xtrabackup-incompatibilities/" target="_blank" rel="noopener">disabling our default clone mechanism</a>

.
They <a href="https://forums.mysql.com/read.php?22,704532,704675" target="_blank" rel="noopener">seem to be unstable</a>

 for not just us, in one way or the other.</p>
<p>Being able to go back one or two major versions (&ldquo;a quarter or half a year&rdquo;) would make this much easier for everyone: Users and Developers, and take a lot of strain of the vendor/customer relationship.</p>
<h2 id="my-default-clone-rant">
    <a href="#my-default-clone-rant">
	My default CLONE rant
    </a>
</h2>
<p>Disk format changes also get somehow in the way of other features:</p>
<p>Our default clone mechanism is not <a href="https://dev.mysql.com/doc/refman/8.0/en/clone-plugin.html" target="_blank" rel="noopener"><code>CLONE</code></a>

.
That is, because <code>CLONE</code> requires the same exact version of the database at the donor and receiver instance, which makes it completely useless for upgrades.</p>
<p>Clone is dependent on the on-disk format not changing for good reasons.
The entire point of Clone is to not mess with formats and just shifting data between instances, multi-threaded, as fast as possible.</p>
<p>By managing on-disk format changes more conservatively, and giving a two-minor-versions window (6 months), Oracle MySQL could rely on Oracle MySQL&rsquo;s on-disk format.
It could handle <code>CLONE</code> based upgrades properly, instead of having everybody depend on <code>xtrabackup</code> catching up.</p>
<p>That would be a lot of value added for little effort.</p>
<h1 id="tldr">
    <a href="#tldr">
	TL;DR
    </a>
</h1>
<p>Databases are where the state is kept.
State has size, and copying state is slow.
That is why everybody is always very protective of state.
Do not treat on-disk data the Yolo way that Devops treats stateless instances.</p>
<ul>
<li>Introducing new features in a major version is okay if you have a mature codebase and development process.</li>
<li>Changing persistent state on disk is more complicated than that, and downgrades need to be possible for two minor versions.
<ul>
<li>If you do not allow that, it is painful for everybody.</li>
<li>That includes us, because we can test slower, so Oracle MySQL gets less feedback.</li>
<li>That includes Oracle MySQL itself, because it makes nifty features such as <code>CLONE</code> needlessly specific and much less useful.</li>
</ul>
</li>
<li>We will, even with today&rsquo;s the degree of automation, never be able to upgrade by dump and restore, just because reindexing is very, very expensive. It is just too much data.
<ul>
<li>Binary in-place upgrade and downgrade paths are completely non-optional.
We will never have the hell of the 5.1 to 5.5 transition again.
We simply cannot afford this anymore.</li>
</ul>
</li>
</ul>

      </div>
    </div>

    
    
    <div class='row justify-content-center mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2022%2f06%2f03%2frolling-back.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.koehntopp.info%2f2022%2f06%2f03%2frolling-back.html&text=Rolling%20back%20MySQL%20versions%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20https%3a%2f%2fblog.koehntopp.info%2f2022%2f06%2f03%2frolling-back.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
        <a href='http://www.reddit.com/submit?url=https%3a%2f%2fblog.koehntopp.info%2f2022%2f06%2f03%2frolling-back.html&title=Rolling%20back%20MySQL%20versions' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>
        <a href='mailto:?subject=Rolling%20back%20MySQL%20versions&body=https%3a%2f%2fblog.koehntopp.info%2f2022%2f06%2f03%2frolling-back.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope-fill'/></svg>
        </a>
      </div>
    </div>

    
    
    <div class='row justify-content-center py-3 mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
        
          <a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            database
          </a>
        
          <a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            mysql
          </a>
        
          <a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            lang_en
          </a>
        
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top mx-0'>
      <div class='col-lg-4 text-center text-lg-start'>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2022/05/17/wie-normale-leute-eben.html">Wie normale Leute eben...</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
