<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Of Stars and Snowflakes | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2022/11/16/of-stars-and-snowflakes.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Of Stars and Snowflakes | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2022/11/16/of-stars-and-snowflakes.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2022-11-16T06:07:08Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Of Stars and Snowflakes' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="of-stars-and-snowflakes-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Of Stars and Snowflakes
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>November 16, 2022</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/11/09/databases-on-unraided-storage.html">Databases on un-RAID-ed storage?</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/11/20/etl-from-a-django-model.html">ETL from a Django Model</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<h1 id="a-sample-system">
    <a href="#a-sample-system">
	A sample system
    </a>
</h1>
<p>When you have an Online Transactional Database, you have to record transactions at some point in time.
That means you get a table with time dimension in your OLTP system.
Consider for example a system that records Reservations.
Users exist and can reserve Things to use, for a day.</p>
<p>You probably get a structure such as this:</p>
<p><p class="md__image">
  <img src="/uploads/2022/11/snowflake-01.png" alt=""  />
</p>

</p>
<p><em>In an OLTP database, a reservation is a <code>(resid, userid, thingid, date)</code>. It references the <code>user</code> data by <code>userid</code>, and the <code>thing</code> data by <code>thingid</code>.</em></p>
<p>This assumes we have unique complete representations of a <code>user</code> and a <code>thing</code>, and we always want to reference the most current version of each of them.
It also assumes that the <code>reservation</code> is transient. Maybe we add additional fields, or pointers to other tables to track state changes:
A user can show up and get their thing, then work with it.
When they give it back, we record the fact, and make sure the thing is checked to be okay after use.</p>
<h2 id="fixed-sized-oltp-systems">
    <a href="#fixed-sized-oltp-systems">
	Fixed sized OLTP systems
    </a>
</h2>
<p>Finally, the transaction is closed, and in an OLTP system we are then well advised to forget about it.
To model that, we should add for example a state field that tracks this, and maybe fields to link to complaints or damages, if applicable.</p>
<p>That is, we want the OLTP system to be largely fixed in size, given unchanging outside parameters.
Or in other words, for the same number of things and users, we want the size of the OLTP system to be largely constant over time.</p>
<p>If we did not forget about Reservations after their completion, we would have a table with a time dimension, but with an incomplete data lifecycle management.
The <code>reservation</code> table would grow over time, without an upper bound, eventually becoming the largest object in our system.
Most of the transactions recorded would be in the past, done and dead.</p>
<p>This will make our customer facing system large, slow, hard to back up and hard to change.
Most people do not want that, but they also want records of transactions past.
So instead of deleting old <code>reservation</code> entries, they <strong>Extract</strong> them, and push them elsewhere.</p>
<p>This keeps the customer facing system nice and clean, and pushes data to another system, with different performance and availability requirements, and different data structures.</p>
<h2 id="changing-values">
    <a href="#changing-values">
	Changing values
    </a>
</h2>
<p>Most OLTP systems that make sales are well advised to keep current values of the data, if at all possible.
It is cheap and easy to ask for the price of a product in a table with exactly one entry per product, the current price:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- CREATE TABLE product (
</span></span></span><span class="line"><span class="cl"><span class="c1">--   product_id SERIAL,
</span></span></span><span class="line"><span class="cl"><span class="c1">--   name VARCHAR(255),
</span></span></span><span class="line"><span class="cl"><span class="c1">--   price DECIMAL(12,4)
</span></span></span><span class="line"><span class="cl"><span class="c1">-- )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="w">
</span></span></span></code></pre></div><p>If we recorded the price of a product together with a validity interval instead, then all queries become complicated to write,
and expensive to execute:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- CREATE TABLE product (
</span></span></span><span class="line"><span class="cl"><span class="c1">--   product_id SERIAL,
</span></span></span><span class="line"><span class="cl"><span class="c1">--   name VARCHAR(255),
</span></span></span><span class="line"><span class="cl"><span class="c1">--   price DECIMAL(12,4),
</span></span></span><span class="line"><span class="cl"><span class="c1">--   valid_from DATE NULL,
</span></span></span><span class="line"><span class="cl"><span class="c1">--   valid_until DATE NULL,
</span></span></span><span class="line"><span class="cl"><span class="c1">--   INDEX (product_id, valid_until)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">product</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">product_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">valid_until</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span></code></pre></div><p>So if that kind of design can be avoided for the business transactional part of the system, we should not model it.</p>
<p>That kind of query is almost always needed for the backend, analytical part of the system, but that is another place, and it should not part of the OLTP system.</p>
<h2 id="separate-systems">
    <a href="#separate-systems">
	Separate systems
    </a>
</h2>
<p>In an OLTP system, we have data in 3NF or something close to it.
We have a large number of queries, short running transactions and a lot of data changes.
We have a large number of concurrent users, making these changes.
We want to design the system so that the working set of it fits into memory
If we manage to do that, we do see almost no disk reads, and the number of disk reads is independent of the number of users, or the load of the systems.
We cannot avoid the writes, because that&rsquo;s what transactions are.</p>
<p>We design the system so that it contains only current data.
The size of the system is stable over time.
There are no tables that grow over time, without an upper bound.
Instead, the system size is a function of the number of entities modelled in each of its entity-representation tables, and by the number of in-flight business transactions.</p>
<p>In an analytics systems, we have data in &ldquo;fact&rdquo; tables.
These are tables that have &ldquo;time&rdquo; as a component of the primary key, or are even partitioned by time.</p>
<p>We have few, long-running queries, that are often scans.
They aggregate over a fact table or parts of it.
We do not have many data changes.
The data changes we see are often imports, which append data to the fact tables.</p>
<h1 id="etl---extract-transform-load">
    <a href="#etl---extract-transform-load">
	ETL - Extract, Transform, Load
    </a>
</h1>
<p>Sometimes data imports are multistage, because the imported data is not in its final form and needs to be cleaned up.</p>
<p>Data gets from the OLTP system to the analytics system, undergoing a distinct three phased process.
The process is named after the phased, &ldquo;ETL&rdquo; &ndash; extract, transform, load:</p>
<ul>
<li>The data is extracted from the OLTP system. It is in 3NF, and contains many id&rsquo;s representing functionally dependent values in their respective tables.</li>
<li>The data is transformed, resolving the IDs into the functionally dependent value literals.</li>
<li>The data is loaded into the analytics system.
Often this involves cleanup steps, bringing the data into the form it needs be for the analytics system.</li>
</ul>
<h2 id="an-etl-example">
    <a href="#an-etl-example">
	An ETL example
    </a>
</h2>
<p>In <a href="/2020/09/26/my-private-data-warehouse.html">My Private Data Warehouse</a>

 we have an example of such a process, using my bank account statements from a German Sparkasse.</p>
<p>Data arrives from a Sparkasse system in CSV format.
In a first step we load the data into a loader table, <code>transactions</code> table.
Data is then copied from the loader table into a cleanup table, <code>b</code>, and undergoes a number of changes as part of the cleanup process.
Afterwards it could be copied over into a fact table, extending an existing, ever-growing collection of account transactions.</p>
<p>This example is also showing data crossing administrative domain boundaries:
The Sparkasse is running my account, and it does so in whatever form they want or need.
They export data in a documented format, our software contract, but it is not the format I need.</p>
<p>The Extract process is downloading that data from the Sparkasse and shipping it to my system.</p>
<p>The Transform process has, in part already happened &ndash; there are no IDs for me to resolve.</p>
<p>The Load is multistage, I load the data basically as text, and then apply a number of cleanup transformations to it.</p>
<h2 id="the-star-and-the-snowflake">
    <a href="#the-star-and-the-snowflake">
	The Star and the Snowflake
    </a>
</h2>
<p>In order to do actual analytics with it, I need to turn this into collectible, aggregate-able dimensions.
That is, I define categories such as <code>moneysinks</code> and map each remote account name to a category &ndash; basically bins for the aggregation.
I am assigning each transaction to such a category, and then aggregate daily, weekly or monthly spend per category &ndash; this is a report.</p>
<p>While the normal form of an OLTP database is the 3NF or something close to it, analytics databases are made up from fact tables.
Facts have a date as part of the primary key or are even partitioned by date.
For each <code>(id, date)</code> pair we record certain attribute values, and store them literally and denormalized.</p>
<p>&ldquo;Around&rdquo; each fact table we often have stored, pre-aggregated values, for example &ldquo;daily spend by category&rdquo;, &ldquo;daily spend by spender&rdquo; and so on.
Each of these aggregations is called a dimension, and because they group themselves around the fact of which they are aggregates, we call this a Star.</p>
<p>The Star Schema is the simple normal form for analytics databases.
They are not in 3NF, because 3NF stores the <em>current</em> value of an attribute of an entity, and we reference the only copy of that by id.
Instead, we store the literal value of an attribute for a given date as a fact about the thing we are recording, so that we can observe how that value changes over time.</p>
<p>Sometimes, the literal values are rather long strings, and they are repeating quite often.
We then, as part of the data load, also perform a string compression with a lookup table.
In <a href="/2020/09/18/mysql-encoding-fields-for-great-profit.html">Encoding fields for great profit</a>

 I am giving an example of how that works.</p>
<p>Sometimes we aggregate along more than one dimension.
If, for example, in our reservations fact table we would record the country of origin for each user, and the color of each thing, we could aggregate &ldquo;daily reservations per country and color&rdquo; to identify conceivable national color preferences.
Two-dimensional aggregates can be thought of as specializations of single dimensions, and the resulting pattern looks like a Snowflake, the other, slightly more complicated normal form for analytics databases.</p>
<h1 id="summary">
    <a href="#summary">
	Summary
    </a>
</h1>
<p>We try to keep our OLTP systems in 3NF.
We also try to keep only current data in them, and we expire business transactions that are no longer active from them.
This keeps them small and fast, allowing us to run from memory.</p>
<p>If we want to record a transactional history, we do that elsewhere, in an analytics system.
Data in analytics system is collected in tables with a time dimension in the primary key, the fact tables, and groups of aggregates around them, forming a Star or Snowflake.</p>
<p>Data flows from the OLTP system to the Analytics system in an ETL workflow.
This workflow collects data from the OLTP system (extract), resolves the IDs into the functionally dependent values, and retains the literal values of interest (transform).
That data is then loaded into the analytics system, cleaned up, categorized and pre-aggregated (load).
Old, retired transactions can then be removed from the OLTP system, keeping it lean and mean.</p>
<p>ETL processes can be batched, once per day, hour or even minute.
This is classic offline analytics with data warehouses.</p>
<p>Or they can be realtime, where a reader tails the log of the database and puts the data onto an event bus such as Kafka or SNS.
On the consuming side the data is still being processed, either classically, or with realtime aggregator that executes sliding window queries.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
				<a href="/tags/#data-warehouse" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				data warehouse
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2022-11-16-of-stars-and-snowflakes.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/11/09/databases-on-unraided-storage.html">Databases on un-RAID-ed storage?</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/11/20/etl-from-a-django-model.html">ETL from a Django Model</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
