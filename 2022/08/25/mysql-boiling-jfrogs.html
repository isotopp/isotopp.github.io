<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Boiling JFrogs | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2022/08/25/mysql-boiling-jfrogs.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Boiling JFrogs | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2022/08/25/mysql-boiling-jfrogs.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2022-08-25T11:13:00Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Boiling JFrogs' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-boiling-jfrogs-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Boiling JFrogs
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>August 25, 2022</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/08/23/mysql-gipk.html">MySQL: GIPK (InnoDB and Primary Keys)</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/09/02/mysql-yolo-mode.html">MySQL: YOLO mode</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>A work problem:
A commercial application, Artifactory, where we do not control the source or the schema has performance problems involving a certain long running query.</p>
<p>The data size and row counts are not outrageous, and the query itself and the schema are not broken.
But the data is very skewed and for certain values the query is very slow, as almost the entire table is selected.</p>
<p>We introduce an experimental covering index, and show a 16x improvement, going from 143s to 9s execution time.
We advise the customer to ask for this covering index to be added officially using the normal way through MySQL portal.</p>
<h1 id="here-we-go">
    <a href="#here-we-go">
	Here we go
    </a>
</h1>
<p>A call to DBA:</p>
<blockquote>
<p>We&rsquo;ve been investigating performance issues on the Artifactory side and found that our current MySQL primary is sitting at 80-90% I/O utilization.
Our next steps would be to see if there is any slow queries without indices or anything else unusual going on from the 3rd party application that we could potentially fix.</p>
<p>How would I get the required access to have a look or is there already data collection in regards to this?</p></blockquote>
<p>We are running SolarWinds DPM nee Vividcortex, so the easy way out is to point the customer at the SolarWinds access form and wish them luck.</p>
<p>Instead we go and have a look.</p>
<h1 id="the-situation-on-the-ground">
    <a href="#the-situation-on-the-ground">
	The situation on the ground
    </a>
</h1>
<p>Artifactory is a product by a company called JFrogs.
It stores the output of CI pipelines and serves images for all kinds of backends.
For us, mostly Docker.</p>
<p>The replication hierarchy is present in two AZs, and is comprised of standard bare metal blades.
That translates into 16C/32T, 128 GB RAM and 2 TB of local disk.
A quick hop onto the box shows a load of 22+, which is very high.
We see around 10k-15k SELECT/s, which is unusual for a primary in our database landscape.</p>
<p>The data directory has a total size of some 400 GB, and the Resident Set Size of the <code>mysqld</code> is aroudn 100 GB, fully grown.
That is pretty large for such a small database.</p>
<p>We see a low read load, so the Working Set Size (WSS) still fits into the InnoDB Buffer Pool.
The write load is rather high (hundreds of writes per second, spiking into several thousands), which is very weird for a thing that is supposed to be a metadata store for images.</p>
<p>The replica pool is completely idle:
We see the write load being replicated, but there are no client connections outside the monitoring.
Artifactory is an external product and it knows nothing about replication.
It does not split read and write handles, and so all of its traffic hits the primary and only the primary.
It does not scale.</p>
<p>In the past, we also had tables without primary keys in their schema, which is a big issue for scalability for other reasons.
Generally the product claims to be database product agnostic, which among DBA folk is a sure signal for badly optimized schemas and worse scalability.
Being a &ldquo;database agnostic&rdquo; Java application, I expect UUIDv4 primary keys, bad Hibernate generated queries and toil from a tangle of foreign key constraints.</p>
<h1 id="whats-visible">
    <a href="#whats-visible">
	What&rsquo;s visible
    </a>
</h1>
<p>There is a bunch of tooling running in our environment that can give you an idea what the box is doing, and what is observed to be slow.
Most of that has a latency, and a history, but I want to see what is happening now, and I want to see it in full fidelity, without aggregations.</p>
<p>So I hop on the box and</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">processlist</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;query&#34;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">10</span><span class="err">\</span><span class="k">G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">time</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">info</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;docker&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">time</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">info</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;maven-booking-snapshots&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">time</span><span class="p">:</span><span class="w"> </span><span class="mi">147</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">info</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">node_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">folders</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">node_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">repo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">time</span><span class="p">:</span><span class="w"> </span><span class="mi">96</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">info</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;docker&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">time</span><span class="p">:</span><span class="w"> </span><span class="mi">97</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">info</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;docker&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">6</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">time</span><span class="p">:</span><span class="w"> </span><span class="mi">109</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">info</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;docker&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Here I am asking <code>I_S.PROCESSLIST</code> what is currently running and takes longer than 10 seconds.
I find six instances of a query, five of them a reporting query on the total size of what later turns out to be a folder (&ldquo;sum query&rdquo;) and one of it a reporting query over a set of files and folders (&ldquo;folder query&rdquo;).
Both are running on the same table, <code>nodes</code>.</p>
<p>So let&rsquo;s have a look at the ground truth some more.</p>
<h1 id="tables-and-sizes">
    <a href="#tables-and-sizes">
	Tables and Sizes
    </a>
</h1>
<p>Before we are going to dive into the single repeated slow query seen above, we want to know more about the database size and statistics.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">table_name</span><span class="p">,</span><span class="w"> </span><span class="n">data_length</span><span class="p">,</span><span class="w"> </span><span class="n">index_length</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">data_length</span><span class="o">+</span><span class="n">index_length</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------------+--------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">TABLE_NAME</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="n">DATA_LENGTH</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">INDEX_LENGTH</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------------+--------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">indexed_archives_entries</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">119276568576</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">141969801216</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">nodes</span><span class="w">                    </span><span class="o">|</span><span class="w">  </span><span class="mi">17985060864</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">26106396672</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">node_props</span><span class="w">               </span><span class="o">|</span><span class="w">   </span><span class="mi">6278447104</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">10418765824</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">md_files</span><span class="w">                 </span><span class="o">|</span><span class="w">   </span><span class="mi">4574937088</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">9278537728</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">binaries</span><span class="w">                 </span><span class="o">|</span><span class="w">   </span><span class="mi">4375724032</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">5129666560</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">md_ver_user_properties</span><span class="w">   </span><span class="o">|</span><span class="w">   </span><span class="mi">2065678336</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">1154039808</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">md_files_versions</span><span class="w">        </span><span class="o">|</span><span class="w">   </span><span class="mi">1363902464</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">1270267904</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">md_ver_repos</span><span class="w">             </span><span class="o">|</span><span class="w">    </span><span class="mi">766492672</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">1069252608</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">node_meta_infos</span><span class="w">          </span><span class="o">|</span><span class="w">   </span><span class="mi">1807663104</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="n">md_versions</span><span class="w">              </span><span class="o">|</span><span class="w">    </span><span class="mi">557842432</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">969637888</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------------+--------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">10</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">15</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>and that&rsquo;s a total of 243 GB for the largest table, and some 41 GB for our friend, the <code>nodes</code> table, the second largest table in our database.</p>
<h2 id="tables-of-log-nature">
    <a href="#tables-of-log-nature">
	Tables of Log-nature
    </a>
</h2>
<p>The largest table, <code>indexed_archives_entries</code>, is not our problem today.
But the size and the name suggest a thing that happens so often that it is worthwhile mentioning anyway:</p>
<p>Almost all transactional applications have tables that are log-natured.
Their primary key has a time or counter component, or they are partitioned on time.
With all load factors of the system staying the same, just by waiting, these tables will grow without bounds, because they are logs.
If you do not complete the data lifecycle for these structures, they will eventually eat the box.</p>
<p>That is, such tables need to be pruned.
They are a data warehouse inside your transactional system that struggles to get out.
So you either ETL these records into a data warehouse in a regular export.
Or you forego this entirely, put a change even onto a Kafka bus or a syslog, and let another component that is not serving user facing transactional traffic pick it up and aggregate it.</p>
<p>Again, everybody has these tables, and everybody eventually needs to come clean about them, or die from bloat. (looking at you OpenStack)</p>
<h1 id="the-nodes-table">
    <a href="#the-nodes-table">
	The nodes table
    </a>
</h1>
<p>The <code>nodes</code> table looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">show</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">nodes</span><span class="err">\</span><span class="k">G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="n">nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Create</span><span class="w"> </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">nodes</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">node_id</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">node_type</span><span class="o">`</span><span class="w"> </span><span class="n">tinyint</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">repo</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">node_path</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">node_name</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">depth</span><span class="o">`</span><span class="w"> </span><span class="n">tinyint</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">created</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">created_by</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">modified</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">modified_by</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">updated</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">bin_length</span><span class="o">`</span><span class="w"> </span><span class="nb">bigint</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">sha1_actual</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">sha1_original</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">md5_actual</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">md5_original</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">sha256</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">repo_path_checksum</span><span class="o">`</span><span class="w"> </span><span class="nb">char</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">node_id</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">nodes_repo_path_name_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">repo</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">node_path</span><span class="o">`</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span><span class="o">`</span><span class="n">node_name</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">nodes_node_path_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">node_path</span><span class="o">`</span><span class="p">(</span><span class="mi">255</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">nodes_node_name_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">node_name</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">nodes_sha1_actual_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">sha1_actual</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">nodes_md5_actual_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">md5_actual</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">nodes_sha256_idx</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">sha256</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">nodes_repo_path_checksum</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">repo_path_checksum</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">KEY</span><span class="w"> </span><span class="o">`</span><span class="n">node_type__repo</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">node_type</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">repo</span><span class="o">`</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="o">`</span><span class="n">nodes_binaries_fk</span><span class="o">`</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">sha1_actual</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="o">`</span><span class="n">binaries</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">sha1</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">RESTRICT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">RESTRICT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb3</span><span class="w"> </span><span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb3_bin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>The table is using a <code>bigint</code> primary key, which is a positive surprise for me, expecting a Java UUIDv4.</p>
<p>The index used from the plan below is <code>nodes_repo_path_name_idx</code>, which has a prefix of <code>repo</code> being used.
<code>repo</code> is a <code>varchar(64) charset utf8mb3</code> worth up to 194 bytes including length counter overhead.</p>
<p>The plan:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;docker&#39;</span><span class="err">\</span><span class="k">G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">select_type</span><span class="p">:</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">table</span><span class="p">:</span><span class="w"> </span><span class="n">nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">partitions</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="k">ref</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">possible_keys</span><span class="p">:</span><span class="w"> </span><span class="n">nodes_repo_path_name_idx</span><span class="p">,</span><span class="n">node_type__repo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">key</span><span class="p">:</span><span class="w"> </span><span class="n">nodes_repo_path_name_idx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">key_len</span><span class="p">:</span><span class="w"> </span><span class="mi">194</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="k">ref</span><span class="p">:</span><span class="w"> </span><span class="n">const</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">rows</span><span class="p">:</span><span class="w"> </span><span class="mi">13064296</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">filtered</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">29</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">Extra</span><span class="p">:</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Now, I know nothing about Artifactory at all, but this reads to me like a non-critical query for the baseline functionality of Artifactory.
It also looks like something that can and should be cached somewhat.</p>
<p>It is unclear to me and the customer if that query is coming from actual Artifactory or some external monitoring added to it, but it is rather obvious that a rather large part of the load we see is coming from it.</p>
<p>For good measure, here are the table stats:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&#34;nodes&#34;</span><span class="err">\</span><span class="k">G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">***************************</span><span class="w"> </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="o">***************************</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">TABLE_CATALOG</span><span class="p">:</span><span class="w"> </span><span class="n">def</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">TABLE_SCHEMA</span><span class="p">:</span><span class="w"> </span><span class="n">artdb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">TABLE_NAME</span><span class="p">:</span><span class="w"> </span><span class="n">nodes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">TABLE_TYPE</span><span class="p">:</span><span class="w"> </span><span class="n">BASE</span><span class="w"> </span><span class="k">TABLE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">ENGINE</span><span class="p">:</span><span class="w"> </span><span class="n">InnoDB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">VERSION</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">ROW_FORMAT</span><span class="p">:</span><span class="w"> </span><span class="k">Dynamic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">TABLE_ROWS</span><span class="p">:</span><span class="w"> </span><span class="mi">26008347</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">AVG_ROW_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="mi">691</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DATA_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="mi">17985060864</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MAX_DATA_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">INDEX_LENGTH</span><span class="p">:</span><span class="w"> </span><span class="mi">26106396672</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">DATA_FREE</span><span class="p">:</span><span class="w"> </span><span class="mi">7340032</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">CREATE_TIME</span><span class="p">:</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">15</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">08</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">UPDATE_TIME</span><span class="p">:</span><span class="w"> </span><span class="mi">2022</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">24</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">40</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">CHECK_TIME</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">TABLE_COLLATION</span><span class="p">:</span><span class="w"> </span><span class="n">utf8mb3_bin</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="n">CHECKSUM</span><span class="p">:</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">CREATE_OPTIONS</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">TABLE_COMMENT</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Neither the table definition nor the plan are broken per se,
and the table size is not outrageous.
But we see around 26 MRows in total, and from the plan 13 MRows being considered.</p>
<p>So this looks like a data problem, not a problem with the SQL or the plan.
We have bad selectivity.</p>
<h1 id="selectivity-matters-this-is-a-data-bug">
    <a href="#selectivity-matters-this-is-a-data-bug">
	Selectivity matters (This is a data bug)
    </a>
</h1>
<p>Running one of the slow queries takes two minutes and a bit, 135 seconds.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="o">=</span><span class="s1">&#39;docker&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">330189712981975</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">min</span><span class="w"> </span><span class="mi">15</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Let&rsquo;s histogram and check the prevalence of <code>&quot;docker&quot;</code> values in this table.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">node_type</span><span class="p">,</span><span class="w"> </span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">node_type</span><span class="p">,</span><span class="w"> </span><span class="n">repo</span><span class="w">  </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cnt</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">&lt;</span><span class="n">two</span><span class="w"> </span><span class="n">hundred</span><span class="w"> </span><span class="n">something</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">output</span><span class="w"> </span><span class="n">cut</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">auto</span><span class="o">-</span><span class="n">trashcan</span><span class="w">                      </span><span class="o">|</span><span class="w">  </span><span class="mi">1487255</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">android</span><span class="o">-</span><span class="n">snapshots</span><span class="w">                  </span><span class="o">|</span><span class="w">  </span><span class="mi">1698574</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">maven</span><span class="o">-</span><span class="n">booking</span><span class="o">-</span><span class="n">snapshots</span><span class="w">            </span><span class="o">|</span><span class="w">  </span><span class="mi">4910184</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">         </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">docker</span><span class="w">                             </span><span class="o">|</span><span class="w"> </span><span class="mi">12155158</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+------------------------------------+----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">261</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">17</span><span class="p">.</span><span class="mi">22</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>So the column <code>repo</code> has 261 different values for 26 MRows.
But the distribution of values is very uneven.
240 values or so have each fewer than 100 KRows (many have fewer than 100) and the value <code>&quot;docker&quot;</code> is seen 12M times.</p>
<p>Data is stored in pages of 16 KB, and we get to see an average row length of slightly under 1K in the output further above.
That means we see 16 or more rows per block.
But 1/2 of all rows are values <code>&quot;docker&quot;</code>, so when we ask questions related to <code>&quot;repo='docker'&quot;</code>, we select 50% all rows.</p>
<p>Assuming equidistribution and no clustering that means we are loading all pages of this table and have to go through them.
For this value of <code>repo</code> the index is useless.</p>
<p>&ldquo;You query is fine, but your data is bad, mate.&rdquo; is something nobody wants to hear.
But selectivity matters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="o">=</span><span class="s1">&#39;nuget&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">       </span><span class="mi">270744844</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>versus</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="o">=</span><span class="s1">&#39;docker&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">330108119380433</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">min</span><span class="w"> </span><span class="mi">23</span><span class="p">.</span><span class="mi">98</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Asking for <code>repo='nuget'</code> is solved in 0.11s, but asking for <code>repo='docker'</code> is taking 144 seconds.</p>
<h1 id="a-better-index-for-bad-data">
    <a href="#a-better-index-for-bad-data">
	A better index for bad data
    </a>
</h1>
<p>To resolve the query</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="o">=</span><span class="s1">&#39;docker&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>using an index on repo, the database will go into the secondary index and select all rows with <code>repo=&quot;docker&quot;</code>.
It needs to narrow this list down to values that are also have <code>node_type=1</code>, manually, because the index chosen as per <code>EXPLAIN</code> does not have this information.</p>
<p>It will find the primary key of each row in the index, and then go to the primary key.
Here it will select all rows found, to get the value for <code>bin_length</code>.</p>
<p>It will then sum up these numbers to come up with the result.</p>
<p>That&rsquo;s a bunch on index reads on the secondary index, and then using the cleaned up of primary key values from the index to fetch the actual data.
On rotating disk, it would also involve around 13M disk seeks (at 5ms, so 200 seeks/second), so the query would run for ages (or things are cached very well in memory).</p>
<p>But we can do better, even in a bad situation such as this.</p>
<p>We could either</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">(</span><span class="n">node_type</span><span class="p">,</span><span class="w"> </span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="n">bin_length</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>or the equivalent</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">(</span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="n">node_type</span><span class="p">,</span><span class="w"> </span><span class="n">bin_length</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Either will satisfy the (commutative) <code>AND</code> condition from our sum query. But we also have the folder query to consider, which is also slow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">repo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">node_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">folders</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="k">CASE</span><span class="w"> </span><span class="k">WHEN</span><span class="w"> </span><span class="n">node_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">ELSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">END</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">files</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">repo</span><span class="w">
</span></span></span></code></pre></div><p>This groups by <code>repo</code> and otherwise uses the same columns.
As it groups by <code>repo</code> it can only profit from an index that has <code>repo</code> as the prefix.</p>
<p>We choose</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">(</span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="n">node_type</span><span class="p">,</span><span class="w"> </span><span class="n">bin_length</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>as an index that can serve both.</p>
<h2 id="covering-indexes-or-why-this-is-fast">
    <a href="#covering-indexes-or-why-this-is-fast">
	Covering indexes (or why this is fast)
    </a>
</h2>
<p>Running the sum query against this index will dive into the secondary index.</p>
<p>Using the index, we select all rows matching <code>repo</code> and <code>node_type</code>.
We also forced <code>bin_length</code> into this index, but it is not used in selection.</p>
<p>But it&rsquo;s there, as well as the invisible pointer to the full row (the primary key, <code>id</code>).
The optimizer knows that, and can use it: It uses the <code>bin_length</code> from the index, no need to go to the full row.</p>
<p>Effectively we select a subtree from the index, incidentally also find the data we need to sum up, and serve that back.
We can do this without having to go back to the primary key, critically saving abunch of seek operations (on rotating disk) and data page access (everywhere).</p>
<p>This speeds up query execution from 140-ish seconds to 4s-9s.</p>
<p>Since we have a bunch of replicas for resilience, even if Artifactory cannot use them, I might as well use them for experimentation.
Running the docker query on the cold (on the replica) cache takes 6m10s.
After cache warmup, it takes 2m15.
After the index juggling (which takes 3m6s) the query resolves in 9s.</p>
<p>That&rsquo;s a 16x speedup.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="n">cold</span><span class="w"> </span><span class="n">box</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="o">=</span><span class="s1">&#39;docker&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">330182660184225</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">6</span><span class="w"> </span><span class="k">min</span><span class="w"> </span><span class="mi">9</span><span class="p">.</span><span class="mi">81</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="k">cache</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">warm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="o">=</span><span class="s1">&#39;docker&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">330189712981975</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">min</span><span class="w"> </span><span class="mi">15</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">me</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">index</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">node_type</span><span class="p">,</span><span class="w"> </span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="n">bin_length</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">min</span><span class="w"> </span><span class="mi">6</span><span class="p">.</span><span class="mi">64</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Records</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Duplicates</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">covering</span><span class="w"> </span><span class="k">index</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">repo</span><span class="o">=</span><span class="s1">&#39;docker&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">bin_length</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">330202302319881</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">9</span><span class="p">.</span><span class="mi">03</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>This technique of using covering indexes I have learned from an Ex-MySQL colleague, <a href="https://twitter.com/mituzas" target="_blank" rel="noopener">Domas Mituzas</a>

, who used it excessively to make Wikipedia fast while working as a Wikimedia DBA.
Thanks, Domas.</p>
<h1 id="other-observations">
    <a href="#other-observations">
	Other observations
    </a>
</h1>
<h2 id="ohai-mdl">
    <a href="#ohai-mdl">
	Ohai, MDL!
    </a>
</h2>
<p>During our experimentation we found that an additional index can speed some critical queries.
Adding the index on a production replica worked, taking 3 minutes and yielded a speedup of 16x.</p>
<p>Trying to put this index into production failed:
Plenty of slow sum queries pile up with &ldquo;waiting on metadata lock&rdquo;.
Checking on the <code>ALTER</code>, we find it is also waiting on the metadata lock.</p>
<p>I have not checked the source, but I am assuming the MDL protects the table definition.
A running query takes a share lock (S-Lock) on the MDL to make sure the table does not change shape while the query is running.
An <code>ALTER</code> takes out an exclusive lock (X-Lock) on the MDL to make sure it is alone while the shape of the table changes.</p>
<p>In MySQL, X-Locks usually have precedence over S-Locks, so asking for an X-Lock will stall all requests for S-Lock.
That means starting the <code>ALTER</code> was responsible for all the stalled queries on <code>nodes</code> in &ldquo;waiting for metadata lock&rdquo; state.</p>
<p>But why was the <code>ALTER</code> itself stalled?
While X-Locks have precedence over S-Locks, breaking locks that have already been granted is Not A Thing.
So the <code>ALTER</code> has to wait for all the existing S-Locks being held on <code>nodes</code> to go away before it can start.
The queries running are slow queries, though, running for around 2 minutes.</p>
<p>So we &ldquo;just&rdquo; have to wait two minutes for the <code>ALTER</code> to start and then another three minutes for it to complete, I presume.
Unfortunately, a 5m to 7m wait piles up so many queries that we would run out of connection, and also our developers using Artifactory would hate on us.</p>
<p>So I have to terminate the <code>ALTER</code> and we choose another approach:
Change all replicas, fail the application to a replica that is being promoted to primary, and then fix the ex-primary left behind (or simply let the automation reclone it).</p>
<h2 id="latency-matters">
    <a href="#latency-matters">
	Latency matters
    </a>
</h2>
<p>We do this, and we find that Artifactory shows a very much changed behavior:
Write levels are around 10x lower, and disk I/O &ldquo;util%&rdquo; drops dramatically, but also the load balancer metrics look a lot more precarious.</p>
<p>We learn that for the application team a switchover means a switchover of the database.
The Artifactory application remains running in the Netherlands, but the database it talks to is now 10ms away in England.
Obviously, this kind of communication latency affects application performance.</p>
<p>After making changes, we fail back.
Both Artifactory and its database are now in the Netherlands, and we get a 10x higher write rate, stable load balancer latencies and again a critically high disk saturation.</p>
<h2 id="disk-writes-why">
    <a href="#disk-writes-why">
	Disk Writes, why?
    </a>
</h2>
<p>Well, not critically high.
It turns out that &ldquo;util%&rdquo; is not a good metric at all, and also that <code>dm-7</code> or other device mapper metrics are often fishy.
Looking at completion latency statistics from <code>sda</code> shows we move up around 10% with plenty of headroom, so we are actually fine.</p>
<p>The question remains:
Why does an application serving docker image metadata write to disk so much?</p>
<p>Well, it&rsquo;s writes and we archive them in binlog.
So, let&rsquo;s ghetto some table write stats from a row based replication binlog.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="o">#</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">mysql</span><span class="cm">/*/logs
</span></span></span><span class="line"><span class="cl"><span class="cm"># mysqlbinlog -vvv binlog.... | awk &#39;/^### UPDATE/ { print $3 }&#39; | sort | uniq -c | sort -n
</span></span></span><span class="line"><span class="cl"><span class="cm">...
</span></span></span><span class="line"><span class="cl"><span class="cm"> 112615 `artdb`.`nodes`
</span></span></span><span class="line"><span class="cl"><span class="cm"> 610088 `artdb`.`md_pkg_stats`
</span></span></span><span class="line"><span class="cl"><span class="cm"> 610088 `artdb`.`md_ver_stats`
</span></span></span><span class="line"><span class="cl"><span class="cm">2901027 `artdb`.`stats`
</span></span></span></code></pre></div><p>Uh, yes.</p>
<p>If you are turning every image read into a stats write, you have a lot of writes and you don&rsquo;t scale.</p>
<p>Maybe don&rsquo;t log to the production database monolith, but Kafka or syslog stats out, and collect them elsewhere?
It&rsquo;s 2022, after all</p>
<h2 id="one-more-slow-query">
    <a href="#one-more-slow-query">
	One more slow query
    </a>
</h2>
<p>The team finds one more slow query that is breaching our ad-hoc 10s barrier:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="n">node_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="n">node_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="n">repo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="n">node_path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="n">node_name</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">nodes</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="n">node_type</span><span class="o">=</span><span class="mi">1</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="n">repo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;auto-trashcan&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">nodes</span><span class="p">.</span><span class="n">repo</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;jfrog-support-bundle&#39;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">lower</span><span class="p">(</span><span class="n">nodes</span><span class="p">.</span><span class="n">node_name</span><span class="p">)</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;tax%&#39;</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1000</span><span class="w">
</span></span></span></code></pre></div><p>We already know from other research that <code>node_type=1</code> is not very selective.
It indicates directories (0) and files (1).
The negations are also not good at increasing selectivity and indexing on negations is&hellip; fraught with problems.
That leaves us with <code>nodes.node_name</code>.</p>
<p>Which is wrapped into a function, <code>lower()</code>.
This function turns the values in the column into lower case for comparison with a string constant with a wildcard in a like (essentially almost a <code>BETWEEN 'tax' AND 'tay'</code>, except that <code>BETWEEN</code> is inclusive and <code>%</code> is not).</p>
<p>Now in database gnostic SQL one would drop the <code>lower()</code> since your default collation is <code>_ci</code> (case insensitive) and <code>_ai</code> (accent insensitive) anyway.
It serves no function in MySQL.</p>
<p>In all other databases, you&rsquo;d <code>lower()</code> in Java and write normalized data into the database.</p>
<p>But it matters not, we have functional indexes, so instead of indexing <code>nodes.node_name</code> we just index <code>lower(nodes.node_name)</code> instead.
That changes nothing for MySQL at all, but the optimizer requires this data duplication in order to see the possibility.</p>
<p>Percona discusses <a href="https://www.percona.com/blog/mysql-8-0-functional-indexes/" target="_blank" rel="noopener">MySQL 8 Functional Indexes</a>

 in their blog, and the <a href="https://dev.mysql.com/doc/refman/8.0/en/create-index.html#create-index-functional-key-parts" target="_blank" rel="noopener">manual</a>

 has them as well, of course.</p>
<h1 id="summary">
    <a href="#summary">
	Summary
    </a>
</h1>
<p>We run into a database load problem that turns out not to be a size-related or query-related problem at all, but a good case for covering indexes.
Covering indexes are a powerful tool to speed up certain kind of reporting queries that otherwise accumulate a lot of run time.</p>
<p>We also get a glimpse at the data structures in Artifactory, which look a lot better than most DBAs would expect from previous encounters with Hibernate using Java products.</p>
<p>Still the product can benefit a lot from a very modest investment in access modernization (split read and write handles) and segregation of transactional and reporting/log-natured data (cut out log writes, cut out log tables and complete the data lifecycle), which would help it scale to survive in a large Enterprise environment.
Do not weigh down your transactional database with evergrowing log writes, and also do not turn every customer read into a write into your transactional database monolith.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2022-08-25-mysql-boiling-jfrogs.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/08/23/mysql-gipk.html">MySQL: GIPK (InnoDB and Primary Keys)</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/09/02/mysql-yolo-mode.html">MySQL: YOLO mode</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
