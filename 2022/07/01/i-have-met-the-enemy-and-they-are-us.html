<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>I have met the enemy, and they are us | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2022/07/01/i-have-met-the-enemy-and-they-are-us.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='I have met the enemy, and they are us | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2022/07/01/i-have-met-the-enemy-and-they-are-us.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2022-07-01T14:30:00Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='I have met the enemy, and they are us' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="i-have-met-the-enemy-and-they-are-us-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						I have met the enemy, and they are us
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>July 1, 2022</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/06/28/the-new-energy-bill.html">The new energy bill</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/07/03/energieverbrauch-in-deutschland.html">Energieverbrauch in Deutschland</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Another Friday, another replication hierarchy lost.</p>
<h1 id="the-error-from-june-july-edition">
    <a href="#the-error-from-june-july-edition">
	The error from June, July edition?
    </a>
</h1>
<p>The errors reported look awfully familiar: Binlog position is supposedly 4, and the error message has text about &ldquo;max_allowed_packet&rdquo;.
Could it be another instance of <a href="/2022/06/07/mysql-binlog-compression-and-large-transactions.html">this bug</a>

 from early last month?</p>
<p>Indeed, one symptom was &ldquo;a large binlog, larger than max_binlog_size&rdquo;.
We check.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">-rw-r----- 1 mysql mysql 1073794077 Jul  1 06:39 binlog.000914
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r----- 1 mysql mysql 1073869075 Jul  1 07:09 binlog.000915
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r----- 1 mysql mysql 1073741881 Jul  1 09:28 binlog.000916
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r----- 1 mysql mysql 2038358667 Jul  1 11:21 binlog.000917
</span></span></span></code></pre></div><p>Log ends at 11:21, at twice the expected size.
Meh.</p>
<h1 id="to-the-flight-recorder">
    <a href="#to-the-flight-recorder">
	To the flight recorder
    </a>
</h1>
<p>Let&rsquo;s check the <a href="/2021/04/22/a-mysql-flight-recorder.html">flight recorder</a>

, again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> <span class="nb">cd</span> /var/log/mysql_pl/Fri
</span></span><span class="line"><span class="cl"><span class="gp">#</span> <span class="k">for</span> i in 1<span class="o">[</span>012<span class="o">]</span>_??.innodb.xz<span class="p">;</span> <span class="k">do</span> 
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span>   <span class="nb">echo</span> <span class="nv">$i</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span>   xz -dc <span class="nv">$i</span> <span class="p">|</span> 
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span>     perl -ne <span class="s1">&#39;/(undo log entries) ([0-9]+)/ &amp;&amp; $2 &gt; 1000 &amp;&amp; print &#34;$2\n&#34;;&#39;</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span> <span class="k">done</span><span class="p">|</span>
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span> less
</span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">11_20.innodb.xz
</span></span></span><span class="line"><span class="cl"><span class="go">2895
</span></span></span><span class="line"><span class="cl"><span class="go">11_21.innodb.xz
</span></span></span><span class="line"><span class="cl"><span class="go">2895
</span></span></span><span class="line"><span class="cl"><span class="go">11_22.innodb.xz
</span></span></span><span class="line"><span class="cl"><span class="go">11_23.innodb.xz
</span></span></span></code></pre></div><h1 id="dba-meet-dba">
    <a href="#dba-meet-dba">
	DBA, meet DBA
    </a>
</h1>
<p>So what is it this time?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> xz -dc 11_21.innodb.xz<span class="p">|</span> less
</span></span><span class="line"><span class="cl"><span class="go">623 lock struct(s), heap size 73848, 3548 row lock(s), undo log entries 2895
</span></span></span><span class="line"><span class="cl"><span class="go">MySQL thread id 186615979, OS thread handle 140545428498176, query id 2978139105 localhost root Waiting for semi-sync ACK
</span></span></span><span class="line"><span class="cl"><span class="go">INSERT LOW_PRIORITY IGNORE INTO `schema`.`_table_new` (`id`, ...`) 
</span></span></span><span class="line"><span class="cl"><span class="go">  SELECT `id`, ... FROM `schema`.`table` LOCK IN SHARE MODE /*pt-online-schema-change 63828 copy table*/
</span></span></span></code></pre></div><p>This is an <code>INSERT ... SELECT ...</code>, generated from Percona Online Schema Change.
The transaction has some 2895 rows open, so in order for this to be a problem the average row length must be very large.</p>
<p>Let&rsquo;s check:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@instance-1009 [schema]&gt; show table status like &#39;table&#39;\G
</span></span></span><span class="line"><span class="cl"><span class="go">*************************** 1. row ***************************
</span></span></span><span class="line"><span class="cl"><span class="go">           Name: table
</span></span></span><span class="line"><span class="cl"><span class="go">         Engine: InnoDB
</span></span></span><span class="line"><span class="cl"><span class="go">        Version: 10
</span></span></span><span class="line"><span class="cl"><span class="go">     Row_format: Dynamic
</span></span></span><span class="line"><span class="cl"><span class="go">           Rows: 2437
</span></span></span><span class="line"><span class="cl"><span class="go"> Avg_row_length: 3350975    &lt;-- average!
</span></span></span><span class="line"><span class="cl"><span class="go">    Data_length: 8166326272 &lt;-- 8-ish GB used
</span></span></span><span class="line"><span class="cl"><span class="go">Max_data_length: 0
</span></span></span><span class="line"><span class="cl"><span class="go">   Index_length: 3194880    &lt;-- almost no secondary index
</span></span></span><span class="line"><span class="cl"><span class="go">      Data_free: 57958989824 &lt;- also spiky usage, 53 GB free space
</span></span></span><span class="line"><span class="cl"><span class="go"> Auto_increment: 546211
</span></span></span><span class="line"><span class="cl"><span class="go">    Create_time: 2020-12-08 02:25:41
</span></span></span><span class="line"><span class="cl"><span class="go">    Update_time: 2022-07-01 10:11:12
</span></span></span><span class="line"><span class="cl"><span class="go">     Check_time: NULL
</span></span></span><span class="line"><span class="cl"><span class="go">      Collation: latin1_swedish_ci
</span></span></span><span class="line"><span class="cl"><span class="go">       Checksum: NULL
</span></span></span><span class="line"><span class="cl"><span class="go"> Create_options: row_format=DYNAMIC
</span></span></span><span class="line"><span class="cl"><span class="go">        Comment:
</span></span></span><span class="line"><span class="cl"><span class="go">1 row in set (0.00 sec)
</span></span></span></code></pre></div><p>Ok, so we have 3.3 MB row size, on the average (peak blob size is 6.7 MB or so).
Checking the schema shows us two <code>MEDIUMTEXT</code> columns.</p>
<h1 id="analysis">
    <a href="#analysis">
	Analysis
    </a>
</h1>
<p>The mitigation from <a href="/2022/06/07/mysql-binlog-compression-and-large-transactions.html">last month</a>

 had not been implemented, yet.
It has now been escalated.</p>
<p>The event triggering the outage was a transaction larger than 1 GB, as before, in the face of binlog compression.
The program triggering the large transaction was a DBA maintenance job running Percona Online Schema Change.</p>
<p>Percona Online Schema Change has no logic to prevent large transactions from occuring.
It should maybe check average row size, or check largest row size in the table, and cut smaller pieces so that the <code>INSERT ... SELECT</code> it generates always stays below 1G.</p>
<p>Or it should accept that the <code>INSERT ... SELECT</code> may fail, if <code>max_binlog_cache_size</code> has been set, and retry with smaller steps then.
The second idea would be better, I believe.</p>
<p>Again, the flight recorder has been invaluable in nailing down the root cause.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				database
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2022-07-01-i-have-met-the-enemy-and-they-are-us.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/06/28/the-new-energy-bill.html">The new energy bill</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2022/07/03/energieverbrauch-in-deutschland.html">Energieverbrauch in Deutschland</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
