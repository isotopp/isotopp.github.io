<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>PHP: Understanding unserialize() | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">
<link rel="canonical" href="https://blog.koehntopp.info">


<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">




<meta name="generator" content="Hugo 0.104.3" />
<meta property="og:title" content='PHP: Understanding unserialize()' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />


<meta property="og:locale" content="en_US" />


<meta name="description" content='' />
<meta property="og:description" content='' />

<link rel="canonical" href="https://blog.koehntopp.info" />
<meta property="og:url" content="https://blog.koehntopp.info" />


<meta property="og:type" content="article" />
<meta name="article:published_time" content='2017-08-11T13:50:20Z' />



<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/schloss.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content='@isotopp' />
<meta name="twitter:creator" content='@isotopp' />
<meta property="twitter:title" content='PHP: Understanding unserialize()' />
<meta property="twitter:description" content='' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/schloss.jpg' />

<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","description":null,"headline":"PHP: Understanding unserialize()","image":"/assets/img/background/schloss.jpg","name":"Die wunderbare Welt von Isotopp","url":"https://blog.koehntopp.info"}
</script>

    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.731532d47a51fed497cc74301e50720b3c56d09404efc36b4fa1a4117a6aa10e.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            




<div class="page">
  <article class="php-understanding-unserialize-page">
    <div class='row  justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            PHP: Understanding unserialize()
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
            <img alt='isotopp image' src='/assets/img/isotopp.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
            <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
            </a>

            
              <span class='d-none d-lg-inline'>-</span>
              <div class='d-block d-lg-inline'>August 11, 2017</div>
            

          </div>
        </div>
        
          <img alt='a featured image' src="/assets/img/background/schloss.jpg">
        
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p>The history of <code>serialize()</code> and <code>unserialize()</code> in PHP begins with Boris
Erdmann and me, and we have to go 20 years back in time. This is the day of
the prerelease versions of PHP 3,
<a href="http://marc.info/?l=php-general&amp;amp;m=90222513233060&amp;amp;w=2" target="_blank" rel="noopener">some time in 1998</a>

.</p>
<p>Boris and I were working on code for a management system for employee education
for German Telekom. The front side is a web shop that sells classes and
courses, the back end is a complex structure that manages attendance, keeps
track of a line manager approval hierarchy and provides alternative dates
for overfull classes. In order to manage authentication, shopping carts and
other internal state, we needed something that allowed us to go from a
stateless system to a stateful thing, securely. The result was
<a href="https://github.com/bevhost/phplib" target="_blank" rel="noopener">PHPLIB</a>

, and especially the code in
<a href="https://github.com/bevhost/phplib/blob/master/inc/session.inc#L272-L318" target="_blank" rel="noopener">session.inc</a>

.</p>
<p>That code contained a function <code>serialize()</code>, which created a stringified
representation of a PHP variable and appended it to a string. There was no
<code>unserialize()</code> necessary, because <code>serialize()</code> generated PHP code.
<code>eval()</code> would <code>unserialize()</code>.</p>
<p><strong>One of the problems</strong> we had to solve was that PHP3 was slow. So if we
were to write out a serialized representation of variables, we would have to
write a parser for that, and that parser better be fast, because it would be
executed at the beginning of each and every page load. We already had such a
parser, and it was the fastest parser available, PHP itself. So we decided
to write a function that takes a variable, recurses through that variable
and generated PHP code to recreate the variable if that code would be
executed.</p>
<p>For scalars,
<a href="https://github.com/bevhost/phplib/blob/master/inc/session.inc#L313" target="_blank" rel="noopener">that is trivial</a>

.</p>
<p>For an array,
<a href="https://github.com/bevhost/phplib/blob/master/inc/session.inc#L313" target="_blank" rel="noopener">that is possible with a simple recursion over each element</a>

.</p>
<p>For objects, things are complicated.</p>
<p>Firstly, in PHP3, an object does not have the slightest clue what it&rsquo;s
classname is. Secondly, an object might have instance variables that we do
not want to be part of the stringified representation of the object, for
example file and image file handles or other resources. We solved both
problems by requiring serializable objects to have metadata instance
variables, <code>classname</code> and <code>persistent_slots</code>&quot;.</p>
<p>For unserialize, we simply executed that code inside an <code>eval()</code>.</p>
<p>From PHP 4 onward, Sascha Schumann wrote a C implementation of session
management that became a standard part of PHP, which was largely based on
our ideas. Unlike us, he made PHP store session data in the filesystem,
inheriting our idea of probabilistic session expiration. He also converted
the data format from PHP Code to the current representation.</p>
<p><strong>Another problem that needed adressing was code uniformity:</strong>
If you load a serialized object written by another web page of your
application, that object has a class. And the code for that class needs to
be loaded before you can load and re-instantiate that object. Basically, you
saved an instance <code>$a</code> of <code>DemoClass</code>, and if you load that instance again,
running <code>unserialize()</code> on it, PHP needs to know what a <code>DemoClass</code> is and
how to make one, using <code>$a = new DemoClass()</code>, before it can fill in the
values of all instance variables. So the includes of your app better be the
same on all pages, or you invent the
<a href="http://php.net/manual/en/function.autoload.php" target="_blank" rel="noopener">Autoloader</a>

.</p>
<p>The Autoloader originally was a simple callback function that would be
invoked every time you want to make an instance of an unknown class. The
function would get the name of the missing class as a parameter, and would
then be responsible to produce a class definition for that class.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">function</span> <span class="nf">__autoload</span><span class="p">(</span><span class="nv">$missing</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">  <span class="k">echo</span> <span class="s2">&#34;Class </span><span class="si">$missing</span><span class="s2"> is missing.&#34;</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl">  <span class="k">include</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$missing</span><span class="s2">.class.php&#34;</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DoesNotExist</span><span class="p">();</span> 
</span></span></code></pre></div><p>This is your classic suicide autoloader: Whenever an undefined class is
being encountered, <code>__autoload()</code> is being called with that classname. It
would then try to include a file with that name (and all dots and slashes
that you manage to falsify into that name) and hope that this would contain
code that defined a class with a matching name.</p>
<p>Real autoloaders should not look like this (but often they are close enough
to this code to contain exploitable security problems).</p>
<p>Today the autoload mechanism of PHP is more complicated. It has a
<a href="http://php.net/manual/en/function.spl-autoload.php" target="_blank" rel="noopener">default autoloader</a>

,
<a href="http://php.net/manual/en/function.spl-autoload-register.php" target="_blank" rel="noopener">a mechanism to manage a stack of autoloaders</a>

,
and a bunch of <a href="http://php.net/manual/en/function.spl-autoload-extensions.php" target="_blank" rel="noopener">other</a>


<a href="http://php.net/manual/en/function.include.php" target="_blank" rel="noopener">things</a>

 such as file
extensions and include path names to influence all that. It is also quite
good,
<a href="https://github.com/Sereal/Sereal/blob/master/README.pod" target="_blank" rel="noopener">even if more sophisticated serializers exist</a>

.</p>
<p><strong>So what is the state of <code>unserialize()</code> in PHP these days, and why?</strong></p>
<p><p class="md__image">
  <img src="/uploads/2017/08/Screen-Shot-2017-08-11-at-13.44.00.png" alt=""  />
</p>

</p>
<p><a href="https://twitter.com/nikita_ppv/status/895571304325062656" target="_blank" rel="noopener">That was a controversial Tweet</a>

</p>
<p>It links to this:</p>
<p><p class="md__image">
  <img src="/uploads/2017/08/do-not-unserialize-foreign-code.png" alt=""  />
</p>

</p>
<p><a href="http://php.net/unserialize" target="_blank" rel="noopener">Really Good Advice™</a>

</p>
<p>People object:</p>
<p><p class="md__image">
  <img src="/uploads/2017/08/how-does-this-solve-anything.png" alt=""  />
</p>

</p>
<p><a href="https://twitter.com/buherator/status/895933031529275392" target="_blank" rel="noopener">People object</a>

</p>
<p>but given the little tour above, you should be able to understand how
<code>unserialize()</code> cannot really be made safe for import of foreign data. You can
<code>unserialize()</code> stuff your code has written, after having verified that the
data you read still is the data you have written, using salted hash_hmac()s
on said data. That&rsquo;s going to be reasonably safe.</p>
<p>You can&rsquo;t, ever, use <code>unserialize()</code> as a data interchange format with other
application or an end user. <code>unserialize()</code> is not an exposable API. Never
was. Other functions and formats for this exist. Use those. Here is some
code to try:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">#! /usr/local/bin/php 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">&lt;?</span><span class="nx">php</span> 
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">show_serialize1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">file_put_contents</span><span class="p">(</span><span class="s2">&#34;demo&#34;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">show_serialize2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$a</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;fnorp&#34;</span><span class="p">,</span> <span class="s2">&#34;glorp&#34;</span><span class="p">,</span> <span class="s2">&#34;dorp&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">file_put_contents</span><span class="p">(</span><span class="s2">&#34;demo&#34;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">show_serialize3</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">DemoClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">private</span> <span class="nv">$priv</span> <span class="o">=</span> <span class="s1">&#39;priv&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$prot</span> <span class="o">=</span> <span class="s1">&#39;prot&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">public</span> <span class="nv">$pub</span> <span class="o">=</span> <span class="s1">&#39;pub&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;Constructed.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">public</span> <span class="k">function</span> <span class="fm">__sleep</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;To be serialized</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;priv&#39;</span><span class="p">,</span> <span class="s1">&#39;prot&#39;</span><span class="p">,</span> <span class="s1">&#39;pub&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">public</span> <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;Just unserialized.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DemoClass</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">file_put_contents</span><span class="p">(</span><span class="s2">&#34;demo&#34;</span><span class="p">,</span> <span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">show_serialize4</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$a</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$a</span><span class="p">[]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="nv">$a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;References inside an array work:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print_r</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;References across unserialize:</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$b</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nx">serialize</span><span class="p">(</span><span class="nv">$a</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;b is unserialized a:&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;Does the ref still work?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print_r</span><span class="p">(</span><span class="nv">$b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">show_unserialize1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;demo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$x</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print_r</span><span class="p">(</span><span class="nv">$x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">define_democlass</span><span class="p">(</span><span class="nv">$class</span> <span class="o">=</span> <span class="s2">&#34;none&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;We want </span><span class="si">$class</span><span class="s2"> defined.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">DemoClass</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">private</span> <span class="nv">$priv</span> <span class="o">=</span> <span class="s1">&#39;fnorp&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">protected</span> <span class="nv">$prot</span> <span class="o">=</span> <span class="s1">&#39;glorp&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">public</span> <span class="nv">$pub</span> <span class="o">=</span> <span class="s1">&#39;dorp&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;Constructed.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">public</span> <span class="k">function</span> <span class="fm">__sleep</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;To be serialized</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;priv&#39;</span><span class="p">,</span> <span class="s1">&#39;prot&#39;</span><span class="p">,</span> <span class="s1">&#39;pub&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">public</span> <span class="k">function</span> <span class="fm">__wakeup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;Just unserialized.</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">show_unserialize2</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spl_autoload_register</span><span class="p">(</span><span class="s1">&#39;define_democlass&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$str</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;demo&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$x</span> <span class="o">=</span> <span class="nx">unserialize</span><span class="p">(</span><span class="nv">$str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">print_r</span><span class="p">(</span><span class="nv">$x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nx">isset</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;Please start with &#39;ser&#39; or &#39;unser&#39;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">switch</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s2">&#34;ser1&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">show_serialize1</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s2">&#34;ser2&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">show_serialize2</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s2">&#34;ser3&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">show_serialize3</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s2">&#34;ser4&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">show_serialize4</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s2">&#34;unser1&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">show_unserialize1</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="s2">&#34;unser2&#34;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="nx">show_unserialize2</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">echo</span> <span class="s2">&#34;Wot?</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>You can use this to see what serialized data looks like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ./probe.php ser1<span class="p">;</span> cat demo<span class="p">;</span> <span class="nb">echo</span>
</span></span><span class="line"><span class="cl"><span class="go">i:1; 
</span></span></span></code></pre></div><p>More complicated stuff such as arrays:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ./probe.php ser2<span class="p">;</span> cat demo<span class="p">;</span> <span class="nb">echo</span>
</span></span><span class="line"><span class="cl"><span class="go">a:3:{i:0;s:5:&#34;fnorp&#34;;i:1;s:5:&#34;glorp&#34;;i:2;s:4:&#34;dorp&#34;;}
</span></span></span></code></pre></div><p>Also, references half-work, if they are internal:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ./probe.php ser4 
</span></span><span class="line"><span class="cl"><span class="go">References inside an array work: 
</span></span></span><span class="line"><span class="cl"><span class="go">Array ( [0] =&gt; 2 [1] =&gt; 2 ) 
</span></span></span><span class="line"><span class="cl"><span class="go">References across unserialize: 
</span></span></span><span class="line"><span class="cl"><span class="go">b is unserialized a:Array ( [0] =&gt; 2 [1] =&gt; 2 ) 
</span></span></span><span class="line"><span class="cl"><span class="go">Does the ref still work? 
</span></span></span><span class="line"><span class="cl"><span class="go">Array ( [0] =&gt; 3 [1] =&gt; 3 ) 
</span></span></span></code></pre></div><p>but serializing a reference $b that points to $a does not work: The value $b
is referencing is saved, and the unserialized variable will have a value,
but will not reference the previous value. There is no error or warning.</p>
<p>Here is what we do to Objects:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ./probe.php ser3<span class="p">;</span> cat demo<span class="p">;</span> <span class="nb">echo</span> 
</span></span><span class="line"><span class="cl"><span class="go">Constructed. 
</span></span></span><span class="line"><span class="cl"><span class="go">To be serialized 
</span></span></span><span class="line"><span class="cl"><span class="go">O:9:&#34;DemoClass&#34;:3:{s:15:&#34;DemoClasspriv&#34;;s:4:&#34;priv&#34;;s:7:&#34;\*prot&#34;;s:4:&#34;prot&#34;;s:3:&#34;pub&#34;;s:3:&#34;pub&#34;;} 
</span></span></span></code></pre></div><p>This shows how the contructor is being executed, how the <code>__sleep()</code>
callback is called and the content of the serialized file with the
stringified DemoClass instance referencing the class name. If we load this
without DemoClass being defined, we get</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ./probe.php unser1 
</span></span><span class="line"><span class="cl"><span class="go">__PHP_Incomplete_Class Object ( 
</span></span></span><span class="line"><span class="cl"><span class="go">  [__PHP_Incomplete_Class_Name] =&gt; DemoClass 
</span></span></span><span class="line"><span class="cl"><span class="go">  [priv:DemoClass:private] =&gt; priv 
</span></span></span><span class="line"><span class="cl"><span class="go">  [prot:protected] =&gt; prot 
</span></span></span><span class="line"><span class="cl"><span class="go">  [pub] =&gt; pub 
</span></span></span><span class="line"><span class="cl"><span class="go">) 
</span></span></span></code></pre></div><p>We can load DemoClass using an autoloader we define. Then we get</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ./probe.php unser2 
</span></span><span class="line"><span class="cl"><span class="go">We want DemoClass defined. 
</span></span></span><span class="line"><span class="cl"><span class="go">Just unserialized. 
</span></span></span><span class="line"><span class="cl"><span class="go">DemoClass Object ( 
</span></span></span><span class="line"><span class="cl"><span class="go">  [priv:DemoClass:private] =&gt; priv 
</span></span></span><span class="line"><span class="cl"><span class="go">  [prot:protected] =&gt; prot 
</span></span></span><span class="line"><span class="cl"><span class="go">  [pub] =&gt; pub 
</span></span></span><span class="line"><span class="cl"><span class="go">) 
</span></span></span></code></pre></div><p>You can see the Autoloader being called, the <code>__wakeup()</code> function running
(it didn&rsquo;t in the example before!) and then the properly re-instantiated
object.</p>
<p>Note that our new version of DemoClass, as defined by the autoloader, does
define different default values for the instance variables so we can show
that the values from the file are being loaded.</p>

      </div>
    </div>

    
    
    <div class='row justify-content-center mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2017%2f08%2f11%2fphp-understanding-unserialize.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.koehntopp.info%2f2017%2f08%2f11%2fphp-understanding-unserialize.html&text=PHP%3a%20Understanding%20unserialize%28%29%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20https%3a%2f%2fblog.koehntopp.info%2f2017%2f08%2f11%2fphp-understanding-unserialize.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
        <a href='http://www.reddit.com/submit?url=https%3a%2f%2fblog.koehntopp.info%2f2017%2f08%2f11%2fphp-understanding-unserialize.html&title=PHP%3a%20Understanding%20unserialize%28%29' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>
        <a href='mailto:?subject=PHP%3a%20Understanding%20unserialize%28%29&body=https%3a%2f%2fblog.koehntopp.info%2f2017%2f08%2f11%2fphp-understanding-unserialize.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope-fill'/></svg>
        </a>
      </div>
    </div>

    
    
    <div class='row justify-content-center py-3 mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
        
          <a href="/tags/#security" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            security
          </a>
        
          <a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            erklaerbaer
          </a>
        
          <a href="/tags/#php" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            php
          </a>
        
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top mx-0'>
      <div class='col-lg-4 text-center text-lg-start'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Next Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2017/08/13/why-you-cant-have-nice-things.html">Why you can&#39;t have nice things…</a>
          </div>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2017/08/09/monitoring-the-data-you-have-and-the-data-you-want.html">Monitoring - the data you have and the data you want</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
