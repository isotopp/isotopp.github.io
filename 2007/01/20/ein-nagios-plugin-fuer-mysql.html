<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Ein Nagios-Plugin für MySQL</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">
<link rel="canonical" href="https://blog.koehntopp.info">


<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">




<meta name="generator" content="Hugo 0.92.0" />
<meta property="og:title" content='Ein Nagios-Plugin für MySQL' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />


<meta property="og:locale" content="de_DE" />


<meta name="description" content='' />
<meta property="og:description" content='' />

<link rel="canonical" href="https://blog.koehntopp.info" />
<meta property="og:url" content="https://blog.koehntopp.info" />


<meta property="og:type" content="article" />
<meta name="article:published_time" content='2007-01-20T04:00:00Z' />



<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content='@isotopp' />
<meta name="twitter:creator" content='@isotopp' />
<meta property="twitter:title" content='Ein Nagios-Plugin für MySQL' />
<meta property="twitter:description" content='' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />

<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","description":null,"headline":"Ein Nagios-Plugin für MySQL","image":"/assets/img/background/rijksmuseum.jpg","name":"Die wunderbare Welt von Isotopp","url":"https://blog.koehntopp.info"}
</script>

    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.34cf67ab5155251adc1c5fa5c2f37d5a4f8f029f51399eb2556031d6ac918d49.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            




<div class="page">
  <article class="ein-nagios-plugin-f%C3%BCr-mysql-page">
    <div class='row  justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            Ein Nagios-Plugin für MySQL
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
            <img alt='isotopp image' src='/assets/img/isotopp.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
            <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
            </a>

            
              <span class='d-none d-lg-inline'>-</span>
              <div class='d-block d-lg-inline'>January 20, 2007</div>
            

          </div>
        </div>
        
          <img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
        
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p>Auf Sourceforge findet man
<a href="http://nagiosplug.sourceforge.net/developer-guidelines.html" target="_blank" rel="noopener">Plug-in development guidelines</a>


für den Nagios Netzwerkmonitor.
Demnach ist es trivial, Nagios-Plugins zu entwickeln:
Der Check ist ein externes Programm, das den Returncode 0, 1 oder 2 zurückgibt und eine einzeilige Nachricht auf stdout druckt.</p>
<p>Tun wir das doch mal für MySQL:
Wir wollen die Anzahl der Threads_connected überwachen und den Replikationsstatus:
SQL-Thread und IO-Thread müssen laufen und der Slave-Lag darf nicht zu groß sein.</p>
<p>Wir schreiben das Plugin in C, damit wir zugleich mal lernen, die MYSQL Client-API in C zu verwenden - Shellscripte, die sich das Abbrechen gibt es ja schon genug.</p>
<p>Der gesamte Quelltext aus diesem Beispiel kann hier heruntergeladen werden:
<a href="/uploads/check_mysql.c">check_mysql.c</a>

</p>
<p>Unser Programm soll eine Reihe von Optionen verarbeiten.
Wir lesen die Optionen mit GNU
<a href="http://www.cs.duke.edu/courses/spring04/cps108/resources/getoptman.html" target="_blank" rel="noopener">getopt_long</a>

.
Die Funktion braucht eine Optionsliste in einem struct options Array, in dem wir die Optionen deklarieren.</p>
<p>Wir wollen:</p>
<ul>
<li>&ndash;mode={slave-lag,slave-io-running,slave-sql-running,connections},</li>
<li>&ndash;threshold-warn=x,</li>
<li>&ndash;threshold-err=x</li>
<li>und die üblichen MySQL Connection-Options (&ndash;user, &ndash;password, &ndash;host und &ndash;port).</li>
</ul>
<p>In Code sieht das so aus:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">option</span> <span class="n">long_options</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">{</span> <span class="s">&#34;host&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;h&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&#34;user&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;u&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&#34;password&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;p&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&#34;port&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&#34;mode&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;m&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&#34;threshold-warn&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">},</span>
        <span class="p">{</span> <span class="s">&#34;threshold-err&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="s">&#34;debug&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span>
        <span class="p">{</span> <span class="s">&#34;help&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="sc">&#39;?&#39;</span> <span class="p">},</span>
        <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
  <span class="n">unspecified</span><span class="p">,</span>
  <span class="n">slave_lag</span><span class="p">,</span>
  <span class="n">slave_io_running</span><span class="p">,</span>
  <span class="n">slave_sql_running</span><span class="p">,</span>
  <span class="n">connections</span>
<span class="p">}</span> <span class="n">mode_t</span><span class="p">;</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">host</span>     <span class="o">=</span> <span class="s">&#34;127.0.0.1&#34;</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">user</span>     <span class="o">=</span> <span class="s">&#34;root&#34;</span><span class="p">;</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">password</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
<span class="kt">int</span>   <span class="n">port</span>     <span class="o">=</span> <span class="mi">3306</span><span class="p">;</span>
<span class="n">mode_t</span> <span class="n">mode</span>    <span class="o">=</span> <span class="n">unspecified</span><span class="p">;</span>
<span class="kt">int</span>   <span class="n">threshold_warn</span><span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
<span class="kt">int</span>   <span class="n">threshold_err</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
<span class="kt">int</span>   <span class="n">debug</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div><p>Die Optionen werden dann wie folgt eingelesen:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">parse_args</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">int</span>   <span class="n">c</span><span class="p">;</span>
  <span class="kt">int</span>   <span class="n">optind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">myarg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&#34;h:u:p:P:m:t:T:d?&#34;</span><span class="p">,</span> <span class="n">long_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">optind</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">myarg</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">myarg</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Out of memory in strdup!</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="sc">&#39;?&#39;</span><span class="o">:</span> <span class="c1">// Hilfstext
</span><span class="c1"></span>        <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">myarg</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="sc">&#39;u&#39;</span><span class="o">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">myarg</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="sc">&#39;p&#39;</span><span class="o">:</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">myarg</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="sc">&#39;P&#39;</span><span class="o">:</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="sc">&#39;m&#39;</span><span class="o">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="s">&#34;slave-lag&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">mode</span> <span class="o">=</span> <span class="n">slave_lag</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="s">&#34;slave-io-running&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">mode</span> <span class="o">=</span> <span class="n">slave_io_running</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="s">&#34;slave-sql-running&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">mode</span> <span class="o">=</span> <span class="n">slave_sql_running</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">myarg</span><span class="p">,</span> <span class="s">&#34;connections&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">mode</span> <span class="o">=</span> <span class="n">connections</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">mode</span> <span class="o">=</span> <span class="n">unspecified</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">free</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>
        <span class="n">threshold_warn</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="sc">&#39;T&#39;</span><span class="o">:</span>
        <span class="n">threshold_err</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">myarg</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>

      <span class="k">default</span><span class="o">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Unknown option: %c</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Die Formalitäten sind damit erledigt:
Wir haben ein Programm, das die gewünschten Kommandozeilenoptionen einlesen kann und an die Arbeit gehen könnte.</p>
<p>Die Arbeit besteht bei uns darin, an ein MySQL zu verbinden, eine Query auszuführen, das einzeilige Resultat zu lesen und eine bestimmte Spalte aus dem Resultat auszuschneiden, um diese als String zurückzugeben.</p>
<p>Die Funktion <code>run_query()</code> tut dies für uns:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">char</span> <span class="o">*</span><span class="nf">run_query</span><span class="p">(</span><span class="n">MYSQL</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">col</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MYSQL_ROW</span>  <span class="n">row</span><span class="p">;</span>
  <span class="n">MYSQL_RES</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Field %d of query %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">mysql_real_query</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Query %s failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
      <span class="n">cmd</span><span class="p">,</span>
      <span class="n">mysql_error</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">res</span> <span class="o">=</span> <span class="n">mysql_store_result</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Query %s failed: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
      <span class="n">cmd</span><span class="p">,</span>
      <span class="n">mysql_error</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">row</span> <span class="o">=</span> <span class="n">mysql_fetch_row</span><span class="p">(</span><span class="n">res</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">num_fields</span> <span class="o">=</span> <span class="n">mysql_num_fields</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">len</span>        <span class="o">=</span> <span class="n">mysql_fetch_lengths</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">&lt;</span> <span class="n">num_fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Result column %d returns value </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> (length %d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">len</span><span class="p">[</span><span class="n">col</span><span class="p">]);</span>
      <span class="k">return</span> <span class="n">len</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">?</span><span class="n">strndup</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">len</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Query cmd does not return %d fields (it returns %d fields).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
        <span class="n">cmd</span><span class="p">,</span>
        <span class="n">col</span><span class="p">,</span>
        <span class="n">num_fields</span>
      <span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">mysql_free_result</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Die Funktion bekommt eine bestehende MySQL-Verbindung m als Parameter übergeben, zudem eine SQL-Query cmd und eine Spaltennummer, die aus dem einzeiligen Resultset der Query ausgesägt werden soll.
Intern brauchen wir eine <code>MYSQL_ROW row</code> und einen Resultset <code>MYSQL_RES res</code>.</p>
<p>Die Query wird mit <code>mysql_real_query()</code> an den Server gesendet.
Wenn dabei kein Fehler gemeldet wird, können wir den gesamten Resultset mit <code>mysql_store_result()</code> zum Client nach <code>res</code> kopieren.
Der Server ist damit fertig.</p>
<p>Auf dem Client lesen wir nun mit <code>mysql_fetch_row(res)</code> eine Zeile aus dem Resultset.
Diese Zeile hat <code>mysql_num_fields(res)</code> viele Spalten, deren Längen man mit <code>mysql_fetch_length()</code> bestimmen kann.
Wenn unser gewünschtes Zielfeld im Datensatz enthalten ist (<code>col &lt; num_fields</code>), dann duplizieren wir das und sind fertig
(Nun ja, gemogelt: Wir hätten noch <code>mysql_free_result()</code> aufrufen müssen, aber wir machen sowieso gleich <code>exit()</code>).</p>
<p>Ansonsten beklagen wir uns gar bitterlich und sind dann fertig.</p>
<p>Im Hauptprogramm müssen wir nun eine Connection öffnen und dann je nach Mode die passenden Sachen checken.
Erstmal eine Connection bauen.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

  <span class="n">parse_args</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">unspecified</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: No or wrong mode specified. Specify --mode={slave-lag,slave-io-running,slave-sql-running,connections}</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Connect to %s:%d with %s:%s for test %d with threshold_warn %d and threshold_err %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
      <span class="n">host</span><span class="p">,</span>
      <span class="n">port</span><span class="p">,</span>
      <span class="n">user</span><span class="p">,</span>
      <span class="n">password</span><span class="p">,</span>
      <span class="n">mode</span><span class="p">,</span>
      <span class="n">threshold_warn</span><span class="p">,</span>
      <span class="n">threshold_err</span>
    <span class="p">);</span>

  <span class="n">mysql_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mysql_real_connect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="s">&#34;mysql&#34;</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Cannot connect to database: Error: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
      <span class="n">mysql_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">));</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Connected...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</code></pre></div><p>Jetzt können wir je nach mode unterschiedliche Dinge tun. Zum Beispiel den Slave Lag checken:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">slave_lag</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span>   <span class="n">lag</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">run_query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="s">&#34;show slave status&#34;</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Slave lag NULL</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">lag</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lag</span> <span class="o">&gt;</span> <span class="n">threshold_err</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Slave lag %d sec exceeds threshold_err %d sec</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">threshold_err</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lag</span> <span class="o">&gt;</span> <span class="n">threshold_warn</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;WARN: Slave lag %d sec exceeds threshold_warn %d sec</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lag</span><span class="p">,</span> <span class="n">threshold_warn</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;OK: Slave lag %d is inside tolerance.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lag</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div><p>Oder Slave-IO und Slave-SQL testen:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c">  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">slave_io_running</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">run_query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="s">&#34;show slave status&#34;</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Slave io not running</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&#34;Yes&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Slave io not running: result is %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;OK: Slave io is running.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">slave_sql_running</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">run_query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mysql</span><span class="p">,</span> <span class="s">&#34;show slave status&#34;</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Slave sql not running</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&#34;Yes&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">&#34;CRIT: Slave sql not running: result is %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
      <span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;OK: Slave sql is running.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div><p>Oder eben die Anzahl der Threads_connected prüfen und ggf. anmeckern:</p>
<pre tabindex="0"><code>  if (mode == connections) {
    char *p;
    int   conn = 0;

    p = run_query(&amp;mysql, &quot;show global status like 'Threads_connected'&quot;, 1);
    if (p == NULL) {
      printf(&quot;CRIT: No connection information available.\n&quot;);
      exit(2);
    }

    conn = atoi(p);
    free(p);

    if (conn &gt; threshold_err) {
      printf(&quot;CRIT: Threads_connected %d exceeds threshold_err %d\n&quot;, conn, threshold_err);
      exit(2);
    }
    if (conn &gt; threshold_warn) {
      printf(&quot;WARN: Threads_connected %d exceeds threshold_warn %d\n&quot;, conn, threshold_warn);
      exit(1);
    }

    printf(&quot;OK: Threads_connected %d\n&quot;, conn);
    exit(0);
  }
</code></pre><p>Compiled wird so:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">LIBS=-lmysqlclient
</span><span class="go">CFLAGS=-g
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">all:    check_mysql
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">check_mysql:    check_mysql.c
</span><span class="go">        cc $(CFLAGS) -o check_mysql check_mysql.c $(LIBS)
</span></code></pre></div><p>Und im Nagios kann man dann in <code>/etc/nagios/checkcommands.cfg</code> definieren:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">define command {
</span><span class="go">    command_name check_mysql_status
</span><span class="go">    command_line /usr/lib/nagios/plugins/custom/check_mysql --mode=$ARG1$  -h $HOSTALIAS$ -u monitor -p g33k  $ARG2$
</span><span class="go">}
</span></code></pre></div><p>Ein Service kann dann definiert werden als</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">define service {
</span><span class="go">    name                template-mysql-slave-lag
</span><span class="go">    use                 template-standardhost
</span><span class="go">    register            0
</span><span class="go">    service_description MySQL slave-lag
</span><span class="go">    check_command       check_mysql_status!slave-lag!--threshold-warn=600 --threshold-err=900
</span><span class="go">}
</span></code></pre></div>
      </div>
    </div>

    
    
    <div class='row justify-content-center mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f20%2fein-nagios-plugin-fuer-mysql.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f20%2fein-nagios-plugin-fuer-mysql.html&text=Ein%20Nagios-Plugin%20f%c3%bcr%20MySQL%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f20%2fein-nagios-plugin-fuer-mysql.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
        <a href='http://www.reddit.com/submit?url=https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f20%2fein-nagios-plugin-fuer-mysql.html&title=Ein%20Nagios-Plugin%20f%c3%bcr%20MySQL' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>
        <a href='mailto:?subject=Ein%20Nagios-Plugin%20f%c3%bcr%20MySQL&body=https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f20%2fein-nagios-plugin-fuer-mysql.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope-fill'/></svg>
        </a>
      </div>
    </div>

    
    
    <div class='row justify-content-center py-3 mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
        
          <a href="/tags/#monitoring" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            monitoring
          </a>
        
          <a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            mysql
          </a>
        
          <a href="/tags/#lang_de" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            lang_de
          </a>
        
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top mx-0'>
      <div class='col-lg-4 text-center text-lg-start'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Next Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2007/02/03/supertopp.html">Supertopp!</a>
          </div>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2007/01/19/ein-flugbericht.html">Ein Flugbericht</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
