<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>fork, exec, wait und exit</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">
<link rel="canonical" href="https://blog.koehntopp.info">


<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">




<meta name="generator" content="Hugo 0.92.0" />
<meta property="og:title" content='fork, exec, wait und exit' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />


<meta property="og:locale" content="de_DE" />


<meta name="description" content='' />
<meta property="og:description" content='' />

<link rel="canonical" href="https://blog.koehntopp.info" />
<meta property="og:url" content="https://blog.koehntopp.info" />


<meta property="og:type" content="article" />
<meta name="article:published_time" content='2007-01-07T01:09:00Z' />



<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content='@isotopp' />
<meta name="twitter:creator" content='@isotopp' />
<meta property="twitter:title" content='fork, exec, wait und exit' />
<meta property="twitter:description" content='' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />

<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","description":null,"headline":"fork, exec, wait und exit","image":"/assets/img/background/rijksmuseum.jpg","name":"Die wunderbare Welt von Isotopp","url":"https://blog.koehntopp.info"}
</script>

    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.34cf67ab5155251adc1c5fa5c2f37d5a4f8f029f51399eb2556031d6ac918d49.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            




<div class="page">
  <article class="fork-exec-wait-und-exit-page">
    <div class='row  justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            fork, exec, wait und exit
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
            <img alt='isotopp image' src='/assets/img/isotopp.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
            <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
            </a>

            
              <span class='d-none d-lg-inline'>-</span>
              <div class='d-block d-lg-inline'>January 7, 2007</div>
            

          </div>
        </div>
        
          <img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
        
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p>In
<a href="news:de.comp.os.unix.linux.misc">de.comp.os.unix.linux.misc</a>

 fragte jemand:</p>
<blockquote>
<ul>
<li>Werden in einem Skript die Befehle streng sequentiell ausgeführt, d.h.
der nächste erst bearbeitet, wenn der Vorgänger vollständig ausgeführt
ist, oder wird <strong>automatisch</strong> bei unvollständiger Auslastung des
Systems bereits der nächste Befehl angefangen?</li>
<li>Läßt sich das Standardverhalten - wie auch immer es sein mag - bei
Bedarf ändern?</li>
</ul>
</blockquote>
<p>Wenn man in ein Shellbuch schaut, wird einem an der einen oder anderen
Stelle möglicherweise erläutert, daß die Shell jeden Befehl in einem eigenen
Prozeß abarbeitet. Dann wiederum fängt man möglicherweise an zu denken und
fragt sich, wie das alles zusammenhängt. Sobald man dort angekommen ist,
kann man sich mit dem Unix-Prozeßzyklus beschäftigen.</p>
<h2 id="prozeß-und-programm">
    <a href="#proze%c3%9f-und-programm">
	Prozeß und Programm
    </a>
</h2>
<p>Ein Programm ist in Unix eine Serie von ausführbaren Maschineninstruktionen
auf der Platte. Man kann mit dem Befehl <em>size</em> einen sehr oberflächlichen
Blick auf die Struktur des Programmes werfen oder mit <em>objdump</em> sehr viel
mehr Detailinformation bekommen. Der Aspekt, der uns hier interessieren
soll: Ein Programm ist eine Folge von Anweisungen und Daten (auf der
Platte), die möglicherweise einmal ausgeführt werden.</p>
<p>Ein Prozeß ist ein in Ausführung befindliches Programm. Er besteht aus dem
Programm selbst (also der Versammlung von Anweisungen und Daten) und dem
aktuellen Zustand der Ausführung. Dazu gehört neben der Memory-Map, die sagt
wie das Programm und seine Daten im Speicher angeordnet sind auch der
Programmzähler, die Prozessorregister und der Stack des Prozesses, aber auch
sein Root-Directory, sein aktuelles Verzeichnis, die Umgebungsvariablen und
alle offenen Dateien sowie einigen weiteren Dingen.</p>
<p>Unix behandelt Prozesse und Programme als die verschiedenen Dinge, die es
sind: Es ist möglich, ein Programm mehr als einmal auszuführen - es ist zum
Beispiel möglich, mehr als eine Kopie des Texteditors vi offen zu haben, die
zwei unterschiedliche Texte bearbeiten. Programm und (initiale) Daten beider
Prozesse sind gleich, aber der Zustand beider Prozesse ist verschieden. Es
ist auch möglich, im selben Prozeß nacheinander mehr als ein Programm
auszuführen - dazu schmeißt sich das aktuelle Programm in dem Prozeß selbst
weg und ersetzt sich durch ein zweites, in diesen Prozeß nachgeladene
Programm.</p>
<p>Unix regelt all diese Dinge mit vier sehr einfachen Systemkonzepten -
<code>fork()</code>, <code>exec()</code>, <code>wait()</code> und <code>exit()</code>.</p>
<h2 id="usermode-und-kernel">
    <a href="#usermode-und-kernel">
	Usermode und Kernel
    </a>
</h2>
<p><p class="md__image">
  <img src="/uploads/prozesswechsel.png" alt=""  />
</p>

</p>
<p>Prozeßwechsel: Es wird ein Stück Prozeß 1 abgearbeitet, dann (1) auf Prozeß
2 umgeschaltet. Nach einer Weile wird (2) wieder auf Prozeß 1 zurück
geschaltet. Die Ausführung von Prozeß 1 erscheint lückenlos, erfolgt aber in
zeitlich nicht zusammenhängenden Intervallen.</p>
<p>Wenn ein Unix-Prozeß eine Systemfunktion aufruft (und noch bei ein paar
anderen Gelegenheiten), dann verläßt der betreffende Prozeß seinen
Userkontext und betritt den privilegierten Betriebsystemkern, den Kernel.
Dort wird die aufgerufene Systemfunktion ausgeführt und danach landet jede
dieser Funktionen im Scheduler. Der Scheduler entscheidet dann, welcher
Prozeß als nächstes dran kommt und kehrt aus dem Kernel in diesen Prozeß
zurück. Das kann unser Ausgangsprozeß oder nach Entscheidung des Schedulers
ein anderer Prozeß sein.</p>
<p>Wir halten für die Zwecke diese Textes fest: Jeder Systemaufruf wechselt vom
Userkontext in den Kernel. Der einzige Weg aus dem Kernel in einen
Userkontext führt durch den Scheduler, und dann kehren wir unter Umständen
nicht in den Ausgangsprozeß zurück. Bei jedem Systemaufruf kann ein Prozeß
also seine CPU verlieren.</p>
<p>Das ist nicht schlimm, weil dieser andere Prozeß auch irgendwann einmal die
CPU aufgeben muß und wir dann in unseren eigenen Prozeß zurück kehren als
sei nichts gewesen.</p>
<p>Unser Programm wird also nicht linear abgearbeitet, sondern in kurzen
linearen Segmenten, zwischen denen Pausen liegen können. In den Pausen
arbeitet die CPU an den Segmenten der anderen Prozesse, die ebenfalls
lauffähig sind.</p>
<h2 id="fork-und-exit">
    <a href="#fork-und-exit">
	fork() und exit()
    </a>
</h2>
<p>In traditionellem Unix ist der Systemaufruf <code>fork()</code> die einzige Methode,
einen neuen Prozeß zu erzeugen. Der neue Prozeß enthält eine Kopie des
laufenden Programmes. Er hat eine neue Prozeß-ID und die Prozeß-ID des
Erzeugers ist als seine Parent Prozeß-ID (PPID) eingetragen.</p>
<p>Im Parent-Prozeß kehrt <code>fork()</code> mit der PID des neuen Prozesses als Ergebnis
zurück. Der neue Prozeß kehrt ebenfalls aus dem Systemaufruf <code>fork()</code> zurück,
liefert dort aber das Resultat 0.</p>
<p>Der Systemaufruf fork() ist also insofern besonders, als daß er einmal
betreten wird, aber zweimal verlassen wird: Einmal im Elternprozeß und
einmal im neu erzeugten Kindprozeß. <code>fork()</code> erhöht die Anzahl der laufenden
Prozesse im System um eins.</p>
<p>Jeder Unix-Prozeß beginnt seine Existenz also, indem er aus einem
<code>fork()</code>-Systemaufruf spontan zurückkehrt und ein Programm ausführt, daß
eine Kopie des Elternprogrammes ist. Sein Schicksal unterscheidet sich vom
Schicksal des Elternprozesses, weil das Ergebnis des <code>fork()</code>-Aufrufes
unterschiedlich ist (0 statt der PID des Kindes) und man dies zur
Verzweigung nutzen kann.</p>
<p>In Code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ich bin der Kindprozess.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ich bin der Elternprozess, das Kind ist %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">&#34;In fork():&#34;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>und</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">kris@linux:/tmp/kris&gt; make probe1
</span><span class="go">cc     probe1.c   -o probe1
</span><span class="go">kris@linux:/tmp/kris&gt; ./probe1
</span><span class="go">Ich bin der Kindprozess.
</span><span class="go">Ich bin der Elternprozess, das Kind ist 16959.
</span></code></pre></div><p>Wir vereinbaren also eine Variable <code>pid</code> vom Typ <code>pid_t</code>.</p>
<p>Diese Variable speichert das Ergebnis des Systemaufrufes <code>fork()</code> und mit
Hilfe dieses Wertes aktivieren wir entweder das eine (&ldquo;Ich bin der
Kindprozeß&rdquo;) oder das andere (&ldquo;Ich bin der Elternprozeß&rdquo;) if().</p>
<p>Starten wir das Programm, erhalten wir zwei Ausgaben. Da innerhalb eines
Prozesses nur ein Status existieren kann und nur eines der beiden if()
betreten werden kann, wir aber zwei Ausgaben erhalten haben, müssen wir zwei
Prozesse erzeugt haben.</p>
<p>Indem wir das Ergebnis von <code>getpid()</code> druckten, könnten wir das sogar noch
anschaulicher zeigen.</p>
<p>Der Systemaufruf <code>fork()</code> wird einmal betreten, aber zweimal verlassen und
erhöht die Anzahl der Prozesse im System um eins. Nach dem Ablauf unseres
Programmes ist die Anzahl der Prozesse im System aber wieder genauso hoch
wie vor dem Aufruf des Programmes. Es muß also einen weiteren Systemaufruf
geben, der die Anzahl der Prozesse im System um eins erniedrigt.</p>
<p>Dieser Aufruf ist <code>exit()</code>.</p>
<p><code>exit()</code> wird einmal betreten und nie verlassen. Er verkleinert die Anzahl
der Prozesse im System um eins. <code>exit()</code> liefert außerdem einen Exitstatus,
den der Elternprozeß abholen kann (oder gar muß) und der ihn über das
Schicksal seines Kindes informiert.</p>
<p>In unserem Beispiel enden alle Varianten unseres Programmes mit <code>exit()</code> -
wir rufen <code>exit()</code> also im Elternprozeß und im Kindprozeß auf, beenden also
zwei Prozesse. Das können wir nur deswegen tun, weil unser Elternprozeß auch
ein Kindprozeß ist und zwar ein Kind der Shell.</p>
<p>Die Shell arbeitet also genau wie wir:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">bash (16957) --- erzeugt durch fork() ---&gt; bash (16958) --- wird zu ---&gt; probe1 (16958)
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">probe1 (16958) --- erzeugt durch fork() ---&gt; probe1 (16959) --&gt; exit()
</span><span class="go">   |
</span><span class="go">   +---&gt; exit()
</span></code></pre></div><p><code>exit()</code> schließt alle Dateien und Internetverbindungen eines Prozesses,
gibt allen Speicher frei und beendet dann den Prozeß. Der Parameter von
<code>exit()</code>, der Exitstatus, wird an den Elternprozeß zurückgegeben.</p>
<h2 id="wait">
    <a href="#wait">
	wait()
    </a>
</h2>
<p>Der Kindprozeß endet durch ein exit(0). Die 0 ist der Exitstatus unseres
Programmes und steht nun zur Abholung bereit. Wir müssen im Elternprozeß den
Exitstatus abholen. Dies geschieht mit der Systemfunktion <code>wait()</code>.</p>
<p>In Code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span>   <span class="n">status</span><span class="p">;</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ich bin der Kindprozess.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
                <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ich bin der Kindprozess 10 Sekunden spaeter.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ich bin der Elternprozess, das Kind ist %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ende des Prozesses %d: &#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Der Prozess wurde mit exit(%d) beendet.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Der Prozess wurde mit kill -%d beendet.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">&#34;In fork():&#34;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>und</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">kris@linux:/tmp/kris&gt; make probe2
</span><span class="go">cc     probe2.c   -o probe2
</span><span class="go">kris@linux:/tmp/kris&gt; ./probe2
</span><span class="go">Ich bin der Kindprozess.
</span><span class="go">Ich bin der Elternprozess, das Kind ist 17399.
</span><span class="go">Ich bin der Kindprozess 10 Sekunden spaeter.
</span><span class="go">Ende des Prozesses 17399: Der Prozess wurde mit exit(0) beendet.
</span></code></pre></div><p>Die Variable <code>status</code> wird dem Systemaufruf <code>wait()</code> als Referenzparameter
mit übergeben und von diesem überschrieben. Neben dem Exitstatus finden wir
dort auch noch weitere Informationen über den Grund des Programmendes
hinterlegt. Zur Decodierung stellt das System eine Reihe von Prädikaten wie
<code>WIFEXITED()</code> oder <code>WIFSIGNALED()</code> zur Abfrage bereit und Extraktoren wie
<code>WEXITSTATUS()</code> und <code>WTERMSIG()</code>. <code>wait()</code> gibt außerdem die Prozeß-ID des
Prozesses zurück, der beendet wurde.</p>
<p><code>wait()</code> hängt im Elternprozeß so lange bis entweder ein Signal eintrifft
oder ein Kindprozeß beendet wird.</p>
<p>Das Programm init mit der PID 1 macht übrigens den ganzen lieben langen Tag
nix anderes: Es hängt im <code>wait()</code> und frühstückt die ihm zugeworfenen
Exitstati ab, um sie zu verwerfen. Außerdem liest es die <code>/etc/inittab</code> und
startet die dort konfigurierten Programme. Ist eines dieser Programme auf
Respawn gesetzt und wird beendet, wird es von init neu gestartet.</p>
<p>Beendet sich ein Kindprozeß, ohne daß der Elternprozeß ein <code>wait()</code> macht,
zerstört <code>exit()</code> schon einmal alle Datenstrukturen des Kindprozesses, kann
jedoch den Prozeßlisteneintrag des Prozesses noch nicht wegwerfen, denn hier
steht der Exitstatus des Kindes drin. Es könnte ja nun sein, daß der
Elternprozeß sich irgendwann entschließt, ein <code>wait()</code> auszuführen und dann
muß der Exitstatus ja bereitstehen.</p>
<p>Der Kindprozeß ist also bereits tot - er hat <code>exit()</code> ausgeführt und alle
Ressourcen freigegeben, kann aber noch nicht sterben, weil ja der
Elternprozeß den Status noch nicht abgeholt hat. Unix nennt so einen Prozeß
einen Zombie-Prozeß. Zombies werden in der Prozeßliste sichtbar, wenn ein
Prozeßerzeuger falsch programmiert ist und nicht ausreichend <code>wait()</code> aufruft.</p>
<p>Anders herum ist es auch möglich, daß ein Kindprozeß weiter läuft, während
ein Elternprozeß beendet wird. Dann wird die Parent Prozeß-ID (PPID) des
Kindes von der PID des Elternprozesses auf die Konstante 1 geändert, oder in
anderen Worten - init erbt den Prozeß.</p>
<p>Beendet sich das Kind, empfängt init den Exitstatus des Kindes, denn init
hängt ja sowieso dauernd im wait. Dadurch wird die Entstehung eines Zombies
in diesem Fall verhindert.</p>
<p>Wenn die Anzahl der Prozesse im System über die Laufzeit des System im
Mittel konstant ist, dann ist die Anzahl der <code>fork()</code>, <code>exit()</code> und
<code>wait()</code>-Aufrufe im System ebenfalls im Mittel gleich, denn für jedes
<code>fork()</code> muß irgendwann einmal ein <code>exit()</code> gemacht werden und für jedes
<code>exit()</code> muß der Elternprozeß einmal ein <code>wait()</code> machen (In Wirklichkeit
ist die Situation wegen einiger anderer Regeln noch ein wenig komplizierter,
aber erst einmal soll dies hier genügen).</p>
<p>Wir haben also ein sauberes fork-exit-wait-Dreieck.</p>
<h2 id="exec">
    <a href="#exec">
	exec()
    </a>
</h2>
<p>So wie <code>fork()</code> Prozesse erzeugt, so lädt <code>exec()</code> Programme in einen Prozeß.</p>
<p>In  Code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span><span class="cp"></span>
<span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span>   <span class="n">status</span><span class="p">;</span>

        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ich bin der Kindprozess.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
                <span class="n">execl</span><span class="p">(</span><span class="s">&#34;/bin/ls&#34;</span><span class="p">,</span> <span class="s">&#34;ls&#34;</span><span class="p">,</span> <span class="s">&#34;-l&#34;</span><span class="p">,</span> <span class="s">&#34;/tmp/kris&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">&#34;In exec(): &#34;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ich bin der Elternprozess, das Kind ist %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="n">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Ende des Prozesses %d: &#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Der Prozess wurde mit exit(%d) beendet.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Der Prozess wurde mit kill -%d beendet.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">&#34;In fork():&#34;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">kris@linux:/tmp/kris&gt; make probe3
</span><span class="go">cc     probe3.c   -o probe3
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">kris@linux:/tmp/kris&gt; ./probe3
</span><span class="go">Ich bin der Kindprozess.
</span><span class="go">Ich bin der Elternprozess, das Kind ist 17690.
</span><span class="go">total 36
</span><span class="go">-rwxr-xr-x 1 kris users 6984 2007-01-05 13:29 probe1
</span><span class="go">-rw-r--r-- 1 kris users  303 2007-01-05 13:36 probe1.c
</span><span class="go">-rwxr-xr-x 1 kris users 7489 2007-01-05 13:37 probe2
</span><span class="go">-rw-r--r-- 1 kris users  719 2007-01-05 13:40 probe2.c
</span><span class="go">-rwxr-xr-x 1 kris users 7513 2007-01-05 13:42 probe3
</span><span class="go">-rw-r--r-- 1 kris users  728 2007-01-05 13:42 probe3.c
</span><span class="go">Ende des Prozesses 17690: Der Prozess wurde mit exit(0) beendet.
</span></code></pre></div><p>Hier wird im Sohnprozeß der Code von probe3 weggeworfen (Das <code>perror(&quot;In exec():&quot;)</code> wird niemals ausgeführt) und durch den angegebenen Aufruf von
<code>ls</code> ersetzt. In der Ausführung erkennen wir, daß probe3 wartet, bis das
<code>ls</code> sich mit <code>exit()</code> beendet hat und dann seine eigene Ausführung danach
fortsetzt.</p>
<h2 id="als-shellscript">
    <a href="#als-shellscript">
	Als Shellscript
    </a>
</h2>
<p>Die Beispiele oben operieren in C. In bash sieht es so aus:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">kris@linux:/tmp/kris&gt; cat probe1.sh
</span><span class="go"></span><span class="gp">#</span>! /bin/bash --
<span class="err">
</span><span class="err"></span><span class="go">echo &#34;Starte Kindprozess&#34;
</span><span class="go">sleep 10 &amp;
</span><span class="go">echo &#34;Der Kindprozess hat die ID $!&#34;
</span><span class="go">echo &#34;Der Elternprozess hat die ID $$&#34;
</span><span class="go">echo &#34;$(date): Elternprozess geht schlafen.&#34;
</span><span class="go">wait
</span><span class="go">echo &#34;Der Kindprozess $! hat den Exit-Status $?&#34;
</span><span class="go">echo &#34;$(date): Elternprozess ist aufgewacht.&#34;
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">kris@linux:/tmp/kris&gt; ./probe1.sh
</span><span class="go">Starte Kindprozess
</span><span class="go">Der Kindprozess hat die ID 18071
</span><span class="go">Der Elternprozess hat die ID 18070
</span><span class="go">Fri Jan  5 13:49:56 CET 2007: Elternprozess geht schlafen.
</span><span class="go">Der Kindprozess 18071 hat den Exit-Status 0
</span><span class="go">Fri Jan  5 13:50:06 CET 2007: Elternprozess ist aufgewacht.
</span></code></pre></div><p>Und hier beobachten wie die Shell bei der Ausführung von Kommandos:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">kris@linux:~&gt; strace -f -e execve,clone,fork,waitpid bash
</span><span class="go">kris@linux:~&gt; ls
</span><span class="go">clone(Process 30048 attached
</span><span class="go">child_stack=0, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD,
</span><span class="go">child_tidptr=0xb7dab6f8) = 30048
</span><span class="go">[pid 30025] waitpid(-1, Process 30025 suspended
</span><span class="go"> &lt;unfinished ...&gt;
</span><span class="go">[pid 30048] execve(&#34;/bin/ls&#34;, [&#34;/bin/ls&#34;, &#34;-N&#34;, &#34;--color=tty&#34;, &#34;-T&#34;, &#34;0&#34;],
</span><span class="go">[/* 107 vars */]) = 0
</span><span class="go">...
</span><span class="go">Process 30025 resumed
</span><span class="go">Process 30048 detached
</span><span class="go">&lt;... waitpid resumed&gt; [{WIFEXITED(s) &amp;&amp; WEXITSTATUS(s) == 0}], WSTOPPED
</span><span class="go">WCONTINUED) = 30048
</span><span class="go">--- SIGCHLD (Child exited) @ 0 (0) ---
</span><span class="go">...
</span></code></pre></div><p>Linux verwendet eine Verallgemeinerung von <code>fork()</code> mit dem Namen <code>clone()</code> um
einen Kindprozeß zu erzeugen. Daher sehen wir keinen <code>fork()</code>, sondern einen
<code>clone()</code>-Aufruf mit einigen Parametern.</p>
<p>Linux verwendet außerdem die Variante <code>waitpid()</code> von <code>wait()</code>, um auf eine
bestimmte PID zu warten.</p>
<p>Linux startet außerdem das Programm mit <code>execve()</code> statt mit <code>execl()</code>, aber
das ist nur eine andere Anordnung von Parametern. Nach dem Ende von <code>ls</code>
(PID 30048) wird der Prozeß 30025 aus dem <code>wait()</code> erweckt und fortgesetzt.</p>
<p>Und
<a href="http://minnie.tuhs.org/UnixTree/V7/usr/src/cmd/sh/xec.c.html" target="_blank" rel="noopener">hier</a>

 ist
der C-Code der Originalshell aus dem Jahre 1979, mit dem <code>fork()</code> (Man suche
nach &ldquo;case TFORK:&rdquo; und wundere sich nicht über den Programmierstil von Herrn
Bourne). Ja, bash ist schöner - GNU Code oder nicht.</p>
<p>(nach
<a href="http://groups.google.com/group/de.comp.os.unix.linux.misc/msg/4035c67415f9bc09" target="_blank" rel="noopener">einem News-Artikel</a>

 von mir)</p>

      </div>
    </div>

    
    
    <div class='row justify-content-center mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f07%2ffork-exec-wait-und-exit.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f07%2ffork-exec-wait-und-exit.html&text=fork%2c%20exec%2c%20wait%20und%20exit%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f07%2ffork-exec-wait-und-exit.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
        <a href='http://www.reddit.com/submit?url=https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f07%2ffork-exec-wait-und-exit.html&title=fork%2c%20exec%2c%20wait%20und%20exit' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>
        <a href='mailto:?subject=fork%2c%20exec%2c%20wait%20und%20exit&body=https%3a%2f%2fblog.koehntopp.info%2f2007%2f01%2f07%2ffork-exec-wait-und-exit.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope-fill'/></svg>
        </a>
      </div>
    </div>

    
    
    <div class='row justify-content-center py-3 mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
        
          <a href="/tags/#linux" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            linux
          </a>
        
          <a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            erklaerbaer
          </a>
        
          <a href="/tags/#computer" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            computer
          </a>
        
          <a href="/tags/#lang_de" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            lang_de
          </a>
        
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top mx-0'>
      <div class='col-lg-4 text-center text-lg-start'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Next Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2007/01/07/fork-und-exec-vs-createprocess.html">fork und exec vs. CreateProcess</a>
          </div>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2006/12/26/bundestrojaner.html">Bundestrojaner</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
