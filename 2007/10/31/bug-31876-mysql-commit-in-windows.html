<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Bug #31876: MySQL Commit in Windows</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">
<link rel="canonical" href="https://blog.koehntopp.info">


<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">




<meta name="generator" content="Hugo 0.92.0" />
<meta property="og:title" content='Bug #31876: MySQL Commit in Windows' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />


<meta property="og:locale" content="de_DE" />


<meta name="description" content='' />
<meta property="og:description" content='' />

<link rel="canonical" href="https://blog.koehntopp.info" />
<meta property="og:url" content="https://blog.koehntopp.info" />


<meta property="og:type" content="article" />
<meta name="article:published_time" content='2007-10-31T18:30:45Z' />



<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content='@isotopp' />
<meta name="twitter:creator" content='@isotopp' />
<meta property="twitter:title" content='Bug #31876: MySQL Commit in Windows' />
<meta property="twitter:description" content='' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />

<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","description":null,"headline":"Bug #31876: MySQL Commit in Windows","image":"/assets/img/background/mysql.jpg","name":"Die wunderbare Welt von Isotopp","url":"https://blog.koehntopp.info"}
</script>

    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.34cf67ab5155251adc1c5fa5c2f37d5a4f8f029f51399eb2556031d6ac918d49.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            




<div class="page">
  <article class="bug-#31876-mysql-commit-in-windows-page">
    <div class='row  justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            Bug #31876: MySQL Commit in Windows
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
            <img alt='isotopp image' src='/assets/img/isotopp.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
            <a href="https://twitter.com/isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
            </a>

            
              <span class='d-none d-lg-inline'>-</span>
              <div class='d-block d-lg-inline'>October 31, 2007</div>
            

          </div>
        </div>
        
          <img alt='a featured image' src="/assets/img/background/mysql.jpg">
        
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p><a href="http://bugs.mysql.com/bug.php?id=31876" target="_blank" rel="noopener">Bug #31876</a>

:
Neulich war ich bei einem Kunden, der ein kleines Testscript hatte, das im wesentlichen 500 Mal hintereinander eine Row in eine InnoDB-Tabelle eingefügt hat, und dann ein Commit gesendet hat.
Das Script war unter Linux unmöglich schnell, und unter Windows unmöglich langsam - insbesondere war es unter Windows viermal langsamer als dasselbe Script unter DB/2 und MS SQL Server.
Das ist natürlich verdächtig und nicht akzeptabel.</p>
<p>Was macht man, wenn man ein Performance-Problem hat?
Richtig, man misst nach.
Hier wollten wir erst einmal sehen, was MySQL denn so mit dem Betriebssystem macht, wenn es committed.
Dazu brauchen wir so etwas wie einen Systemcall-Monitor für Windows.
Das gibt es zum Glück, und zwar bei der von Microsoft aufgekauften Firma
<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/" target="_blank" rel="noopener">Sysinternals</a>

 von Mark Russinovich.
Wir messen also mit FileMon und ProcMon, was genau MySQL da tut.</p>
<p>Mit <code>innodb_flush_log_on_trx_commit = 1</code> sehen wir dann im FileMon die folgende Ausgabe:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">94      14:43:22        mysqld-nt.exe:2736      WRITE   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS Offset: 2258432 Length: 1024
</span><span class="go">95      14:43:22        mysqld-nt.exe:2736      FLUSH   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS
</span><span class="go">96      14:43:22        mysqld-nt.exe:2736      WRITE   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS Offset: 2258944 Length: 512
</span><span class="go">97      14:43:22        mysqld-nt.exe:2736      FLUSH   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS
</span></code></pre></div><p>Mit anderen Worten: Für jede Transaktion ruft MySQL einmal <code>WriteFile()</code> und einmal <code>FlushFileBuffers()</code> auf.</p>
<p>Konfiguriert man auf <code>innodb_flush_log_on_trx_commit = 2</code> um, bekommt man</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">101     14:35:55        mysqld-nt.exe:548       WRITE   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS Offset: 1638912 Length: 1024
</span><span class="go">102     14:35:55        mysqld-nt.exe:548       WRITE   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0    SUCCESS Offset: 1639424 Length: 512
</span></code></pre></div><p>Das heißt, die <code>WriteFile()</code>-Aufrufe finden weiter statt, die <code>FlushFileBuffer()</code>-Aufrufe entfallen aber.</p>
<p>In InnoDB ist das nicht ACID, weil die <code>WriteFile()</code>-Aufrufe die Daten nur vom MySQL-Prozess in den Windows Filesystem Buffer Cache kopieren, aber nicht von dort auf die Platte, und das kann man am Blinken der HDD-LED auch sehen.</p>
<p>Spielt man dasselbe Spiel mit einem DB/2 auf Windows, sieht man</p>
<pre tabindex="0"><code>408     15:05:10        db2syscs.exe:2020       WRITE   D:\Daten\Filis\DB2log\S0007531.LOG     SUCCESS Offset: 970752 Length: 4096
409     15:05:10        db2syscs.exe:2020       WRITE   D:\Daten\Filis\DB2log\S0007531.LOG     SUCCESS Offset: 970752 Length: 4096
</code></pre><p>DB/2 macht also auch nur <code>WriteFile()</code>-Aufrufe, und behauptet, das sei ACID!
Mehr noch, am Blinken der Platten-LED kann man sehen, daß das auch wahrscheinlich der Fall ist.</p>
<p>Was ist also anders?
Sieht man sich die Sache mit ProcMon an, kann man sehen wie die Dateien in Windows mit dem Aufruf
<a href="http://msdn2.microsoft.com/en-us/library/aa363858.aspx" target="_blank" rel="noopener">CreateFile</a>


und <code>dwCreateDisposition = OPEN_EXISTING</code> geöffnet werden.
Dabei gibt man dem Aufruf außerdem noch einen Haufen <code>dwFlagsAndAttributes</code> mit.
Uns sollen hier in erster Linie die Flags interessieren.</p>
<p>Normalerweise öffnet MySQL seine InnoDB-Daten- und Logfiles so:</p>
<pre tabindex="0"><code>Sequence:       12795
Date &amp; Time:    25.10.2007 11:01:33
Event Class:    File System
Operation:      CreateFile
Result: NAME COLLISION
Path:   C:\Programme\MySQL\MySQL Server 5.0\data\ib_logfile0
TID:    2688
Duration:       0.0000131
Desired Access: Generic Read/Write
Disposition:    Create
Options:        No Buffering, Synchronous IO Non-Alert, Non-Directory File
Attributes:     n/a
ShareMode:      Read
AllocationSize: 0
</code></pre><p>Das heißt, wie man in der Zeile <code>Options</code> sehen kann, <code>FILE_FLAG_NO_BUFFERING</code> ist angegeben.
Das ist schon mal gut, aber wie man sehen kann, sind immer noch <code>FlushFileBuffer()</code>-Aufrufe notwendig.
DB/2 und MS SQL Server dagegen machen das so, daß außerdem noch <code>FILE_FLAG_WRITE_THROUGH</code> angegeben wird (und ggf. auch noch <code>FILE_FLAG_RANDOM_ACCESS</code>), berichtet uns ProcMon hier.</p>
<p>Das bedeutet:
Brächte man InnoDB dazu seine Daten- und Logfiles mit diesen Flags zu öffnen, wären die <code>FushFileBuffers()</code>-Aufrufe nicht mehr notwendig (und mit <code>innodb_flush_log_on_trx_commit = 2</code> wären sie auch weg).
Also patched man</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="gh">===== innobase/os/os0file.c 1.121 vs edited =====
</span><span class="gh"></span><span class="gd">--- 1.121/innobase/os/os0file.c 2007-08-15 18:54:19 -04:00
</span><span class="gd"></span><span class="gi">+++ edited/innobase/os/os0file.c        2007-10-25 17:34:01 -04:00
</span><span class="gi"></span><span class="gu">@@ -1218,9 +1218,13 @@ try_again:
</span><span class="gu"></span>                        /* Do not use unbuffered i/o to log files because
                        value 2 denotes that we do not flush the log at every
                        commit, but only once per second */
<span class="gi">+                       attributes |= (FILE_FLAG_WRITE_THROUGH
</span><span class="gi">+                              | FILE_FLAG_RANDOM_ACCESS);
</span><span class="gi"></span>                } else if (srv_win_file_flush_method ==  SRV_WIN_IO_UNBUFFERED) {
<span class="gd">-                       attributes = attributes | FILE_FLAG_NO_BUFFERING;
</span><span class="gd"></span><span class="gi">+                       attributes |= (FILE_FLAG_NO_BUFFERING
</span><span class="gi">+                              | FILE_FLAG_WRITE_THROUGH
</span><span class="gi">+                              | FILE_FLAG_RANDOM_ACCESS);
</span><span class="gi"></span>                }
 #endif
        } else if (purpose == OS_FILE_NORMAL) {
<span class="gu">@@ -1232,7 +1236,9 @@ try_again:
</span><span class="gu"></span>                        commit, but only once per second */
                } else if (srv_win_file_flush_method == SRV_WIN_IO_UNBUFFERED) {
<span class="gd">-                       attributes = attributes | FILE_FLAG_NO_BUFFERING;
</span><span class="gd"></span><span class="gi">+                       attributes |= (FILE_FLAG_NO_BUFFERING
</span><span class="gi">+                              | FILE_FLAG_WRITE_THROUGH
</span><span class="gi">+                              | FILE_FLAG_RANDOM_ACCESS);
</span><span class="gi"></span>                }
 #endif
        } else {

</code></pre></div><p>Wenn ich mich nicht sehr täusche ist <code>innodb_flush_log_on_trx_commit = 2</code> jetzt ACID und sehr viel schneller als die Write/Flush-Sequenz - sechs bis siebenmal schneller.
Das Blinken meiner Platten-LED sieht auch plausibel aus.</p>
<p>Dasselbe Verhalten beobachten wir nun auch mit dem Binlog:
<code>log-bin= ...</code> sorgt für <code>WriteFile()</code>-Aufrufe ins Binlog, und mit <code>sync_binlog = 1</code> kriegen wir nach jedem Write ein langsames Flush.
Besser wäre es, das <code>CreateFile()</code> für das Binlog zu finden und dort ebenfalls <code>FILE_FLAG_WRITE_THROUGH</code> zu machen. Damit wäre schon ein normales Binlog-Schreiben &ldquo;sync&rdquo; und schneller als die Write/Flush-Paare von <code>sync_binlog = 1</code>.</p>
<p>Versucht man denselben Benchmark mit Linux, kriege ich auf meinen Testsystemen übrigens vollkommene Unsinns-Zeiten raus.
Das liegt daran, weil</p>
<pre tabindex="0"><code>linux:~ # hdparm -I /dev/sda
...
        Enabled Supported:
           *    SMART feature set
                Security Mode feature set
           *    Power Management feature set
           *    Write cache
           *    Look-ahead
...
</code></pre><p>Der Write-Cache ist also bei dieser Platte enabled.
Für so einen ACID-Commit ist das eher nicht so gut.</p>
<p>Mit</p>
<pre tabindex="0"><code>linux:~ # hdparm -W0 /dev/sda

/dev/sda:
 setting drive write-caching to 0 (off)
</code></pre><p>ist Linux dann nicht nur genau so ACID wie Windows, sondern auch vergleichbar langsam.
Und man bekommt auch bei einem <code>innodb_flush_method = fdatasync / O_DIRECT</code> plötzlich plausible Benchmark-Ergebnisse zurück.
Das nur mal an die Adresse derjenigen, die glauben, daß <code>O_DIRECT</code> nichts bringt (bis letzte Woche auch ich).</p>

      </div>
    </div>

    
    
    <div class='row justify-content-center mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2007%2f10%2f31%2fbug-31876-mysql-commit-in-windows.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>
        <a href='https://twitter.com/intent/tweet?source=https%3a%2f%2fblog.koehntopp.info%2f2007%2f10%2f31%2fbug-31876-mysql-commit-in-windows.html&text=Bug%20%2331876%3a%20MySQL%20Commit%20in%20Windows%20%7C%20Die+wunderbare+Welt+von+Isotopp:%20https%3a%2f%2fblog.koehntopp.info%2f2007%2f10%2f31%2fbug-31876-mysql-commit-in-windows.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>
        <a href='http://www.reddit.com/submit?url=https%3a%2f%2fblog.koehntopp.info%2f2007%2f10%2f31%2fbug-31876-mysql-commit-in-windows.html&title=Bug%20%2331876%3a%20MySQL%20Commit%20in%20Windows' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>
        <a href='mailto:?subject=Bug%20%2331876%3a%20MySQL%20Commit%20in%20Windows&body=https%3a%2f%2fblog.koehntopp.info%2f2007%2f10%2f31%2fbug-31876-mysql-commit-in-windows.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope-fill'/></svg>
        </a>
      </div>
    </div>

    
    
    <div class='row justify-content-center py-3 mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
        
          <a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            database
          </a>
        
          <a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            mysql
          </a>
        
          <a href="/tags/#lang_de" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            lang_de
          </a>
        
      </div>
    </div>

    <div class='row justify-content-center mb-5 pt-5 border-top mx-0'>
      <div class='col-lg-4 text-center text-lg-start'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Next Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2007/12/14/wir-sind-die-guten.html">Wir sind die Guten!</a>
          </div>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2007/10/11/bundestrojaner-in-den-tagesthemen.html">Bundestrojaner in den Tagesthemen</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>

        <a href='https://twitter.com/isotopp' title='Follow on Twitter' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#twitter'/></svg>
        </a>

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
