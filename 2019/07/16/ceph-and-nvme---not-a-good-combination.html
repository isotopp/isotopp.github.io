<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Ceph and NVME - not a good combination? | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2019/07/16/ceph-and-nvme---not-a-good-combination.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Ceph and NVME - not a good combination? | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2019/07/16/ceph-and-nvme---not-a-good-combination.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2019-07-16T08:21:25Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Ceph and NVME - not a good combination?' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="ceph-and-nvme-not-a-good-combination-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Ceph and NVME - not a good combination?
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>July 16, 2019</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/06/14/not-quite-storage-any-more.html">Not quite storage any more</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/09/03/konsenssysteme.html">Konsenssysteme</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Saving an <a href="https://twitter.com/isotopp/status/1151013922528534528" target="_blank" rel="noopener">older twitter thread on Ceph</a>

.</p>
<p><a href="https://ceph.com/community/part-4-rhcs-3-2-bluestore-advanced-performance-investigation/" target="_blank" rel="noopener"><p class="md__image">
  <img src="/uploads/ceph-blog.jpg" alt=""  />
</p>

</a>

</p>
<p>I just have finished reading
<a href="https://ceph.com/community/part-4-rhcs-3-2-bluestore-advanced-performance-investigation/" target="_blank" rel="noopener">Part 4: RHCS 3.2 Bluestore Advanced Performance Investigation</a>


and now I do not know what to say.</p>
<p>Ceph set out with the idea to make storage a commodity by using
regular PCs + a lot of local hard disks + software to make
inexpensive storage. For that, you ran a number of control
processes and an OSD process per disk (&ldquo;object storage demon&rdquo;).</p>
<p>Some people were very enthusiastic, envisioning OSD processes
becoming an integrated part of any storage device as part of
computational storage, even.</p>
<p>Something else happened: NVME. NVME is flash memory on a PCIe
bus, giving you a very large number of IOPS with mediocre
latency. You get around 1 million IO operations per second, but
a read takes ~100 microseconds, and an unbuffered write takes
about 420 micros. That means, you need to run 100s of parallel
things.</p>
<p>Ceph is full of logs. Logs kill parallelism by design, or at
least severely limit it. Also, Ceph is full of computational
complexity. And that is ok, when a disk seek takes 5ms on a 3GHz
CPU, and you got 15 million clock cycles think time per disk
seek. Less so, when you need to keep 100s of ops in flight.
Suddenly, the budget shrinks by /1000, and your serializing
architecture gets in the way of things.</p>
<p>Now read this report. We are talking about NVME devices, 11T,
maybe 16T per device, 4 PCIe lanes. These people are talking
about 4 OSD processes (down to 2, and they consider this an
improvement) per device. And they eat six (sic!) cores per NVME
device. Apart from this never making it to computational storage
for thermal reasons, this is an insane cost.</p>
<p>In modern storage, bandwidth is usually limited by the network,
not the local devices: You can RAID your storage bandwidth until
you saturated the 100 GBit/s network, and then you are done.</p>
<p>IOPS are unlimited in the same way: You get not quite 1 million
IOPS per device, so if that is not sufficient, spread across
many.</p>
<p>The only remaining challenge in this
<a href="/2017/07/07/the-data-center-in-the-age-of-abundance.html">age of abundance in the data center</a>


is commit (fsync) latency: how long to push things to a
persistent storage. Even that comes down a lot, with optane or
NVRAM in the client or as early as possible in the server.</p>
<p>Relatively low powered all-flash iSCSI appliances do routinely
250 micros commit latency, and things involving NVMEoF and RDMA
can come down to under 100 micros reliably, if you have the
coin. Want faster? Put Optane or NVRAM into each client.</p>
<p>And it is telling that the paper here talks about latency
improvements only in relative numbers (&ldquo;30% less&rdquo;), but never
actually speaks about absolute timings.</p>
<p>Maybe it is time to stop and think, and re-evaluate if this Ceph
thing is the smart thing to do with storage in the face of NVME,
Optane and NVRAM. Because the numbers look all wrong to me. Even
the units look wrong, actually.</p>
<p><a href="https://twitter.com/antondollmaier/status/1151022173982724097" target="_blank" rel="noopener">Conversations deeper in the Thread</a>

:</p>
<p>There was were questions on what to use for low-latency
disaggregated storage and if one needed redundancy at all.</p>
<p>Examples of low-latency storage are software solutions from
<a href="http://lightbitslabs.com" target="_blank" rel="noopener">Lightbitslabs</a>

, from
<a href="http://datera.com" target="_blank" rel="noopener">Datera</a>

, and from
<a href="http://quobyte.com" target="_blank" rel="noopener">Quobyte</a>

. There are many more.</p>
<p>And funnily enough, if you talk to your inhouse customers, most
actually don&rsquo;t want any of this, because they talk to a database
(MySQL, Cassandra, Elastic, &hellip;) and not to &ldquo;storage&rdquo; directly.</p>
<p>Then you speak to the MySQL people and they say &ldquo;We have
replication and
<a href="https://github.com/github/orchestrator" target="_blank" rel="noopener">Orchestrator</a>

, even
masters are throwaway&rdquo;. You talk to the Cassandra team and they
laugh in Paxos. And so on. So most of these teams actually
prefer &ldquo;RDMA to a NVME namespace&rdquo; over storage software with
redundancy, and do resiliency higher up on the stack, in
application context.</p>
<p>As a storage team, you have to have some kind of low-latency
non-replicated solution first, because that&rsquo;s what is actually
the primary demand. You also need a lowish-latency, OLTP-capable
redundant solution (&lt;500 microseconds is fine), but there is
only unscaled, low level demand.</p>
<p>And then there is huge demand for volume at any latency,
append-only preferred over rewriteable for many reasons. So S3
with heavy tiering. Ceph is actually pretty good at that, but
that is likely not NVME, but many large disk drives.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#computer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				computer
				</a>
				
				<a href="/tags/#storage" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				storage
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2019-07-16-ceph-and-nvme---not-a-good-combination.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/06/14/not-quite-storage-any-more.html">Not quite storage any more</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/09/03/konsenssysteme.html">Konsenssysteme</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
