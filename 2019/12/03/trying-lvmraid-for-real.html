<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Trying lvmraid for real | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2019/12/03/trying-lvmraid-for-real.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Trying lvmraid for real | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2019/12/03/trying-lvmraid-for-real.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2019-12-03T14:10:12Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Trying lvmraid for real' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="trying-lvmraid-for-real-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Trying lvmraid for real
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>December 3, 2019</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/12/02/cloning-and-splitting-logical-volumes.html">Cloning and splitting logical volumes</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/12/28/streaming-and-energy.html">Streaming and Energy</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>So after testing <a href="/2019/12/02/cloning-and-splitting-logical-volumes.html">LVM Raid</a>


in princple, I have been trying it on some real hardware to see
what happens. The idea was to estimate if it scales and if not,
how it doesn&rsquo;t. I was expecting to run into all kinds of obscure
problems in my testing, but in fact, it was a quick and short
death.</p>
<p>Here is my box: QuantaGrid D42A-2U with an <a href="https://www.amd.com/en/products/cpu/amd-epyc-7551p" target="_blank" rel="noopener">AMD EPYC 7551P CPU</a>


(32C, HT off), 1024 GB of memory, a boot disk and 12x
Micron_9200_MTFDHAL11TATCW
(<a href="https://www.micron.com/-/media/client/global/documents/products/product-flyer/9200_ssd_product_brief.pdf" target="_blank" rel="noopener">PDF</a>

)
for 120TB of disk storage.</p>
<p>The setup was very straight forward:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> pvcreate /dev/nvme*n1
</span></span><span class="line"><span class="cl"><span class="gp">#</span> vgcreate vg00 /dev/nvme*n1
</span></span><span class="line"><span class="cl"><span class="gp">#</span> lvcreate -n mysqlvol -L60T vg00
</span></span><span class="line"><span class="cl"><span class="gp">#</span> lvconvert --type raid1 -m1 /dev/vg00/mysqlVol
</span></span></code></pre></div><p>The objective was to ensure that an existing non-raided volume
could be converted into a RAID after the fact. My installation
is half-sized. The actual production version of this would be on
a machine with 24 of these drives, 12 of them currently filled
by a 90T database, and I just used a spare box to test the basic
procedure.</p>
<h2 id="it-works-slowly">
    <a href="#it-works-slowly">
	It works, slowly
    </a>
</h2>
<p>So, this worked:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> lvs -a -o+raid_min_recovery_rate,raid_max_recovery_rate,raid_mismatch_count,raid_sync_action
</span></span><span class="line"><span class="cl"><span class="go">  LV                  VG    Attr       LSize    Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert MinSync MaxSync Mismatches SyncAction
</span></span></span><span class="line"><span class="cl"><span class="go">  audit               sysvm -wi-ao----    1.95g
</span></span></span><span class="line"><span class="cl"><span class="go">  log                 sysvm -wi-ao----   10.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  root                sysvm -wi-ao----    9.77g
</span></span></span><span class="line"><span class="cl"><span class="go">  swap                sysvm -wi-ao---- 1000.00m
</span></span></span><span class="line"><span class="cl"><span class="go">  var                 sysvm -wi-ao----   35.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  mysqlVol            vg00  rwi-a-r---   60.00t                                    0.51                                      0 recover
</span></span></span><span class="line"><span class="cl"><span class="go">  [mysqlVol_rimage_0] vg00  iwi-aor---   60.00t
</span></span></span><span class="line"><span class="cl"><span class="go">  [mysqlVol_rimage_1] vg00  Iwi-aor---   60.00t
</span></span></span><span class="line"><span class="cl"><span class="go">  [mysqlVol_rmeta_0]  vg00  ewi-aor---    4.00m
</span></span></span><span class="line"><span class="cl"><span class="go">  [mysqlVol_rmeta_1]  vg00  ewi-aor---    4.00m
</span></span></span></code></pre></div><h2 id="performance-metric">
    <a href="#performance-metric">
	Performance metric
    </a>
</h2>
<p>For very slow and single threaded values of work: <code>iostat -x -k 10</code></p>
<p><p class="md__image">
  <img src="/uploads/2019/12/lvmraid-iostat.png" alt=""  />
</p>

</p>
<p>As you can see, nmve0n1 is being read at around 240 MB/s, and
being written at the same speed to nvme6n1. The rimage_0 is
dm-8, you can see the reading, and the writing goes to dm-10,
the rimage_1.</p>
<p>At this rate, I will get a RAID sync in 3.5 days or so (60*1024/0.22 = 280k
seconds).</p>
<h2 id="expected-performance">
    <a href="#expected-performance">
	Expected performance
    </a>
</h2>
<p>The expected behavior is to see a request queue deep enough to get the full
transfer rate from a single NVME device (3.5 GB/s according to the spec
sheet, anything above 2.5 GB/s sustained is good enough), and on all 6
device pairs in parallel, for a total of anything above 6x 2.5GB/s = 15 GB/s
for an unconstrained RAID-1 sync. That is what the hardware can do here. In
this case, the sync would complete in 4096 seconds, a bit under 1.5h.</p>
<p>So basically this died in the crib, because it does not leverage any
parallelism the CPU, the multitude of drives, the deep queues of the NVMEs
or anything else would have to offer.</p>
<p>It&rsquo;s from the past.</p>
<p>LVM is in need of serious overhaul in order to become a tool for the 2020&rsquo;s.
Outside of toy workloads, snapshots don&rsquo;t work,
<a href="https://www.systutorials.com/docs/linux/man/7-lvmraid/" target="_blank" rel="noopener">lvmraid</a>

 also does
not work.</p>
<h2 id="why-is-this-slow">
    <a href="#why-is-this-slow">
	Why is this slow?
    </a>
</h2>
<p>A single NVME drive (we have 2x 6 of them) like the one I used is a 4xPCIe
3.0 device, so we get a transfer rate on the bus of 32 GByte/s. The internal
structure of the flash limits the performance here, and according to the
technical specifications of the device we get 800k-ish IOPS (let&rsquo;s say it&rsquo;s
a million) and 3.5 GByte/s from it.</p>
<p>We also can measure the device and see that it does have a read latency of
around 100-120 microseconds, and a buffered write latency (to the internal
RAM of the device, assume it has 512 MB or so) of 50 microseconds. If you
write a lot, writes become unbuffered at, say, 420 micros.</p>
<p>In order to get 1 million IOPS single threaded at a queue depth of 1, you
would need a latency of 1 microseconds. You don&rsquo;t get that, so in order to
get all IOPS, you need to have deep queues (and async IO) or many threads.</p>
<p>In order to get 3.5 GB/s (say, 4 GB/s) at 4 KB block size, you need 1
million blocks per second (920k for 3.5 GB/s). Again, you need deep queues
or many thread to get that.</p>
<h2 id="addendum-unexpected-performance-limits">
    <a href="#addendum-unexpected-performance-limits">
	Addendum: Unexpected performance limits
    </a>
</h2>
<p>Today, I monitored the still syncing array and it has been progressing at
around 250 MB/s equalling around 1.1% per hours over night, and
is now at 20-something percent synced.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> lvchange -maxrecoveryspeed<span class="o">=</span>1000k /dev/vg00/mysqlVol
</span></span></code></pre></div><p>This works, and throttles the sync to just below 1000k per
second. Conversely, setting a recovery speed of 0k falls back to
the default 250 MB/s.</p>
<p>But: Setting it to 1000000k ups the speed to around 550 MB/s,
which is the single threaded native speed of the array. I see
around 4300 requests/s at a size of 256 KB at the NVME level,
and around 8600 requests/s at a size of 128 KB one level higher
in the dm-layer. There is also some kind of request merging
going on somewhere in the stack, which for adjacent requests
even makes sense.</p>
<h2 id="addendum-interrupting-the-raid-sync">
    <a href="#addendum-interrupting-the-raid-sync">
	Addendum: Interrupting the RAID sync
    </a>
</h2>
<p>If you try to split the Volume while it is still synching, you
will find that this is not possible.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> lvconvert --splitmirrors <span class="m">1</span> -n splitlv /dev/vg00/mysqlVol
</span></span><span class="line"><span class="cl"><span class="go">  Unable to split vg00/mysqlVol while it is not in-sync.
</span></span></span></code></pre></div><p>Another observationL While lvmraid employs mdraid code, working with
devicemapper block devices for the data and external metadata, mdraid does
not see any of this in /proc;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> cat /proc/mdstat
</span></span><span class="line"><span class="cl"><span class="go">Personalities : [raid6] [raid5] [raid4] [raid1]
</span></span></span><span class="line"><span class="cl"><span class="go">unused devices: &lt;none&gt;
</span></span></span></code></pre></div><p>You can&rsquo;t use any mdraid tooling to turn knobs inside lvm
controlled mdraid code.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#storage" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				storage
				</a>
				
				<a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				erklaerbaer
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2019-12-03-trying-lvmraid-for-real.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/12/02/cloning-and-splitting-logical-volumes.html">Cloning and splitting logical volumes</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/12/28/streaming-and-energy.html">Streaming and Energy</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
