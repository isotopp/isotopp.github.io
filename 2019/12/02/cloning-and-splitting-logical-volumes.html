<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Cloning and splitting logical volumes | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2019/12/02/cloning-and-splitting-logical-volumes.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Cloning and splitting logical volumes | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2019/12/02/cloning-and-splitting-logical-volumes.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2019-12-02T15:01:41Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Cloning and splitting logical volumes' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="cloning-and-splitting-logical-volumes-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Cloning and splitting logical volumes
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>December 2, 2019</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/11/22/fertig-gelesen-exit-strategy.html">Fertig gelesen: Exit Strategy</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/12/03/trying-lvmraid-for-real.html">Trying lvmraid for real</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Where I work, we routinely run our databases on XFS on LVM2.</p>
<h2 id="the-setup">
    <a href="#the-setup">
	The setup
    </a>
</h2>
<p>Each database has their database on <code>/mysql/schemaname</code>, with
the subdirectories <code>/mysql/schemaname/{data,log,tmp}</code>. The
entire <code>/mysql/schemname</code> tree is a LVM2 Logical Volume
<code>mysqlVol</code> on the Volume Group <code>vg00</code>, which is then formatted
as an XFS filesystem.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> pvcreate /dev/nvme*n1
</span></span><span class="line"><span class="cl"><span class="gp">#</span> vgcreate vg00 /dev/nvme*n1
</span></span><span class="line"><span class="cl"><span class="gp">#</span> lvcreate -n mysqlVol -L...G vg00
</span></span><span class="line"><span class="cl"><span class="gp">#</span> mkfs -t xfs /dev/vg00/mysqlVol
</span></span><span class="line"><span class="cl"><span class="gp">#</span> mount -t xfs /dev/vg00/mysqlVol /mysql/schemaname
</span></span></code></pre></div><h2 id="basic-ops">
    <a href="#basic-ops">
	Basic Ops
    </a>
</h2>
<p>You can grow an existing LVM Logical Volume with
<code>lvextend -L+50G /dev/vg00/mysqlVol</code> or similar, and then
<code>xfs_grow /dev/vg00/myqlVol</code>.</p>
<p>You can also create a snapshot with
<code>lvcreate -s -L50G -n SNAPSHOT /dev/vg00/mysqlVol</code>
and if you do this right, it will even be consistent or at least
recoverable, from a database POV. But LVM snapshots are terribly
inefficient, and you might not want to do that on a busy
database.</p>
<p>The size you specified for the LVM snapshot is the amount of
backing storage: When there is a logical write to the mysqlVol,
LVM intercepts the write, physically reads the old target block,
physically writes the old target block into the snapshot backing
storage and then resumes the original write. This will do
horrible things to your write latency, because the orignal write
is stalled until the copy has been made, and I crashed a
database at least once with Redo-Log overflow while holding and
reading a snapshot.</p>
<p>As the backing storage fills up, the snapshot will fail once it
is running out of free space. If you still have free space, it
is possible to extend the backing store using
<code>lvextend -L+50G /dev/vg00/SNAPSHOT</code> with a live snapshot being
held.</p>
<p>Reads to the original mysqlVol can be satisfied the normal way
now, as the data we see is always the most recent blocks. Reads
from the snapshot will look for the data in the snapshot, and if
they find it, will return with the old, snapshotted data. Or, if
they do not find it, will look into the mysqlVol instead. In any
case, the normal filesystem will show current data, while the
snapshot will show old data, and as both volumes diverge,
snapshot backing storage will be consumed up to the point where
both volumes are completely diverged and the snapshot is as
large as the original volume.</p>
<p>Mounting the XFS snapshot volume is a bit tricky: XFS will
refuse to mount the same UUID filesystem twice, and since by
definition the snapshot is a clone of the (past) original
volume, it will of course have the same UUID. So we need to tell
XFS that this is okay:
<code>mount -t ro,nouuid /dev/vg00/SNAPSHOT /mnt</code>
to get it mounted.</p>
<p>Once unmounted again, you can turn the Logical Volume to offline
and throw it away: <code>lvchange -an /dev/vg00/SNAPSHOT</code> and
<code>lvremove /dev/vg00/SNAPSHOT</code> to get it done.</p>
<h2 id="mirroring-using-dm-raid">
    <a href="#mirroring-using-dm-raid">
	Mirroring using dm-raid
    </a>
</h2>
<p>One method to clone a machine is to convert an existing volume
into a RAID1, then split the raid and move one half of the
mirror to a new machine.</p>
<p>I made myself a small VM with seven tiny drives to test this:
The boot disk is sda, and the drives sdb to sdg are for LVM
testing.</p>
<p>The initial setup is like so: We copy the partition table of sda
to all play drives. We then create a volume group testvg, to
which we add the initial 3 drives only partitions, sdb1, sdc1
and sdd1. We then create a simple concatenation of 2G extents
from sdb1, sdbc1 and sdd1.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> <span class="k">for</span> i in sdb sdc sdd sde sdf sdg
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span>   sfdisk -d /dev/sda <span class="p">|</span> sfdisk /dev/<span class="nv">$i</span>
</span></span><span class="line"><span class="cl"><span class="gp">&gt;</span> <span class="k">done</span>
</span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> pvcreate /dev/sd<span class="o">{</span>b,c,d,e,f,g<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span> vgcreate testvg /dev/sd<span class="o">{</span>b,c,d<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span> lvcreate -n testlv -L2G testvg
</span></span><span class="line"><span class="cl"><span class="gp">#</span> lvextend -L+2G /dev/testvg/testlv /dev/sdc1
</span></span><span class="line"><span class="cl"><span class="gp">#</span> lvextend -L+2G /dev/testvg/testlv /dev/sdd1
</span></span></code></pre></div><p>We can now check what we have. We are looking at the <code>lvs</code>
output to see that we have a 6G LV. Then we check the <code>pvs</code>
output to see that we indeed have sdb1, sdc1 and sdd1 in testvg,
and that 2G of each drive have been used. We can then finally
proceed to <code>pvdisplay --map</code> to validate the actual layout.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> lvs
</span></span><span class="line"><span class="cl"><span class="go">  LV     VG     Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span></span></span><span class="line"><span class="cl"><span class="go">  testlv testvg -wi-a----- 6.00g
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> pvs
</span></span><span class="line"><span class="cl"><span class="go">  PV         VG     Fmt  Attr PSize   PFree
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdb1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdc1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdd1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sde1         lvm2 ---  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdf1         lvm2 ---  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdg1         lvm2 ---  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> pvdisplay --map
</span></span><span class="line"><span class="cl"><span class="go">  --- Physical volume ---
</span></span></span><span class="line"><span class="cl"><span class="go">  PV Name               /dev/sdb1
</span></span></span><span class="line"><span class="cl"><span class="go">  VG Name               testvg
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">  --- Physical Segments ---
</span></span></span><span class="line"><span class="cl"><span class="go">  Physical extent 0 to 511:
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical volume      /dev/testvg/testlv
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical extents     0 to 511
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">  --- Physical volume ---
</span></span></span><span class="line"><span class="cl"><span class="go">  PV Name               /dev/sdc1
</span></span></span><span class="line"><span class="cl"><span class="go">  VG Name               testvg
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">  --- Physical Segments ---
</span></span></span><span class="line"><span class="cl"><span class="go">  Physical extent 0 to 511:
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical volume      /dev/testvg/testlv
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical extents     512 to 1023
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">  --- Physical volume ---
</span></span></span><span class="line"><span class="cl"><span class="go">  PV Name               /dev/sdd1
</span></span></span><span class="line"><span class="cl"><span class="go">  VG Name               testvg
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">  --- Physical Segments ---
</span></span></span><span class="line"><span class="cl"><span class="go">  Physical extent 0 to 511:
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical volume      /dev/testvg/testlv
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical extents     1024 to 1535
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><p>With this we can introduce the three additional drives, and
convert the setup to a mirror:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# vgextend testvg /dev/sd{e,f,g}1
</span></span></span><span class="line"><span class="cl"><span class="go">  Volume group &#34;testvg&#34; successfully extended
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# pvs
</span></span></span><span class="line"><span class="cl"><span class="go">  PV         VG     Fmt  Attr PSize   PFree
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdb1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdc1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdd1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sde1  testvg lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdf1  testvg lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdg1  testvg lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span></code></pre></div><p>and the actual conversion.
First, using <code>lvs</code> we can watch the progress of the sync:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# lvconvert --type raid1 -m1 /dev/testvg/testlv
</span></span></span><span class="line"><span class="cl"><span class="go">Are you sure you want to convert linear LV testvg/testlv to raid1 with 2 images enhancing resilience? [y/n]: y
</span></span></span><span class="line"><span class="cl"><span class="go">  Logical volume testvg/testlv successfully converted.
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# lvs
</span></span></span><span class="line"><span class="cl"><span class="go">  LV     VG     Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span></span></span><span class="line"><span class="cl"><span class="go">  testlv testvg rwi-a-r--- 6.00g                                    6.25
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# lvs
</span></span></span><span class="line"><span class="cl"><span class="go">  LV     VG     Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span></span></span><span class="line"><span class="cl"><span class="go">  testlv testvg rwi-a-r--- 6.00g                                    15.92
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# lvs
</span></span></span><span class="line"><span class="cl"><span class="go">  LV     VG     Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span></span></span><span class="line"><span class="cl"><span class="go">  testlv testvg rwi-a-r--- 6.00g                                    100.00
</span></span></span></code></pre></div><p>Let&rsquo;s check the disk layout again.</p>
<p>There are two competing implementations of this, <code>--type mirror</code>
and <code>--type raid1</code>. The mirror implementation is very extremely
strongly deprecated, the raid1 implementation is okay, which is
why we used this one. It uses mdraid code internally, and we can
show this using <code>lvs -a --segments -o+devices</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> lvs -a --segments -o+devices
</span></span><span class="line"><span class="cl"><span class="go">  LV                VG     Attr       #Str Type   SSize Devices
</span></span></span><span class="line"><span class="cl"><span class="go">  testlv            testvg rwi-a-r---    2 raid1  6.00g testlv_rimage_0(0),testlv_rimage_1(0)
</span></span></span><span class="line"><span class="cl"><span class="go">  [testlv_rimage_0] testvg iwi-aor---    1 linear 2.00g /dev/sdb1(0)
</span></span></span><span class="line"><span class="cl"><span class="go">  [testlv_rimage_0] testvg iwi-aor---    1 linear 2.00g /dev/sdc1(0)
</span></span></span><span class="line"><span class="cl"><span class="go">  [testlv_rimage_0] testvg iwi-aor---    1 linear 2.00g /dev/sdd1(0)
</span></span></span><span class="line"><span class="cl"><span class="go">  [testlv_rimage_1] testvg iwi-aor---    1 linear 6.00g /dev/sde1(1)
</span></span></span><span class="line"><span class="cl"><span class="go">  [testlv_rmeta_0]  testvg ewi-aor---    1 linear 4.00m /dev/sdb1(512)
</span></span></span><span class="line"><span class="cl"><span class="go">  [testlv_rmeta_1]  testvg ewi-aor---    1 linear 4.00m /dev/sde1(0)
</span></span></span></code></pre></div><p>This shows us the visible LV testlv as well as the hidden
infrastructure that is being created to build it. The left leg
of the RAID 1 is testlv_rimage_0, spread over 3 physical
devices.</p>
<p>The right leg is testlv_rimage1, and because the data all fits
onto one disk, we get this consolidated into a single 6G segment
on a single device, not quite what we want. We also see two meta
devices, which hold the metadata and a bitmap that can speed up
array synchonisation.</p>
<p>Here we see the asymmetric layout again, at the <code>pvs</code> level.
Note how the allocation of the rmeta sub-LVs creats the &ldquo;.99&rdquo;
free sizes.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# pvs
</span></span></span><span class="line"><span class="cl"><span class="go">  PV         VG     Fmt  Attr PSize   PFree
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdb1  testvg lvm2 a--  &lt;20.00g  17.99g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdc1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdd1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sde1  testvg lvm2 a--  &lt;20.00g  13.99g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdf1  testvg lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdg1  testvg lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> pvdisplay --map
</span></span><span class="line"><span class="cl"><span class="go">  --- Physical volume ---
</span></span></span><span class="line"><span class="cl"><span class="go">  PV Name               /dev/sde1
</span></span></span><span class="line"><span class="cl"><span class="go">  VG Name               testvg
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">  --- Physical Segments ---
</span></span></span><span class="line"><span class="cl"><span class="go">  Physical extent 0 to 0:
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical volume      /dev/testvg/testlv_rmeta_1
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical extents     0 to 0
</span></span></span><span class="line"><span class="cl"><span class="go">  Physical extent 1 to 1536:
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical volume      /dev/testvg/testlv_rimage_1
</span></span></span><span class="line"><span class="cl"><span class="go">    Logical extents     0 to 1535
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><h2 id="maintaining-the-raid">
    <a href="#maintaining-the-raid">
	Maintaining the RAID
    </a>
</h2>
<p>As dm-raid uses md-raid plumbing internally, it has the same controls as
md-raid. Among them are also controls that control the sync speed of a
logical volume. The lvchange command can set these. For demonstration
purposes we are setting these as low as possible, then force a resync of the
RAID and check this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> lvchange /dev/testvg/testlv --minrecoveryrate 1k --maxrecoveryrate 100k
</span></span><span class="line"><span class="cl"><span class="go">  Logical volume testvg/testlv changed.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> lvchange --syncaction repair /dev/testvg/testlv
</span></span><span class="line"><span class="cl"><span class="gp">#</span> lvs -o+raid_min_recovery_rate,raid_max_recovery_rate,raid_mismatch_count,raid_sync_action
</span></span><span class="line"><span class="cl"><span class="go">  LV                VG     Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert MinSync MaxSync Mismatches SyncAction
</span></span></span><span class="line"><span class="cl"><span class="go">  testlv            testvg rwi-a-r--- 6.00g                                    0.19                   1     100          0 repair
</span></span></span></code></pre></div><p>The <code>--syncaction repair</code> forces a RAID recovery, the <code>lvs</code> command shows
the data we need to see to track it.</p>
<h2 id="splitting-the-raid-and-the-vg">
    <a href="#splitting-the-raid-and-the-vg">
	Splitting the RAID and the VG
    </a>
</h2>
<p>We can now split the RAID into two unraided LVs with different
names inside the same VG:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# lvconvert --splitmirrors 1 -n splitlv /dev/testvg/testlv
</span></span></span><span class="line"><span class="cl"><span class="go">Are you sure you want to split raid1 LV testvg/testlv losing all resilience? [y/n]: y
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# lvs
</span></span></span><span class="line"><span class="cl"><span class="go">  LV      VG     Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span></span></span><span class="line"><span class="cl"><span class="go">  splitlv testvg -wi-a----- 6.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  testlv  testvg -wi-a----- 6.00g
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# pvs
</span></span></span><span class="line"><span class="cl"><span class="go">  PV         VG     Fmt  Attr PSize   PFree
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdb1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdc1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdd1  testvg lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sde1  testvg lvm2 a--  &lt;20.00g &lt;14.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdf1  testvg lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdg1  testvg lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span></code></pre></div><p>Since the raid is now split, the rmeta sub-LVs are gone and the
rimage sub-LVs are unwrapped and become the actual LVs (and
those .99 numbers in the PFree column are nice and round again).</p>
<p>At this point we can then proceed to split the Volume Group in two,
putting splitlv into a new Volume Group splitvg, then export
that.</p>
<p>For that, we need to change the testvg to unavailable, then run
vgsplit. Because of that, a data LV should always be on a data
VG that is different from the Boot VG which would hold the boot
LVs. If this is not the case, splitting the data LV would require
a boot into a rescue image in order to be able to split the data
LV: It is not possible to offline a boot LV without this.</p>
<p>The outcome:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# vgchange -an testvg
</span></span></span><span class="line"><span class="cl"><span class="go">  0 logical volume(s) in volume group &#34;testvg&#34; now active
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# vgsplit -n splitlv testvg splitvg
</span></span></span><span class="line"><span class="cl"><span class="go">  New volume group &#34;splitvg&#34; successfully split from &#34;testvg&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# lvs
</span></span></span><span class="line"><span class="cl"><span class="go">  LV      VG      Attr       LSize Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span></span></span><span class="line"><span class="cl"><span class="go">  splitlv splitvg -wi------- 6.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  testlv  testvg  -wi------- 6.00g
</span></span></span><span class="line"><span class="cl"><span class="go">root@ubuntu:~# pvs
</span></span></span><span class="line"><span class="cl"><span class="go">  PV         VG      Fmt  Attr PSize   PFree
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdb1  testvg  lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdc1  testvg  lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdd1  testvg  lvm2 a--  &lt;20.00g &lt;18.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sde1  splitvg lvm2 a--  &lt;20.00g &lt;14.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdf1  testvg  lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span><span class="line"><span class="cl"><span class="go">  /dev/sdg1  testvg  lvm2 a--  &lt;20.00g &lt;20.00g
</span></span></span></code></pre></div><p>We can see that vgsplit automatically identified the physical
drives that make up the splitlv volume, made sure nothing else
is on these drives and moves them into a new VG splitvg.</p>
<p>We can now <code>vgexport</code> that thing, eject the drives and move them
elsewhere. Over there, we can <code>vgimport</code> things and proceed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# vgexport splitvg
</span></span></span><span class="line"><span class="cl"><span class="go">  Volume group &#34;splitvg&#34; successfully exported
</span></span></span></code></pre></div><p>It is now safe to pull the drive.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				erklaerbaer
				</a>
				
				<a href="/tags/#storage" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				storage
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2019-12-02-cloning-and-splitting-logical-volumes.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/11/22/fertig-gelesen-exit-strategy.html">Fertig gelesen: Exit Strategy</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/12/03/trying-lvmraid-for-real.html">Trying lvmraid for real</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
