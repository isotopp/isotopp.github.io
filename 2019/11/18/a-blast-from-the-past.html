<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>A blast from the past | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2019/11/18/a-blast-from-the-past.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='A blast from the past | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2019/11/18/a-blast-from-the-past.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2019-11-18T14:53:14Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='A blast from the past' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="a-blast-from-the-past-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						A blast from the past
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>November 18, 2019</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/11/18/fertig-gelesen-change-agent.html">Fertig gelesen: Change Agent</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/11/19/when-a-file-changes-do-a-thing.html">When a file changes, do a thing</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p><strong>TL:DR:</strong> If you have long running transactions, MySQL does not
deal well with this, and it will slow down the box. That&rsquo;s
okay as long as you are basically alone on your box, but if you
aren&rsquo;t, the others will hate you.</p>
<p>The database machine &lsquo;somehierarchy-02&rsquo; in a general purpose
load balancer pool for somehierarchy had replication delay.</p>
<p>It&rsquo;s a MySQL replica and is receiving the same write workload
than all the other boxen in that pool. Yet, somehierarchy-03 is
fine, while somehierarchy-02 is not. Both machines have
comparable hardware: -02 and -03 are both Dell M630 with 128 GB
of memory and two SSD. They should behave identically, yet one
runs from memory, but the other is reading 40 MB/s from disk.</p>
<p><p class="md__image">
  <img src="/uploads/2019/11/symptom-metrics.png" alt=""  />
</p>

</p>
<p>Machine somehierarchy-02 reading up to 40 MB/s from disk. The
sister box runs from memory.</p>
<p>The objective was to find the root cause for this, as it was
causing replication delay and generally making people unhappy.</p>
<p>Together with a colleague we established that both boxes
replicate from the same master and that they receive identical
binlogs. We did find indeed the same set of GTIDs, a similar
amount of binlog files, and a bit of Ghetto statistics
(<code>mysqlbinlog -v binlog... | egrep -i '(insert|update|delete)' | awk ... | sort | uniq -c</code>) on the active tables per time also
found nothing unusual.</p>
<p>We then did a <code>mysqldump --no-data schemaname</code> to validate
that the schemas are identical. They indeed were, same tables,
same table structures, same indexes.</p>
<h2 id="its-reads-coming-from-a-client">
    <a href="#its-reads-coming-from-a-client">
	It&rsquo;s reads, coming from a client
    </a>
</h2>
<p>We can therefore rule out anything related to replication or
disk writes. The difference must be in the reads, that is, the
two boxes receive vastly different workload from clients.</p>
<p>Comparing the active <code>PROCESSLIST</code> between the two boxes did not
yield results, though. Checking back we found that the problem
had been going away while we were looking. So whatever we were
looking for would not be in processlists, only in logs.</p>
<p>So, do we have logs?</p>
<h2 id="log_processlist-is-still-a-thing">
    <a href="#log_processlist-is-still-a-thing">
	log_processlist is still a thing
    </a>
</h2>
<p>Turns out: we do. The tool
<a href="http://blog.wl0.org/2011/02/log_processlist-sh-script-for-monitoring-mysql-instances/" target="_blank" rel="noopener">log_processlist</a>


is older than time itself, it goes back to before 2007. Simon
Mudd and I wrote that once, to have a flight recorder for
crashed machines.</p>
<p>Basically it dumps data from the operating system and the
various MySQL tables into the directory <code>/var/log/mysql_pl</code>, where
we have a weekly ring-buffer like directory structure:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">[somehierarchy-02 /var/log/mysql_pl]$ ls -F
</span></span></span><span class="line"><span class="cl"><span class="go">Fri/  Mon/  README  Sat/  Sun/  Thu/  Tue/  Wed/
</span></span></span></code></pre></div><p>When a box crashes or misbehaves, as long as you have access to
this subtree, you can go there and inspect the files to see what
the box did just before it crashed. So we go into <code>Mon</code>
subdirectory for Monday, and look into some files, for example
the 10:20 recordings:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">[somehierarchy-02 ~]# cd /var/log/mysql_pl/Mon
</span></span></span><span class="line"><span class="cl"><span class="go">[somehierzrchy-02 Mon]# ls -l 10_20*
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 19144 Nov 18 10:20 10_20.innodb.xz
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root  5836 Nov 18 10:20 10_20.unix.xz
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 18368 Nov 18 10:20 10_20.xz
</span></span></span><span class="line"><span class="cl"><span class="go">[somehierarchy-02 Mon]# ls -l 10_21.sys*
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 14590 Nov 18 10:21 10_21.sys.gz
</span></span></span></code></pre></div><p>In the 10_20.xz we find the MySQL processlist and a few other
things, in the 10_20.unix file.xz we find the UNIX processlist,
system memory and other system stuff, and in the 10_20.innodb
file there are various InnoDB related table dumps from this
point in time. There is also a dump of the entire sys set of
views every 15 minutes, so 10_21.sys.gz has that.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">[somehierarchy-02 /var/log/mysql_pl]# head -3 /tmp/x
</span></span></span><span class="line"><span class="cl"><span class="go">Id	User	Host	db	Command	Time	State	Info
</span></span></span><span class="line"><span class="cl"><span class="go">33	system user		NULL	Connect	1	Waiting for dependent transaction to commit	NULL
</span></span></span><span class="line"><span class="cl"><span class="go">34	system user		NULL	Connect	1	System lock	INSERT INTO ...
</span></span></span></code></pre></div><p>Checking the processlist shows many sleeping connections. We
filter these and immediately hit paydirt:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">[somehierarchy-02 tmp]# awk -F&#34;\t&#34; &#39;$5 != &#34;Sleep&#34; { print $5, $6 }&#39; x | wc -l
</span></span></span><span class="line"><span class="cl"><span class="go">27
</span></span></span><span class="line"><span class="cl"><span class="go">[somehierarchy-02 tmp]# awk -F&#34;\t&#34; &#39;$5 != &#34;Sleep&#34; { print $5, $6 }&#39; x
</span></span></span><span class="line"><span class="cl"><span class="go">Command Time
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 1
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 1
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 1
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 1
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 1
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 1
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 2
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 2
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 2
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 2
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 2
</span></span></span><span class="line"><span class="cl"><span class="go">Connect 39412
</span></span></span><span class="line"><span class="cl"><span class="go">Query 33242
</span></span></span><span class="line"><span class="cl"><span class="go">Query 33242
</span></span></span><span class="line"><span class="cl"><span class="go">Query 33241
</span></span></span><span class="line"><span class="cl"><span class="go">Query 24514
</span></span></span><span class="line"><span class="cl"><span class="go">Query 20613
</span></span></span><span class="line"><span class="cl"><span class="go">Query 14924
</span></span></span><span class="line"><span class="cl"><span class="go">Query 6827
</span></span></span><span class="line"><span class="cl"><span class="go">Query 3219
</span></span></span><span class="line"><span class="cl"><span class="go">Query 1
</span></span></span><span class="line"><span class="cl"><span class="go">Query 1
</span></span></span><span class="line"><span class="cl"><span class="go">Query 0
</span></span></span><span class="line"><span class="cl"><span class="go">Query 0
</span></span></span><span class="line"><span class="cl"><span class="go">Query 0
</span></span></span><span class="line"><span class="cl"><span class="go">Query 0
</span></span></span></code></pre></div><p>The &ldquo;Connect&rdquo; only means that these are replication threads.
Running Queries have &ldquo;Query&rdquo; and here the number is the seconds
of runtime for this query. There are apparently a number of
queries with a large runtime: 33242 seconds are 9.25 hours -
they are running since 1 am.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">[somehierarchy-02 tmp]# awk -F&#34;\t&#34; &#39;($5 == &#34;Query&#34; ) &amp;&amp; ($6 &gt; 10000) { printf &#34;%s %s %s %s\n&#34;, $2, $3, $6, $7 }&#39; x
</span></span></span><span class="line"><span class="cl"><span class="go">hadoopuser hadoop-07:62112 33242 Sending data
</span></span></span><span class="line"><span class="cl"><span class="go">hadoopuser hadoop-07:62126 33242 Sending data
</span></span></span><span class="line"><span class="cl"><span class="go">hadoopuser hadoop-07:62128 33241 Sending data
</span></span></span><span class="line"><span class="cl"><span class="go">cronuser cronbox-14:34017 24514 Creating sort index
</span></span></span><span class="line"><span class="cl"><span class="go">cronuser cronbox-06:45661 20613 Creating sort index
</span></span></span><span class="line"><span class="cl"><span class="go">cronuser cronbox-14:55920 14924 Creating sort index
</span></span></span></code></pre></div><p>At around 1:00am the <code>hadoopuser</code> connected from hadoop-07 to
somehierarchy-02 and started a number of queries:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">SELECT ...
</span></span></span><span class="line"><span class="cl"><span class="go">FROM MessageLog
</span></span></span><span class="line"><span class="cl"><span class="go">WHERE ( `hotelnumber` &gt;= 986116 ) AND ( `hotelnumber` &lt; 1181338 )
</span></span></span></code></pre></div><p>and similar. They read around 70M rows from MessageLog
each, a table that itself has 540M rows. That takes time.</p>
<p>During that time the &ldquo;select&rdquo; statements maintains a read-only
transaction to create a stable view of the table it is reading.
That means that as we change rows in MessageLog the old versions
of the row are being shifted to the Undo-Log, and while other
transactions read the new version of the row from the
tablespace, these transactions read old versions of the row from
the Undo-Log.</p>
<p>Or they try. They hit the tablespace first, see a new version of
the row, are being sent one version into the past, find that
this is still too recent, go one step deeper into the past and
so on. We are essentially traversing a linked list on disk,
without caching. MySQL is not really meant to deal well with 9h
old transactions.</p>
<p>We can monitor this:</p>
<p><p class="md__image">
  <img src="/uploads/2019/11/undo-log.png" alt=""  />
</p>

</p>
<p>and we will. Not necessarily a thing to alert on at night, but
certainly a thing to check up on early on in debugging.</p>
<p>Certainly a blast from the past: Not just from the past of the
row in a
<a href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control" target="_blank" rel="noopener">MVCC</a>


system, but also a thing <a href="http://mysqldump.azundris.com/archives/101-House-and-Heisenberg-having-Replication-Delay.html" target="_blank" rel="noopener">we have seen
before</a>

,
and that was 2012. Certainly a blast from the past.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#innodb" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				innodb
				</a>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2019-11-18-a-blast-from-the-past.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/11/18/fertig-gelesen-change-agent.html">Fertig gelesen: Change Agent</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2019/11/19/when-a-file-changes-do-a-thing.html">When a file changes, do a thing</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
