<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL für Dummies (5) | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2006/03/06/mysql-fuer-dummies-5.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL für Dummies (5) | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="de_DE" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2006/03/06/mysql-fuer-dummies-5.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2006-03-06T17:00:00Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL für Dummies (5)' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-f%C3%BCr-dummies-5-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL für Dummies (5)
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>March 6, 2006</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2006/03/05/mysql-fuer-dummies-4.html">MySQL für Dummies (4)</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2006/03/07/mysql-fuer-dummies-6.html">MySQL für Dummies (6)</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<h1 id="key-buffer">
    <a href="#key-buffer">
	Key Buffer
    </a>
</h1>
<p>In dem letzten Artikel dieser Serie haben wir gesehen, wie MySQL einen Index anlegt und was dies bedeutet.
MySQL at einen Puffer, mit dem ein Index ganz oder teilweise im RAM gehalten werden kann.
Dies ist der Key Buffer, und er ist eine sehr zentrale Konfigurationsvariable, die in der <code>[mysqld]</code>-Sektion der <code>my.cnf</code> gesetzt wird.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">[mysqld]
</span></span></span><span class="line"><span class="cl"><span class="go">key_buffer = 100M
</span></span></span></code></pre></div><p>Dies stellt einen Key Buffer von bis zu 100 MB für den mysqld zur Verfügung.
Mit den STATUS-Variablen <code>key_read_requests</code> und <code>key_reads</code> kann man dann leicht feststellen, ob dieser Puffer groß genug ist:
<code>key_read_requests</code> sollte sehr viel größer als <code>key_reads</code> sein, und zwar zwischen 100- und 1000-mal so groß.
MySQL hält dann den MyISAM-Index im RAM, und kann so Daten auf der Platte sehr schnell finden.</p>
<p>Man kann bis zu 20 % des Hauptspeichers, den man MySQL zur Verfügung stellen will, in den Key Buffer investieren (auf einer 1 GB Maschine, bei der man 500 MB für MySQL und 500 MB für Apache aufwenden will, kann man den Key Buffer also 100 MB groß machen).
Der Key Buffer sollte so groß sein, wie die Summe aller verwendeten Indices ist (und wir haben ja schon gesehen, wie man die berechnen oder nachsehen kann).
Je nach Hauptspeicher und Indexgröße ist das Dilemma nun da, und man muss auf der einen oder anderen Seite Abstriche machen.</p>
<p>Das nennt der Sysadmin dann &ldquo;Optimierungsaufgabe&rdquo; und der Betriebswirtschaftler hat auch ein Wort dafür: &ldquo;Investitionsbedarf&rdquo;.
Man sieht deutlich die verschiedenen Herangehensweisen der beiden Disziplinen an Probleme.</p>
<h1 id="locks-und-locking">
    <a href="#locks-und-locking">
	Locks und Locking
    </a>
</h1>
<p>Wie wir in den vergangenen Ausgaben dieser Serie auch gesehen haben, kann es Datenbankoperationen geben, die vergleichsweise lange dauern.
Es kann sein, daß eine solche Operation während dieser Zeit ein <code>LOCK</code> auf einer Tabelle erzeugt.
MyISAM kennt zwei Arten von Locks und sie gelten immer für die gesamte Tabelle - MyISAM kann nicht Bereiche einer Tabelle oder gar einzelne Zeilen locken.</p>
<p>Ein <code>SHARED LOCK</code> oder <code>READ LOCK</code> erlaubt dem Lockinhaber den Lesezugriff auf eine Tabelle, und erlaubt gleichzeitig weitere Lesezugriffe durch andere Threads.
Schreibende Threads werden jedoch ausgesperrt und müssen warten.
Ein <code>EXCLUSIVE LOCK</code> oder <code>WRITE LOCK</code> erlaubt dem Lockinhaber und nur diesem den Schreibzugriff auf die Tabelle.
Alle anderen Threads, egal ob sie lesen oder schreiben wollen, müssen warten.</p>
<p>Ein Thread, der wartet, sieht so aus:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@localhost [rootforum]&gt; show processlist\G
</span></span></span><span class="line"><span class="cl"><span class="go">     Id: 7
</span></span></span><span class="line"><span class="cl"><span class="go">   User: root
</span></span></span><span class="line"><span class="cl"><span class="go">   Host: localhost
</span></span></span><span class="line"><span class="cl"><span class="go">     db: rootforum
</span></span></span><span class="line"><span class="cl"><span class="go">Command: Query
</span></span></span><span class="line"><span class="cl"><span class="go">   Time: 0
</span></span></span><span class="line"><span class="cl"><span class="go">  State: NULL
</span></span></span><span class="line"><span class="cl"><span class="go">   Info: show processlist
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">     Id: 8
</span></span></span><span class="line"><span class="cl"><span class="go">   User: root
</span></span></span><span class="line"><span class="cl"><span class="go">   Host: localhost
</span></span></span><span class="line"><span class="cl"><span class="go">     db: rootforum
</span></span></span><span class="line"><span class="cl"><span class="go">Command: Query
</span></span></span><span class="line"><span class="cl"><span class="go">   Time: 422
</span></span></span><span class="line"><span class="cl"><span class="go">  State: copy to tmp table
</span></span></span><span class="line"><span class="cl"><span class="go">   Info: alter table t add index (i)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">     Id: 9
</span></span></span><span class="line"><span class="cl"><span class="go">   User: root
</span></span></span><span class="line"><span class="cl"><span class="go">   Host: localhost
</span></span></span><span class="line"><span class="cl"><span class="go">     db: rootforum
</span></span></span><span class="line"><span class="cl"><span class="go">Command: Query
</span></span></span><span class="line"><span class="cl"><span class="go">   Time: 205
</span></span></span><span class="line"><span class="cl"><span class="go">  State: Locked
</span></span></span><span class="line"><span class="cl"><span class="go">   Info: insert into t values (20000001+1, &#34;keks&#34;, &#34;keks&#34;, 17)
</span></span></span><span class="line"><span class="cl"><span class="go">3 rows in set (0.00 sec)
</span></span></span></code></pre></div><p>Hier ist der Thread mit der ID 9 im State: <code>Locked</code>, denn er versucht auf die Tabelle <code>t</code> zu schreiben.
<code>t</code> wird jedoch gerade vom Thread 8 bearbeitet, der die Tabelle dazu mit einem Lock belegt hat.
Das INSERT-Kommando hängt nun an seinem Prompt und kommt nicht zurück.
Erst nachdem das <code>ALTER TABLE</code> durchgelaufen ist, kann das INSERT-Kommando ausgeführt werden.
Wenn man so eine Ausgabe (&ldquo;Locked&rdquo;) in seinem eigenen <code>SHOW PROCESSLIST</code> sieht, womöglich für mehr als ein Kommando in Folge, dann ist es quasi schon zu spät - der MySQL-Server braucht dringend eine tunende Hand.</p>
<p>Hier noch einmal die Ausführungszeit:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@localhost [rootforum]&gt; insert into t values (20000001+1, &#34;keks&#34;, &#34;keks&#34;, 17);
</span></span></span><span class="line"><span class="cl"><span class="go">Query OK, 1 row affected (8 min 9.49 sec)
</span></span></span></code></pre></div><p>Ein Blick ins Slow-Query-Log bringt dann noch mehr Information.
Dort wird für jede lange dauernde Query nämlich neben der absoluten Query_time auch noch die <code>Lock_time</code> mit aufgeführt.
Ist diese nicht 0, weiß man, daß der Server ein Problem mit seinen Locks hat.</p>
<p>Das ist eine sehr unangenehme Situation, die man unbedingt vermeiden möchte.
Denn wenn man sich mit der Performance von Servern auseinandersetzt, dann gibt es im Wesentlichen zwei Ziele, auf die man einen Server optimieren kann.
Eines dieser Ziele ist Durchsatz, also die Anzahl der Anfragen pro Sekunde, die ein Server zu Ende bringt, und das andere ist Latenz, also die Dauer, die eine einzelne Query dauern darf.
Beides sind sehr unterschiedliche Ziele, und man muss beim Performancetuning seine Segel sehr sorgfältig setzen, je nachdem, welches Optimierungsziel vorne steht.</p>
<h1 id="warteschlangen-telefonzellen-und-hockeyschläger">
    <a href="#warteschlangen-telefonzellen-und-hockeyschl%c3%a4ger">
	Warteschlangen, Telefonzellen und Hockeyschläger
    </a>
</h1>
<p>Bei Optimierung auf Antwortzeit, Latenz, begegnet einem dabei in der Regel die &ldquo;Hockey Stick Curve&rdquo; aus der Warteschlangentheorie. Sie sieht in etwa so aus:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">latency
</span></span></span><span class="line"><span class="cl"><span class="go">^
</span></span></span><span class="line"><span class="cl"><span class="go">|               |
</span></span></span><span class="line"><span class="cl"><span class="go">|               |
</span></span></span><span class="line"><span class="cl"><span class="go">|               |
</span></span></span><span class="line"><span class="cl"><span class="go">|              |
</span></span></span><span class="line"><span class="cl"><span class="go">|            _|
</span></span></span><span class="line"><span class="cl"><span class="go">|         __-
</span></span></span><span class="line"><span class="cl"><span class="go">|____-----
</span></span></span><span class="line"><span class="cl"><span class="go">+-----------X-------&gt; load
</span></span></span></code></pre></div><p>Warum diese Kurve so aussieht, wie sie aussieht, kann man leicht mit einem kleinen PHP-Script testen.
Das gezeigte PHP-Script simuliert eine Telefonzelle, an der mit 20 %-iger Wahrscheinlichkeit pro Minute Leute auftauchen, die Gespräche führen wollen, die zwischen einer und fünf Minuten lang sind.
Lässt man das Script mehrfach mit einem CLI-PHP laufen, und dreht dabei $prob langsam von 20 % auf 22 %, 25 % und dann 30 % hoch, sieht man sehr schön, wie sich die Warteschlangen im System immer weiter aufbauen.</p>
<p>Warum ist das so? Telefonzellen (und auch Datenbanken) können nicht vorarbeiten.
Idlezeit verstreicht ungenutzt - nur Zeit, in der die Warteschlange nicht leer ist, ist sinnvoll genutzte Zeit.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="c1">#! /usr/bin/php5 -q
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">&lt;?</span><span class="nx">php</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$prob</span>   <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="c1">## Wahrscheinlichkeit für neuen Kunden in Prozent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nv">$maxlen</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>  <span class="c1">## Gesprächsdauer in Minuten (1-$maxlen)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nv">$link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">connect</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="nv">$link</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$link</span> <span class="o">=</span> <span class="nx">mysql_connect</span><span class="p">(</span><span class="s2">&#34;localhost&#34;</span><span class="p">,</span> <span class="s2">&#34;root&#34;</span><span class="p">,</span> <span class="s2">&#34;1wjsnh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$link</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Argh&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">mysql_select_db</span><span class="p">(</span><span class="s2">&#34;rootforum&#34;</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s2">&#34;cannot select db&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">doquery</span><span class="p">(</span><span class="s2">&#34;DROP TABLE IF EXISTS telefon&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">doquery</span><span class="p">(</span><span class="s2">&#34;CREATE TABLE telefon ( id serial, dauer int )&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">doquery</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mysql_query</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">)</span> <span class="k">or</span> <span class="k">die</span><span class="p">(</span><span class="s2">&#34;cannot do query </span><span class="si">$cmd</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">getvalues</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$res</span> <span class="o">=</span> <span class="nx">mysql_query</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$res</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">die</span><span class="p">(</span><span class="s2">&#34;Cannot query </span><span class="si">$cmd</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$r</span> <span class="o">=</span> <span class="nx">mysql_fetch_assoc</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">function</span> <span class="nf">getvalue</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$r</span> <span class="o">=</span> <span class="nx">getvalues</span><span class="p">(</span><span class="nv">$cmd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nv">$r</span><span class="p">[</span><span class="nv">$name</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">connect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$minute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$call_remaining</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nv">$id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="nv">$minute</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$minute</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;Processing minute </span><span class="si">$minute</span><span class="s2">: &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Wie lang ist die Schlange?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nv">$r</span> <span class="o">=</span> <span class="nx">getvalues</span><span class="p">(</span><span class="s2">&#34;select count(dauer) as len, sum(dauer) as wait from telefon&#34;</span><span class="p">,</span> <span class="s2">&#34;len&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$len</span> <span class="o">=</span> <span class="nv">$r</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$wait</span> <span class="o">=</span> <span class="nv">$r</span><span class="p">[</span><span class="s1">&#39;wait&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;(Schlange </span><span class="si">$len</span><span class="s2">, Wait </span><span class="si">$wait</span><span class="s2">) &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Neuer Kunde stellt sich an
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nv">$prob</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">$call_len</span> <span class="o">=</span> <span class="nx">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nv">$maxlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">echo</span> <span class="s2">&#34;(New customer </span><span class="si">$call_len</span><span class="s2"> min.) &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">doquery</span><span class="p">(</span><span class="s2">&#34;insert into telefon ( dauer ) values ( </span><span class="si">$call_len</span><span class="s2"> )&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Zelle leer:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nv">$call_remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># Wartet ein Kunde?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nv">$r</span> <span class="o">=</span> <span class="nx">getvalues</span><span class="p">(</span><span class="s2">&#34;select id, dauer from telefon order by id limit 1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nv">$r</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Kein Kunde da.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">echo</span> <span class="s2">&#34;(queue empty) &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Kunde da, abholen und processing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$call_remaining</span> <span class="o">=</span> <span class="nv">$r</span><span class="p">[</span><span class="s1">&#39;dauer&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$id</span> <span class="o">=</span> <span class="nv">$r</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">echo</span> <span class="s2">&#34;(customer </span><span class="si">$id</span><span class="s2">: </span><span class="si">$call_remaining</span><span class="s2">) &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Kunde aus der Schlange nehmen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">doquery</span><span class="p">(</span><span class="s2">&#34;delete from telefon where id = </span><span class="si">$id</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># Telefonieren...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nv">$call_remaining</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">echo</span> <span class="s2">&#34;(customer </span><span class="si">$id</span><span class="s2">: </span><span class="si">$call_remaining</span><span class="s2">) &#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">echo</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cp">?&gt;</span><span class="err">
</span></span></span></code></pre></div><h1 id="tabellen-locks-und-deadlocks">
    <a href="#tabellen-locks-und-deadlocks">
	Tabellen, Locks und Deadlocks
    </a>
</h1>
<p>In MyISAM braucht man Tabellen in der Regel nicht selber zu locken:
Jedes Kommando ist logisch atomar.
Es lockt die benötigten Tabellen mit dem passenden Lock, führt seine Operation durch und unlockt die Tabellen am Ende des Kommandos wieder.</p>
<p>Manchmal will man aber mehr als ein Kommando auf einer Tabelle durchführen und will dabei sicherstellen, daß sich der Inhalt der Tabelle nicht verändert, während man die Operation durchführt.
Der häufigste Fall ist das Auslesen und Verändern eines Zählers.
Um einen Zähler einfach nur hochzuzählen kann man ja einfach</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">update counter set val = val + 1 where id = &lt;wert&gt;
</span></span></span></code></pre></div><p>verwenden. Aber will man den Zähler auch auslesen, dann braucht man so etwas wie</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">LOCK TABLES counter WRITE
</span></span></span><span class="line"><span class="cl"><span class="go">SELECT val into @v from counter where id = &lt;wert&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">UPDATE counter SET val = @v+1 WHERE id = &lt;wert&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">UNLOCK TABLES
</span></span></span><span class="line"><span class="cl"><span class="go">SELECT @v
</span></span></span></code></pre></div><p>Nur so ist sichergestellt, daß das Hochzählen auch atomar und ohne Unterbrechung durch andere Zähloperationen erfolgt.</p>
<p>Wann immer man mehrere Tabellen mit einem Lock belegt, können Deadlocks entstehen.
Man stelle sich vor, zwei Threads würden gleichzeitig die Statements <code>LOCK TABLES a, b WRITE</code> und <code>LOCK TABLES b, a WRITE</code> ausführen.
Thread 1 würde die Tabelle <code>a</code> locken, während Thread 2 jetzt die Tabelle <code>b</code> lockt.
1 will nun <code>b</code> locken, aber das geht nicht, weil 2 dieses Lock schon hält.
Zugleich will 2 jetzt <code>a</code> locken, aber das geht auch nicht - beide Threads würden ewig darauf warten, daß der jeweils andere die Locks aufgibt.</p>
<p>Ein gängiger Weg zur Vermeidung von Deadlocks ist, Ressourcen grundsätzlich nur einmal und nur atomar zu vergeben - MySQL hat mit LOCK TABLES diesen Weg gewählt.
Ein Thread kann also nur <code>LOCK TABLES a,b WRITE</code> ausführen, nicht etwa <code>LOCK TABLES a WRITE</code> und später <code>LOCK TABLES b WRITE</code> dazunehmen, um zusätzlich zu <code>a</code> noch <code>b</code> dazuzunehmen.
Außerdem kann <code>LOCK TABLES</code> nicht unterbrochen werden - <code>LOCK TABLES a,b WRITE</code> sammelt also alle Locks für <code>a</code> und <code>b</code> gleichzeitig ein.</p>
<p>Eine andere Methode Deadlocks zu vermeiden besteht darin, die Ressourcen, die zu vergeben sind, anzuordnen und alle Threads zu zwingen, Ressourcen in Reihenfolge zu bestellen.
<code>LOCK TABLES a, b WRITE</code> und <code>LOCK TABLES b, a WRITE</code> würden so intern beide zu demselben Kommando <code>LOCK TABLES a,b WRITE</code> werden, und dann kann es schon gar nicht mehr zum Deadlock kommen (denn der zweite Thread würde a gelockt vorfinden, bevor er überhaupt seine Finger auf b legen kann).
So hat MySQL die oben dargestellte Atomizität intern implementiert.</p>
<p>Ein LOCK auf Tabellen kann mit <code>UNLOCK TABLES</code> aufgehoben werden.</p>
<p>Ein LOCK auf Tabellen sollte immer nur so kurz wie irgend möglich gehalten werden.
Wer mit den Werten für die Telefonatsdauer und die Neukundenwahrscheinlichkeit im Telefonzellensimulations-PHP ein wenig gespielt hat, der hat möglicherweise jetzt eine Vorstellung davon, warum das so ist.</p>
<h1 id="locks-haben-prioritäten">
    <a href="#locks-haben-priorit%c3%a4ten">
	Locks haben Prioritäten
    </a>
</h1>
<p>In MySQL hat ein WRITE-Lock eine höhere Priorität als ein READ-Lock und entsprechend ein INSERT/UPDATE/DELETE eine höhere Priorität als ein SELECT.
Wenn also auf eine Tabelle viele schreibende Statements durchgeführt werden, dann werden die SELECT-Statements entsprechend zurückgedrängt.
Daher ist es sehr wichtig, daß schreibende Statements schnell durchgeführt werden, damit sie ihre Locks nur für möglichst kurze Zeit halten.
Ein schreibendes Statement kann dann schnell durchgeführt werden, wenn es eine möglichst einfache WHERE-Clause hat, die einen Index verwenden kann (z.B. ein UPDATE gegen eine Zeile, die über ihren PRIMARY KEY bestimmt wird).</p>
<p>Oft kann es sinnvoll sein, schreibende Statements zu batchen.
Dazu kann man zum Beispiel die extended INSERT-Syntax verwenden (<code>insert into &lt;name&gt; ( col1, col2, ...) values (val1, val2, ...), (val1, val2, ...)</code>), mit der man mehr als eine Zeile auf einmal in die Datenbank einfügen kann.
Diese Syntax steht für UPDATE nicht zur Verfügung, kann aber zum Beispiel mit &ldquo;REPLACE INTO&rdquo; verwendet werden.
Ein einzelnes Statement kann <code>max_allowed_packet</code> Bytes lang sein, und wenn extended INSERT-Syntax verwendet wird, verwendet MySQL intern einen Puffer von <code>bulk_insert_buffer_size</code>, um diese Operation zu beschleunigen.
Dieser Puffer sollte zur Insert-Größe passend gewählt werden.</p>
<p>Bei extended INSERT-Syntax werden Updates der Indices einer Tabelle gepuffert und der Baum nicht nach jedem Insert rebalanciert, sondern nur einmal am Ende aller Inserts dieses Blocks.
Hat man mehr als ein solches INSERT-Statement, kann man diese außerdem noch in ein <code>LOCK TABLES</code> wickeln, damit es noch schneller geht:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">LOCK TABLES t WRITE;
</span></span></span><span class="line"><span class="cl"><span class="go">INSERT INTO t (a,b) VALUES (1, 2), (3, 4);
</span></span></span><span class="line"><span class="cl"><span class="go">INSERT INTO t (a,b) VALUES (5,6);
</span></span></span><span class="line"><span class="cl"><span class="go">UNLOCK TABLES;
</span></span></span></code></pre></div><p>Hier wird der Key Buffer nur einmal, beim <code>UNLOCK TABLES</code>, aktualisiert und auf die Platte geschrieben.</p>
<p>Wer sehr mutig ist, und ein MySQL 5.x hat, startet seinen MySQL-Server mit der Konfigurationsvariable <code>delayed_key_writes = ON</code> oder gar <code>delayed_key_writes = ALL</code> in der <code>[mysqld]</code>-Sektion der <code>my.cnf</code>.
Steht diese Variable auf 1, kann man eine Tabelle beim <code>CREATE TABLE</code> mit der Option <code>DELAYED_KEY_WRITE</code> spezifizieren.
Der Key-Buffer für solche Tabellen wird dann nicht mehr so oft auf die Platte geschrieben (bei <code>delayed_key_writes = 2</code> wird dies für alle Tabellen unabhängig von den CREATE-Optionen gemacht).
Dies kann dazu führen, daß bei einem Servercrash die Indices (aber nicht die Daten) beschädigt sind und neu erzeugt werden müssen - das macht hässlich lange Recovery-Zeiten.
Dafür werden Index-Updates immer so schnell ausgeführt, als wären sie gebatched und in <code>LOCK TABLES</code> eingewickelt.</p>
<p>Manchmal will man ein einzelnes <code>SELECT</code> haben, das nicht von <code>INSERT</code>-Statements verdrängt werden kann.
Das kann man mit <code>SELECT HIGH_PRIORITY ...</code> erreichen:
Es macht das Select nicht schneller, sorgt aber dafür, daß es nicht von immer wieder eintreffenden <code>INSERT</code>-Statements nach hinten gedrückt werden kann.</p>
<p>Anders herum hat man manchmal ein <code>INSERT</code>, das keine <code>SELECT</code>-Statements zur Seite drücken soll. Das kann man mit <code>INSERT LOW_PRIORITY</code> erreichen:
Es macht das Insert nicht langsamer, sorgt aber dafür, daß das <code>INSERT</code> keine <code>SELECT</code>-Statements zur Seite drückt.</p>
<h1 id="insert-delayed">
    <a href="#insert-delayed">
	INSERT DELAYED
    </a>
</h1>
<p>Etwas ganz anderes ist <code>INSERT DELAYED</code>: <code>INSERT DELAYED</code> kommt in jedem Fall sofort zurück.
Die Daten, die dem Insert übergeben werden, sind dabei noch lange nicht geschrieben und tatsächlich kann es sein, daß sie niemals geschrieben werden, denn MySQL schiebt die Daten nur in einen internen Puffer, der irgendwann einmal abgearbeitet wird und in die Tabelle geschoben wird.</p>
<p>Dabei gelten eine ganze Reihe von Einschränkungen, die in <a href="http://dev.mysql.com/doc/refman/5.0/en/insert-delayed.html" target="_blank" rel="noopener">http://dev.mysql.com/doc/refman/5.0/en/insert-delayed.html</a>

 im Detail beschrieben sind.
Wie auch immer: <code>INSERT DELAYED</code> drückt Daten in einen Insert-Puffer und kommt dann immer sofort mit Erfolg zurück, während der Puffer irgendwann mal von einem Delayed-Insert-Thread gelesen wird und von diesem mit niederer Priorität in die Tabellen geschoben wird.
Genau genommen kann <code>SHOW STATUS</code> einem zeigen, daß es <code>delayed_insert_threads</code> viele solcher Threads gibt, die derzeit <code>not_flushed_delayed_rows</code> an Datenzeilen ausstehen haben (von insgesamt <code>delayed_writes</code> vielen Zeilen, die bisher geschrieben worden sind).</p>
<p>In den Konfigurationsvariablen lässt sich einstellen, wie <code>INSERT DELAYED</code> arbeitet:
Alle <code>delayed_insert_limit</code> Zeilen lässt ein Delay-Insert-Thread eventuell anstehenden Select-Statements den Vortritt.
Ebenso gibt ein solcher Thread sein Lock auf, wenn sein Puffer leer ist und beendet sich <code>delayed_insert_timeout</code> Sekunden später, wenn er keine neue Arbeit bekommt.
Kommen andererseits sehr viele <code>INSERT DELAYED</code>-Zeilen in die Warteschlange, so setzt <code>delayed_queue_size</code> der Anzahl der Zeilen im Puffer eine obere Grenze, damit der Speicher nicht überläuft.</p>
<h1 id="reminder-data_free--0-und-concurrent_inserts">
    <a href="#reminder-data_free--0-und-concurrent_inserts">
	Reminder: Data_free = 0 und Concurrent_inserts
    </a>
</h1>
<p>Wir erinnern uns an die Diskussion von <code>SHOW TABLE STATUS</code> und das Feld <code>Data_free</code> dort.
Wenn <code>Data_free = 0</code> ist, und für den Server <code>Concurrent_inserts</code> eingeschaltet sind, dann können auf der Tabelle Inserts und Selects gleichzeitig durchgeführt werden.
Insert-Locks können dann nicht entstehen und so können auch keine Selects an die Wand gedrückt werden.</p>
<p>MERGE-Tables oder MySQL 5.1 Partitions können sehr, sehr hilfreich sein, wenn man Tabellen so gestalten will, daß Data_free immer 0 ist und man sich <code>OPTIMIZE TABLE</code> nicht leisten kann.</p>
<h1 id="wie-steht-es-mit-meinem-locking">
    <a href="#wie-steht-es-mit-meinem-locking">
	Wie steht es mit meinem Locking?
    </a>
</h1>
<p>Mithilfe von <code>SHOW STATUS</code> sieht man seine <code>Table_locks_immediate</code> und <code>Table_locks_waiting</code>.
Wenn mehr als 1 % (manche Leute sagen 3 %) der Table Locks waiting sind, dann hat der Server ein definitives Locking-Problem.
Wie ernst das ist, kann man besser beurteilen, wenn man Questions/Uptime (Queries pro Sekunde, qps) berechnet und wenn man <code>(qcache_hits+com_select)/(com_delete+com_insert+com_replace+com_update)</code> (QL/DML-Ratio, &ldquo;update-heavyness&rdquo;) des Servers kennt.</p>
<p>Wenn mehr als eine Query pro Sekunde wartend ist (1 % Table_locks_waiting bei 100 qps oder mehr), dann lohnt es sich, sich mit locklösenden Maßnahmen zu befassen. Locklösende Maßnahmen sind:</p>
<ul>
<li>DML schneller machen</li>
<li>weniger DML pro Sekunde erzeugen</li>
<li>keine Table Locks mehr verwenden → InnoDB einsetzen</li>
</ul>
<p>(geschrieben für
<a href="http://www.rootforum.de/forum/viewforum.php?f=23" target="_blank" rel="noopener">Rootforum</a>


und hier herüber geschafft zur Archivierung)</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#lang_de" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_de
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2006-03-06-mysql-fuer-dummies-5.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2006/03/05/mysql-fuer-dummies-4.html">MySQL für Dummies (4)</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2006/03/07/mysql-fuer-dummies-6.html">MySQL für Dummies (6)</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
