<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Not JOINing on PERFORMANCE_SCHEMA | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">
<link rel="canonical" href="https://blog.koehntopp.info/2020/12/01/not-joining-on-performance-schema.html">


<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">




<meta name="generator" content="Hugo 0.111.3">
<meta property="og:title" content='Not JOINing on PERFORMANCE_SCHEMA' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />


<meta property="og:locale" content="en_US" />


<meta name="description" content='' />
<meta property="og:description" content='' />

<meta property="og:url" content="https://blog.koehntopp.info" />


<meta property="og:type" content="article" />
<meta name="article:published_time" content='2020-12-01T09:33:10Z' />



<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content='@isotopp' />
<meta name="twitter:creator" content='@isotopp' />
<meta property="twitter:title" content='Not JOINing on PERFORMANCE_SCHEMA' />
<meta property="twitter:description" content='' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />

<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","description":null,"headline":"Not JOINing on PERFORMANCE_SCHEMA","image":"/assets/img/background/mysql.jpg","name":"Die wunderbare Welt von Isotopp","url":"https://blog.koehntopp.info"}
</script>

    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.6b600fb66ca1591ba6dcc9b3bdfc59ebd5c0fdc49622889f839fc36f71dde892.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            




<div class="page">
  <article class="not-joining-on-performance_schema-page">
    <div class='row  justify-content-center text-center my-4 mx-0'>
      <header>
        <div class='col'>
          <h1 class="title mb-lg-4 text-white">
            Not JOINing on PERFORMANCE_SCHEMA
          </h1>
          <div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
            <img alt='isotopp image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0' style='width: 1.9rem; border-radius: 1rem;'>
            <a href="https://chaos.social/@isotopp" class='text-light text-decoration-none'>
                Kristian Köhntopp
            </a>

            
              <span class='d-none d-lg-inline'>-</span>
              <div class='d-block d-lg-inline'>December 1, 2020</div>
            

          </div>
        </div>
        
          <img alt='a featured image' src="/assets/img/background/mysql.jpg">
        
      </header>
    </div>

    <div class='row justify-content-center mx-0 mt-5 mb-5'>
      <div class='col-lg-8'>
        <p>The tables in <code>PERFORMANCE_SCHEMA</code> (<code>P_S</code>) are not actually tables. You should not think of them as tables, even if your SQL works on them. You should not JOIN them, and you should not GROUP or ORDER BY them.</p>
<h2 id="unlocked-memory-buffers-without-indexes">
    <a href="#unlocked-memory-buffers-without-indexes">
	Unlocked memory buffers without indexes
    </a>
</h2>
<p>The stuff in <code>P_S</code> has been created with &ldquo;keep the impact on production small&rdquo; in mind. That is, from a users point of view, you can think of them as unlocked memory buffers - the values in there change as you look at them, and there are precisely zero stability guarantees.</p>
<p>There are also no indexes (<em>EDIT:</em> There actually are secondary indexes on <code>P_S</code> tables in MySQL 8, see below).</p>
<h3 id="unstable-comparisons">
    <a href="#unstable-comparisons">
	Unstable comparisons
    </a>
</h3>
<p>When sorting a table for a GROUP BY or ORDER BY, it may be necessary to compare the value of one row to other rows multiple times in order to determine where the row goes. The value compared to other rows can change while this happens, and will change more often the more load the server has. The end result is unstable. Also, as the table you sort may be larger on a server under load, the row may need more comparisons, making this even more likely to happen.</p>
<p>The table you look at may produce correct results on your stable, underutilized test systems, but the monitoring you base on this will fail on a loaded test system.</p>
<p>Do not use GROUP BY or ORDER BY on <code>P_S</code> tables.</p>
<h3 id="no-indexes-meaning-slow-joins-on-loaded-systems">
    <a href="#no-indexes-meaning-slow-joins-on-loaded-systems">
	No indexes, meaning slow joins on loaded systems
    </a>
</h3>
<p>When JOINing a <code>P_S</code> table against other tables, the join is done without indexes (in MySQL up to and including 5.7). There are no indexes defined in <code>P_S</code> before MySQL 8.</p>
<p>In practice that means your join against the processlist or session variables tables in <code>P_S</code> do little harm in test, but will fail in production environments with many connections. You will be losing monitoring the moment you need it most - under load, in critital situations.</p>
<p>Do not JOIN <code>P_S</code> tables to anything.</p>
<h2 id="how-to-monitor">
    <a href="#how-to-monitor">
	How to monitor
    </a>
</h2>
<p>About the only type of query you can reliably run on <code>P_S</code> is a single table <code>SELECT * FROM P_S.table</code>, maybe with a simple <code>WHERE</code> clause. That is, you can download and materialize data from a single <code>P_S</code> table at a time, unsorted, unaggregated.</p>
<p>Connection to other tables, aggregation and sorting should be done on tables that are not <code>P_S</code> tables.</p>
<p>There are multiple ways to do this.</p>
<h3 id="subqueries-without-optimization">
    <a href="#subqueries-without-optimization">
	Subqueries, without optimization
    </a>
</h3>
<p>It used to be that the MySQL optimizer did not resolve simple subqueries properly. So</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">&lt;</span><span class="n">complicated</span><span class="w"> </span><span class="n">stuff</span><span class="o">&gt;</span><span class="w"> </span><span class="k">from</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w">   </span><span class="p">(</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">performance_schema</span><span class="p">.</span><span class="n">sometable</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">&lt;</span><span class="n">something</span><span class="o">&gt;</span><span class="w">
</span></span></span></code></pre></div><p>used to work. The subquery <code>t</code> would materialize the <code>P_S</code> table as whatever your version of MYSQL used for implicit temporary tables, and the rest of the query resolution would happen on the materialized temptable. This is a snapshot, and would be stable.</p>
<p>And it still would not add up to 100%, of course. That is, queries like Dennis Kaarsemakers &ldquo;How loaded is the SQL_THREAD&rdquo; Replication Load analysis never came out at 100%, because the various values changed while the temporary table would be materialized, so you do not get a consistent snapshot (and by construction, this kind of consistency is impossible in <code>P_S</code>).</p>
<p>Anyway, with older versions of MySQL, this results in the query plan we want. Starting with MySQL 5.7, this does no longer work, because the optimizer became too smart. :-)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">version</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">version</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">22</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">processlist</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">processlist</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">256</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Newer MySQL (5.7 and above) will apply the <code>derived_merge</code> optimization and fold the subquery into the outer query, resulting in a rewritten single query that again is executed on <code>P_S</code> directly. This is extremely useful, but in this one particular case precisely not what we want.</p>
<p>You either need to <code>SET SESSION optimizer_switch = &quot;derived_merge=off&quot;;</code> or provide an advanced <a href="https://dev.mysql.com/doc/refman/8.0/en/optimizer-hints.html#optimizer-hints-table-level" target="_blank" rel="noopener">MySQL 8 optimizer hint</a>

 to prevent the optimizer from ruining your cunning plan:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="cm">/*+ NO_MERGE(t) */</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">processlist</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">&lt;</span><span class="n">derived2</span><span class="o">&gt;</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">256</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">DERIVED</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">processlist</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">256</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
</span></span></span></code></pre></div><p>Here we get the <code>DERIVED</code> table as a non-<code>P_S</code> temptable, and then run our &ldquo;advanced&rdquo; SQL on that as <code>PRIMARY</code> on it.</p>
<h3 id="in-the-client">
    <a href="#in-the-client">
	In the client
    </a>
</h3>
<p>The alternative is, of course, to completely download the tables in question into client side hashes, and then perform the required operations on them on the client side, in memory. The important thing here is to limit the amount of memory spent - do not download unconstrained result sets into your client monitoring program.</p>
<p>Then use a linearly scaling join method to construct the connections between the tables. Effectively, load data into hashes, and then program a client side hash join. This is additive (n + m) instead of quadratic (n * m), so you can survive this.</p>
<p>This is the recommended method.</p>
<h2 id="who-is-doing-it-wrong">
    <a href="#who-is-doing-it-wrong">
	Who is doing it wrong?
    </a>
</h2>
<p>Getting monitoring queries that use <code>P_S</code> wrongly is common - it understands SQL, it handles <code>SHOW CREATE TABLE</code>, so it is treated as a table and exposed to full SQL all the time. And on idle test boxen, it even looks like it works.</p>
<p>At work, see this in our own code (still using a deprecated Diamond collector) and in SolarWinds nee Vividcortex.</p>
<p>SolarWinds kindly highlights itself:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- Most time consuming query - Coming from solar winds monitoring itself ¯\_(ツ)_/¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ifnull</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">s</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">sql_text</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">ifnull</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">processlist_user</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">ifnull</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">processlist_host</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">performance_schema</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">events_statements_history</span><span class="o">`</span><span class="w"> </span><span class="o">`</span><span class="n">s</span><span class="o">`</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">left</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">performance_schema</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">threads</span><span class="o">`</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">thread_id</span><span class="o">`</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="o">`</span><span class="n">s</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">thread_id</span><span class="o">`=?</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="o">`</span><span class="n">s</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">event_id</span><span class="o">`=?</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Coming from the &#34;table ownership write identifier&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">cnt</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">digest_text</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">current_schema</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">processlist_user</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">system_user</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">performance_schema</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">events_statements_history</span><span class="o">`</span><span class="w"> </span><span class="o">`</span><span class="n">esh</span><span class="o">`</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">performance_schema</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">threads</span><span class="o">`</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">thread_id</span><span class="o">`=`</span><span class="n">esh</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">thread_id</span><span class="o">`</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="o">`</span><span class="n">event_name</span><span class="o">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(...)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">and</span><span class="w"> </span><span class="o">`</span><span class="n">current_schema</span><span class="o">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(...)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">digest_text</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">current_schema</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">processlist_user</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- Coming from diamond collector
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">processlist_user</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">sbt</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">variable_value</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="k">count</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">performance_schema</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">status_by_thread</span><span class="o">`</span><span class="w"> </span><span class="o">`</span><span class="n">sbt</span><span class="o">`</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">performance_schema</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">threads</span><span class="o">`</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">thread_id</span><span class="o">`</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="o">`</span><span class="n">sbt</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">variable_name</span><span class="o">`=?</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">and</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">processlist_user</span><span class="o">`</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">t</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">processlist_user</span><span class="o">`</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">variable_value</span><span class="o">`</span><span class="w">
</span></span></span></code></pre></div><p>Many of the above examples fail in multiple ways: Using JOIN for bad scalability (this is how we spotted them), at least before MySQL 8 (and you probably want your monitoring to work anywhere). Some are also using unstable sorting.</p>
<p>We also see ORDER BY statements in the <a href="https://github.com/influxdata/telegraf/blob/master/plugins/inputs/mysql/mysql.go#L376" target="_blank" rel="noopener">Telegraf MySQL plugin</a>

 in one place. It uses LIMIT, but if the ORDER BY does not work (ie does not actually sort), you cut off randomly.</p>
<h2 id="is-performance_schema-broken">
    <a href="#is-performance_schema-broken">
	Is PERFORMANCE_SCHEMA broken?
    </a>
</h2>
<p>Clearly, it is not. Just badly misunderstood.</p>
<p>The alternative is <code>INFORMATION_SCHEMA</code>, which often locks, and that can be actually deadly:</p>
<p>Just <code>select * from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE</code> on a server with a few hundreds of GB of buffer pool, humming at 10k QPS. The query will freeze the server completely for the runtime of the query – which with a large buffer pool size can be substantial.</p>
<p>I&rsquo;d rather have this in <code>P_S</code> and then deal with the vagaries of the data changing while I read it than lose an important production server. So <code>P_S</code> is much better than <code>I_S</code>, provided that you ask it in the right way.</p>
<h2 id="addendum">
    <a href="#addendum">
	Addendum
    </a>
</h2>
<p>Both <a href="https://twitter.com/ogrovlen/status/1334047725298585600" target="_blank" rel="noopener">Øystein Grøvlen</a>

 and <a href="https://twitter.com/MarkLeith/status/1334075136450945024" target="_blank" rel="noopener">Mark Leith</a>

 remind me that in MySQL 8 <a href="https://dev.mysql.com/doc/refman/8.0/en/performance-schema-optimization.html" target="_blank" rel="noopener">we geht secondary indexes on <code>P_S</code></a>

 - this will address some of the problematic queries above and will need some research on my side.</p>
<p>The sorting is still complicated. <a href="https://twitter.com/ogrovlen/status/1334056375123632129" target="_blank" rel="noopener">Øystein writes</a>

:</p>
<blockquote>
<p>It depends on the sort algorithm used by MySQL.  Many sorts will add all requested columns to the sort buffer, and will not need to fetch anything from the tables after sorting, but it depends on the size of the sort buffer and how much data needs to be fetched.</p>
</blockquote>
<p>So there are some sorts that are stable, and some sorts that will always be unstable (those that work with bloblike columns such as <code>SQL_TEXT</code> or <code>DIGEST_TEXT</code> likely), but it is really hard to see this when looking at the query.</p>
<p>I still maintain my advice of forcing stable copies with subselects and <code>NO_MERGE()</code> hints - this is much easier to teach and guaranteed to be stable.</p>
<h2 id="another-addendum">
    <a href="#another-addendum">
	Another addendum
    </a>
</h2>
<p>In <a href="https://twitter.com/justin_swanhart/status/1334544467987197953" target="_blank" rel="noopener">a tweet</a>

 Justin Swanhart pointed me at <a href="https://github.com/greenlion/PS_HISTORY" target="_blank" rel="noopener">PS_HISTORY</a>

, which makes snapshots of <code>P_S</code> that try to be as consistent as possible.</p>
<p>It will allow you to replay and review old <code>P_S</code> states and query them, and it will - if you configure it - also automatically expire the old recordings. It may be useful as a kind of flight recorder to debug performance problems that cannot otherwise reproduced.</p>

      </div>
    </div>

    
    
    <div class='row justify-content-center mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
        <a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2020%2f12%2f01%2fnot-joining-on-performance-schema.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#facebook'/></svg>
        </a>

        <a href='http://www.reddit.com/submit?url=https%3a%2f%2fblog.koehntopp.info%2f2020%2f12%2f01%2fnot-joining-on-performance-schema.html&title=Not%20JOINing%20on%20PERFORMANCE_SCHEMA' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>
        <a href='mailto:?subject=Not%20JOINing%20on%20PERFORMANCE_SCHEMA&body=https%3a%2f%2fblog.koehntopp.info%2f2020%2f12%2f01%2fnot-joining-on-performance-schema.html' target='_blank' class='text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope-fill'/></svg>
        </a>
      </div>
    </div>

    
    
    <div class='row justify-content-center py-3 mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
        
          <a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            lang_en
          </a>
        
          <a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
            <svg class="bi" width="1rem" height="1rem" fill="currentColor"><use xlink:href="/bootstrap-icons.svg#tag-fill"></use></svg>
            mysql
          </a>
        
      </div>
    </div>

    
    
    
    
    <div class='row justify-content-center py-3 mb-3 mx-0'>
      <div class='col-lg-8 text-center'>
        <a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2020-12-01-not-joining-on-performance-schema.md" rel="noopener noreferrer" target="_blank">
            <span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
        </a>
      </div>
    </div>
    

    <div class='row justify-content-center mb-5 pt-5 border-top mx-0'>
      <div class='col-lg-4 text-center text-lg-start'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Next Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2020/12/09/embracing-the-stream.html">Embracing the Stream</a>
          </div>
        
      </div>

      <div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
        
          <div>
            <div class='letter-spacing-01 text-uppercase text-secondary'>
              Previous Post
            </div>
            <a class='text-decoration-none' href="https://blog.koehntopp.info/2020/11/27/backups-and-replication.html">MySQL: Backups and Replication</a>
          </div>
        
      </div>
    </div>

    
    </article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

	<a rel="me" href="https://chaos.social/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#mastodon'/></svg>
	</a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>



        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
