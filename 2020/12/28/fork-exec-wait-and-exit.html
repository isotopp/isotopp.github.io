<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>fork, exec, wait and exit | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2020/12/28/fork-exec-wait-and-exit.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='fork, exec, wait and exit | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2020/12/28/fork-exec-wait-and-exit.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2020-12-28T18:25:00Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='fork, exec, wait and exit' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="fork-exec-wait-and-exit-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						fork, exec, wait and exit
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>December 28, 2020</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/12/26/sql-clause-is-coming-to-town.html">SQL Clause is coming to town</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/01/05/using-python-to-bash.html">Using Python to bash</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>This is the <a href="/2007/01/07/fork-exec-wait-und-exit.html">english version of a 2007 article</a>

.</p>
<p>In <a href="news:de.comp.os.unix.linux.misc">de.comp.os.unix.linux.misc</a>

 somebody asked:</p>
<blockquote>
<ul>
<li>Are commands in a script executed strictly sequentially, that is,
will the next command only be executed when the previous command has
completed, or will the shell <strong>automatically</strong> start the next command
if the system has spare capacity?</li>
<li>Can I change the default behavior - whatever it may be - in any way?</li>
</ul></blockquote>
<p>If you are looking into the fine manual, it may explain at some point that the shell starts each command in a separate process. Then you may continue your thought process and ask what that actually means. As soon as you get to this stage, you may want to have a look at the Unix process lifecycle.</p>
<h2 id="processes-and-programs">
    <a href="#processes-and-programs">
	Processes and programs
    </a>
</h2>
<p>A program in Unix is a sequence of executable instructions on a disk. You can use the command <em>size</em> to get a very cursory check of the structure and memory demands of the program, or use the various invocations of <em>objdump</em> for a much more detailed view. The only aspect that is of interest to us is the fact that a program is a sequence of instructions and data (on disk) that may potentially be executed at some point in time, maybe even multiple times, maybe even concurrently.</p>
<p>Such a program in execution is called a process. The process contains the code and initial data of the program itself, and the actual state at the current point in time for the current execution. That is the memory map and the associated memory (check /proc/<em>pid</em>/maps), but also the program counter, the processor registers, the stack, and finally the current root directory, the current directory, environment variables and the open files, plus a few other things (in modern Linux for example, we find the processes cgroups and namespace relationships, and so on - things became a lot more complicated since 1979).</p>
<p>In Unix processes and programs are two different and independent things. You can run a program more than once, concurrently. For example, you can run two instances of the <em>vi</em> editor, which edit two different texts. Program and initial data are the same: it is the same editor. But the state inside the processes is different: the text, the insert mode, cursor position and so on differ. From a programmers point of view, &ldquo;the code is the same, but the variable values are differing&rdquo;.</p>
<p>A process can run more than one program: The currently running program is throwing itself away, but asks that the operating system loads a different program into the same process. The new program will inherit some reused process state, such as current directories, file handles, privileges and so on.</p>
<p>All of that is done in original Unix, at the system level, with only four syscalls:</p>
<ul>
<li><code>fork()</code></li>
<li><code>exec()</code></li>
<li><code>wait()</code></li>
<li><code>exit()</code></li>
</ul>
<h2 id="usermode-and-kernel">
    <a href="#usermode-and-kernel">
	Usermode and Kernel
    </a>
</h2>
<p><p class="md__image">
  <img src="/uploads/prozesswechsel.png" alt=""  />
</p>

</p>
<p><em>Context switching: Process 1 is running for a bit, but at (1) the kernel interrupts the execution and switches to process 2. Some time later, process 2 is frozen, and we context switch back to where we left off with (1), and so on. For each process, this seems to be seamless, but it happens in intervals that are not continous.</em></p>
<p>Whenever a Unix process does a system call (and at some other opportunities) the current process leaves the user context and the operating system code is being activated. This is privileged kernel code, and the activation is not quite a subroutine call, because not only is privileged mode activated, but also a kernel stack is being used and the CPU registers of the user process are saved.</p>
<p>From the point of view of the kernel function, the user process that has called us is inert data and can be manipulated at will.</p>
<p>The kernel will then execute the system call on behalf of the user program, and then will try to exit the kernel. The typical way to leave the kernel is through the scheduler.</p>
<p>The scheduler will review the process list and current situation. It will then decide into which of all the different userland processes to exit. It will restore the chosen processes registers, then return into this processes context, using this processes stack. The chosen process may or may not be the one that made the system call.</p>
<p>In short: Whenever you make a system call, you may (or may not) lose the CPU to another process.</p>
<p>That&rsquo;s not too bad, because this other process at some point has to give up the CPU and the kernel will then return into our process as if nothing happened.</p>
<p>Our program is not being executed linearly, but in a sequence of subjectively linear segments, with breaks inbetween. During these breaks the CPU is working on segments of other processes that are also runnable.</p>
<h2 id="fork-and-exit">
    <a href="#fork-and-exit">
	fork() and exit()
    </a>
</h2>
<p>In traditional Unix the only way to create a process is using the <code>fork()</code> system call. The new process gets a copy of the current program, but new process id (pid). The process id of the parent process (the process that called <code>fork()</code>) is registered as the new processes parent pid (ppid) to build a process tree.</p>
<p>In the parent process, <code>fork()</code> returns and delivers the new processes pid as a result.</p>
<p>The new process also returns from the <code>fork()</code> system call (because that is when the copy was made), but the result of the <code>fork()</code> is 0.</p>
<p>So <code>fork()</code> is a special system call. You call it once, but the function returns twice: Once in the parent, and once in the child process. <code>fork()</code> increases the number of processes in the system by one.</p>
<p>Every Unix process always starts their existence by returning from a <code>fork()</code> system call with a 0 result, running the same program as the parent process. They can have different fates because the result of the <code>fork()</code> system call is different in the parent and child incarnation, and that can drive execution down different <code>if()</code> branches.</p>
<p>In Code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the child.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the parent, the child is %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;In fork():&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Running this, we get:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@linux:/tmp/kris&gt; make probe1
</span></span></span><span class="line"><span class="cl"><span class="go">cc     probe1.c   -o probe1
</span></span></span><span class="line"><span class="cl"><span class="go">kris@linux:/tmp/kris&gt; ./probe1
</span></span></span><span class="line"><span class="cl"><span class="go">I am the child.
</span></span></span><span class="line"><span class="cl"><span class="go">I am the parent, the child is 16959.
</span></span></span></code></pre></div><p>We are defining a variable <code>pid</code> of the type <code>pid_t</code>.</p>
<p>This variable saves the <code>fork()</code> result, and using it we activate one (&ldquo;I am the child.&rdquo;) or the other (&ldquo;I am the parent&rdquo;) branch of an if().</p>
<p>Running the program we get two result lines. Since we have only one variable, and this variable can have only one state, an instance of the program can only be in either one or the other branch of the code. Since we see two lines of output, two instances of the program with different values for <code>pid</code> must have been running.</p>
<p>If we called <code>getpid()</code> and printed the result we could prove this by showing two different pids (change the program to do this as an exercise!).</p>
<p>The <code>fork()</code> system call is entered once, but left twice, and increments the number of processes in the system by one. After finishing our program the number of processes in the system is as large as before. That means there must be another system call which decrements the number of system calls.</p>
<p>This system call is <code>exit()</code>.</p>
<p><code>exit()</code> is a system call you enter once and never leave. It decrements the number of processes in the system by one.</p>
<p><code>exit()</code> also accepts an exit status as a parameter, which the parent process can receive (or even has to receive), and which communicates the fate of the child to the parent.</p>
<p>In our example, all variants of the program call <code>exit()</code> - we are calling <code>exit()</code> in the child process, but also in the parent process. That means we terminate two processes. We can only do this, because even the parent process is a child, and in fact, a child of our shell.</p>
<p>The shell does exactly the same thing we are doing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">bash (16957) --- calls fork() ---&gt; bash (16958) --- becomes ---&gt; probe1 (16958)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">probe1 (16958) --- calls fork() ---&gt; probe1 (16959) --&gt; exit()
</span></span></span><span class="line"><span class="cl"><span class="go">   |
</span></span></span><span class="line"><span class="cl"><span class="go">   +---&gt; exit()
</span></span></span></code></pre></div><p><code>exit()</code> closes all files and sockets, frees all memory and then terminates the process. The parameter of <code>exit()</code> is the only thing that survives and is handed over to the parent process.</p>
<h2 id="wait">
    <a href="#wait">
	wait()
    </a>
</h2>
<p>Our child process ends with an <code>exit(0)</code>. The 0 is the exit status of our program and can be shipped. We need to make the parent process pick up this value and we need a new system call for this.</p>
<p>This system call is <code>wait()</code>.</p>
<p>In Code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span>   <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the child.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the child, 10 seconds later.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the parent, the child is %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="nf">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;End of process %d: &#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The process ended with exit(%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The process ended with kill -%d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;In fork():&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And the runtime protocol:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@linux:/tmp/kris&gt; make probe2
</span></span></span><span class="line"><span class="cl"><span class="go">cc     probe2.c   -o probe2
</span></span></span><span class="line"><span class="cl"><span class="go">kris@linux:/tmp/kris&gt; ./probe2
</span></span></span><span class="line"><span class="cl"><span class="go">I am the child.
</span></span></span><span class="line"><span class="cl"><span class="go">I am the parent, the child is 17399.
</span></span></span><span class="line"><span class="cl"><span class="go">I am the child, 10 seconds later.
</span></span></span><span class="line"><span class="cl"><span class="go">End of process 17399: The process ended with exit(0).
</span></span></span></code></pre></div><p>The variable <code>status</code> is passed to the system call <code>wait()</code> as a reference parameter, and will be overwritten by it. The value is a bitfield, containing the exit status and additional reasons explaining how the program ended. To decode this, C offers a number of macros with predicates such as <code>WIFEXITED()</code> or <code>WIFSIGNALED()</code>. We also get extractors, such as <code>WEXITSTATUS()</code> and <code>WTERMSIG()</code>. <code>wait()</code> also returns the pid of the process that terminated, as a function result.</p>
<p><code>wait()</code> stops execution of the parent process until either a signal arrives or a child process terminates. You can arrange for a SIGALARM to be sent to you in order to time bound the <code>wait()</code>.</p>
<h2 id="the-init-program-and-zombies">
    <a href="#the-init-program-and-zombies">
	The <code>init</code> program, and Zombies
    </a>
</h2>
<p>The program <code>init</code> with the pid 1 will do basically nothing but calling <code>wait()</code>: It waits for terminating processes and polls their exit status, only to throw it away. It also reads <code>/etc/inittab</code> and starts the programs configured there. When something from <code>inittab</code> terminates and is set to <code>respawn</code>, it will be restarted by <code>init</code>.</p>
<p>When a child process terminates while the parent process is not (yet) waiting for the exit status, <code>exit()</code> will still free all memory, file handles and so on, but the <code>struct task</code> (basically the <code>ps</code> entry) cannot be thrown away. It may be that the parent process at some point in time arrives at a <code>wait()</code> and then we have to have the exit status, which is stored in a field in the <code>struct task</code>, so we need to retain it.</p>
<p>And while the child process is dead already, the process list entry cannot die because the exit status has not yet been polled by the parent. Unix calls such processes without memory or other resouces associated <em>Zombies</em>. Zombies are visible in the process list when a process generator (a forking process) is faulty and does not <code>wait()</code> properly. They do not take up memory or any other resouces but the bytes that make up their <code>struct task</code>.</p>
<p>The other case can happen, too: The parent process exits while the child moves on. The kernel will set the ppid of such children with dead parents to the constant value 1, or in other words: <code>init</code> inherits orphaned processes.</p>
<p>When the child terminates, <code>init</code> will <code>wait()</code> for the exit status of the child, because that&rsquo;s what <code>init</code> does. No Zombies in this case.</p>
<p>When we observe the number of processes in the system to be largely constant over time, then the number of calls to <code>fork()</code>, <code>exit()</code> and <code>wait()</code> have to balanced. This is, because for each <code>fork()</code> there will be an <code>exit()</code> to match and for each <code>exit()</code> there must be a <code>wait()</code> somewhere.</p>
<p>In reality, and in modern systems, the situation is a bit more complicated, but the original idea is as simple as this. We have a clean fork-exit-wait triangle that describes all processes.</p>
<h2 id="exec">
    <a href="#exec">
	exec()
    </a>
</h2>
<p>So while <code>fork()</code> makes processes, <code>exec()</code> loads programs into processes that already exist.</p>
<p>In Code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span>   <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">pid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the child.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">execl</span><span class="p">(</span><span class="s">&#34;/bin/ls&#34;</span><span class="p">,</span> <span class="s">&#34;ls&#34;</span><span class="p">,</span> <span class="s">&#34;-l&#34;</span><span class="p">,</span> <span class="s">&#34;/tmp/kris&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;In exec(): &#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;I am the parent, and the child is %d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">pid</span> <span class="o">=</span> <span class="nf">wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;End of process %d: &#34;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">WIFEXITED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The process ended with exit(%d).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">WEXITSTATUS</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">WIFSIGNALED</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;The process ended with kill -%d.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">WTERMSIG</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;In fork():&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The runtime protocol:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@linux:/tmp/kris&gt; make probe3
</span></span></span><span class="line"><span class="cl"><span class="go">cc     probe3.c   -o probe3
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">kris@linux:/tmp/kris&gt; ./probe3
</span></span></span><span class="line"><span class="cl"><span class="go">I am the child.
</span></span></span><span class="line"><span class="cl"><span class="go">I am the parent, the child is 17690.
</span></span></span><span class="line"><span class="cl"><span class="go">total 36
</span></span></span><span class="line"><span class="cl"><span class="go">-rwxr-xr-x 1 kris users 6984 2007-01-05 13:29 probe1
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 kris users  303 2007-01-05 13:36 probe1.c
</span></span></span><span class="line"><span class="cl"><span class="go">-rwxr-xr-x 1 kris users 7489 2007-01-05 13:37 probe2
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 kris users  719 2007-01-05 13:40 probe2.c
</span></span></span><span class="line"><span class="cl"><span class="go">-rwxr-xr-x 1 kris users 7513 2007-01-05 13:42 probe3
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 kris users  728 2007-01-05 13:42 probe3.c
</span></span></span><span class="line"><span class="cl"><span class="go">End of process 17690: The process ended with exit(0).
</span></span></span></code></pre></div><p>Here the code of <code>probe3</code> is thrown away in the child process (the <code>perror(&quot;In exec():&quot;)</code> is not reached). Instead the running program is being replaced by the given call to <code>ls</code>.</p>
<p>From the protocol we can see the parent instance of <code>probe3</code> waits for the <code>exit()</code>. Since the <code>perror()</code> after the <code>execl()</code>is never executed, it cannot be an <code>exit()</code> in our code. In fact, <code>ls</code> ends the process we made with an <code>exit()</code> and that is what we receive our exit status from in our parent processes <code>wait()</code> call.</p>
<h2 id="the-same-as-a-shellscript">
    <a href="#the-same-as-a-shellscript">
	The same, as a Shellscript
    </a>
</h2>
<p>The examples above have been written in C. We can do the same, in <code>bash</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@linux:/tmp/kris&gt; cat probe1.sh
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span>! /bin/bash --
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">echo &#34;Starting child:&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">sleep 10 &amp;
</span></span></span><span class="line"><span class="cl"><span class="go">echo &#34;The child is $!&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">echo &#34;The parent is $$&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">echo &#34;$(date): Parent waits.&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">wait
</span></span></span><span class="line"><span class="cl"><span class="go">echo &#34;The child $! has the exit status $?&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">echo &#34;$(date): Parent woke up.&#34;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">kris@linux:/tmp/kris&gt; ./probe1.sh
</span></span></span><span class="line"><span class="cl"><span class="go">Starting child:
</span></span></span><span class="line"><span class="cl"><span class="go">The child is 18071
</span></span></span><span class="line"><span class="cl"><span class="go">The parent is 18070
</span></span></span><span class="line"><span class="cl"><span class="go">Fri Jan  5 13:49:56 CET 2007: Parent waits.
</span></span></span><span class="line"><span class="cl"><span class="go">The child 18071 has the exit status 0
</span></span></span><span class="line"><span class="cl"><span class="go">Fri Jan  5 13:50:06 CET 2007: Parent woke up.
</span></span></span></code></pre></div><h2 id="the-actual-bash">
    <a href="#the-actual-bash">
	The actual bash
    </a>
</h2>
<p>We can also trace the shell while it executes a single command. The information from above should allow us to understand what goes on, and see how the shell actually works.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">kris@linux:~&gt; strace -f -e execve,clone,fork,waitpid bash
</span></span></span><span class="line"><span class="cl"><span class="go">kris@linux:~&gt; ls
</span></span></span><span class="line"><span class="cl"><span class="go">clone(Process 30048 attached
</span></span></span><span class="line"><span class="cl"><span class="go">child_stack=0, flags=CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD,
</span></span></span><span class="line"><span class="cl"><span class="go">child_tidptr=0xb7dab6f8) = 30048
</span></span></span><span class="line"><span class="cl"><span class="go">[pid 30025] waitpid(-1, Process 30025 suspended
</span></span></span><span class="line"><span class="cl"><span class="go"> &lt;unfinished ...&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">[pid 30048] execve(&#34;/bin/ls&#34;, [&#34;/bin/ls&#34;, &#34;-N&#34;, &#34;--color=tty&#34;, &#34;-T&#34;, &#34;0&#34;],
</span></span></span><span class="line"><span class="cl"><span class="go">[/* 107 vars */]) = 0
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">Process 30025 resumed
</span></span></span><span class="line"><span class="cl"><span class="go">Process 30048 detached
</span></span></span><span class="line"><span class="cl"><span class="go">&lt;... waitpid resumed&gt; [{WIFEXITED(s) &amp;&amp; WEXITSTATUS(s) == 0}], WSTOPPED
</span></span></span><span class="line"><span class="cl"><span class="go">WCONTINUED) = 30048
</span></span></span><span class="line"><span class="cl"><span class="go">--- SIGCHLD (Child exited) @ 0 (0) ---
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><p>Linux uses a generalization of the original Unix <code>fork()</code>, named <code>clone()</code>, to create child processes. That is why we do not see <code>fork()</code> in a Linux system to create a child process, but a <code>clone()</code> call with some parameters.</p>
<p>Linux also uses a specialized variant of <code>wait()</code>, called <code>waitpid()</code>, to wait for a specific pid.</p>
<p>Linux finally uses the <code>exec()</code> variant <code>execve()</code> to load programs, but that is just shuffling the paramters around. At the end of <code>ls</code> (PID 30048) the process 30025 will wake up from the <code>wait()</code> and continue.</p>
<h2 id="original-code-what-windows-does-and-what-microsoft-thinks-about-linux">
    <a href="#original-code-what-windows-does-and-what-microsoft-thinks-about-linux">
	Original Code, what Windows does, and what Microsoft thinks about Linux
    </a>
</h2>
<p>This text is based on <a href="http://groups.google.com/group/de.comp.os.unix.linux.misc/msg/4035c67415f9bc09" target="_blank" rel="noopener">a USENET article</a>

 I wrote a long time ago.</p>
<p><a href="https://minnie.tuhs.org/cgi-bin/utree.pl?file=V7/usr/src/cmd/sh/xec.c" target="_blank" rel="noopener">Here</a>

 is the original C-code of the original <code>sh</code> from 1979, with the <code>fork()</code> system call. Search for <code>case TFORK:</code>.</p>
<p>Also, check out the programming style of Mr. Bourne - this is C, even if it does not look like it.</p>
<p>The <a href="/2007/01/07/fork-exec-wait-und-exit.html">original 2007 blog article</a>

, has a followup article <a href="/2007/01/07/fork-und-exec-vs-createprocess.html">on Windows CreateProcess()</a>

, which has not been translated.</p>
<p>When implementing <code>fork()</code> in Windows as part of the WSL 1, Microsoft ran into a lot of problems with the syscall, and wrote an article about how they hate it, and why they think their <code>CreateProcessEx()</code> (in Unix: <code>spawn()</code>) would be better. The <a href="https://www.microsoft.com/en-us/research/uploads/prod/2019/04/fork-hotos19.pdf" target="_blank" rel="noopener">PDF</a>

 makes a number of good points, but is still wrong. :-)</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#linux" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				linux
				</a>
				
				<a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				erklaerbaer
				</a>
				
				<a href="/tags/#computer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				computer
				</a>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2020-12-28-fork-exec-wait-and-exit.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/12/26/sql-clause-is-coming-to-town.html">SQL Clause is coming to town</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2021/01/05/using-python-to-bash.html">Using Python to bash</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
