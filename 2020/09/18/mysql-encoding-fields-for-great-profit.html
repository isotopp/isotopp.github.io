<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Encoding fields for great profit. | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2020/09/18/mysql-encoding-fields-for-great-profit.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Encoding fields for great profit. | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2020/09/18/mysql-encoding-fields-for-great-profit.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2020-09-18T17:39:10Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Encoding fields for great profit.' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-encoding-fields-for-great-profit.-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Encoding fields for great profit.
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>September 18, 2020</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/09/17/mein-selbstfahrendes-auto-hat-kameras-oh-nein.html">Mein selbstfahrendes Auto hat Kameras, oh nein!</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/09/22/alter-table-for-uuid.html">MySQL: ALTER TABLE for UUID</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Iterating schemas over time is not an uncommon thing. Often requirements emerge only after you have data, and then directed action is possible. Consequently, working on existing data, and structuring and cleaning it up is a common task.</p>
<p>In today&rsquo;s example we work with a log table that logged state transitions of things in freeform <code>VARCHAR</code> fields. After some time the log table grew quite sizeable, and the log strings are repeated rather often, contributing to the overall size of the table considerably.</p>
<p>We are starting with this table:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">log</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">device_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">change_time</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">old_state</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">new_state</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w">
</span></span></span></code></pre></div><p>That is, our log table has an <code>id</code> field to allow individual row addressing, and then logs the state change of a <code>device_id</code> at a certain <code>change_time</code> from an <code>old_state</code> into a <code>new_state</code>. The two state fields are <code>varchar(64)</code> and contain one of some 13 or so different strings.</p>
<p>Maybe they also contain typos, outdated state codes or other stuff that will later need remapping and cleanup, but in today&rsquo;s example we want to concentrate on the cleanup.</p>
<p>Some small manual sample data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">device_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">change_time</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">old_state</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">new_state</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">37</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">racked</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">34</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">18</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">56</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">live</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Let&rsquo;s build a list of all possible states from both columns, <code>old_state</code> and <code>new_state</code>. This is easily done. Using <code>old_state</code>, and we prepend a <code>NULL</code> column because we want to <code>INSERT ... SELECT ...</code> this later into a <code>map</code> table which will map the string to an <code>id</code> value. We will then encode the strings using exactly this value.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">            </span><span class="n">old_state</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">       </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">   </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">old_state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">old_state</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">racked</span><span class="w">        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Now using a <code>UNION</code> we extend it to <code>new_state</code> as well.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">             </span><span class="n">old_state</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">old_state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w"> </span><span class="k">union</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">      </span><span class="k">select</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">             </span><span class="n">new_state</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">        </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">    </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">new_state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">old_state</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">x</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">racked</span><span class="w">        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">x</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">x</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">x</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">x</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="n">x</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">live</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>The result strings look good, but something happened to our <code>NULL</code> values. In the original statement they were still good, but in the <code>UNION</code> they get mangled.</p>
<p>The data types of the result table are derived from the values and their types in the first result set of the <code>UNION</code>. And <code>NULL</code> is not a good value to guess anything from.</p>
<p>So let&rsquo;s be more explicit about the types:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">signed</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">            </span><span class="n">old_state</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">       </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">   </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w"> </span><span class="k">union</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">     </span><span class="k">select</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">signed</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">            </span><span class="n">new_state</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">       </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">   </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">state</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">racked</span><span class="w">        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">live</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>This now works, and we can feed it into an <code>INSERT ... SELECT ...</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">map</span><span class="err">\</span><span class="k">G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="k">map</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Create</span><span class="w"> </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="k">map</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="k">state</span><span class="o">`</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="k">map</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">signed</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">old_state</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w"> </span><span class="k">union</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">cast</span><span class="p">(</span><span class="k">NULL</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">signed</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">new_state</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="k">state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Records</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="w">  </span><span class="n">Duplicates</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">state</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">racked</span><span class="w">        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">live</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">6</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Yay. A nice and automatically numbered list of all possible states from the existing data.
We need this indexed, and we also need indices on the two source columns.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">index</span><span class="p">(</span><span class="k">state</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">08</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Records</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Duplicates</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">index</span><span class="p">(</span><span class="n">old_state</span><span class="p">),</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">index</span><span class="p">(</span><span class="n">new_state</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">08</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Records</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Duplicates</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span></code></pre></div><p>If we want to encode these two columns with id-Values from map, we need to add columns for that.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">old_state_id</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="n">old_state</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">                     </span><span class="k">add</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">new_state_id</span><span class="w"> </span><span class="nb">integer</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="n">new_state</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>We can now encode by looking up each <code>log.old_state</code> value in <code>map.state</code> and returning the matching <code>map.id</code> value. With this we should be able to construct an <code>UPDATE</code> statement that fills in the <code>log.old_state_id</code> column.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">map</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">old_state_id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">       </span><span class="k">from</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">log</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">         </span><span class="k">on</span><span class="w"> </span><span class="k">map</span><span class="p">.</span><span class="k">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">old_state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">old_state_id</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">            </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">            </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">            </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Let&rsquo;s try this out in an <code>UPDATE</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">log</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">        </span><span class="k">set</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">old_state_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">          </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">old_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">map</span><span class="p">.</span><span class="k">state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">update</span><span class="w"> </span><span class="n">log</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">        </span><span class="k">set</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">new_state_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">          </span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">new_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">map</span><span class="p">.</span><span class="k">state</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">        </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Rows</span><span class="w"> </span><span class="n">matched</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="n">Changed</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+--------------+---------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">device_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">change_time</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">old_state</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">old_state_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">new_state</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">new_state_id</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+--------------+---------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">37</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">racked</span><span class="w">        </span><span class="o">|</span><span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">34</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w">            </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w">            </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">56</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w">            </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">live</span><span class="w">          </span><span class="o">|</span><span class="w">            </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+--------------+---------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>So we update <code>log</code>, specifically setting each current <code>log.old_state_id</code> value to whatever is returned as matching, for this row, from the subselect we wrote. We then do the same, again, for the <code>new_state</code> column. The result is as shown, it works.</p>
<p>We now have two redundant columns and the indexes that go with them, and can drop these. Let&rsquo;s also check the new table structure, and validate the output by joining the id values for resolution against the map.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">old_state</span><span class="p">,</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="k">column</span><span class="w"> </span><span class="n">new_state</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">24</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Records</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Duplicates</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="n">Warnings</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">log</span><span class="err">\</span><span class="k">G</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="n">log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">Create</span><span class="w"> </span><span class="k">Table</span><span class="p">:</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="o">`</span><span class="n">log</span><span class="o">`</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">device_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">change_time</span><span class="o">`</span><span class="w"> </span><span class="n">datetime</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">old_state_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">`</span><span class="n">new_state_id</span><span class="o">`</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span><span class="w"> </span><span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">6</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="w"> </span><span class="k">COLLATE</span><span class="o">=</span><span class="n">utf8mb4_0900_ai_ci</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+--------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">device_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">change_time</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">old_state_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">new_state_id</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+--------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">37</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">34</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">56</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+--------------+--------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="n">device_id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="n">change_time</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">            </span><span class="n">oldmap</span><span class="p">.</span><span class="k">state</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">old_state</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">            </span><span class="n">newmap</span><span class="p">.</span><span class="k">state</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">new_state</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">       </span><span class="k">from</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">oldmap</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">         </span><span class="k">on</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">old_state_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oldmap</span><span class="p">.</span><span class="n">id</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">       </span><span class="k">join</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">newmap</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-&gt;</span><span class="w">         </span><span class="k">on</span><span class="w"> </span><span class="n">log</span><span class="p">.</span><span class="n">new_state_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newmap</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">device_id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">change_time</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">old_state</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">new_state</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">37</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">racked</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">burn</span><span class="o">-</span><span class="k">in</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">34</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">provisionable</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">48</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">setup</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">|</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">17</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">2020</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">56</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">installed</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">live</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">----+-----------+---------------------+---------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">5</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>Note that we have to join against the map twice, once for each source column, and that also means we have to rename the map table to get unique names for each usage.</p>
<p>Well, that&rsquo;s a toy example. Let&rsquo;s do that at scale, using a Python driver implementing exactly this procedure. <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py" target="_blank" rel="noopener">Code is on GitHub.com</a>

.</p>
<p>We <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L95-L102" target="_blank" rel="noopener">set up our source tables</a>

 by going over the table creation statements in the <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L19-L23" target="_blank" rel="noopener">sql_setup list</a>

.</p>
<p>We are also defining a <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L25-L39" target="_blank" rel="noopener">list of possible states</a>

, and in a <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L77-L93" target="_blank" rel="noopener">data generation loop</a>

 fill the log table with many state transitions from random devices. Note that we do not really care much about matching source and target states, so the transitions are really random jumps. We commit once every <code>statecount</code> many rows (once for each device) to make it a bit faster.</p>
<p>In a <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L48-L53" target="_blank" rel="noopener">prepare_log_transformation</a>

 function we basically add the missing columns and indexes, then in perform_log_transformation, <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L57-L60" target="_blank" rel="noopener">populate the map</a>

 and <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L62-L68" target="_blank" rel="noopener">encode the log</a>

.</p>
<p>Finally, in <a href="https://github.com/isotopp/mysql-dev-examples/blob/master/mysql-lookups/lookups.py#L70-L75" target="_blank" rel="noopener">finish_log_transformation</a>

, we drop the unneeded columns and also implicitly any indices defined on them.</p>
<p>On my super slow test machine, filling the table with a million rows from a thousand devices yields a 64M data file after 2 minutes. I have some 59M of data, and a bit of empty space:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nb">time</span> ./lookups.py create-log-data --devicecount <span class="m">1000</span> --statecount <span class="m">1000</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">real	2m9.729s
</span></span></span><span class="line"><span class="cl"><span class="go">user	0m30.487s
</span></span></span><span class="line"><span class="cl"><span class="go">sys	0m7.536s
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">$</span> ls -l /var/lib/mysql/kris/log.ibd
</span></span><span class="line"><span class="cl"><span class="go">-rw-r----- 1 mysql mysql  64M Sep 18 12:27 log.ibd
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; select * from information_schema.tables where table_name = &#34;log&#34;\G
</span></span></span><span class="line"><span class="cl"><span class="go">  TABLE_CATALOG: def
</span></span></span><span class="line"><span class="cl"><span class="go">   TABLE_SCHEMA: kris
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_NAME: log
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_TYPE: BASE TABLE
</span></span></span><span class="line"><span class="cl"><span class="go">         ENGINE: InnoDB
</span></span></span><span class="line"><span class="cl"><span class="go">        VERSION: 10
</span></span></span><span class="line"><span class="cl"><span class="go">     ROW_FORMAT: Dynamic
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_ROWS: 998347
</span></span></span><span class="line"><span class="cl"><span class="go"> AVG_ROW_LENGTH: 59
</span></span></span><span class="line"><span class="cl"><span class="go">    DATA_LENGTH: 59326464
</span></span></span><span class="line"><span class="cl"><span class="go">MAX_DATA_LENGTH: 0
</span></span></span><span class="line"><span class="cl"><span class="go">   INDEX_LENGTH: 0
</span></span></span><span class="line"><span class="cl"><span class="go">      DATA_FREE: 4194304
</span></span></span><span class="line"><span class="cl"><span class="go"> AUTO_INCREMENT: 1000001
</span></span></span><span class="line"><span class="cl"><span class="go">    CREATE_TIME: 2020-09-18 12:24:50
</span></span></span><span class="line"><span class="cl"><span class="go">    UPDATE_TIME: 2020-09-18 12:27:05
</span></span></span><span class="line"><span class="cl"><span class="go">     CHECK_TIME: NULL
</span></span></span><span class="line"><span class="cl"><span class="go">TABLE_COLLATION: utf8mb4_0900_ai_ci
</span></span></span><span class="line"><span class="cl"><span class="go">       CHECKSUM: NULL
</span></span></span><span class="line"><span class="cl"><span class="go"> CREATE_OPTIONS:
</span></span></span><span class="line"><span class="cl"><span class="go">  TABLE_COMMENT:
</span></span></span><span class="line"><span class="cl"><span class="go">1 row in set (0.00 sec)
</span></span></span></code></pre></div><p>The file size will go up to 132M in the transformation step, most of that is from the indexing we add.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nb">time</span> ./lookups.py prepare-log-transformation
</span></span><span class="line"><span class="cl"><span class="go">Adding id columns and indexes
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">real    0m24.395s
</span></span></span><span class="line"><span class="cl"><span class="go">user    0m0.050s
</span></span></span><span class="line"><span class="cl"><span class="go">sys     0m0.004s
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">$</span> <span class="nb">time</span> ./lookups.py perform-log-transformation
</span></span><span class="line"><span class="cl"><span class="go">Populating map
</span></span></span><span class="line"><span class="cl"><span class="go">Converting old_states
</span></span></span><span class="line"><span class="cl"><span class="go">Converting new_states
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">real    0m39.729s
</span></span></span><span class="line"><span class="cl"><span class="go">user    0m0.050s
</span></span></span><span class="line"><span class="cl"><span class="go">sys     0m0.008s
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">$</span> ls -l /var/lib/mysql/kris/log.ibd
</span></span><span class="line"><span class="cl"><span class="go">-rw-r----- 1 mysql mysql 132M Sep 18 12:31 log.ibd
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; select * from information_schema.tables where table_name = &#34;log&#34;\G
</span></span></span><span class="line"><span class="cl"><span class="go">  TABLE_CATALOG: def
</span></span></span><span class="line"><span class="cl"><span class="go">   TABLE_SCHEMA: kris
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_NAME: log
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_TYPE: BASE TABLE
</span></span></span><span class="line"><span class="cl"><span class="go">         ENGINE: InnoDB
</span></span></span><span class="line"><span class="cl"><span class="go">        VERSION: 10
</span></span></span><span class="line"><span class="cl"><span class="go">     ROW_FORMAT: Dynamic
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_ROWS: 996152
</span></span></span><span class="line"><span class="cl"><span class="go"> AVG_ROW_LENGTH: 78
</span></span></span><span class="line"><span class="cl"><span class="go">    DATA_LENGTH: 78200832
</span></span></span><span class="line"><span class="cl"><span class="go">MAX_DATA_LENGTH: 0
</span></span></span><span class="line"><span class="cl"><span class="go">   INDEX_LENGTH: 50446336
</span></span></span><span class="line"><span class="cl"><span class="go">      DATA_FREE: 5242880
</span></span></span><span class="line"><span class="cl"><span class="go"> AUTO_INCREMENT: 1000001
</span></span></span><span class="line"><span class="cl"><span class="go">    CREATE_TIME: 2020-09-18 12:28:04
</span></span></span><span class="line"><span class="cl"><span class="go">    UPDATE_TIME: 2020-09-18 12:28:07
</span></span></span><span class="line"><span class="cl"><span class="go">     CHECK_TIME: NULL
</span></span></span><span class="line"><span class="cl"><span class="go">TABLE_COLLATION: utf8mb4_0900_ai_ci
</span></span></span><span class="line"><span class="cl"><span class="go">       CHECKSUM: NULL
</span></span></span><span class="line"><span class="cl"><span class="go"> CREATE_OPTIONS:
</span></span></span><span class="line"><span class="cl"><span class="go">  TABLE_COMMENT:
</span></span></span><span class="line"><span class="cl"><span class="go">1 row in set (0.00 sec)
</span></span></span></code></pre></div><p>Finishing up will drop the two <code>VARCHAR</code> columns and the indices defined on them, but leaves us with the encoded values.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nb">time</span> ./lookups.py finish-log-transformation
</span></span><span class="line"><span class="cl"><span class="go">Removing string columns
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">real    0m10.486s
</span></span></span><span class="line"><span class="cl"><span class="go">user    0m0.045s
</span></span></span><span class="line"><span class="cl"><span class="go">sys     0m0.008s
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">$</span> ls -l /var/lib/mysql/kris/log.ibd
</span></span><span class="line"><span class="cl"><span class="go">-rw-r----- 1 mysql mysql  52M Sep 18 12:32 log.ibd
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">mysql&gt; select * from information_schema.tables where table_name = &#34;log&#34;\G
</span></span></span><span class="line"><span class="cl"><span class="go">  TABLE_CATALOG: def
</span></span></span><span class="line"><span class="cl"><span class="go">   TABLE_SCHEMA: kris
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_NAME: log
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_TYPE: BASE TABLE
</span></span></span><span class="line"><span class="cl"><span class="go">         ENGINE: InnoDB
</span></span></span><span class="line"><span class="cl"><span class="go">        VERSION: 10
</span></span></span><span class="line"><span class="cl"><span class="go">     ROW_FORMAT: Dynamic
</span></span></span><span class="line"><span class="cl"><span class="go">     TABLE_ROWS: 997632
</span></span></span><span class="line"><span class="cl"><span class="go"> AVG_ROW_LENGTH: 48
</span></span></span><span class="line"><span class="cl"><span class="go">    DATA_LENGTH: 48824320
</span></span></span><span class="line"><span class="cl"><span class="go">MAX_DATA_LENGTH: 0
</span></span></span><span class="line"><span class="cl"><span class="go">   INDEX_LENGTH: 0
</span></span></span><span class="line"><span class="cl"><span class="go">      DATA_FREE: 2097152
</span></span></span><span class="line"><span class="cl"><span class="go"> AUTO_INCREMENT: 1000001
</span></span></span><span class="line"><span class="cl"><span class="go">    CREATE_TIME: 2020-09-18 12:31:43
</span></span></span><span class="line"><span class="cl"><span class="go">    UPDATE_TIME: NULL
</span></span></span><span class="line"><span class="cl"><span class="go">     CHECK_TIME: NULL
</span></span></span><span class="line"><span class="cl"><span class="go">TABLE_COLLATION: utf8mb4_0900_ai_ci
</span></span></span><span class="line"><span class="cl"><span class="go">       CHECKSUM: NULL
</span></span></span><span class="line"><span class="cl"><span class="go"> CREATE_OPTIONS:
</span></span></span><span class="line"><span class="cl"><span class="go">  TABLE_COMMENT:
</span></span></span><span class="line"><span class="cl"><span class="go">1 row in set (0.00 sec)
</span></span></span></code></pre></div><p>So data length went from 59326464 bytes to 48824320 bytes, a reduction to 82.3% of the original size. We could save even more by not using <code>integer</code> 4-byte values to encode, but for example <code>tinyint unsigned</code> 1-byte values. On the other hand, that may become a problem later on when we exceed the id-space of the map table as we add new states.</p>
<p>On top of that, the size of the target <code>log</code> table is now a function of the row number, as we have no variable length columns anymore. The size of the source table is dependent on the variable length string values as well, so by encoding we also get predictable table sizes.</p>
<p>TL;DR:</p>
<ul>
<li>Using a map table, and update statements with a subselect, we can encode variable length repeated string values into integer values.</li>
<li>We also get better data quality, as now only legal values from the map table can be encoded.</li>
<li>The transformation requires at least two <code>ALTER TABLE</code> statements (or matching online schema changes), and one full scan for each column to be encoded. A lot of intermediate disk space is required. This needs planning.</li>
</ul>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				database
				</a>
				
				<a href="/tags/#innodb" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				innodb
				</a>
				
				<a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				erklaerbaer
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2020-09-18-mysql-encoding-fields-for-great-profit.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/09/17/mein-selbstfahrendes-auto-hat-kameras-oh-nein.html">Mein selbstfahrendes Auto hat Kameras, oh nein!</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/09/22/alter-table-for-uuid.html">MySQL: ALTER TABLE for UUID</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
