<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Deleting data | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2020/09/24/mysql-deleting-data.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Deleting data | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2020/09/24/mysql-deleting-data.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2020-09-24T21:39:24Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Deleting data' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-deleting-data-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Deleting data
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>September 24, 2020</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/09/23/mylogin-cnf.html">MySQL: Provisioning .mylogin.cnf</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/09/25/mysql-dynamic-partitions-suck.html">MySQL: automatic partitions surely would be nice</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Completing the data lifecycle is often harder than originally expected:
Deleting data can sometimes cost way more than inserting it in the first place.
MySQL Partitions can offer a way out.
We have an <a href="/2020/05/13/deleting-data-from-mysql.html">earlier post</a>

 on the subject.</p>
<h2 id="a-sample-table-and-a-problem-statement">
    <a href="#a-sample-table-and-a-problem-statement">
	A sample table, and a problem statement
    </a>
</h2>
<p>Let&rsquo;s define a kind of log table, to which data is added with an <code>auto_increment</code> id value and some data.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#! /usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">click</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">MySQLdb</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">MySQLdb.cursors</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">db_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">user</span><span class="o">=</span><span class="s2">&#34;kris&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">passwd</span><span class="o">=</span><span class="s2">&#34;geheim&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="o">=</span><span class="s2">&#34;kris&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">cursorclass</span><span class="o">=</span><span class="n">MySQLdb</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@click.group</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&#34;Load and delete data using partitions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">sql</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@sql.command</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">setup_tables</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">sql_setup</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;drop table if exists data&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34; create table data (
</span></span></span><span class="line"><span class="cl"><span class="s2">                id integer not null primary key auto_increment,
</span></span></span><span class="line"><span class="cl"><span class="s2">                d varchar(64) not null,
</span></span></span><span class="line"><span class="cl"><span class="s2">                e varchar(64) not null
</span></span></span><span class="line"><span class="cl"><span class="s2">        )&#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;alter table data partition by range (id) ( partition p1 values less than (10000))&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;insert into data (id, d, e) values ( 1, &#39;keks&#39;, &#39;keks&#39; )&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;commit&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">sql_setup</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;setup_tables: failed </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sql</span><span class="p">()</span>
</span></span></code></pre></div><p>This is our basic Python framework for experimentation, using the <code>click</code> framework, and a command <code>setup-tables</code>. This command will run a number of SQL statements to initialize our log table named <code>data</code>.</p>
<p>The log table has three columns: <code>id</code>, an auto_increment counter, and two columns <code>d</code> and <code>e</code>, each containing 64 characters of data. To get things started, we add an initial partition, containing all id-values below 10.000 and an initial row.</p>
<p>If we were to add data to this table in a loop, we would increment our id-counter, and with InnoDB being what it is, all new rows will be added at the end of the table: We remember from <a href="/2020/09/22/alter-table-for-uuid.html">ALTER TABLE for UUID</a>

 that the physical order of any InnoDB table is by primary key - our id-counter.</p>
<p>Now, if we were to expire old data, we would start to delete rows with the lowest id-values, so we would delete rows from the beginning of the table, or the left-hand side of the B+-Tree. To keep the tree balanced, MySQL would have to execute balancing operations, which will be expensive, because rows are being shuffled around in the tree.</p>
<p><p class="md__image">
  <img src="/uploads/loeschen_einfuegen.png" alt=""  />
</p>

</p>
<p><em>New data is added to the right-hand side of the B+-Tree, while old data is being deleted at the left-hand side. To keep the tree balanced, data is reshuffled, which is an expensive operation.</em></p>
<p>Instead, we are defining partitions. In our case, we are using the simplest definition possible: A <code>PARTITION BY RANGE</code> on the primary key column. We are making bins of 10.000 rows each, because that is convenient for our demonstration here.</p>
<h2 id="three-processes">
    <a href="#three-processes">
	Three processes
    </a>
</h2>
<p>We will be using the Python multiprocessing module to have three processes, an <code>inserter()</code>, a <code>partitioner()</code> and a <code>dropper()</code>. All of them are endless loops.</p>
<ul>
<li>The inserter will insert random new data rows into the table as fast as possible.</li>
<li>The partitioner will make sure that we always have a sufficient number of empty new partitions for the inserter to continue.</li>
<li>The dropper will limit the number of partitions with data by throwing the oldest partition away.</li>
</ul>
<p>We will have small piece of code that starts our processes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@sql.command</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">start_processing</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc_partition</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">partitioner</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc_partition</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc_drop</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">dropper</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc_drop</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc_insert</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">inserter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">proc_insert</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="the-inserter">
    <a href="#the-inserter">
	The Inserter
    </a>
</h2>
<p>The Inserter is an endless loop that generates two random 64 character strings and inserts a new row into the database. Every 10 rows, we commit, every 1000 rows we print a message.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">inserter</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">step</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&#34;insert into data (id, d, e) values( NULL, </span><span class="si">%(d)s</span><span class="s2">, </span><span class="si">%(e)s</span><span class="s2"> )&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;d&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="mi">97</span> <span class="o">+</span> <span class="mi">26</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">)]),</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;e&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">chr</span><span class="p">(</span><span class="n">randint</span><span class="p">(</span><span class="mi">97</span><span class="p">,</span> <span class="mi">97</span> <span class="o">+</span> <span class="mi">26</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">64</span><span class="p">)]),</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">counter</span> <span class="o">%</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">counter</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;counter = </span><span class="si">{</span><span class="n">counter</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Without the other two threads, the inserter will generate 10.000 rows and then stop, because there is no <code>MAXVALUE</code> clause.</p>
<h2 id="the-partitioner">
    <a href="#the-partitioner">
	The Partitioner
    </a>
</h2>
<p>The Partitioner is an endless loop that runs an <code>ANALYZE TABLE data</code> command to refresh the statistics, and then queries <code>INFORMATION_SCHEMA.PARTITIONS</code> for the five partitions with the highest <code>PARTITION_ORDINAL_POSITION</code>.</p>
<p>If there are fewer than 5 partitions in total, we generate new partitions no matter what.</p>
<p>If there are not at least 5 partitions with no rows&rsquo; int them, we create new partitions.</p>
<p>If we did nothing, we wait for 1/10th of a second and then check again.</p>
<p>The new partition gets a range expression with a limit 10.000 values higher than the highest one found, and the partition name is derived from the limit by dividing by 10.000.</p>
<p>In code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_partition</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">next_name</span><span class="p">,</span> <span class="n">next_limit</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;alter table data add partition ( partition </span><span class="si">{</span><span class="n">next_name</span><span class="si">}</span><span class="s2"> values less than ( </span><span class="si">{</span><span class="n">next_limit</span><span class="si">}</span><span class="s2">))&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;cmd = </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></span></code></pre></div><p>This will simply format and run an <code>ALTER TABLE</code> statement to add a new partition to the existing table.</p>
<p>And the checking loop:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">partitioner</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># force stats refresh</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;analyze table kris.data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># find the five highest partitions</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;select
</span></span></span><span class="line"><span class="cl"><span class="s2">          partition_name,
</span></span></span><span class="line"><span class="cl"><span class="s2">          partition_ordinal_position,
</span></span></span><span class="line"><span class="cl"><span class="s2">          partition_description,
</span></span></span><span class="line"><span class="cl"><span class="s2">          table_rows
</span></span></span><span class="line"><span class="cl"><span class="s2">        from
</span></span></span><span class="line"><span class="cl"><span class="s2">          information_schema.partitions
</span></span></span><span class="line"><span class="cl"><span class="s2">        where
</span></span></span><span class="line"><span class="cl"><span class="s2">          table_schema = &#34;kris&#34; and
</span></span></span><span class="line"><span class="cl"><span class="s2">          table_name = &#34;data&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">        order by
</span></span></span><span class="line"><span class="cl"><span class="s2">          partition_ordinal_position desc
</span></span></span><span class="line"><span class="cl"><span class="s2">        limit 5
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;PARTITION_DESCRIPTION&#34;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl">        <span class="n">next_name</span> <span class="o">=</span> <span class="s2">&#34;p&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">next_limit</span> <span class="o">/</span> <span class="mi">10000</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;create </span><span class="si">{</span><span class="n">next_name</span><span class="si">}</span><span class="s2"> reason: not enough partitions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">create_partition</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">next_name</span><span class="p">,</span> <span class="n">next_limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nb">sum</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">sum</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&#34;TABLE_ROWS&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;create </span><span class="si">{</span><span class="n">next_name</span><span class="si">}</span><span class="s2"> reason: not enough empty partitions&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">create_partition</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">next_name</span><span class="p">,</span> <span class="n">next_limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span></span></code></pre></div><p>This code is mostly a long <code>SELECT</code> on the <code>INFORMATION_SCHEMA.PARTITIONS</code> table, and then two quick checks to see if we need to make more partitions.</p>
<h2 id="the-dropper">
    <a href="#the-dropper">
	The Dropper
    </a>
</h2>
<p>The Dropper structurally mirrors the Partitioner: We have a tiny function to create the actual <code>ALTER TABLE data DROP PARTITION</code> statement:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">drop_partition</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">partition_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;alter table data drop partition </span><span class="si">{</span><span class="n">partition_name</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;cmd = </span><span class="si">{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></span></code></pre></div><p>And we have an endless loop that basically runs a <code>SELECT</code> on <code>INFORMATION_SCHEMA.PARTITIONS</code> and checks the number of partitions that have a non-zero number of <code>TABLE_ROWS</code>. If it is too many, we drop the one with the lowest number (&ldquo;the first one found&rdquo;, using an appropriate sort order in our SQL).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">dropper</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">**</span><span class="n">db_config</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># force stats refresh</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;analyze table kris.data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34; select
</span></span></span><span class="line"><span class="cl"><span class="s2">          partition_name,
</span></span></span><span class="line"><span class="cl"><span class="s2">          partition_ordinal_position,
</span></span></span><span class="line"><span class="cl"><span class="s2">          partition_description,
</span></span></span><span class="line"><span class="cl"><span class="s2">          table_rows
</span></span></span><span class="line"><span class="cl"><span class="s2">        from
</span></span></span><span class="line"><span class="cl"><span class="s2">          information_schema.partitions
</span></span></span><span class="line"><span class="cl"><span class="s2">        where
</span></span></span><span class="line"><span class="cl"><span class="s2">          table_schema = &#34;kris&#34; and
</span></span></span><span class="line"><span class="cl"><span class="s2">          table_name = &#34;data&#34; and
</span></span></span><span class="line"><span class="cl"><span class="s2">          table_rows &gt; 0
</span></span></span><span class="line"><span class="cl"><span class="s2">        order by
</span></span></span><span class="line"><span class="cl"><span class="s2">          partition_ordinal_position asc
</span></span></span><span class="line"><span class="cl"><span class="s2">        &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">rows</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">partition_name</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;PARTITION_NAME&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;drop </span><span class="si">{</span><span class="n">partition_name</span><span class="si">}</span><span class="s2"> reason: too many partitions with data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">drop_partition</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">partition_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="a-test-run">
    <a href="#a-test-run">
	A test run
    </a>
</h2>
<p>In our test run, we see immediately after startup how the five spare partitions are being created.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ./partitions.py  setup-tables
</span></span><span class="line"><span class="cl"><span class="gp">$</span> ./partitions.py  start-processing
</span></span><span class="line"><span class="cl"><span class="go">create p2 reason: not enough partitions
</span></span></span><span class="line"><span class="cl"><span class="go">cmd = alter table data add partition ( partition p2 values less than ( 20000))
</span></span></span><span class="line"><span class="cl"><span class="go">create p3 reason: not enough partitions
</span></span></span><span class="line"><span class="cl"><span class="go">cmd = alter table data add partition ( partition p3 values less than ( 30000))
</span></span></span><span class="line"><span class="cl"><span class="go">create p4 reason: not enough partitions
</span></span></span><span class="line"><span class="cl"><span class="go">cmd = alter table data add partition ( partition p4 values less than ( 40000))
</span></span></span><span class="line"><span class="cl"><span class="go">create p5 reason: not enough partitions
</span></span></span><span class="line"><span class="cl"><span class="go">cmd = alter table data add partition ( partition p5 values less than ( 50000))
</span></span></span><span class="line"><span class="cl"><span class="go">create p6 reason: not enough empty partitions
</span></span></span><span class="line"><span class="cl"><span class="go">cmd = alter table data add partition ( partition p6 values less than ( 60000))
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 1000
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 2000
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 3000
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><p>Once we cross the threshold of p1, the number of empty partitions is no longer low enough and another one is being created:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 9000
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 10000
</span></span></span><span class="line"><span class="cl"><span class="go">create p7 reason: not enough empty partitions
</span></span></span><span class="line"><span class="cl"><span class="go">cmd = alter table data add partition ( partition p7 values less than ( 70000))
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 11000
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><p>This continues for a while, until we have a sufficient number of data partitions so that we begin dropping, too:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">...
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 90000
</span></span></span><span class="line"><span class="cl"><span class="go">create p15 reason: not enough empty partitions
</span></span></span><span class="line"><span class="cl"><span class="go">cmd = alter table data add partition ( partition p15 values less than ( 150000))
</span></span></span><span class="line"><span class="cl"><span class="go">drop p1 reason: too many partitions with data
</span></span></span><span class="line"><span class="cl"><span class="go">cmd = alter table data drop partition p1
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 91000
</span></span></span><span class="line"><span class="cl"><span class="go">counter = 92000
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><p>Now the system reaches a stable state and will add and drop partitions in sync with the Inserter.</p>
<p>From inside SQL we can see the number of rows in the table rise, and then suddenly drop by 10.000 as we drop a partition.</p>
<pre tabindex="0"><code class="language-sqlkris@localhost" data-lang="sqlkris@localhost">+----------+
| count(*) |
+----------+
|    89872 |
+----------+
1 row in set (0.00 sec)

kris@localhost [kris]&gt; select count(*) from data;
+----------+
| count(*) |
+----------+
|    90122 |
+----------+
1 row in set (0.02 sec)

kris@localhost [kris]&gt; select count(*) from data;
+----------+
| count(*) |
+----------+
|    80362 |
+----------+
1 row in set (0.01 sec)
</code></pre><p>The complete example is available <a href="https://github.com/isotopp/mysql-dev-examples/tree/master/mysql-partitions" target="_blank" rel="noopener">on GitHub.com</a>

.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				database
				</a>
				
				<a href="/tags/#innodb" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				innodb
				</a>
				
				<a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				erklaerbaer
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2020-09-24-mysql-deleting-data.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/09/23/mylogin-cnf.html">MySQL: Provisioning .mylogin.cnf</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/09/25/mysql-dynamic-partitions-suck.html">MySQL: automatic partitions surely would be nice</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
