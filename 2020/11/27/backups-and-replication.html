<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>MySQL: Backups and Replication | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2020/11/27/backups-and-replication.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='MySQL: Backups and Replication | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2020/11/27/backups-and-replication.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2020-11-27T12:40:33Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='MySQL: Backups and Replication' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="mysql-backups-and-replication-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						MySQL: Backups and Replication
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>November 27, 2020</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/11/22/gitlab-in-docker.html">Gitlab in Docker</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/12/01/not-joining-on-performance-schema.html">Not JOINing on PERFORMANCE_SCHEMA</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>There was a question at work about MySQL backups and restore. I needed to explain more.</p>
<p>We use databases to make state persistent. That is: As a developer you can think of your database as a single giant, structured global variable with a weird access method, and to make things worse, concurrent access.</p>
<blockquote>
<p>A database is just a global variable to your code</p></blockquote>
<p>We can log statements that change the state of our database in a log. In MySQL, we call this <em>The Binlog</em>.</p>
<p><p class="md__image">
  <img src="/uploads/2020/11/replication-01.png" alt=""  />
</p>

</p>
<p><em>Making a change to the database, and logging the data changing statement to the binlog.</em></p>
<p>When we make a full backup of the database, we just copy away all tables in the data directory while the database does not change. This can be achieved by simply taking the server offline during the copy, or using more elegant methods that do not interrupt production, yet still look the same when done.</p>
<p>If the database does not change while we make the backup, the backup is internally referentially consistent, and it is associated with exactly one binlog position. And to keep things simple, the binlog position is  just the pair <code>(newest binlog filename, file length)</code>. So a binlog position looks like <code>(binlog.000004, 7625)</code> or similar.</p>
<p>The server will periodically start new binlogs: When it becomes too large, when the server restarts, or when we ask it to do so using a <code>FLUSH BINARY LOGS</code> command.</p>
<p>Every transaction that changes data is being assigned a unique binlog position, and this way we also get a total order of all transactions (and that is becoming a problem later in the game).</p>
<p><p class="md__image">
  <img src="/uploads/2020/11/replication-02.png" alt=""  />
</p>

</p>
<p><em>We can see the binlog position as the internal clock of the database: Whenever something changes in the database, it is written to the binlog. Each transaction is assigned a unique binlog position, and thus, transactions also have a total order.</em></p>
<p>When we restore from a backup, we are at the backups binlog position of the past, and can then replay statements – beginning with the backups position – to roll forward, until we are at the desired position.</p>
<blockquote>
<p>We can use the binlog to replay history</p></blockquote>
<p>What the desired position exactly <em>is</em> depends a bit on the problem: If we issued a command we wish we had not, the desired position is, of course, exactly before this statement. We then skip the undesirable statement.</p>
<p>How we continue after that statement depends on what that statement was. But if we are lucky we can simply continue to replay statements unchanged.</p>
<p>In complicated cases (We might have changed a table definition wrongly) we might need to replace the content of the binlog with alternate, edited statements. In any case we create a new, different and edited timeline that does not contain the mistake we made.</p>
<h1 id="replication-is-an-ongoing-live-restore">
    <a href="#replication-is-an-ongoing-live-restore">
	Replication is an ongoing live Restore
    </a>
</h1>
<p>As early as MySQL 3.23.15 from May 2000, we have replication:</p>
<ul>
<li>We restore our original servers&rsquo; data directory to a new machine, effectively cloning it.</li>
<li>We tell our clone the binlog position of the parent server it was created from.</li>
<li>We tell this new machine where the parent server is, and give it credentials to log in to that parent.</li>
<li>The cloned server will then log in to the parent, download the binlog as it is written, and apply it.</li>
</ul>
<p>This is exactly the same process as with a restore and then applying the binlog that has been created since the backup was made. But with replication, it is live and ongoing as new binlog is being created. As a result, we get a cloned server that executes the same statements as its upstream parent, keeping its internal state a mirror copy of the parent.</p>
<p>We called the parent server a <em>master</em> back then, and a <em>primary</em> or <em>source server</em> these days. The cloned server was a <em>slave</em> back then and is now a <em>replica</em>.</p>
<p>Of course this simplistic approach has all kinds of problems, which then got corrected over time, making replication better, but also more complicated.</p>
<h1 id="splitting-threads">
    <a href="#splitting-threads">
	Splitting Threads
    </a>
</h1>
<p>Early replication had a single thread downloading statements, and then applying them. Of course, some statements take longer than others to execute: a large <code>ALTER TABLE</code> can take hours to run, depending on the size of the table being altered. During that time replication stops and the binlog does not even leave the source server. This is a bit unfortunate should the source fail during that time.</p>
<p>So the very first thing that got changed is splitting the replication thread in two: The <code>IO_THREAD</code> downloads data from the source as quickly as possible, and writes it to the replica as the relay log. Even when the source goes down we still have our local copy.</p>
<p>The <code>SQL_THREAD</code> then reads the relay log and executes it in sequence, strictly maintaining transaction order. Whenever it finishes a relay log, it can delete that file and turn to the next one.</p>
<p>This logic, at the core, is unchanged even today:</p>
<p><p class="md__image">
  <img src="/uploads/2020/11/replication-03.png" alt=""  />
</p>

</p>
<p><em>Simple, asynchronous replication as seen even today.</em></p>
<h1 id="asynchronous-and-semi-synchronous-replication">
    <a href="#asynchronous-and-semi-synchronous-replication">
	Asynchronous and Semi-Synchronous Replication
    </a>
</h1>
<p>We call this kind of replication asynchronous: There is no feedback channel from the replica to the source, and consequently no way for the source to delay the commit and have the application wait until the data has left the machine.</p>
<p>Asynchronous replication scales well, even across long distance links: Applications write to the primary, and don’t wait. The replicas log into the source, download the binlogs and will eventually execute it locally on the replica. Applications reading from the replicas will read outdated state until the replica comes around and catches up.</p>
<p>The main risk is the source going down due to a fault before the binlog has been copied  off. So one innovation is to make the source delay the commit until at least one copy exists on a replica.</p>
<p>For that we need add a communication mechanism to the replica, in which it can signal that is has read a transaction from the binary log, and committed it to the local relay log. Only when the transaction is persisted to disk on the replica, in the relay log, we signal the source, which then lets the transaction commit finish so that the application can continue.</p>
<blockquote>
<p>Semi-Synchronous Replication is Asynchronous Replication with added delays on the commit.</p></blockquote>
<p>This is <em>Semi-Synchronous Replication</em>, <em>SSR</em>, in MySQL, and it comes with a number of caveats:</p>
<ul>
<li>SSR has a timeout. If a transaction is not acknowledged in time, a message is error logged and the server reverts to regular asynchronous replication. It will flip back to SSR once a replica responds within the timeout window.</li>
<li>If a source has zero replicas and a really high timeout, it never receives an acknowledgement, and will essentially block all applications. If your requirement is “transactions must be persisted on more than a single machine to be valid”, this is the desired behaviour. If your requirement is “It is more important to persist things at all than to ever hang the business”, then ASR is better than SSR for your use case. Nonetheless, we have plenty of outages because of this: primary servers ending up with zero replicas due to bugs or circumstances.</li>
<li>SSR guarantees that at least one more copy of the transaction exists, but it does not say where. To build a resilient system, you need orchestration to find out where, and make sure you fail to that machine in order to be able to continue. We are using a special program for this kind of orchestration, and it is being ingeniously called <a href="https://github.com/openark/orchestrator" target="_blank" rel="noopener">MySQL Orchestrator</a>

.</li>
<li>Depending on where your replicas reside, the most advanced replica server may be in the same data center or AZ as the source. In a scenario where the entire AZ fails this does not help you at all.</li>
</ul>
<h1 id="statement-and-row-based-replication">
    <a href="#statement-and-row-based-replication">
	Statement and Row Based Replication
    </a>
</h1>
<p>MySQL&rsquo;s replication logs statements to the binlog. Unfortunately, not all statements are actually replay-able, because they may not be deterministic.</p>
<p>MySQL knows this, and for the obvious cases logs additional code that makes them deterministic.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">flush</span><span class="w"> </span><span class="nb">binary</span><span class="w"> </span><span class="n">logs</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">02</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">());</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">11</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">warning</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Note</span><span class="w"> </span><span class="p">(</span><span class="n">Code</span><span class="w"> </span><span class="mi">1592</span><span class="p">):</span><span class="w"> </span><span class="n">Unsafe</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="n">written</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nb">binary</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="k">using</span><span class="w"> </span><span class="k">statement</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">since</span><span class="w"> </span><span class="n">BINLOG_FORMAT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">STATEMENT</span><span class="p">.</span><span class="w"> </span><span class="k">Statement</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">unsafe</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">uses</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">system</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">slave</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="w">                  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">8351237492962962</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>In the binlog, we find (editing out the cruft):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">mysqlbinlog</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000043</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="mi">201127</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">02</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">548</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">x1b4b14a9</span><span class="w">  </span><span class="n">Rand</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="n">RAND_SEED1</span><span class="o">=</span><span class="mi">850981370</span><span class="p">,</span><span class="w"> </span><span class="o">@@</span><span class="n">RAND_SEED2</span><span class="o">=</span><span class="mi">491246833</span><span class="cm">/*!*/</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="mi">201127</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span><span class="mi">02</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">654</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">xa57c1606</span><span class="w">  </span><span class="n">Query</span><span class="w">   </span><span class="n">thread_id</span><span class="o">=</span><span class="mi">229860</span><span class="w">     </span><span class="n">exec_time</span><span class="o">=</span><span class="mi">0</span><span class="w">     </span><span class="n">error_code</span><span class="o">=</span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="o">=</span><span class="mi">1606470302</span><span class="cm">/*!*/</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span></code></pre></div><p>What is being logged is</p>
<ol>
<li>The RAND_SEED values to make the statement deterministic.</li>
<li>The timestamp of the server when executing the statement (this will also make the NOW() function deterministic).</li>
<li>The actual statement.</li>
</ol>
<p>Despite the warning, this replicates well, and has done so for the last 20 years. What does not replicate well at all, ever, is stuff like <code>UPDATE t SET x = x+1 LIMIT 10</code>. As this lacks an <code>ORDER BY</code> clause, the server is free to order the row updates as it wishes, and can (and in NDB cluster actually will!) update 10 random rows, different ones on each instance of replication. It is the <code>LIMIT</code> clause that makes this non-deterministic.</p>
<p>Now that limitations of this approach are clear, we can see: We would be better off with logging the rows changed, instead of logging the statements that change them.</p>
<p>Counterintuitively, for the workloads we have at work, this is also 50% to 66% smaller than the statement itself, even before optimisation and compression.</p>
<h1 id="using-row-based-replication">
    <a href="#using-row-based-replication">
	Using Row Based Replication
    </a>
</h1>
<p>Let’s do this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">binlog_format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">row</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">flush</span><span class="w"> </span><span class="nb">binary</span><span class="w"> </span><span class="n">logs</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="p">);</span><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">values</span><span class="w"> </span><span class="p">(</span><span class="n">rand</span><span class="p">());</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="w">                  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">7980042936261783</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="c1">--------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>We find:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="err">$</span><span class="w"> </span><span class="n">mysqlbinlog</span><span class="w"> </span><span class="n">binlog</span><span class="p">.</span><span class="mi">000043</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="mi">201127</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">43</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">end_log_pos</span><span class="w"> </span><span class="mi">598</span><span class="w"> </span><span class="n">CRC32</span><span class="w"> </span><span class="mi">0</span><span class="n">xdae6423f</span><span class="w">  </span><span class="n">Write_rows</span><span class="p">:</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">233</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="n">STMT_END_F</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">BINLOG</span><span class="w"> </span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">p8zAXxMBAAAAMAAAAAAAAAAAAOkAAAAAAAEABGtyaXMAAXQAAQUBCAEBAQCZVfvm
</span></span></span><span class="line"><span class="cl"><span class="s1">p8zAXx4BAAAALAAAAAAAAAAAAOkAAAAAAAEAAgAB/wABJeZMQInpPz9C5to=
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;</span><span class="cm">/*!*/</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">#</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mi">598</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">...</span><span class="w">
</span></span></span></code></pre></div><p>(You would need to run <code>mysqlbinlog -vvv</code> to have the mysqlbinlog command decode the BASE64 for you).</p>
<blockquote>
<p>Row Based Replication logs Row Events. <code>mysqlbinlog</code> presents them as a special <code>BINLOG</code> statement to make it possible to feed the output to another server.</p></blockquote>
<p>So in order to be able to represent a Row Events as a statement that can be replayed in another server, MySQL implemented a <code>BINLOG</code> statement, which takes a single parameter.
The parameter is a BASE64 encoded pre- and post-image of the row, a kind of binary patch to the data in the table.</p>
<p>Seeing this, I should be able to take this <code>BINLOG</code> statement and run it on the command line of my client:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w">   </span><span class="n">BINLOG</span><span class="w"> </span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;</span><span class="o">&gt;</span><span class="w"> </span><span class="n">p8zAXxMBAAAAMAAAAAAAAAAAAOkAAAAAAAEABGtyaXMAAXQAAQUBCAEBAQCZVfvm</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="s1">&#39;&gt; p8zAXx4BAAAALAAAAAAAAAAAAOkAAAAAAAEAAgAB/wABJeZMQInpPz9C5to=
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;</span><span class="o">&gt;</span><span class="w"> </span><span class="s1">&#39;/*!*/;
</span></span></span><span class="line"><span class="cl"><span class="s1">ERROR 1609 (HY000): The BINLOG statement of type `Table_map` was not preceded by a format description BINLOG statement.
</span></span></span></code></pre></div><p>To make a long story short: If you go back and pick up the preceding <code>BINLOG</code> command earlier in the binlog, and then this one, it actually works.</p>
<p>Also interesting:
In the earliest versions of MySQL with Row Based logs, the <code>BINLOG</code> command lacked all access controls.
By handcrafting the appropriate patches, anybody could change any data anywhere with any permissions - MySQL did not anticipate that somebody would take replication-only special commands and run them on a regular command line.
This bug is now a long time fixed.</p>
<h2 id="row-based-replication-and-filters">
    <a href="#row-based-replication-and-filters">
	Row Based Replication and Filters
    </a>
</h2>
<p>Since the earliest days of replication, we could filter the binlog on the primary (using <code>binlog-do-*</code> config directives) and the relay log on the replica (using <code>replicate-do-*</code> config directives).</p>
<p>Filtering the binlog is never a good idea: It will break your ability to perform point-in-time restores. Filtering the relay log can be done, but most of the config directives that do this are broken:</p>
<ul>
<li><code>replicate-do-db</code> and <code>replicate-ignore-db</code> are matching the current database in statement based replication, and the actual statements&rsquo; database in row based replication. The statement <code>use a; insert into b.t values (...);</code> will be filtered differently in SBR than in RBR under a <code>replicate-do-db=a</code> rule. With the default setting of <code>row-format=MIXED</code>, the behavior is random, depending on the row format chosen by mysql.</li>
<li><code>replicate-do/ignore-table</code> are tedious, they require you to state each table explicitly, and nobody really wants to use them/</li>
<li><code>replicate-wild-do/ignore-table</code> work in SBR and RBR, but <a href="https://dev.mysql.com/doc/refman/8.0/en/replication-rules-table-options.html" target="_blank" rel="noopener">precedence</a>

 is complicated, and it is advisable to use either only positive or only negative logic.</li>
</ul>
<p>With group replication, which we do not discuss here, any filtering will break consistency in the group, so any filters are forbidden.</p>
<p>The summary of all that is basically: Don&rsquo;t use binlog or replication filters, but if you have to, it&rsquo;s best to stick to either <code>replicate-wild-do-table</code> or <code>replicate-wild-ignore-table</code>.</p>
<h2 id="row-based-replication-and-blob-columns">
    <a href="#row-based-replication-and-blob-columns">
	Row Based Replication and BLOB columns
    </a>
</h2>
<p>Row Based Replication also fails in other interesting ways: Consider a table with a BLOB and a counter.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">kris</span><span class="o">@</span><span class="n">localhost</span><span class="w"> </span><span class="p">[</span><span class="n">kris</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"> </span><span class="n">cnt</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="nb">blob</span><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Query</span><span class="w"> </span><span class="n">OK</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="n">affected</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">05</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>When you increment the counter, the entire row is logged, twice: Once as a pre-image, and once again as a post-image. You end up with 4 bytes integer changing, but two full copies of the <code>BLOB</code>, which can be very large.</p>
<p>This is how we got the setting <code>binlog-row-image</code>, which can be <code>FULL</code> (the default), <code>NOBLOB</code> or <code>MINIMAL</code>. In <code>NOBLOB</code> mode, blobs and text fields are not logged unless they change. In <code>MINIMAL</code> mode, the pre-image contains only the primary key, and the post-image contains only the changed fields new values.</p>
<p>We can use RBR in <code>FULL</code> mode, not only for replication, but also for Change Data Capture, to feed Hadoop and Kafka with it. On the other hand, with  replication chains that are blobby require <code>NOBLOB</code> or <code>MINIMAL</code> mode to not die on us.</p>
<h2 id="row-based-replication-and-primary-keys">
    <a href="#row-based-replication-and-primary-keys">
	Row Based Replication and Primary Keys
    </a>
</h2>
<p>On the replica, the RBR image needs to be applied. For this, the replica needs to find the row. It uses the pre-image to do this, and when the table has no primary key defined, this can be slow - it ends up being a full table scan.</p>
<p>This is another fun cause of replication delay: Having a table of even moderate size without a primary key in a replication chain that uses RBR will delay the replica, and it will look very busy. The replica will eat a lot of CPU doing in-memory scans to find rows to change, in the most inefficient way possible.</p>
<h1 id="more-complications">
    <a href="#more-complications">
	More complications…
    </a>
</h1>
<p>Arriving at this stage took MySQL around 10 years:</p>
<ul>
<li>We can now reliably replicate, and build simple replication trees that are one level deep.</li>
<li>Because of the relay log, binlog positions for the same statement vary between servers - transactions are locally renumbered.</li>
<li>We can replicate, but the <code>SQL_THREAD</code> is a bottleneck: Replication is single-threaded.</li>
<li>We still don’t have distributed transactions, or a way to handle writes to different primary servers.</li>
</ul>
<p>It has taken MySQL another 10 years of changes to improve on this, with Global Transaction IDs, Parallel Replication and Group Replication, but that is for another article.</p>
<p>This article is continued in <a href="/2021/11/08/mysql-parallel-replication.html">Parallel Replication</a>

.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#mysqldev" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysqldev
				</a>
				
				<a href="/tags/#replication" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				replication
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2020-11-27-backups-and-replication.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/11/22/gitlab-in-docker.html">Gitlab in Docker</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2020/12/01/not-joining-on-performance-schema.html">Not JOINing on PERFORMANCE_SCHEMA</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
