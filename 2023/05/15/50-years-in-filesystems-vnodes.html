<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>50 years in filesystems: A detour on vnodes | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="apple-touch-icon" href="icon.png">
<link rel="favicon.ico" rel="icon" type="image/ico">
<link rel="canonical" href="https://blog.koehntopp.info/2023/05/15/50-years-in-filesystems-vnodes.html">


<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">




<meta name="generator" content="Hugo 0.113.0">
<meta property="og:title" content='50 years in filesystems: A detour on vnodes' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />


<meta property="og:locale" content="en_US" />


<meta name="description" content='' />
<meta property="og:description" content='' />

<meta property="og:url" content="https://blog.koehntopp.info" />


<meta property="og:type" content="article" />
<meta name="article:published_time" content='2023-05-15T01:02:03Z' />



<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content='@isotopp' />
<meta name="twitter:creator" content='@isotopp' />
<meta property="twitter:title" content='50 years in filesystems: A detour on vnodes' />
<meta property="twitter:description" content='' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />

<script type="application/ld+json">
    {"@context":"https://schema.org","@type":"WebSite","description":null,"headline":"50 years in filesystems: A detour on vnodes","image":"/assets/img/background/rijksmuseum.jpg","name":"Die wunderbare Welt von Isotopp","url":"https://blog.koehntopp.info"}
</script>

    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.6b600fb66ca1591ba6dcc9b3bdfc59ebd5c0fdc49622889f839fc36f71dde892.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            




<div class="page">
	<article class="50-years-in-filesystems-a-detour-on-vnodes-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header>
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						50 years in filesystems: A detour on vnodes
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='isotopp image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
							 style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://chaos.social/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>

						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>May 15, 2023</div>
						

					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/05/17/50-years-in-filesystems-towards-2004-lfs.html">50 years in filesystems: towards 2004 – LFS</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/05/12/50-years-in-filesystems-1994.html">50 years in filesystems: 1994</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
				<header class="bg-light">
					<nav id="TableOfContents">
  <ul>
    <li><a href="#how-to-have-multiple-filesystems">How to have multiple filesystems</a></li>
    <li><a href="#two-abstractions">Two abstractions</a>
      <ul>
        <li><a href="#vnodes-in-action">Vnodes in action</a></li>
        <li><a href="#new-system-calls">New system calls</a></li>
      </ul>
    </li>
    <li><a href="#in-linux">In Linux</a>
      <ul>
        <li><a href="#the-file">The file</a></li>
        <li><a href="#the-inode">The inode</a></li>
        <li><a href="#the-superblock">The superblock</a></li>
      </ul>
    </li>
    <li><a href="#summary">Summary</a></li>
  </ul>
</nav>
				</header>
				
			</div>
			<div class='col-lg-8'>
				<p>This is part 4 of a series.</p>
<ol>
<li>&ldquo;<a href="https://blog.koehntopp.info/2023/05/05/50-years-in-filesystems-1974.html">1974</a>

&rdquo; on the traditional Unix Filesystem.</li>
<li>&ldquo;<a href="https://blog.koehntopp.info/2023/05/06/50-years-in-filesystems-1984.html">1984</a>

&rdquo; on the BSD Fast File System.</li>
<li>&ldquo;<a href="https://blog.koehntopp.info/2023/05/12/50-years-in-filesystems-1994.html">1994</a>

&rdquo; on SGI XFS.</li>
</ol>
<p>Progress is sometimes hard to see, especially when you have been part of it or otherwise lived through it.
Often, it is easier to see by comparing modern educational material and the problems discussed with older material.
Or look for the research papers and sources that fueled the change. So this is what we do.</p>
<h1 id="how-to-have-multiple-filesystems">
    <a href="#how-to-have-multiple-filesystems">
	How to have multiple filesystems
    </a>
</h1>
<p>Steve Kleiman wrote
&ldquo;<a href="https://www.semanticscholar.org/paper/Vnodes%3A-An-Architecture-for-Multiple-File-System-in-Kleiman/e0d14c74f23ef9b21c2fc37b5197fbfe348a7fcf" target="_blank" rel="noopener">Vnodes: An Architecture for Multiple File System Types in Sun UNIX</a>

&rdquo;
in 1986.</p>
<p>This is a short paper, with little text, because most of it is listing of data structures and diagrams of C language <code>struct</code>&rsquo;s pointing at each other.
Kleiman wanted to have multiple file systems in Unix, but wanted the file systems to be able to share interfaces and internal memory, if at all possible.
Specifically, he wanted a design that provided</p>
<ul>
<li>one common interface with multiple implementations,</li>
<li>supporting BSD FFS, but also NFS and RFS, two remote filesystems, and Non-Unix filesystems, specifically MS-DOS,</li>
<li>with the operations being defined by the interface being atomic.</li>
</ul>
<p>And the implementations should be able to handle memory and structures dynamically, without performance impact,
reentrant and multicore capable, and somewhat object-oriented.</p>
<h1 id="two-abstractions">
    <a href="#two-abstractions">
	Two abstractions
    </a>
</h1>
<p>He looked at the various operations, and decided to provide two major abstractions:
The filesystem (<code>vfs</code>, virtual filesystem) and the inode (<code>vnode</code>, virtual inode), representing a filesystem and a file.</p>
<p>In true C++ style (but expressed in C), we get a virtual function table for each type, representing the class:</p>
<ul>
<li>For the <code>vfs</code> type, this is a <code>struct vfsops</code>,
a collection of function pointers with operations such as <code>mount</code>, <code>unmount</code>, <code>sync</code> and <code>vget</code>.
Later in the paper, prototypes and functionality of these functions are explained.</li>
<li>For the <code>vnode</code> type, likewise, we get <code>struct vnodeops</code>.
The functions here are <code>open</code>, <code>rdwr</code> and <code>close</code>, of course, but also <code>create</code>, <code>unlink</code>, and <code>rename</code>.
Some functions are specific to a filetype such as <code>readlink</code>, <code>mkdir</code>, <code>readdir</code> and <code>rmdir</code>.</li>
</ul>
<p>Actual mounts are being tracked in <code>vfs</code> objects, which point to the operations applicable to this particular subtree with their <code>struct vfsops *</code>.</p>
<p>Similarly, open files are being tracked in <code>vnode</code> instances, which again, among other things, have a <code>struct *vnodeops</code> pointer.
<code>vnodes</code> are part of their <code>vfs</code>, so they also have <code>struct *vfs</code> to their filesystem instance.</p>
<p>Both, the <code>vfs</code> and the <code>vnode</code> need to provide a way for the implementation to store implementation specific data (&ldquo;subclass private fields&rdquo;).
So both structures end with <code>caddr_t ...data</code> pointers.
That is, the private data is not part of the virtual structure, but located elsewhere and pointed to.</p>
<h2 id="vnodes-in-action">
    <a href="#vnodes-in-action">
	Vnodes in action
    </a>
</h2>
<p><p class="md__image">
  <img src="/uploads/2023/05/vfs-vnode-structures.png" alt=""  />
</p>


<em>One full page in the paper is dedicated to showing the various structures pointing at each other.
What looks confusing at first glance is actually pretty straightforward and elegant, once you trace it out.</em></p>
<p>Kleiman sets out to explain how things work using the <code>lookuppn()</code> function, which replaces the older <code>namei()</code> function from traditional Unix.
Analogous to <code>namei()</code>, the function consumes a path name, and returns a <code>struct vnode *</code> to the vnode represented by that pathname.</p>
<p>Pathname traversal starts at the root vnode or the current directory vnode for the current process,
depending on the first character of a pathname being <code>/</code> or not.</p>
<p>The function then takes the next pathname component, iteratively, and calls the <code>lookup</code> function for the current vnode.
This function takes a pathname component, and a current <code>vnode</code> assuming it is a directory.
It then returns the <code>vnode</code> representing that component.</p>
<p>If a directory is a mountpoint, it has <code>vfsmountedhere</code> set.
This is a <code>struct vfs *</code>. <code>lookuppn</code> follows the pointer,
and can call the <code>root</code> function for that <code>vfs</code> to get the root <code>vnode</code> for that filesystem, replacing the current <code>vnode</code> being worked on.</p>
<p>The inverse must also be possible:
When resolving a &ldquo;<code>..</code>&rdquo; component and the current <code>vnode</code> has a root flag set in its &ldquo;flags&rdquo; field,
we go from the current <code>vnode</code> to the <code>vfs</code> following the <code>vfsmountedhere</code> pointer.
Then we can use the <code>vnodecovered</code> field in that <code>vfs</code> to get the <code>vnode</code> of the superior filesystem.</p>
<p>In any case, upon successful completion, a <code>struct vnode*</code> representing the consumed pathname is returned.</p>
<h2 id="new-system-calls">
    <a href="#new-system-calls">
	New system calls
    </a>
</h2>
<p>In order to make things work,
and to make things work efficiently, a few new system calls had to be added to round out the interfaces.</p>
<p>It is here in Unix history that we get <code>statfs</code> and <code>fstatfs</code>, to get an interface to filesystems in userland.
We also gain <code>getdirentries</code> (plural) to get multiple directory entries at once (depending on the size of the buffer provided),
which makes directory reading faster a lot for remote filesystems.</p>
<h1 id="in-linux">
    <a href="#in-linux">
	In Linux
    </a>
</h1>
<p>Looking at the Linux kernel source, we can find the general structure of Kleiman&rsquo;s design,
even if the complexity and richness of the Linux kernel obscure most of it.
The Linux kernel has a wealth of file system types, and added also a lot of functionality that wasn&rsquo;t present in BSD 40 years ago.
So we find a lot more structures and system calls,
implementing namespaces, quotas, attributes, read-only modes, directory name caches, and other things.</p>
<h2 id="the-file">
    <a href="#the-file">
	The file
    </a>
</h2>
<p>Still, if you squint, the original structure can still be found:
Linux splits the in-memory structures around files in two, the opened <code>file</code>, which is an inode with a current position associated,
and the <code>inode</code>, which is the whole file.</p>
<p>We find instances of file objects, <code>struct file</code>, defined
<a href="https://github.com/torvalds/linux/blob/v6.3/include/linux/fs.h#L942C3-L981" target="_blank" rel="noopener">here</a>

.
Among all the other things a file has, it has most notably a field <code>loff_t f_pos</code>,
an offset (in bytes) from the start of the file,
the current position.</p>
<p>The file&rsquo;s class is defined via a virtual function table.
We find the pointer as <code>struct file_operations *f_op</code>,
and the definition <a href="https://github.com/torvalds/linux/blob/v6.3/include/linux/fs.h#L1754-L1798" target="_blank" rel="noopener">here</a>

.
It shows all the things a file can do, most notable, <code>open</code>, <code>close</code>, <code>lseek</code> and then <code>read</code> and <code>write</code>.</p>
<p>The file also contains pointers to the inode, <code>struct inode *f_inode</code>.</p>
<h2 id="the-inode">
    <a href="#the-inode">
	The inode
    </a>
</h2>
<p>Operations on files without the need of an offset work on the file as a whole,
defined as <code>struct inode *</code>.</p>
<p>Check the definition <a href="https://github.com/torvalds/linux/blob/v6.3/include/linux/fs.h#L595-L705" target="_blank" rel="noopener">here</a>

.
We see other definitions in here that have no equivalent in BSD from 40 years ago, such as ACLs and attributes.</p>
<p>We find the inode&rsquo;s class is defined via a virtual function table,
<code>struct inode_operations *i_op</code>,
and the definition <a href="https://github.com/torvalds/linux/blob/v6.3/include/linux/fs.h#L1800-L1840" target="_blank" rel="noopener">here</a>

.
Again, a lot of them deal with new features such as ACLs and extended attributes,
but we also find those we expect such as <code>link</code>, <code>unlink</code>, <code>rename</code> and so on.</p>
<p>The inode also contains a pointer to a filesystem, the <code>struct super_block *i_sb</code>.</p>
<h2 id="the-superblock">
    <a href="#the-superblock">
	The superblock
    </a>
</h2>
<p>A mountpoint is represented as an instance of <code>struct super_block</code>,
defined <a href="https://github.com/torvalds/linux/blob/v6.3/include/linux/fs.h#L1136-L1268" target="_blank" rel="noopener">here</a>

.
Again, the class is a <code>struct super_operations *s_op</code>, defined
<a href="https://github.com/torvalds/linux/blob/v6.3/include/linux/fs.h#L1886-L1918" target="_blank" rel="noopener">here</a>

.</p>
<p>As an added complexity, there is no finite list of filesystems.
It is instead extensible through loadable modules, so we also have a <code>struct file_system_type</code>,
<a href="https://github.com/torvalds/linux/blob/v6.3/include/linux/fs.h#L1886-L1918" target="_blank" rel="noopener">here</a>

.
This is basically a class with only one class method as a factory for superblocks, <code>mount</code>.</p>
<h1 id="summary">
    <a href="#summary">
	Summary
    </a>
</h1>
<p>Unix changed.
It became a lot more runtime extensive, added a lot of new functionality and gained system calls.
Things became more structured.</p>
<p>But the original design and data structures conceived by Kleiman and Joy held up, and can still be found in current Linux, 40 years later.
We can point to concrete Linux code, which while looking completely different, is structurally mirroring the original design ideas.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Share</span>
				<a href='https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.koehntopp.info%2f2023%2f05%2f15%2f50-years-in-filesystems-vnodes.html' target='_blank'
				   class='text-decoration-none'>
					<svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
						<use xlink:href='/bootstrap-icons.svg#facebook'/>
					</svg>
				</a>
				
				<a href='http://www.reddit.com/submit?url=https%3a%2f%2fblog.koehntopp.info%2f2023%2f05%2f15%2f50-years-in-filesystems-vnodes.html&title=50%20years%20in%20filesystems%3a%20A%20detour%20on%20vnodes' target='_blank'
				   class='text-decoration-none'>
					<svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
						<use xlink:href='/bootstrap-icons.svg#reddit'/>
					</svg>
				</a>
				<a href='mailto:?subject=50%20years%20in%20filesystems%3a%20A%20detour%20on%20vnodes&body=https%3a%2f%2fblog.koehntopp.info%2f2023%2f05%2f15%2f50-years-in-filesystems-vnodes.html' target='_blank'
				   class='text-decoration-none'>
					<svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
						<use xlink:href='/bootstrap-icons.svg#envelope-fill'/>
					</svg>
				</a>
			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/%20tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/%20tags/#unix" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				unix
				</a>
				
				<a href="/%20tags/#filesystems" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				filesystems
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2023-05-15-50-years-in-filesystems-vnodes.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mb-5 pt-5 border-top mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/05/17/50-years-in-filesystems-towards-2004-lfs.html">50 years in filesystems: towards 2004 – LFS</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/05/12/50-years-in-filesystems-1994.html">50 years in filesystems: 1994</a>
				</div>
				
			</div>
		</div>

		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff. 
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#rss-fill'/></svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#envelope'/></svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#github'/></svg>
        </a>

	<a rel="me" href="https://chaos.social/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#mastodon'/></svg>
	</a>

        <a href='https://www.reddit.com/user/isotopp' title='Follow on Reddit' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#reddit'/></svg>
        </a>

        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#steam'/></svg>
        </a>



        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#youtube'/></svg>
        </a>

      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
