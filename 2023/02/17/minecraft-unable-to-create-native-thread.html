<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Minecraft: unable to create native thread | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2023/02/17/minecraft-unable-to-create-native-thread.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Minecraft: unable to create native thread | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2023/02/17/minecraft-unable-to-create-native-thread.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2023-02-17T13:32:00&#43;01:00' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Minecraft: unable to create native thread' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="minecraft-unable-to-create-native-thread-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Minecraft: unable to create native thread
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>February 17, 2023</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/02/06/service-directories-and-what-they-are-good-for.html">Service Directories, and what they are good for</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/02/18/this-is-not-a-drill.html">This is not a Drill, this is just Tuesday</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>A minecraft server has problems creating threads. The error message reads:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">OutOfMemoryError</span><span class="p">:</span><span class="w"> </span><span class="n">unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="kd">native</span><span class="w"> </span><span class="n">thread</span><span class="p">:</span><span class="w"> </span><span class="n">possibly</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">process</span><span class="o">/</span><span class="n">resource</span><span class="w"> </span><span class="n">limits</span><span class="w"> </span><span class="n">reached</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Thread</span><span class="p">.</span><span class="na">start0</span><span class="p">(</span><span class="n">Native</span><span class="w"> </span><span class="n">Method</span><span class="p">)</span><span class="w"> </span><span class="o">~[?</span><span class="p">:</span><span class="o">?]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">lang</span><span class="p">.</span><span class="na">Thread</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">802</span><span class="p">)</span><span class="w"> </span><span class="o">~[?</span><span class="p">:</span><span class="o">?]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">concurrent</span><span class="p">.</span><span class="na">ThreadPoolExecutor</span><span class="p">.</span><span class="na">addWorker</span><span class="p">(</span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">945</span><span class="p">)</span><span class="w"> </span><span class="o">~[?</span><span class="p">:</span><span class="o">?]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">concurrent</span><span class="p">.</span><span class="na">ThreadPoolExecutor</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">ThreadPoolExecutor</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">1353</span><span class="p">)</span><span class="w"> </span><span class="o">~[?</span><span class="p">:</span><span class="o">?]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">at</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">concurrent</span><span class="p">.</span><span class="na">Executors$DelegatedExecutorService</span><span class="p">.</span><span class="na">execute</span><span class="p">(</span><span class="n">Executors</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">721</span><span class="p">)</span><span class="w"> </span><span class="o">~[?</span><span class="p">:</span><span class="o">?]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">at</span><span class="w"> </span><span class="n">org</span><span class="p">.</span><span class="na">bukkit</span><span class="p">.</span><span class="na">craftbukkit</span><span class="p">.</span><span class="na">v1_19_R2</span><span class="p">.</span><span class="na">scheduler</span><span class="p">.</span><span class="na">CraftAsyncScheduler</span><span class="p">.</span><span class="na">mainThreadHeartbeat</span><span class="p">(</span><span class="n">CraftAsyncScheduler</span><span class="p">.</span><span class="na">java</span><span class="p">:</span><span class="n">73</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></div><p>The server in question has 32 GB of memory (6 GB used), 8 cores, and processes threads running.
It is mostly idle.
There is no reason at all why this machine should be out of resources.</p>
<h1 id="vps-limits-and-how-to-check-them">
    <a href="#vps-limits-and-how-to-check-them">
	VPS Limits, and how to check them
    </a>
</h1>
<p>It is a VPS, and that may be related:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> lscpu <span class="p">|</span> egrep -i <span class="s1">&#39;(visor|virt)&#39;</span>
</span></span><span class="line"><span class="cl"><span class="go">Address sizes:       46 bits physical, 48 bits virtual
</span></span></span><span class="line"><span class="cl"><span class="go">Virtualization:      VT-x
</span></span></span><span class="line"><span class="cl"><span class="go">Hypervisor vendor:   Parallels
</span></span></span><span class="line"><span class="cl"><span class="go">Virtualization type: container
</span></span></span></code></pre></div><p>The instance has a relatively low process limit, shown in <code>/proc/user_beancounters</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> grep numproc /proc/user_beancounters
</span></span><span class="line"><span class="cl"><span class="go">            numproc                       272                  272                 1100                 1100                    0
</span></span></span></code></pre></div><p>This shows a global limit of 1100 threads/processes.</p>
<p>There is an additional threads-per-process limit enforced by systemd, and this is relatively low, because of the low per-instance limit.
It can be shown like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> systemctl show --property<span class="o">=</span>DefaultTasksMax
</span></span><span class="line"><span class="cl"><span class="go">DefaultMax=135
</span></span></span></code></pre></div><p>This matches the numbers from the <code>user_beancounters</code>:
The maximum utilization was 272 in the Beancounters, and the server never managed to hit the limit of 1100.
Instead, it made it to 2x 135 (two Minecraft servers, each with the limit of 135), and two additional threads.</p>
<h1 id="increasing-the-systemd-limit">
    <a href="#increasing-the-systemd-limit">
	Increasing the <code>systemd</code> Limit
    </a>
</h1>
<p>It is possible to increase this limit to the instance limit, like so:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> mkdir /etc/systemd/systemd.conf.d<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span> <span class="nb">cd</span> /etc/systemd/system.conf.d
</span></span><span class="line"><span class="cl"><span class="gp">#</span> <span class="nb">pwd</span>
</span></span><span class="line"><span class="cl"><span class="go">/etc/systemd/system.conf.d
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> cat &lt;&lt; EOF &gt; system.conf
</span></span><span class="line"><span class="cl"><span class="gp">#</span> Override created by ... on ...
</span></span><span class="line"><span class="cl"><span class="gp">#</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>Manager<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="go">DefaultTasksMax=1100
</span></span></span></code></pre></div><p>After creating this file, reload systemd and check the new limits:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> systemctl daemon-reexec
</span></span><span class="line"><span class="cl"><span class="gp">#</span> systemctl show --property<span class="o">=</span>DefaultTasksMax
</span></span><span class="line"><span class="cl"><span class="go">DefaultMax=1100
</span></span></span></code></pre></div><h1 id="non-vps-has-higher-limits">
    <a href="#non-vps-has-higher-limits">
	Non-VPS has higher limits
    </a>
</h1>
<p>On a physical server with 32 GB of memory and 8 cores, the default limit is</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> systemctl show --property<span class="o">=</span>DefaultTasksMax
</span></span><span class="line"><span class="cl"><span class="go">DefaultTasksMax=38313
</span></span></span></code></pre></div><p>and it can be tuned much higher.
Similarly, on a properly virtualized box instead of a VPS it would be much higher.</p>
<p>Consider this when you opt for a cheap, overcomitted VPS slice instead of a proper KVM.
When you go for the VPS, make a monthly contract and do not commit to a one-year option, so you can get rid of it when it turns out to be unsuitable.</p>
<h1 id="actual-resource-consumption">
    <a href="#actual-resource-consumption">
	Actual resource consumption
    </a>
</h1>
<p>On our server, we run three instances of &ldquo;Paper&rdquo; (a high-performance patch to a patch to a patch of the original minecraft server),
and waterfall, a Minecraft proxy that directs users between the instances.</p>
<p><p class="md__image">
  <img src="/uploads/2023/02/native-thread-01.png" alt=""  />
</p>

</p>
<p><em>Output of the <code>htop</code> program.
On the right hand side of the screenshot, we see three identically configured <code>java</code> instances, each representing a &ldquo;Paper&rdquo; server.
The resident set size of these servers is relatively small, 3.5 GB per instance, as shown by the left-lower red bubble.
The virtual size is not quite 10 GB.
The server instance will grow until it reaches the virtual size.
Total memory consumption is shown in the upper-left bubble, 11.6 GB are used (the sum of the servers plus some extra from the OS).</em></p>
<p>We run the servers with <code>-Xmx4096M -Xms4096M</code> each, which is rather generous.
This creates processes with a total <code>VIRT</code> size of ~ 10 GB, of which <code>RES</code> is the actually comitted memory, around 3.5 GB per process.
This results in 11.2 GB memory usage, plus 0.4 GB extra from other processes on the instance.</p>
<p>Our total memory is 32 GB.</p>
<p>The server load is shown as 0.41/8.0, so the machine is pretty idle, and the CPU load meters above the memory meter agrees.</p>
<p><p class="md__image">
  <img src="/uploads/2023/02/native-thread-02.png" alt=""  />
</p>

</p>
<p><em>Output of the <code>htop</code> program, detail. When hitting <code>H</code> to toggle display of user threads, the number of running threads is also shown.
We are running 245 threads.</em></p>
<p>Hitting <code>H</code> (Uppercase-H) in <code>htop</code> unfolds user threads display. It also shows the total number of threads running next to the number of tasks (processes).
In our case, we are running with 245/1100 threads.
This is by far the most scarce resource.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#gaming" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				gaming
				</a>
				
				<a href="/tags/#microsoft" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				microsoft
				</a>
				
				<a href="/tags/#minecraft" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				minecraft
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2023-02-17-minecraft-unable-to-create-native-thread.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/02/06/service-directories-and-what-they-are-good-for.html">Service Directories, and what they are good for</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/02/18/this-is-not-a-drill.html">This is not a Drill, this is just Tuesday</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
