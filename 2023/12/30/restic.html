<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Restic | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2023/12/30/restic.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Restic | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="de_DE" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2023/12/30/restic.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2023-12-30T05:06:07Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Restic' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="restic-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Restic
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>December 30, 2023</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/12/05/x86_64-binaries-on-m1.html">x86_64 binaries on M1</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2024/01/09/deploying-websites.html">Deploying websites - an escalation</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
				<header class="toc bg-light">
					<nav id="TableOfContents">
  <ul>
    <li><a href="#warum-restic">Warum <code>restic</code>?</a></li>
    <li><a href="#situation">Situation</a></li>
    <li><a href="#sshconfig">.ssh/config</a></li>
    <li><a href="#restic-handhaben">Restic handhaben</a>
      <ul>
        <li><a href="#restic-initialisieren">Restic initialisieren</a></li>
        <li><a href="#restic-ausführen">Restic ausführen</a></li>
        <li><a href="#garbage-collection">Garbage Collection</a></li>
        <li><a href="#snapshots-anzeigen">Snapshots anzeigen</a></li>
        <li><a href="#suche">Suche</a></li>
        <li><a href="#restore">Restore</a></li>
        <li><a href="#fuse-mount">FUSE-Mount</a></li>
      </ul>
    </li>
    <li><a href="#sftp-für-restic-aufsetzen"><code>sftp</code> für <code>restic</code> aufsetzen</a></li>
    <li><a href="#rest-server"><code>rest-server</code></a></li>
  </ul>
</nav>
				</header>
				
			</div>
			<div class='col-lg-8'>
				<p>Ich hatte Grund, mich mit <a href="">Restic</a>

 für Backup auseinander zu setzen.</p>
<h1 id="warum-restic">
    <a href="#warum-restic">
	Warum <code>restic</code>?
    </a>
</h1>
<p><code>restic</code> ist eine Datensicherung in ein Repository,
das intern als ein Content-Addressable Storage aufgebaut ist.
Das heißt, daß innerhalb des Backups Datenstücke liegen,
die genau ihre (SHA256-) Prüfsumme als Dateinamen haben.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@server:/backup/restic/data/fc# sha256sum fcec*7a5b
</span></span><span class="line"><span class="cl">fcec25d3e3165d159b4dac3867d1a1831707d582215c1fa30e0277cd57dc7a5b  fcec25d3e3165d159b4dac3867d1a1831707d582215c1fa30e0277cd57dc7a5b
</span></span></code></pre></div><p><em>Die Prüfsumme einer Datei im <code>data</code>-Verzeichnis eines <code>restic</code>-Repos.
Sie entspricht genau dem Namen der Datei.</em></p>
<p>Dies führt zu einer Datenstruktur in <code>restic</code>, die nicht ganz unähnlich der in einem
<code>.git</code>-Repository ist, und auch zu einer starken Deduplizierung von Daten.
Dateien, die in mehr als einer Generation des Backups unverändert vorkommen,
werden automatisch erkannt und nicht mehrfach gespeichert.
Stattdessen wird nur ein Reference-Count erhöht.</p>
<p><code>restic</code> verschlüsselt Daten, Metadaten und Dateinamen genau wie Datei-Inhalte,
prüft die Integrität des Backups über diese Content-Prüfsummen und
stellt die Sicherung über mehrere Such- und Zugriffsmöglichkeiten zur Verfügung.</p>
<p>Man kann sich <code>restic</code> wie Apple Time Machine vorstellen:
Stündliche Backups, die in wenigen Sekunden durchlaufen,
und die immer ein komplettes Image produzieren,
auch wenn sie nur inkrementell Platz und Zeit verbrauchen.
Anders als Time Machine (oder ZFS Snapshots) ist die Lösung jedoch
unabhängig vom verwendeten Dateisystem, und unterstützt ein breites Angebot
von Backend-Storages.</p>
<h1 id="situation">
    <a href="#situation">
	Situation
    </a>
</h1>
<p>Der neue Dedi ist ein E5-1650 v3 mit 12 Threads und 128 GB RAM bei Hetzner.
Er führt stündlich ein <code>restic</code> auf die Hetzner Storagebox durch,
und weiterhin einmal täglich ein <code>restic</code> nach Hause aus.</p>
<pre tabindex="0"><code class="language-cronexp" data-lang="cronexp">10 * * * * /root/bin/run-restic
34 1 * * * /root/bin/run-restic-to-home
</code></pre><p><em>Crontab mit den Backup-Jobs.</em></p>
<p>Zu sichern ist ein LVM2 mit einem recht kleinen <code>/var/www</code>, <code>/etc</code> und der Kram auf <code>/home</code>, der zum Glück noch überschaubar groß ist.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># df -t xfs -h</span>
</span></span><span class="line"><span class="cl">Filesystem              Size  Used Avail Use% Mounted on
</span></span><span class="line"><span class="cl">/dev/mapper/vg0-root     20G  4.0G   17G  20% /
</span></span><span class="line"><span class="cl">/dev/mapper/vg0-home    200G   40G  160G  20% /home
</span></span></code></pre></div><p><em>Situation mit den Dateisystemen auf dem Dedi.</em></p>
<p>Real erfolgen faktisch alle Änderungen am Content immer unter Usern in <code>/home</code>,
sodaß vor allen Dingen die Sicherung dieser Partition dringend ist.
Speziell der Minecraft-Spieluser hat eine Menge Churn,
weil dort im Home alle Server-Instanzen liegen, auf denen gearbeitet wird.</p>
<p>Die lokale Sicherung erfolgt mit einem sftp-Backend auf die Hetzner Storagebox,
das Backup nach Hause verwendet ebenfalls das sftp-Backend.</p>
<h1 id="sshconfig">
    <a href="#sshconfig">
	.ssh/config
    </a>
</h1>
<p>Damit alles nicht so weh tut, verwenden wir einen speziellen Backup-Key,
der nur zur Datensicherung verwendet wird, und der nur die Funktion hat,
ein paßwortloses Login auf den Backup-Zielen zu erlauben.</p>
<p>Wir generieren den Key mit</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ssh-keygen -t rsa -b 4096 -N &#34;&#34; -f ~/.ssh/id_backup</span>
</span></span></code></pre></div><p>und konfigurieren ihn gleich in zwei <code>Host</code>-Matchblocks rein:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># cat .ssh/config</span>
</span></span><span class="line"><span class="cl">ServerAliveInterval <span class="m">10</span>
</span></span><span class="line"><span class="cl">ServerAliveCountMax <span class="m">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HashKnownHosts no
</span></span><span class="line"><span class="cl">TCPKeepAlive yes
</span></span><span class="line"><span class="cl">KeepAlive yes
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Host storagebox
</span></span><span class="line"><span class="cl">        Hostname uxxxxxx.your-storagebox.de
</span></span><span class="line"><span class="cl">        User uxxxxxx
</span></span><span class="line"><span class="cl">        Port <span class="m">23</span>
</span></span><span class="line"><span class="cl">        IdentityFile /root/.ssh/id_backup
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Host restic
</span></span><span class="line"><span class="cl">        Hostname home.example.com
</span></span><span class="line"><span class="cl">        User resticuser
</span></span><span class="line"><span class="cl">        Port <span class="m">22</span>
</span></span><span class="line"><span class="cl">        IdentityFile /root/.ssh/id_backup
</span></span></code></pre></div><p>Dadurch können wir die Backup-Ziele korrekt vorkonfiguriert
über den Namen des Matchblocks ansprechen, also mit <code>storagebox</code> und <code>restic</code>.</p>
<p>Den Key müssen wir nun auch in der <code>authorized_keys</code> der Ziele hinterlegen.
Das geht genauso wie von
<a href="https://docs.hetzner.com/robot/storage-box/backup-space-ssh-keys/#upload" target="_blank" rel="noopener">Hetzner dokumentiert</a>

.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># cat .ssh/id_backup.pub | ssh -p23 uXXXXX@uXXXXX.your-storagebox.de install-ssh-key</span>
</span></span><span class="line"><span class="cl">uXXXXX@uXXXXX.your-storagebox.de<span class="err">&#39;</span>s password:
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></div><p>Test mit <code>ssh -p23 -i ~/.ssh/id_backup uXXXXX@uXXXXX.your-storagebox.de's password</code>.
Man landet in der restricted Shell der Storagebox,
und kann zum Beispiel mit <code>help</code> eine Kommandoliste bekommen.</p>
<h1 id="restic-handhaben">
    <a href="#restic-handhaben">
	Restic handhaben
    </a>
</h1>
<h2 id="restic-initialisieren">
    <a href="#restic-initialisieren">
	Restic initialisieren
    </a>
</h2>
<p>Damit <code>restic</code> Dinge tun kann, muss man das Repository, in dem die Backups landen,
erst einmalig initialisieren.
Dabei wird auch ein Verschlüsselungspaßwort festgelegt, das nicht verloren gehen darf.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># restic -r sftp://storagebox/restic init</span>
</span></span><span class="line"><span class="cl">enter password <span class="k">for</span> new repository:
</span></span><span class="line"><span class="cl">enter password again:
</span></span><span class="line"><span class="cl">created restic repository 1c28ea9e7b at /restic
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Please note that knowledge of your password is required to access
</span></span><span class="line"><span class="cl">the repository. Losing your password means that your data is
</span></span><span class="line"><span class="cl">irrecoverably lost.
</span></span></code></pre></div><p>Dies erzeugt eine Verzeichnishierarchie in <code>/restic</code> auf der Storagebox.</p>
<h2 id="restic-ausführen">
    <a href="#restic-ausf%c3%bchren">
	Restic ausführen
    </a>
</h2>
<p>Das Backup-Script kann nun ausgeführt werden.
Man kann dies zu Fuß tun, wie ich hier, oder
<a href="https://github.com/creativeprojects/resticprofile" target="_blank" rel="noopener">resticprofile</a>


bemühen.</p>
<p>Ich sichere tatsächlich nicht <code>/home</code>, sondern erzeuge einen LVM2-Snapshot,
von dem die Sicherung durchgeführt wird, bevor er released wird.</p>
<p>Dadurch ist <code>/home</code> unveränderlich während der Sicherung,
und die Konsistenz des Backups ist besser.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/usr/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1"># Some basic config</span>
</span></span><span class="line"><span class="cl"><span class="nv">SNAPLV</span><span class="o">=</span>snap
</span></span><span class="line"><span class="cl"><span class="nv">SNAPMOUNT</span><span class="o">=</span>/snapshot-of-home
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">RESTIC_REPOSITORY</span><span class="o">=</span>sftp://storagebox/restic
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">RESTIC_PASSWORD</span><span class="o">=</span>secret_password
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># only use up to 4 cpus.</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">GOMAXPROCS</span><span class="o">=</span><span class="m">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Make this safe to run in a crontab</span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -e
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -o pipefail
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/root/.local/bin:/root/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /root
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Show free space</span>
</span></span><span class="line"><span class="cl">ssh -p <span class="m">23</span> -i /root/.ssh/id_backup storagebox df -m
</span></span><span class="line"><span class="cl"><span class="nb">echo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Delete old backups</span>
</span></span><span class="line"><span class="cl">restic forget <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-daily <span class="m">30</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-monthly <span class="m">12</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-within 2d <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --keep-tag keep <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --prune
</span></span><span class="line"><span class="cl"><span class="nb">echo</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Actually perform a backup</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1. Snapshot and mount it</span>
</span></span><span class="line"><span class="cl">lvcreate -s -n <span class="nv">$SNAPLV</span> -L10G /dev/vg0/home
</span></span><span class="line"><span class="cl">mount -t xfs -o nouuid /dev/vg0/<span class="nv">$SNAPLV</span> <span class="nv">$SNAPMOUNT</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2. Actual backup</span>
</span></span><span class="line"><span class="cl">restic backup <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --json <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --exclude-caches <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --iexclude-file /root/bin/restic-excludes <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  <span class="nv">$SNAPMOUNT</span> /var/www /etc /root <span class="p">|</span> 
</span></span><span class="line"><span class="cl">jq <span class="s1">&#39;. | select(.message_type == &#34;summary&#34; )&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3. Get rid of the snapshot</span>
</span></span><span class="line"><span class="cl">umount <span class="nv">$SNAPMOUNT</span>
</span></span><span class="line"><span class="cl">lvremove -f /dev/vg0/<span class="nv">$SNAPLV</span>
</span></span></code></pre></div><p>Alle <code>restic</code>-Subkommandos haben die Option <code>--json</code> auszugeben, was man dann
mit
<a href="https://github.com/tomnomnom/gron" target="_blank" rel="noopener"><code>gron</code></a>


oder
<a href="https://github.com/jqlang/jq" target="_blank" rel="noopener"><code>jq</code></a>


konsumieren kann.</p>
<p>In diesem Script erzeugen wir mit <code>lvcreate -s</code> einen Snapshot der <code>/home</code>-Partition.
Dieser wird dann in <code>/snapshot-of-home</code> gemounted.
Weil ich xfs verwendet und das versehentliches doppeltes Mounten eines Verzeichnisses verhindert,
muss ich dies mit der Option <code>nouuid</code> tun.</p>
<p>Ich kann jetzt das <code>restic backup</code>-Kommando laufen lassen.
Dies erfolgt unter anderem mit der Option <code>--json</code> und wir fischen den <code>summary</code>-Block am Ende raus,
ohne die Progress Reports weiter zu beachten.</p>
<p>Die Option <code>--exclude-caches</code> tut genau das:
<a href="https://bford.info/cachedir/" target="_blank" rel="noopener">CACHEDIR.TAG</a>

 Verzeichnisse ignorieren.
Außerdem werden die Patterns in einer Exclude-Datei mit <code>--iexclude-file</code> ebenfalls ignoriert.
Das Prefix <code>i</code> steht hier für <code>ignore-case</code>.</p>
<p>Am Ende melden wir den Snapshot wieder ab, und schmeißen ihn weg.</p>
<h2 id="garbage-collection">
    <a href="#garbage-collection">
	Garbage Collection
    </a>
</h2>
<p>Am Anfang des Scripts wird einmal
<code>restic forget --prune</code>
bemüht.
Dies sind die Regeln, nach denen alte Backups verworfen werden:</p>
<ul>
<li>Wir heben alle Backups 2 Tage auf.</li>
<li>Wir heben alle Backups mit dem Tag <code>keep</code> unbegrenzt auf.</li>
<li>Wir heben 30 Tage lang das neuste Backup jeden Tages auf.</li>
<li>Wir heben 12 Monate lang das neuste Backup jeden Monats auf.</li>
</ul>
<p>Auf diese Weise haben wir bis zu einem Jahr Historie.
Dabei ist noch einmal in Erinnerung zu rufen, daß Dinge, die sich nicht ändern,
nur einmal gespeichert werden, weil <code>restic</code> dedupliziert.</p>
<p>Die Deduplizierung ist sehr effektiv:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># restic stats</span>
</span></span><span class="line"><span class="cl">enter password <span class="k">for</span> repository:
</span></span><span class="line"><span class="cl">repository 3d26efdc opened <span class="o">(</span>version 2, compression level auto<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:00<span class="o">]</span> 100.00%  <span class="m">2</span> / <span class="m">2</span> index files loaded
</span></span><span class="line"><span class="cl">scanning...
</span></span><span class="line"><span class="cl">Stats in restore-size mode:
</span></span><span class="line"><span class="cl">     Snapshots processed:  <span class="m">51</span>
</span></span><span class="line"><span class="cl">        Total File Count:  <span class="m">2431309</span>
</span></span><span class="line"><span class="cl">              Total Size:  1.827 TiB
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># df -Th /restic/</span>
</span></span><span class="line"><span class="cl">Filesystem             Type  Size  Used Avail Use% Mounted on
</span></span><span class="line"><span class="cl">/dev/mapper/vg0-restic xfs   250G   57G  194G  23% /restic
</span></span></code></pre></div><p><em>1.8 TB Daten werden von 57 GB Plattenplatz repräsentiert.</em></p>
<p>Das <code>--prune</code> nach dem Forget gibt Plattenplatz wieder frei.
Dabei kann es vorkommen, daß</p>
<ul>
<li>Der Linkcount einer Datei erniedrigt wird, sonst nichts.</li>
<li>Daten frei markiert werden, aber als ungenutzter Datei in einem 16 MB &ldquo;Pack&rdquo; rumstehen.</li>
<li>Der freie Platz im &ldquo;Pack&rdquo; so groß wird, daß das Pack neu geschrieben wird.</li>
<li>Das Pack komplett frei wird und gelöscht werden kann.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">remove <span class="m">1</span> snapshots:
</span></span><span class="line"><span class="cl">ID        Time                 Host        Tags        Paths
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">dac0526f  2023-12-27 13:10:01  bigbox                  /etc
</span></span><span class="line"><span class="cl">                                                       /snapshot-of-home
</span></span><span class="line"><span class="cl">                                                       /var/www
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------
</span></span><span class="line"><span class="cl"><span class="m">1</span> snapshots
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:00<span class="o">]</span> 100.00%  <span class="m">1</span> / <span class="m">1</span> files deleted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">1</span> snapshots have been removed, running prune
</span></span><span class="line"><span class="cl">loading indexes...
</span></span><span class="line"><span class="cl">loading all snapshots...
</span></span><span class="line"><span class="cl">finding data that is still in use <span class="k">for</span> <span class="m">51</span> snapshots
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:02<span class="o">]</span> 100.00%  <span class="m">51</span> / <span class="m">51</span> snapshots
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">searching used packs...
</span></span><span class="line"><span class="cl">collecting packs <span class="k">for</span> deletion and repacking
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:00<span class="o">]</span> 100.00%  <span class="m">3499</span> / <span class="m">3499</span> packs processed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">to repack:          <span class="m">1517</span> blobs / 466.577 MiB
</span></span><span class="line"><span class="cl">this removes:       <span class="m">1341</span> blobs / 444.158 MiB
</span></span><span class="line"><span class="cl">to delete:           <span class="m">138</span> blobs / 65.741 MiB
</span></span><span class="line"><span class="cl">total prune:        <span class="m">1479</span> blobs / 509.899 MiB
</span></span><span class="line"><span class="cl">remaining:        <span class="m">174653</span> blobs / 54.827 GiB
</span></span><span class="line"><span class="cl">unused size after prune: 2.728 GiB <span class="o">(</span>4.98% of remaining size<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">repacking packs
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:01<span class="o">]</span> 100.00%  <span class="m">30</span> / <span class="m">30</span> packs repacked
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">rebuilding index
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:00<span class="o">]</span> 100.00%  <span class="m">3468</span> / <span class="m">3468</span> packs processed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">deleting obsolete index files
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:00<span class="o">]</span> 100.00%  <span class="m">3</span> / <span class="m">3</span> files deleted
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">removing <span class="m">34</span> old packs
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:00<span class="o">]</span> 100.00%  <span class="m">34</span> / <span class="m">34</span> files deleted
</span></span></code></pre></div><p>Eine detaillierte Statistik zeigt an, wie viel Platz <code>--prune</code> reclaimed hat,
und wie viel Platz noch innerhalb der Dateien ungenutzt frei ist.
Er wird bei einem späteren <code>--prune</code> freigegeben.</p>
<h2 id="snapshots-anzeigen">
    <a href="#snapshots-anzeigen">
	Snapshots anzeigen
    </a>
</h2>
<p>Snapshots anzeigen geht mit <code>restic snapshots</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># restic snapshots</span>
</span></span><span class="line"><span class="cl">enter password <span class="k">for</span> repository:
</span></span><span class="line"><span class="cl">repository 3d26efdc opened <span class="o">(</span>version 2, compression level auto<span class="o">)</span>
</span></span><span class="line"><span class="cl">ID        Time                 Host        Tags        Paths
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------
</span></span><span class="line"><span class="cl">0b981e61  2023-12-25 14:21:06  bigbox                  /etc
</span></span><span class="line"><span class="cl">                                                       /snapshot-of-home
</span></span><span class="line"><span class="cl">                                                       /var/www
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">e4e36825  2023-12-25 23:10:01  bigbox                  /etc
</span></span><span class="line"><span class="cl">                                                       /snapshot-of-home
</span></span><span class="line"><span class="cl">                                                       /var/www
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="m">99153462</span>  2023-12-29 15:10:01  bigbox                  /etc
</span></span><span class="line"><span class="cl">                                                       /snapshot-of-home
</span></span><span class="line"><span class="cl">                                                       /var/www
</span></span><span class="line"><span class="cl">------------------------------------------------------------------------
</span></span><span class="line"><span class="cl"><span class="m">51</span> snapshots
</span></span></code></pre></div><p>Wir können auch mit <code>restic ls</code> das Verzeichnis des Snapshots listen lassen,
oder mit <code>restic dump</code> eine einzelne Datei ausgeben lassen.</p>
<h2 id="suche">
    <a href="#suche">
	Suche
    </a>
</h2>
<p>Wir können einen Snapshot nach einzelnen Dateien durchsuchen.
Zum Beispiel wollen wir sehen, ob wir das File <code>/home/snackbag/snackbag/extras/snacksmp/v15-fast.zip</code> im Backup haben.</p>
<p>Gesichert worden ist es als <code>/snapshot-of-home/...</code>.
Also</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># restic find &#39;/snapshot-of-home/snackbag/snackbag/extras/snacksmp/v15-fast.zip&#39;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Found matching entries in snapshot fbb371bd from 2023-12-29 13:10:01
</span></span><span class="line"><span class="cl">/snapshot-of-home/snackbag/snackbag/extras/snacksmp/v15-fast.zip
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Found matching entries in snapshot 498bfd63 from 2023-12-29 14:10:02
</span></span><span class="line"><span class="cl">/snapshot-of-home/snackbag/snackbag/extras/snacksmp/v15-fast.zip
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Found matching entries in snapshot <span class="m">99153462</span> from 2023-12-29 15:10:01
</span></span><span class="line"><span class="cl">/snapshot-of-home/snackbag/snackbag/extras/snacksmp/v15-fast.zip
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Found matching entries in snapshot c5d9b64a from 2023-12-29 16:10:01
</span></span><span class="line"><span class="cl">/snapshot-of-home/snackbag/snackbag/extras/snacksmp/v15-fast.zip
</span></span></code></pre></div><p>Zum Restore brauchen wir die Snapshot-ID (also zum Beispiel: <code>c5d9b64a</code>) der Version, die wir haben wollen.
Die Ausgabe ist chronologisch, also brauchen wir die letzte ID.</p>
<p>Suche geht auch mit Wildcards:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># restic find --json &#39;*/v15-fast.zip&#39; | gron</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span> <span class="o">=</span> <span class="o">{}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.hits <span class="o">=</span> 1<span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches <span class="o">=</span> <span class="o">[]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span> <span class="o">=</span> <span class="o">{}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.atime <span class="o">=</span> <span class="s2">&#34;2023-12-18T12:53:17+01:00&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.ctime <span class="o">=</span> <span class="s2">&#34;2023-12-18T14:39:47.875074144+01:00&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.device_id <span class="o">=</span> 64773<span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.gid <span class="o">=</span> 1013<span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.group <span class="o">=</span> <span class="s2">&#34;snackbag&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.inode <span class="o">=</span> 67328639<span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.links <span class="o">=</span> 1<span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.mode <span class="o">=</span> 420<span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.mtime <span class="o">=</span> <span class="s2">&#34;2023-12-18T12:53:17+01:00&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.path <span class="o">=</span> <span class="s2">&#34;/snapshot-of-home/snackbag/snackbag/extras/snacksmp/v15-fast.zip&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.permissions <span class="o">=</span> <span class="s2">&#34;-rw-r--r--&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.size <span class="o">=</span> 53774271<span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.type <span class="o">=</span> <span class="s2">&#34;file&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.uid <span class="o">=</span> 1013<span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.matches<span class="o">[</span>0<span class="o">]</span>.user <span class="o">=</span> <span class="s2">&#34;snackbag&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">json<span class="o">[</span>50<span class="o">]</span>.snapshot <span class="o">=</span> <span class="s2">&#34;c5d9b64aad4248840801f599baedc95467c49a2b8634a86d75be5bbd9d130bce&#34;</span><span class="p">;</span>
</span></span></code></pre></div><p>Oder mit <code>jq</code> statt <code>gron</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># restic find --json &#39;*/v15-fast.zip&#39; | jq &#39;.[].snapshot&#39;</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="s2">&#34;fbb371bd16a2db6c2b619d14f9c7beb8e52b7f40d212b3eafb1b1f145f731478&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;498bfd639d6ae59c926a63812aaced6dc5b541ca1302c5334913044f3b8333e6&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;9915346249d0ed02d35e43a81a46d184b75f6c00ec00133c0446a4b4a9cc8eb5&#34;</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;c5d9b64aad4248840801f599baedc95467c49a2b8634a86d75be5bbd9d130bce&#34;</span>
</span></span></code></pre></div><h2 id="restore">
    <a href="#restore">
	Restore
    </a>
</h2>
<p>Restore dann:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># mkdir workspace</span>
</span></span><span class="line"><span class="cl"><span class="c1"># restic restore \</span>
</span></span><span class="line"><span class="cl">&gt; --target workspace <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>&gt; --include <span class="s1">&#39;*/v15-fast.zip&#39;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>c5d9b64aad4248840801f599baedc95467c49a2b8634a86d75be5bbd9d130bce
</span></span><span class="line"><span class="cl">repository 3d26efdc opened <span class="o">(</span>version 2, compression level auto<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:00<span class="o">]</span> 100.00%  <span class="m">2</span> / <span class="m">2</span> index files loaded
</span></span><span class="line"><span class="cl">restoring &lt;Snapshot c5d9b64a of <span class="o">[</span>/snapshot-of-home /var/www /etc<span class="o">]</span> at 2023-12-29 16:10:01.934599035 +0100 CET by root@bigbox&gt; to workspace
</span></span><span class="line"><span class="cl">Summary: Restored <span class="m">6</span> / <span class="m">1</span> files/dirs <span class="o">(</span>51.283 MiB / 51.283 MiB<span class="o">)</span> in 0:02
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># find workspace/ -type f</span>
</span></span><span class="line"><span class="cl">workspace/snapshot-of-home/snackbag/snackbag/extras/snacksmp/v15-fast.zip
</span></span></code></pre></div><h2 id="fuse-mount">
    <a href="#fuse-mount">
	FUSE-Mount
    </a>
</h2>
<p>Das ist sehr viel schneller als ein Mount,
aber ein FUSE-Mount kann auch hilfreich sein:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># restic mount /mnt/restic</span>
</span></span><span class="line"><span class="cl">repository 3d26efdc opened <span class="o">(</span>version 2, compression level auto<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>0:00<span class="o">]</span> 100.00%  <span class="m">2</span> / <span class="m">2</span> index files loaded
</span></span><span class="line"><span class="cl">Now serving the repository at /mnt/restic
</span></span><span class="line"><span class="cl">Use another terminal or tool to browse the contents of this folder.
</span></span><span class="line"><span class="cl">When finished, quit with Ctrl-c here or umount the mountpoint.
</span></span></code></pre></div><p>In einem 2. Fenster dann:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># cd /mnt/restic/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ls -F</span>
</span></span><span class="line"><span class="cl">hosts/  ids/  snapshots/  tags/
</span></span><span class="line"><span class="cl"><span class="c1"># ls -F ids/</span>
</span></span><span class="line"><span class="cl">ids/:
</span></span><span class="line"><span class="cl">0167ffd2/  152ea32f/  2ff8540c/  59f8f55b/  9afe61d3/  d58d50fa/  f22e171d/
</span></span><span class="line"><span class="cl">023a782d/  1561f1c8/  33e09326/  5eec2b8c/  a0020775/  d7c8e648/  f80f9e4f/
</span></span><span class="line"><span class="cl">02478085/  1b36de2d/  3f0bce8d/  61e02a5b/  a075cdd8/  d972654b/  fbb371bd/
</span></span><span class="line"><span class="cl">04216185/  1c253586/  451b146d/  6fcc9fbf/  aa916fab/  dd761561/
</span></span><span class="line"><span class="cl">0b981e61/  1c64b318/  4961c739/  89aef175/  b4d945ee/  e1b58661/
</span></span><span class="line"><span class="cl">0caeffbd/  2342db66/  498bfd63/  90a9861c/  be0f439a/  e4e36825/
</span></span><span class="line"><span class="cl">0d7e65d4/  2566d92a/  4e2ba289/  954210a2/  c0fcfe70/  eb8ce869/
</span></span><span class="line"><span class="cl">0ee4d0c9/  2cddb602/  5415cd2d/  99153462/  c5d9b64a/  ee6ad425/
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># cd ids/c5d9b64a</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">etc  snapshot-of-home  var
</span></span><span class="line"><span class="cl"><span class="c1"># ls etc | head -3</span>
</span></span><span class="line"><span class="cl">adjtime
</span></span><span class="line"><span class="cl">aliases
</span></span><span class="line"><span class="cl">aliases.db
</span></span></code></pre></div><h1 id="sftp-für-restic-aufsetzen">
    <a href="#sftp-f%c3%bcr-restic-aufsetzen">
	<code>sftp</code> für <code>restic</code> aufsetzen
    </a>
</h1>
<p>Die Sicherung vom (als kompromittiert anzusehenden) Minecraft-Server nach Hause muss passend gesichert werden.</p>
<ul>
<li>Wir legen einen <code>resticuser</code> nur für die Sicherung dieses Servers an.</li>
<li>Er wird in der <code>/etc/ssh/sshd_config</code> auf <code>sftp-internal</code> constrained.</li>
<li>Der <code>.ssh/authorized_keys</code> dieses Users wird hinterlegt,
und als unveränderlich markiert, um Manipulationen zu erschweren.</li>
<li>Der <code>sftp</code>-User bekommt ein <code>chroot(2)</code> ins Datenverzeichnis und kann nicht auf sein eigenes Home zugreifen.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># useradd -m -c &#34;Restic Backup von Minecraft&#34; resticuser</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># mkdir ~resticuser/.ssh</span>
</span></span><span class="line"><span class="cl"><span class="c1"># scp .../id_backup.pub ~resticuser/.ssh/authorized_keys</span>
</span></span><span class="line"><span class="cl"><span class="c1"># chown -R resticuser:resticuser ~resticuser</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># chattr +i ~/.ssh/authorized_keys</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># tail -5 /etc/ssh/sshd_config</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">Match User resticuser
</span></span><span class="line"><span class="cl">    ChrootDirectory /backup/minecraft_backup
</span></span><span class="line"><span class="cl">    ForceCommand internal-sftp
</span></span><span class="line"><span class="cl">    AllowTcpForwarding no
</span></span><span class="line"><span class="cl">    X11Forwarding no
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="c1"># mkdir /backup/minecraft_backup/restic</span>
</span></span><span class="line"><span class="cl"><span class="c1"># chown -R resticuser:resticuser /backup/minecraft_backup</span>
</span></span></code></pre></div><p>Eine modifizierte Version von <code>run-restic</code> von oben sollte nun Daten in diesen Speicher schieben können.</p>
<h1 id="rest-server">
    <a href="#rest-server">
	<code>rest-server</code>
    </a>
</h1>
<p>(via <a href="https://github.com/mgumz" target="_blank" rel="noopener">Mathias Gumz</a>

)</p>
<p><a href="https://github.com/restic/rest-server" target="_blank" rel="noopener"><code>rest-server</code></a>

 ist ein Unterprojekt von <code>restic</code>,
das ein Server-Backend für das REST-Protokoll von <code>restic</code> implementiert.
Es hat einen <code>--append-only</code> Modus, mit dem man Backups aus unsicheren Quellen annehmen kann,
ohne daß die Backup-Quelle das Backup zerstören oder löschen kann.
Natürlich müssen <code>forget</code> und <code>prune</code> dann lokal auf dem Server getriggert werden und nicht durch den Backup-Prozess.</p>
<p>Das Projekt kommt mit einer umfangreichen Installationsanleitung und mit offiziellen Docker-Images,
sodass das Aufsetzen eines Servers mit wenigen Handgriffen getan ist.</p>
<p>Der Aufruf sieht im Wesentlichen so aus:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ lvcreate -L 100G -n testing hdd
</span></span><span class="line"><span class="cl">$ mkfs -t xfs /dev/hdd/testing
</span></span><span class="line"><span class="cl">$ mkdir /backup/testing
</span></span><span class="line"><span class="cl">$ mount /dev/hdd/testing /backup/testing
</span></span><span class="line"><span class="cl">$ <span class="nb">cd</span> /backup/testing
</span></span><span class="line"><span class="cl">$ htpasswd -B -c .htpasswd kris
</span></span><span class="line"><span class="cl">Password: keks
</span></span><span class="line"><span class="cl">$ cp /etc/apache2/md/domains/<span class="o">{</span>privkey,pubcert<span class="o">}</span>.pem .
</span></span><span class="line"><span class="cl">$ rest-server <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --append-only <span class="se">\ </span>
</span></span><span class="line"><span class="cl">  --tls <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --tls-cert pubcert.pem <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --tls-key privkey.pem <span class="se">\ </span> 
</span></span><span class="line"><span class="cl">  --path /backup/testing/ <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --max-size <span class="m">107374182400</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --listen <span class="s1">&#39;192.168.1.10:8000&#39;</span>
</span></span></code></pre></div><p><em>Testweises Starten von <code>rest-server</code> mit lokalen Kopien der bei &ldquo;Let&rsquo;s Encrypt&rdquo; generierten Zertifikate und ein Test-Repository.</em></p>
<p>Der Beispielaufruf startet den <code>rest-server</code> auf Port 8000 der Testmaschine.
Er verwendet Kopien der von &ldquo;mod_md&rdquo; generierten &ldquo;Let&rsquo;s Encrypt&rdquo;-Zertifikate aus <code>/etc/apache/md/domains</code>,
und greift auf ein &ldquo;append-only&rdquo;-Repository in <code>/backup/testing</code> zu.
Die Größe des Repository ist auf 100 GB (100 * 1024^3 Bytes) limitiert.</p>
<p>Wir können das Repository unter dem Namen <code>rest:https://home.example.com:8000</code> ansprechen.
Also</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ <span class="nb">export</span> <span class="nv">RESTIC_REPOSITORY</span><span class="o">=</span>rest:https://home.example.com:8000
</span></span><span class="line"><span class="cl">$   <span class="nb">export</span> <span class="nv">RESTIC_PASSWORD</span><span class="o">=</span>keks
</span></span><span class="line"><span class="cl">$ restic init
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">$ restic backup --exclude-caches /etc 
</span></span></code></pre></div><p>zum Sichern ein paar mal laufen lassen und dann <code>restic snapshots</code> zum Ansehen der Backups.</p>
<p>Löschen von Backups mit <code>forget</code> und <code>prune</code> ist durch den Client nicht mehr machbar.</p>
<p>Stattdessen kann man das Backup lokal als <code>-r /backup/testing</code> ansprechen und per Cron
das entsprechende <code>forget --prune --keep...</code>-Regel laufen lassen.
Dabei muß man sicherstellen, daß die Datei-Eigentümer sauber bleiben,
am Besten indem man <code>rest-server</code> und den <code>forget</code>-Cronjob unter demselben
Owner laufen läßt.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_de" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_de
				</a>
				
				<a href="/tags/#linux" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				linux
				</a>
				
				<a href="/tags/#devops" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				devops
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2023-12-30-restic.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2023/12/05/x86_64-binaries-on-m1.html">x86_64 binaries on M1</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2024/01/09/deploying-websites.html">Deploying websites - an escalation</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
