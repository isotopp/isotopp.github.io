<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>beep, patch and ed | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2018/04/06/beep-patch-and-ed.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='beep, patch and ed | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2018/04/06/beep-patch-and-ed.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2018-04-06T00:00:00Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/schloss.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='beep, patch and ed' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/schloss.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="beep-patch-and-ed-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						beep, patch and ed
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>April 6, 2018</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/schloss.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/03/04/hashes-in-structures.html">Hashes in Structures</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/04/26/harebrained-battletech.html">Harebrained Battletech</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>So a few days ago, somebody found an exploit in beep - now
<a href="https://nvd.nist.gov/vuln/detail/CVE-2018-0492" target="_blank" rel="noopener">CVE-2018-0492</a>

.</p>
<p>beep is a program that is part of Debian (and Ubuntu) to have the PC speaker
multiple times, at different frequencies, with different pauses and beep
lengths. That works just fine. It&rsquo;s also SUID root. There is zero code in it
that deals with the fact that it may run privileged.</p>
<p>The author confidently writes:</p>
<blockquote>
<p>Some users will encounter a situation where beep dies with a complaint
from ioctl(). The reason for this, as Peter Tirsek was nice enough to
point out to me, stems from how the kernel handles beep&rsquo;s attempt to poke
at (for non-programmers: ioctl is a sort of catch-all function that lets
you poke at things that have no other predefined poking-at mechanism) the
tty, which is how it beeps. The short story is, the kernel checks that
either:</p>
<ul>
<li>you are the superuser</li>
<li>you own the current tty</li>
</ul>
<p>What this means is that root can always make beep work (to the best of my
knowledge!), and that any local user can make beep work, BUT a non-root
remote user cannot use beep in it&rsquo;s natural state.</p>
<p>What&rsquo;s worse, an xterm, or other x-session counts, as far as the kernel is
concerned, as &lsquo;remote&rsquo;, so beep won&rsquo;t work from a non-privileged xterm
either. I had originally chalked this up to a bug, but there&rsquo;s actually
nothing I can do about it, and it really is a Good Thing that the kernel
does things this way.</p>
<p>There is also a solution. By default beep is not installed with the suid
bit set, because that would just be zany. On the other hand, if you do
make it suid root, all your problems with beep bailing on ioctl calls will
magically vanish, which is pleasant, and the only reason not to is that
any suid program is a potential security hole.</p>
<p>Conveniently, beep is very short, so auditing it is pretty
straightforward. Decide for yourself, of course, but it looks safe to me -
there&rsquo;s only one buffer and fgets doesn&rsquo;t let it overflow, there&rsquo;s only
one file opening, and while there is a potential race condition there,
it&rsquo;s with /dev/console. If someone can exploit this race by replacing
/dev/console, you&rsquo;ve got bigger problems. :)</p></blockquote>
<p>So here is how you race this: <a href="https://gist.github.com/fkt/5f8f9560ef54e11ff7df8bec09dc8f9a" target="_blank" rel="noopener">beepbop</a>

</p>
<p>Which is bad, because Ubuntu and Debian both install beep SUID root, by
default. You can check with &ldquo;dpkg-reconfigure -plow beep&rdquo;.</p>
<p><p class="md__image">
  <img src="/uploads/2018/04/dpkg-reconfigure-beep.png" alt=""  />
</p>

</p>
<p>Debian installs beep SUID root by default, &ldquo;dpkg-reconfigure -plow
beep&rdquo;</p>
<p>Somebody also created a fun website for the beep problem, complete with
logo and name: <a href="https://holeybeep.ninja/" target="_blank" rel="noopener">Holey Beep</a>

.</p>
<p><p class="md__image">
  <img src="/uploads/2018/04/holey-beep.png" alt=""  />
</p>

</p>
<p><a href="https://holeybeep.ninja/" target="_blank" rel="noopener">Holey Beep</a>

: The site, which is done very tongue
in cheek, also contained a <a href="https://holeybeep.ninja/beep.patch" target="_blank" rel="noopener">patch</a>

 for
the problem, advertising it like this:</p>
<p><p class="md__image">
  <img src="/uploads/2018/04/patch-exploit.png" alt=""  />
</p>

</p>
<p>So why would your computer beep when it applies a patch?
That&rsquo;s another fun thing. The patch contains this hunk:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gd">--- /dev/null	2018-13-37 13:37:37.000000000 +0100
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/beep.c	2018-13-37 13:38:38.000000000 +0100
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>1337a
</span></span><span class="line"><span class="cl">1,112d
</span></span><span class="line"><span class="cl"><span class="gs">!id&gt;~/pwn.lol;beep # 13-21 12:53:21.000000000 +0100
</span></span></span><span class="line"><span class="cl"><span class="gs"></span>.
</span></span></code></pre></div><p>and that looks very much like an ed-script. In fact, until recently that is
exactly what patch did: popen a copy of ed and feed it. The line &ldquo;id &gt;
~/pwn.lol; beep&rdquo; will hence be run, create a file pwn.lol in $HOME with the
current user id, and then execute beep. That&rsquo;s the promised beep you hear.</p>
<p>Of course code execution by a thing you expect to handle data is a problem,
and that is now
<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-1000156" target="_blank" rel="noopener">CVE-2018-1000156</a>

.</p>
<p>It&rsquo;s fixed by writing the ed code to a tmp file while filtering the commands
fed to ed, and then feeding the filtered input into ed.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				erklaerbaer
				</a>
				
				<a href="/tags/#security" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				security
				</a>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2018-04-06-beep-patch-and-ed.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/03/04/hashes-in-structures.html">Hashes in Structures</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/04/26/harebrained-battletech.html">Harebrained Battletech</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
