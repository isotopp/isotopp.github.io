<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Hashes in Structures | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2018/03/04/hashes-in-structures.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Hashes in Structures | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2018/03/04/hashes-in-structures.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2018-03-04T18:30:22Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Hashes in Structures' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/rijksmuseum.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="hashes-in-structures-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Hashes in Structures
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>March 4, 2018</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/rijksmuseum.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/02/26/hashes-and-their-uses.html">Hashes and their uses</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/04/06/beep-patch-and-ed.html">beep, patch and ed</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>In
<a href="/2018/02/26/hashes-and-their-uses.html">Hashes and their uses</a>


we have been talking about hash functions in general, and
cryptographic hashes in particular. We wanted four things from
cryptographic hashes:</p>
<ol>
<li>The hash should be fast to calculate on a large string of bytes.</li>
<li>The hash is slow to reverse (i.e. only by trying all messages
and checking each result).</li>
<li>The hash is slow to find collisions for (i.e. it&rsquo;s hard to
find two input strings that have the same hash value).</li>
<li>The hash does chaotically cascade changes (i.e. a single bit
flip in the original message does flip many bits in the hash
value).</li>
</ol>
<p>With these things and general cryptography we can built three
very versatile things that see many applications: Digital
signatures, eternal logfiles (&ldquo;blockchains&rdquo;) and hash trees
(&ldquo;torrents&rdquo;).</p>
<h2 id="digital-signatures">
    <a href="#digital-signatures">
	Digital Signatures
    </a>
</h2>
<h3 id="using-asymmetric-cryptography">
    <a href="#using-asymmetric-cryptography">
	Using asymmetric cryptography
    </a>
</h3>
<p>Digital Signatures are using primitives from asymmetric
cryptography and cryptographic checksums.</p>
<p>From asymmetric cryptography we know we can have two keys, P and
Q, which actually work in symmetry:
What has been encrypted with one key can be decrypted only
with the other key.</p>
<p>So we</p>
<ul>
<li>either encrypt a message M with a key P to get a ciphertext C, and decode C with Q to get M back.</li>
<li>Or we encrypt M with Q, and decrypt with P to get M back.</li>
</ul>
<p>The asymmetry is introduced by keeping Q secret and makig P as
public as possible.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">P is public. 
</span></span></span><span class="line"><span class="cl"><span class="go">Q is private and only known to one person. 
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">C = encrypt(P, M) 
</span></span></span><span class="line"><span class="cl"><span class="go">M = decrypt(Q, C) 
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">or 
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">C = encrypt(Q, M) 
</span></span></span><span class="line"><span class="cl"><span class="go">M = decrypt(P, C) 
</span></span></span></code></pre></div><p>Unfortunately, in asymmetric public key cryptography, the keys
are usually rather long, and hence the encrypt() and decrypt()
functions are usually quite slow. It is useful to keep M
reasonably small.</p>
<h3 id="signing">
    <a href="#signing">
	Signing
    </a>
</h3>
<p>For digital signatures, the signer calculates a hash H of a
message M and then encrypts the hash H using the private key Q,
creating CH.</p>
<p>The message and the encrypted hash are sent
together.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">H = hash(M)
</span></span></span><span class="line"><span class="cl"><span class="go">CH = encrypt(Q, H)
</span></span></span><span class="line"><span class="cl"><span class="go">send(M, CH) 
</span></span></span></code></pre></div><p>When receiving the message, the
receiver can read the message and can calculate their own
checksum, <code>RH = hash(M)</code>.</p>
<p>Because the public key P of the sender is, well, public, we can
also decrypt the encrypted checksum the sender calculated:
<code>H = decrypt(p, CH)</code>.</p>
<p>If that H is equal to RH, we can know that one of two things is
true:</p>
<ul>
<li>Either the message has not been tampered with,</li>
<li>or the sender lost control of the private key.</li>
</ul>
<p>Assuming the latter is not the case, the former must be true and
that means that the message we received is as it originated at
the sender and we do know who the sender is.</p>
<h2 id="eternal-logfiles">
    <a href="#eternal-logfiles">
	Eternal Logfiles
    </a>
</h2>
<p>When calculating hashes over a sequence of messages, it is
possible to seed each message with the previous messages hash:</p>
<p><p class="md__image">
  <img src="/uploads/2018/03/eternal-logfile.png" alt=""  />
</p>

</p>
<p>Each log entry consists of the actual message, the current
timestamp and the hash of the previous entry. The current hash
is a hash over all of these three things.</p>
<p>Each entry in the log consists of the actual log entry, the date
the entry is being made and the hash of the previous log entry.
The current hash is being calculated over all of these things:</p>
<ul>
<li>the message,</li>
<li>the current timestamp and</li>
<li>the previous hash.</li>
</ul>
<p>Because each entry contains the previous entries hash value, it
is becoming hard to change older entries in the log: A change to
an old log entry will create a ripple effect that changes each
subsequent newer hash value in the log.</p>
<p>Additional security can be produced by introducing media breaks
and publishing the current hash value (with the date) in many
places. The date added to each log entry is not supplied by the
log source which sends the message: While the logged message can
have a structure and may also contain a timestamp as seen by the
message sender, the date fields shown as separate fields in the
graphics above are the local time of the logger.</p>
<p>The interdependency of the log messages create a public order of
events. Message 2 and Hash 2 could not have been produced before
Message 1 and Hash 1, as the value of Hash 2 is dependent not
only on the contents of Message 2, but also on the value of Hash 1.</p>
<p>A very simple implementation of this can be found in Lutz
Donnerhacke&rsquo;s Eternal Logfile
(<a href="http://altlasten.lutz.donnerhacke.de/mitarb/lutz/logfile/" target="_blank" rel="noopener">Site in German</a>

).
Interestingly, forward secure sealing as implemented in
journald/systemd does not work like this, but uses
<a href="https://lwn.net/Articles/512895/" target="_blank" rel="noopener">another mechanism</a>

.
It also does not seal each log entry as it is being generated,
but creates 15 minute windows of log entries which are then
protected.</p>
<p>The main reason for this are seekability and purgeability: It
should be possible to validate the integrity of the journald log
file without calculating the sequence of hashes from system
installation.</p>
<h3 id="guarantees-given-in-eternal-logfiles">
    <a href="#guarantees-given-in-eternal-logfiles">
	Guarantees given in Eternal Logfiles
    </a>
</h3>
<p>It is important to note that no assumptions whatsoever are being
made of the structure of the messages being chained in this
chain of hash values. It is also important to note that no
mechanism to authenticate or validate the content of the
messages being logged is available automatically - the only
proofs such a chained eternal logfile provides is:</p>
<ol>
<li>
<p>Message n-1 is older than Message n (Order of messages can be
implied from the order of log entries).</p>
</li>
<li>
<p>If the hash chain resolves (i.e. all checksums calculate just
fine), none of the messages prior to the final message have been
tampered with.</p>
</li>
</ol>
<p>By digitally signing the each message in the log, the identity
of the creator for each logged message can be proven, and the
authenticity of each message can be verified independently from
the hash chain itself.</p>
<h3 id="limitations-and-disadvantages-of-eternal-logfiles">
    <a href="#limitations-and-disadvantages-of-eternal-logfiles">
	Limitations and Disadvantages of Eternal Logfiles
    </a>
</h3>
<p>Without additional mechanisms, eternal logfiles cannot be purged
nor seeked. That is, because each log entries hash is dependent
not only on the logfiles content, but also on the hash of the
previous log entry, it is not possible to ever delete log
entries without losing the ability to check the chains
integrity.</p>
<p>All logs have to be kept forever.
Mechanisms to work around that could be constructed, but are
usually not implemented, often on purpose.</p>
<p>Related to that is the ability to check the integrity of the
hash chain: This is only possible from the anchor point, which
by construction and on purpose is only at the start of the
chain.</p>
<p>A validation of the chain therefore becomes increasingly costly
as the length the chain increases and no purge mechanism exists.
A full chain validation could create a local index, which notes
the position of each log entry and also the expected checksum.
This would allow quick seeks and quick local entry validations.</p>
<p>Building this index is still dependent on at least one big scan
and validation of the entire chain.</p>
<h2 id="hash-trees">
    <a href="#hash-trees">
	Hash Trees
    </a>
</h2>
<p>It is also possible to structure hashes-of-hashes in a
non-linear fashion, for example in a tree structure. The
Merkle-Tree is named after the cryptographer
<a href="https://en.wikipedia.org/wiki/Ralph_Merkle" target="_blank" rel="noopener">Ralph Merkle</a>

,
and is one specific implementation of a Hash Tree.</p>
<p><p class="md__image">
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/95/Hash_Tree.svg/800px-Hash_Tree.svg.png" alt=""  />
</p>

</p>
<p>Data (the messages) are at the leaf nodes (L1 to L4) of the
tree. Non-Leaf nodes contain hashes of the blocks beneath them.</p>
<p>([Image Source:Wikipedia:<a href="https://en.wikipedia.org/wiki/File:Hash_Tree.svg" target="_blank" rel="noopener">Hash Tree</a>

)</p>
<p>Hash Trees can establish order of events the same way linearly
hashed logfiles do. They allow better pinpointing of the
position of an error, at least down to the position of a single
block, while at the same time still assuring the intrity of
other data past the modified block. They also allow partial file
integrity checks for each subtree of the main hash tree.</p>
<h3 id="applications-of-hash-trees">
    <a href="#applications-of-hash-trees">
	Applications of Hash Trees
    </a>
</h3>
<p>Hash Trees, Merkle Trees or
<a href="https://en.wikipedia.org/wiki/Tiger_%28cryptography%29" target="_blank" rel="noopener">variants of the system</a>

,
are being used in practically all P2P systems, where their
properties are useful to determine which blocks of a file a
client already has and which ones are still missing. At the same
time, the top level hash can be used as a file name in a
<a href="https://en.wikipedia.org/wiki/Content-addressable_storage" target="_blank" rel="noopener">content addressing scheme</a>

.</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Magnet_URI_scheme" target="_blank" rel="noopener">Magnet Links</a>

 are just
top level hashes of a Hash Tree in a P2P system.</li>
<li>Hash Trees also see application for securing file integrity in file systems that
target very large storages (ZFS, BTRFS), enabling partial file
system checks and rapid validation of files and file trees.</li>
<li>They are also useful in pinpointing areas of files that
changes, enabling fast differential backups. A variant of Hash
Tree logic is consequently also applied in
<a href="https://www.percona.com/doc/percona-toolkit/LATEST/pt-table-sync.html" target="_blank" rel="noopener">pt-table-sync</a>


of the Percona Toolkit, finding differences between two
instances of the same table on two different database servers
and then creating a minimal set of change instructions to
mutate a target table so that it matches the contents of a
source table.</li>
<li>Some version control systems, for example git, are also
using
<a href="https://de.slideshare.net/tommasovisconti/git-contentaddressable-filesystem-and-version-control-system" target="_blank" rel="noopener">trees of hashes as a content addressable storage</a>

,
but in a way that differs from a pure Merkle Tree.</li>
<li><a href="https://www.certificate-transparency.org/what-is-ct" target="_blank" rel="noopener">Certificate Transparency</a>


uses a Merkle Tree as a
<a href="https://www.certificate-transparency.org/log-proofs-work" target="_blank" rel="noopener">container for the log of all certificates</a>


generated by all certificate authorities participating,
establishing completeness and authenticity of the CT log as well
as an order of events.</li>
<li>Merkle Trees are also used to structure
and validate the integrity of the blockchain underneath Bitcoin.</li>
</ul>
<h3 id="limits-and-additional-considerations">
    <a href="#limits-and-additional-considerations">
	Limits and additional considerations
    </a>
</h3>
<p>Like with the Eternal Logfile, no assumptions are made about the
content of the messages that make up the payload of a Merkle
Tree. Additional agreements between multiple parties about the
content of messages are necessary to give data in a Hash Tree
meaning. Without pruning/seeking mechanisms, all
<a href="https://martinfowler.com/eaaDev/EventSourcing.html" target="_blank" rel="noopener">sequentially ordered transactional systems</a>


are accumulating log data/tree size without bounds. Creation of
the systems current state is getting progressively more
expensive in memory and computation required.</p>
<h3 id="history">
    <a href="#history">
	History
    </a>
</h3>
<p>Eternal Log files and Merkle Trees are old innovations. The
patent for Merkle Trees was created by Ralph Merkle in 1979 (and
<a href="https://worldwide.espacenet.com/publicationDetails/biblio?CC=US&amp;NR=4309569&amp;KC=&amp;FT=E&amp;locale=en_EP" target="_blank" rel="noopener">granted in 1982</a>

)
and is since expired. Eternal Log files are an idea created by
David Chaum even before that. Continued from
<a href="/2018/02/26/hashes-and-their-uses.html">Hashes and their uses</a>

</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#erklaerbaer" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				erklaerbaer
				</a>
				
				<a href="/tags/#blockchain" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				blockchain
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2018-03-04-hashes-in-structures.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/02/26/hashes-and-their-uses.html">Hashes and their uses</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/04/06/beep-patch-and-ed.html">beep, patch and ed</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
