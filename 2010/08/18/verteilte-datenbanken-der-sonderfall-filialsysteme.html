<!doctype html>
<html lang="en">
    <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Verteilte Datenbanken: Der Sonderfall Filialsysteme | Die wunderbare Welt von Isotopp</title>
<meta name="description" content="Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" href="favicon.ico" type="image/ico">
<link rel="shortcut icon" href="favicon.ico">
<link rel="canonical" href="https://blog.koehntopp.info/2010/08/18/verteilte-datenbanken-der-sonderfall-filialsysteme.html">

<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/feed.xml' title="Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/mysql/feed.xml' title="Feed: mysql Articles for Die wunderbare Welt von Isotopp">
<link rel="alternate" type="application/rss+xml" href='https://blog.koehntopp.info/tags/review/feed.xml' title="Feed: review Articles for Die wunderbare Welt von Isotopp">


<meta name="generator" content="Hugo 0.145.0">
<meta property="og:title" content='Verteilte Datenbanken: Der Sonderfall Filialsysteme | Die wunderbare Welt von Isotopp' />
<meta property="og:site_name" content='Die wunderbare Welt von Isotopp' />
<meta property="og:locale" content="de_DE" />
<meta name="description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="og:url" content="https://blog.koehntopp.info/2010/08/18/verteilte-datenbanken-der-sonderfall-filialsysteme.html" />
<meta property="og:type" content="article" />
<meta name="article:published_time" content='2010-08-18T13:04:00Z' />
<meta name="fediverse:creator" content="@isotopp@infosec.exchange">
<meta property="og:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:creator" content='@isotopp@infosec.exchange' />
<meta property="twitter:title" content='Verteilte Datenbanken: Der Sonderfall Filialsysteme' />
<meta property="twitter:description" content='Kris Köhntopp&#39;s blog (Fedi: @isotoppinfosec.exchange)' />
<meta property="twitter:image" content='https://blog.koehntopp.info/assets/img/background/mysql.jpg' />


    



<link rel="stylesheet" href="https://blog.koehntopp.info/style.min.dd9d518fe6cac55191b6af874e18327dff051055754ffc7e106131baf826e6d3.css">


    </head>
    <body>
        

        <nav class="navbar navbar-expand-lg navbar-light px-lg-4 pt-lg-4">
    <div class="container-fluid">
        <a class="navbar-brand justify-content-center" href="https://blog.koehntopp.info/" rel="home" title="Die wunderbare Welt von Isotopp">
            <img alt="Kris" height='48' width='48' src='/assets/img/avatars/isotopp.jpg' class='p-0 me-3 d-block d-lg-inline'>
            <span class='h4 d-block d-lg-inline'>Die wunderbare Welt von Isotopp</span>
        </a>

        <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse text-center" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto">
                
                <li class="nav-item ">
                    <a class="nav-link" href="/about/">
                        <span class="">About</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/contribute/">
                        <span class="">Contribute</span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/search/">
                        <span class=""><svg class='bi' height='1.5rem' width='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#search'/></svg></span>
                        
                    </a>
                </li>
                <li class="nav-item ">
                    <a class="nav-link" href="/tags/">
                        <span class=""><svg class='bi' width='1.5rem' height='1.5rem' fill='currentColor'><use xlink:href='/bootstrap-icons.svg#tags-fill'/></svg></span>
                        
                    </a>
                </li>
                
            </ul>
            
        </div>

    </div>
</nav>


        <main role="main" class="container-fluid p-0">

            









<div class="page">
	<article class="verteilte-datenbanken-der-sonderfall-filialsysteme-page">
		<div class='row  justify-content-center text-center my-4 mx-0'>
			<header class="headerbanner">
				<div class='col'>
					<h1 class="title mb-lg-4 text-white">
						Verteilte Datenbanken: Der Sonderfall Filialsysteme
					</h1>
					<div class='text-uppercase text-light' style='letter-spacing: 0.1rem;'>
						<img alt='@isotopp@infosec.exchange image' src='/assets/img/avatars/isotopp.jpg' class='me-1 p-0'
						     style='width: 1.9rem; border-radius: 1rem;'>
						<a href="https://infosec.exchange/@isotopp" class='text-light text-decoration-none'>
							Kristian Köhntopp
						</a>
						
						<span class='d-none d-lg-inline'>-</span>
						<div class='d-block d-lg-inline'>August 18, 2010</div>
						
					</div>
				</div>
				
				<img alt='a featured image' src="/assets/img/background/mysql.jpg">
				
			</header>
		</div>

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2010/08/17/ein-ring-mit-zwei-mysql-servern-und-auto-increment-increment.html">Ein Ring mit zwei MySQL-Servern und auto_increment_increment</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2010/08/18/fertig-gelesen-the-dreaming-void.html">Fertig gelesen: The Dreaming Void</a>
				</div>
				
			</div>
		</div>

		<div class='row justify-content-center mx-0 mt-3 mb-5'>
			<div class="col-lg-8 mb-3">
				
			</div>
			<div class='col-lg-8'>
				<p>In einem Kommentar zu <a href="/2010/08/16/master-master-und-distributed-transactions.html">Master-Master</a>

 schrieb
ich:</p>
<blockquote>
<p>Für den von Dir genannten Sonderfall der Filialsysteme habe ich noch einen
deutschen Artikel in der Warteschlange, ich muß nur Zeit finden ihn zu
schreiben.</p></blockquote>
<p>Normalerweise sieht MySQL Replikation so aus:</p>
<p><p class="md__image">
  <img src="/uploads/replication.png" alt=""  />
</p>

</p>
<p>MySQL Replikation - Architekturübersicht</p>
<h3 id="master-binlog">
    <a href="#master-binlog">
	Master Binlog
    </a>
</h3>
<p>Auf dem Master ist mit der Konfigurationsanweisung <code>log_bin</code> das Binlog
aktiviert.</p>
<p>Das Binlog loggt bei Statement Based Replication (SBR) alle Anweisungen, die
Daten verändern (also quasi alles außer <code>SELECT</code>). Binlog-Dateien haben
dasselbe Namensprefix und werden dann durchnumeriert. Die Datenbank beginnt
ein neues Binlog, wenn die laufende Binlog-Datei größer als
<code>max_binlog_size</code> (Default 1G) wird, wenn das Kommando <code>FLUSH LOGS</code>
ausgeführt wird oder wenn der Server neu gestartet wird.</p>
<p>In der Binlog-Indexdatei findet man eine Liste aller existierenden Binlogs,
man kann sie mit dem Kommando <code>SHOW MASTER LOGS</code> anzeigen lassen. Durch das
Kommando <code>PURGE MASTER LOGS</code> kann man alte Binlogs löschen - meistens macht
man so etwas wie <code>PURGE MASTER LOGS BEFORE NOW() - INTERVAL 3 DAY</code> statt ein
konstantes Datum oder einen festen Dateinamen anzugeben. Man kann die
Löschung auch automatisieren, indem man <code>expire_logs_days</code> auf einen Wert
setzt. Dann werden beim Anlegen eines neuen Binlogs alle Dateien gelöscht,
die älter als <code>expire_logs_days</code> Tage sind.</p>
<p>Mit dem Kommando <code>mysqlbinlog</code> kann man das Binlog lesen und in ein SQL-Script
umwandeln lassen. Dieses könnte man (ab einer gewünschten Position) einlesen
lassen, indem man im Kommandozeilenclient das Kommando <code>source …</code>&rsquo; eingibt.
Auf diese Weise kann man eine Datenbank von einer bekannten Binlog-Position
manuell zu einer anderen Position vorwärts rollen lassen.</p>
<p>Diese Prozedur ist bei einer Recovery notwendig: Man spielt ein Full Backup
ein, das hoffentlich mit einer bekannten Binlog-Position assoziiert ist.
Dann verwendet man das Binlog, um von dieser Position zu einer gewünschten
Position (unmittelbar vor dem fatalen <code>DROP DATABASE</code> wichtig) vorwärts zu
rollen.</p>
<h3 id="server-id">
    <a href="#server-id">
	Server ID
    </a>
</h3>
<p>Jeder Server in einem MySQL-Replikationssystem hat eine eindeutige
Server-ID. Das ist ein 32 Bit Wert ohne Vorzeichen, der den Server eindeutig
identifiziert. Das Binlog markiert jeden Eintrag mit dieser Server-ID.
Dadurch ist es möglich, in Replikationsringen endlos kreisende Statements zu
erkennen und zu eliminieren: Ein Server wird keine Anwendungen per
Replikation ausführen, die seine eigene Server-ID enthalten.</p>
<h3 id="replication-slave-privilege">
    <a href="#replication-slave-privilege">
	REPLICATION SLAVE Privilege
    </a>
</h3>
<p>Replikation besteht für den Master darin, daß sich ein Slave auf dem Master
einloggt und das Kommando SHOW MASTER LOGS sowie das binäre Äquivalent von
SHOW BINLOG EVENTS ausführt. Damit er das kann, muß der Slave einen Account
auf dem Master haben, der das Privileg REPLICATION SLAVE hat.</p>
<h3 id="slave-side">
    <a href="#slave-side">
	Slave Side
    </a>
</h3>
<p>Auf dem Slave besteht Replikation aus zwei Teilen: Der <code>IO_THREAD</code> nimmt die
vier Login-Informationen (Host, Port, User und Paßwort) aus dem <code>CHANGE MASTER</code> Statement und loggt sich auf dem Master ein. Er nimmt dann die zwei
Binlog-Positionsdaten (Binlog Name und Binlog Position), und lädt das Binlog
ab dieser Position beginnend so schnell als möglich runter. Er schreibt
diese Daten auf dem Slave in das Relay Log File. Der <code>SQL_THREAD</code> liest die
Daten aus dem Relay Log File und führt sie aus. Wenn er damit fertig ist,
löscht er das Relay Log File und wendet sich dem nächsten File aus dem Relay
Log Index zu.</p>
<h2 id="filialsysteme">
    <a href="#filialsysteme">
	Filialsysteme
    </a>
</h2>
<p>Ein Filialsystem besteht aus vielen kleinen autonomen Datenbanken in den
Filialen eines Händlers. Die Struktur der Datenbank in jeder Filiale ist
immer gleich, aber jede Filiale hat dieses Schema unter einem eigenen Namen
und mit den Daten dieser Filiale.</p>
<p>Das Problem besteht jetzt darin, die Daten aus den Filialen in der Zentrale
zusammen zu führen und dort dann zu aggregieren. Aus technischen Gründen ist
es nicht möglich, die gesamte Datenbank in die Zentrale zu übertragen.
Stattdessen will man täglich einmal das Delta transportieren.</p>
<p>Der Ansatz dazu ist ein einfacher Sharding Ansatz, bei dem wir den
Vorderteil der Replikation mißbrauchen - also den Teil auf dem Master, der
das Binlog schreibt. Das Hinterteil in der Zentrale bauen wir selber, mit
mysqlbinlog und ein paar Scripten.</p>
<p>Der Ansatz sieht so aus:</p>
<p><p class="md__image">
  <img src="/uploads/filialen.png" alt=""  />
</p>

</p>
<p>Filialsystem (mit Binlog-Transport)</p>
<p>Die Vorbedingungen sind:</p>
<ul>
<li>Die Datenbestände der zweier beliebiger Filialen m und n sind
überlappungsfrei (sonst ist es kein Sharding).</li>
<li>Schreibzugriffe in die Filialdatenbank db_n erfolgen nur in der Filiale
n.</li>
<li>Die Daten in der Zentrale können hinter den Daten in der Filiale hinterher
hinken. Der Abstand ist durch die Häufigkeit des Transportes der Binlogs
wählbar.</li>
<li>In den Filialen sind alle Queries mit unqualifizierten Namen geschrieben:
Man schreibt also immer INSERT INTO t
&hellip;, nie INSERT INTO db.t ….</li>
<li>In der Zentrale existiert eine Schemakopie der Filiale, auf die das Delta
angewendet werden kann.</li>
</ul>
<p>Das Verfahren ist wie folgt: In den Filialen laufen autonome Datenbankserver
mit aktiviertem Binlog. Vor einem Transport in die Zentrale wird ein <code>FLUSH LOGS</code> gemacht. Dadurch wird ein neues Binlog begonnen und man hat einen
sauberen Cutoff-Punkt. Die Binlogs vor dem Cutoff werden archiviert und dem
Transport übergeben. Danach werden sie mit <code>PURGE MASTER LOGS</code> in der
Datenbank gelöscht (können aber im Archiv als Kopie auch in der Filiale
verbleiben).</p>
<p>In der Zentrale wird jedes Binlog-Set einer Filiale in ein SQL-Sourcefile
umgewandelt, durch Anwendung des Kommandos <code>mysqlbinlog</code>. Dieses File wird
dann in die Schemakopie der Filiale eingelesen und bringt diese auf Stand.</p>
<p>Danach kann durch Starten der Aggregationsprozesse die Datenbank der
Zentrale <code>db_agg</code> aktualisiert werden und die Daten aus allen Filialen
integrieren.</p>
<p>Ein Sharding (Shard = Splitter) ist ein Sonderfall einer Partition. Eine
Partition ist eine Aufteilung einer Menge derart, daß die Teile die
Gesamtmenge komplett überdecken und sich zwei Teilmengen nicht überdecken.
Bildlich kann man sich das Zerschneiden einer Torte in Stücke nicht
notwendig gleicher Größe vorstellen. Bei einer Partition liegen die
Teilstücke in der Regel auf einer Maschine, beim Sharding dürfen die
Teilstücke verteilt liegen, es kann also jeder Shard auf einer anderen,
räumlich getrennten Maschine liegen.</p>
<p>In unserem Beispiel stellen wir einen Shard in jede Filiale und lassen ihn
dort lokal und ohne Kenntnis der anderen Shards arbeiten. Wir zeichnen die
Änderungen im Binlog auf und spielen alle Änderungen aller Filialen in der
Zentrale ein. Das funktioniert nur deshalb, weil alle Änderungen sich immer
nur auf das Schema der Filiale beziehen.</p>
<p>In einem großen Zentralschema erzeugen wir durch horizontale
Aggregationsqueries quer über alle Filialschemata eine integrierte
Gesamtansicht.</p>

			</div>
		</div>

		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Tags</span>
				
				<a href="/tags/#mysql" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				mysql
				</a>
				
				<a href="/tags/#database" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				database
				</a>
				
				<a href="/tags/#lang_de" class='btn btn-sm btn-outline-primary mb-1'>
				<svg class="bi" width="1rem" height="1rem" fill="currentColor">
					<use xlink:href="/bootstrap-icons.svg#tag-fill"></use>
				</svg>
				lang_de
				</a>
				
			</div>
		</div>

		
		
		
		
		<div class='row justify-content-center py-3 mb-3 mx-0'>
			<div class='col-lg-8 text-center'>
				<a href="https://github.com/isotopp/isotopp.github.io/edit/main/content/posts/2010-08-18-verteilte-datenbanken-der-sonderfall-filialsysteme.md"
				   rel="noopener noreferrer" target="_blank">
					<span class='letter-spacing-01 text-uppercase text-secondary me-2'>Suggest Changes</span>
				</a>
			</div>
		</div>
		

		<div class='row justify-content-center mx-0'>
			<div class='col-lg-4 text-center text-lg-start'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Previous Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2010/08/17/ein-ring-mit-zwei-mysql-servern-und-auto-increment-increment.html">Ein Ring mit zwei MySQL-Servern und auto_increment_increment</a>
				</div>
				
			</div>

			<div class='col-lg-4 text-lg-end mt-5 mt-lg-0 text-center'>
				
				<div>
					<div class='letter-spacing-01 text-uppercase text-secondary'>
						Next Post
					</div>
					<a class='text-decoration-none' href="https://blog.koehntopp.info/2010/08/18/fertig-gelesen-the-dreaming-void.html">Fertig gelesen: The Dreaming Void</a>
				</div>
				
			</div>
		</div>


		
	</article>
</div>



            <footer class='row justify-content-center mb-4 pb-4 mx-0'>
  <div class='col-8 text-center'>
    <div>
      A collection of old stuff, new stuff and random stuff.
    </div>
    <div class='row text-primary mt-4'>
      <div class='col'>

        <a href='/feed.xml' title='Follow RSS feed' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#rss-fill'/>
          </svg>
        </a>

        <a href='mailto:kristian.koehntopp@gmail.com' title='Email' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#envelope'/>
          </svg>
        </a>

        <a href='https://github.com/isotopp' title='Follow on GitHub' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#github'/>
          </svg>
        </a>

        <a rel="me" href="https://infosec.exchange/@isotopp" title='Follow on Mastodon' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#mastodon'/>
          </svg>
        </a>

        
        <a href='http://steamcommunity.com/id/ixotopp' title='Follow on Steam' class='me-3 text-decoration-none'>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#steam'/>
          </svg>
        </a>

        

        <a href='https://www.youtube.com/user/isotopp' title='Follow on YouTube' class=''>
          <svg class='bi' height='2.5rem' width='2.5rem' fill='currentColor'>
            <use xlink:href='/bootstrap-icons.svg#youtube'/>
          </svg>
        </a>
      </div>
    </div>
  </div>
</footer>


        </main>

	





<script src="https://blog.koehntopp.info/js/bootstrap.js"></script>




<script src="https://blog.koehntopp.info/js/lunr.js"></script>





<script src="https://blog.koehntopp.info/js/app.js"></script>


    </body>
</html>
